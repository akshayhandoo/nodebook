<!DOCTYPE html>
<!-- saved from url=(0102)https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="1573407" data-user-uuid="29525685-85c9-45c7-9eda-3c178d86398e" data-username="raviguru0007" data-account-type="Trial" data-activated-trial-date="04/17/2017" data-archive="9781430260585" data-publishers="Apress" data-htmlfile-name="9781430260585_Ch02.xhtml" data-epub-title="Node.js Recipes: A Problem-Solution Approach" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781430260585"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><script type="text/javascript" src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/510f1a6865"></script><script src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/nr-spa-1026.min.js"></script><script type="text/javascript" async="" src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/linkid.js"></script><script async="" src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/analytics.js"></script><script type="text/javascript">(window.NREUM||(NREUM={})).loader_config={xpid:"VQQDUVVVGwACU1RUAQA="};window.NREUM||(NREUM={}),__nr_require=function(t,e,n){function r(n){if(!e[n]){var o=e[n]={exports:{}};t[n][0].call(o.exports,function(e){var o=t[n][1][e];return r(o||e)},o,o.exports)}return e[n].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,e,n){function r(t){try{c.console&&console.log(t)}catch(e){}}var o,i=t("ee"),a=t(19),c={};try{o=localStorage.getItem("__nr_flags").split(","),console&&"function"==typeof console.log&&(c.console=!0,o.indexOf("dev")!==-1&&(c.dev=!0),o.indexOf("nr_dev")!==-1&&(c.nrDev=!0))}catch(s){}c.nrDev&&i.on("internal-error",function(t){r(t.stack)}),c.dev&&i.on("fn-err",function(t,e,n){r(n.stack)}),c.dev&&(r("NR AGENT IN DEVELOPMENT MODE"),r("flags: "+a(c,function(t,e){return t}).join(", ")))},{}],2:[function(t,e,n){function r(t,e,n,r,o){try{d?d-=1:i("err",[o||new UncaughtException(t,e,n)])}catch(c){try{i("ierr",[c,s.now(),!0])}catch(u){}}return"function"==typeof f&&f.apply(this,a(arguments))}function UncaughtException(t,e,n){this.message=t||"Uncaught error with no additional information",this.sourceURL=e,this.line=n}function o(t){i("err",[t,s.now()])}var i=t("handle"),a=t(20),c=t("ee"),s=t("loader"),f=window.onerror,u=!1,d=0;s.features.err=!0,t(1),window.onerror=r;try{throw new Error}catch(p){"stack"in p&&(t(12),t(11),"addEventListener"in window&&t(6),s.xhrWrappable&&t(13),u=!0)}c.on("fn-start",function(t,e,n){u&&(d+=1)}),c.on("fn-err",function(t,e,n){u&&(this.thrown=!0,o(n))}),c.on("fn-end",function(){u&&!this.thrown&&d>0&&(d-=1)}),c.on("internal-error",function(t){i("ierr",[t,s.now(),!0])})},{}],3:[function(t,e,n){t("loader").features.ins=!0},{}],4:[function(t,e,n){function r(){C++,N=y.hash,this[u]=M.now()}function o(){C--,y.hash!==N&&i(0,!0);var t=M.now();this[l]=~~this[l]+t-this[u],this[d]=t}function i(t,e){x.emit("newURL",[""+y,e])}function a(t,e){t.on(e,function(){this[e]=M.now()})}var c="-start",s="-end",f="-body",u="fn"+c,d="fn"+s,p="cb"+c,h="cb"+s,l="jsTime",m="fetch",v="addEventListener",w=window,y=w.location;if(w[v]){var b=t(9),g=t(10),x=t(8),E=t(6),O=t(12),R=t(7),P=t(13),T=t("ee"),S=T.get("tracer");t(14);var M=t("loader");M.features.spa=!0;var N,j=w[v],C=0;T.on(u,r),T.on(p,r),T.on(d,o),T.on(h,o),T.buffer([u,d,"xhr-done","xhr-resolved"]),E.buffer([u]),O.buffer(["setTimeout"+s,"clearTimeout"+c,u]),P.buffer([u,"new-xhr","send-xhr"+c]),R.buffer([m+c,m+"-done",m+f+c,m+f+s]),x.buffer(["newURL"]),b.buffer([u]),g.buffer(["propagate",p,h,"executor-err","resolve"+c]),S.buffer([u,"no-"+u]),a(P,"send-xhr"+c),a(T,"xhr-resolved"),a(T,"xhr-done"),a(R,m+c),a(R,m+"-done"),x.on("pushState-end",i),x.on("replaceState-end",i),j("hashchange",i,!0),j("load",i,!0),j("popstate",function(){i(0,C>1)},!0)}},{}],5:[function(t,e,n){function r(t){}if(window.performance&&window.performance.timing&&window.performance.getEntriesByType){var o=t("ee"),i=t("handle"),a=t(12),c=t(11),s="learResourceTimings",f="addEventListener",u="resourcetimingbufferfull",d="bstResource",p="resource",h="-start",l="-end",m="fn"+h,v="fn"+l,w="bstTimer",y="pushState",b=t("loader");b.features.stn=!0,t(8);var g=NREUM.o.EV;o.on(m,function(t,e){var n=t[0];n instanceof g&&(this.bstStart=b.now())}),o.on(v,function(t,e){var n=t[0];n instanceof g&&i("bst",[n,e,this.bstStart,b.now()])}),a.on(m,function(t,e,n){this.bstStart=b.now(),this.bstType=n}),a.on(v,function(t,e){i(w,[e,this.bstStart,b.now(),this.bstType])}),c.on(m,function(){this.bstStart=b.now()}),c.on(v,function(t,e){i(w,[e,this.bstStart,b.now(),"requestAnimationFrame"])}),o.on(y+h,function(t){this.time=b.now(),this.startPath=location.pathname+location.hash}),o.on(y+l,function(t){i("bstHist",[location.pathname+location.hash,this.startPath,this.time])}),f in window.performance&&(window.performance["c"+s]?window.performance[f](u,function(t){i(d,[window.performance.getEntriesByType(p)]),window.performance["c"+s]()},!1):window.performance[f]("webkit"+u,function(t){i(d,[window.performance.getEntriesByType(p)]),window.performance["webkitC"+s]()},!1)),document[f]("scroll",r,{passive:!0}),document[f]("keypress",r,!1),document[f]("click",r,!1)}},{}],6:[function(t,e,n){function r(t){for(var e=t;e&&!e.hasOwnProperty(u);)e=Object.getPrototypeOf(e);e&&o(e)}function o(t){c.inPlace(t,[u,d],"-",i)}function i(t,e){return t[1]}var a=t("ee").get("events"),c=t(22)(a,!0),s=t("gos"),f=XMLHttpRequest,u="addEventListener",d="removeEventListener";e.exports=a,"getPrototypeOf"in Object?(r(document),r(window),r(f.prototype)):f.prototype.hasOwnProperty(u)&&(o(window),o(f.prototype)),a.on(u+"-start",function(t,e){var n=t[1],r=s(n,"nr@wrapped",function(){function t(){if("function"==typeof n.handleEvent)return n.handleEvent.apply(n,arguments)}var e={object:t,"function":n}[typeof n];return e?c(e,"fn-",null,e.name||"anonymous"):n});this.wrapped=t[1]=r}),a.on(d+"-start",function(t){t[1]=this.wrapped||t[1]})},{}],7:[function(t,e,n){function r(t,e,n){var r=t[e];"function"==typeof r&&(t[e]=function(){var t=r.apply(this,arguments);return o.emit(n+"start",arguments,t),t.then(function(e){return o.emit(n+"end",[null,e],t),e},function(e){throw o.emit(n+"end",[e],t),e})})}var o=t("ee").get("fetch"),i=t(19);e.exports=o;var a=window,c="fetch-",s=c+"body-",f=["arrayBuffer","blob","json","text","formData"],u=a.Request,d=a.Response,p=a.fetch,h="prototype";u&&d&&p&&(i(f,function(t,e){r(u[h],e,s),r(d[h],e,s)}),r(a,"fetch",c),o.on(c+"end",function(t,e){var n=this;e?e.clone().arrayBuffer().then(function(t){n.rxSize=t.byteLength,o.emit(c+"done",[null,e],n)}):o.emit(c+"done",[t],n)}))},{}],8:[function(t,e,n){var r=t("ee").get("history"),o=t(22)(r);e.exports=r,o.inPlace(window.history,["pushState","replaceState"],"-")},{}],9:[function(t,e,n){var r=t("ee").get("mutation"),o=t(22)(r),i=NREUM.o.MO;e.exports=r,i&&(window.MutationObserver=function(t){return this instanceof i?new i(o(t,"fn-")):i.apply(this,arguments)},MutationObserver.prototype=i.prototype)},{}],10:[function(t,e,n){function r(t){var e=a.context(),n=c(t,"executor-",e),r=new f(n);return a.context(r).getCtx=function(){return e},a.emit("new-promise",[r,e],e),r}function o(t,e){return e}var i=t(22),a=t("ee").get("promise"),c=i(a),s=t(19),f=NREUM.o.PR;e.exports=a,f&&(window.Promise=r,["all","race"].forEach(function(t){var e=f[t];f[t]=function(n){function r(t){return function(){a.emit("propagate",[null,!o],i),o=o||!t}}var o=!1;s(n,function(e,n){Promise.resolve(n).then(r("all"===t),r(!1))});var i=e.apply(f,arguments),c=f.resolve(i);return c}}),["resolve","reject"].forEach(function(t){var e=f[t];f[t]=function(t){var n=e.apply(f,arguments);return t!==n&&a.emit("propagate",[t,!0],n),n}}),f.prototype["catch"]=function(t){return this.then(null,t)},f.prototype=Object.create(f.prototype,{constructor:{value:r}}),s(Object.getOwnPropertyNames(f),function(t,e){try{r[e]=f[e]}catch(n){}}),a.on("executor-start",function(t){t[0]=c(t[0],"resolve-",this),t[1]=c(t[1],"resolve-",this)}),a.on("executor-err",function(t,e,n){t[1](n)}),c.inPlace(f.prototype,["then"],"then-",o),a.on("then-start",function(t,e){this.promise=e,t[0]=c(t[0],"cb-",this),t[1]=c(t[1],"cb-",this)}),a.on("then-end",function(t,e,n){this.nextPromise=n;var r=this.promise;a.emit("propagate",[r,!0],n)}),a.on("cb-end",function(t,e,n){a.emit("propagate",[n,!0],this.nextPromise)}),a.on("propagate",function(t,e,n){this.getCtx&&!e||(this.getCtx=function(){if(t instanceof Promise)var e=a.context(t);return e&&e.getCtx?e.getCtx():this})}),r.toString=function(){return""+f})},{}],11:[function(t,e,n){var r=t("ee").get("raf"),o=t(22)(r),i="equestAnimationFrame";e.exports=r,o.inPlace(window,["r"+i,"mozR"+i,"webkitR"+i,"msR"+i],"raf-"),r.on("raf-start",function(t){t[0]=o(t[0],"fn-")})},{}],12:[function(t,e,n){function r(t,e,n){t[0]=a(t[0],"fn-",null,n)}function o(t,e,n){this.method=n,this.timerDuration="number"==typeof t[1]?t[1]:0,t[0]=a(t[0],"fn-",this,n)}var i=t("ee").get("timer"),a=t(22)(i),c="setTimeout",s="setInterval",f="clearTimeout",u="-start",d="-";e.exports=i,a.inPlace(window,[c,"setImmediate"],c+d),a.inPlace(window,[s],s+d),a.inPlace(window,[f,"clearImmediate"],f+d),i.on(s+u,r),i.on(c+u,o)},{}],13:[function(t,e,n){function r(t,e){d.inPlace(e,["onreadystatechange"],"fn-",c)}function o(){var t=this,e=u.context(t);t.readyState>3&&!e.resolved&&(e.resolved=!0,u.emit("xhr-resolved",[],t)),d.inPlace(t,v,"fn-",c)}function i(t){w.push(t),l&&(b=-b,g.data=b)}function a(){for(var t=0;t<w.length;t++)r([],w[t]);w.length&&(w=[])}function c(t,e){return e}function s(t,e){for(var n in t)e[n]=t[n];return e}t(6);var f=t("ee"),u=f.get("xhr"),d=t(22)(u),p=NREUM.o,h=p.XHR,l=p.MO,m="readystatechange",v=["onload","onerror","onabort","onloadstart","onloadend","onprogress","ontimeout"],w=[];e.exports=u;var y=window.XMLHttpRequest=function(t){var e=new h(t);try{u.emit("new-xhr",[e],e),e.addEventListener(m,o,!1)}catch(n){try{u.emit("internal-error",[n])}catch(r){}}return e};if(s(h,y),y.prototype=h.prototype,d.inPlace(y.prototype,["open","send"],"-xhr-",c),u.on("send-xhr-start",function(t,e){r(t,e),i(e)}),u.on("open-xhr-start",r),l){var b=1,g=document.createTextNode(b);new l(a).observe(g,{characterData:!0})}else f.on("fn-end",function(t){t[0]&&t[0].type===m||a()})},{}],14:[function(t,e,n){function r(t){var e=this.params,n=this.metrics;if(!this.ended){this.ended=!0;for(var r=0;r<d;r++)t.removeEventListener(u[r],this.listener,!1);if(!e.aborted){if(n.duration=a.now()-this.startTime,4===t.readyState){e.status=t.status;var i=o(t,this.lastSize);if(i&&(n.rxSize=i),this.sameOrigin){var s=t.getResponseHeader("X-NewRelic-App-Data");s&&(e.cat=s.split(", ").pop())}}else e.status=0;n.cbTime=this.cbTime,f.emit("xhr-done",[t],t),c("xhr",[e,n,this.startTime])}}}function o(t,e){var n=t.responseType;if("json"===n&&null!==e)return e;var r="arraybuffer"===n||"blob"===n||"json"===n?t.response:t.responseText;return l(r)}function i(t,e){var n=s(e),r=t.params;r.host=n.hostname+":"+n.port,r.pathname=n.pathname,t.sameOrigin=n.sameOrigin}var a=t("loader");if(a.xhrWrappable){var c=t("handle"),s=t(15),f=t("ee"),u=["load","error","abort","timeout"],d=u.length,p=t("id"),h=t(18),l=t(17),m=window.XMLHttpRequest;a.features.xhr=!0,t(13),f.on("new-xhr",function(t){var e=this;e.totalCbs=0,e.called=0,e.cbTime=0,e.end=r,e.ended=!1,e.xhrGuids={},e.lastSize=null,h&&(h>34||h<10)||window.opera||t.addEventListener("progress",function(t){e.lastSize=t.loaded},!1)}),f.on("open-xhr-start",function(t){this.params={method:t[0]},i(this,t[1]),this.metrics={}}),f.on("open-xhr-end",function(t,e){"loader_config"in NREUM&&"xpid"in NREUM.loader_config&&this.sameOrigin&&e.setRequestHeader("X-NewRelic-ID",NREUM.loader_config.xpid)}),f.on("send-xhr-start",function(t,e){var n=this.metrics,r=t[0],o=this;if(n&&r){var i=l(r);i&&(n.txSize=i)}this.startTime=a.now(),this.listener=function(t){try{"abort"===t.type&&(o.params.aborted=!0),("load"!==t.type||o.called===o.totalCbs&&(o.onloadCalled||"function"!=typeof e.onload))&&o.end(e)}catch(n){try{f.emit("internal-error",[n])}catch(r){}}};for(var c=0;c<d;c++)e.addEventListener(u[c],this.listener,!1)}),f.on("xhr-cb-time",function(t,e,n){this.cbTime+=t,e?this.onloadCalled=!0:this.called+=1,this.called!==this.totalCbs||!this.onloadCalled&&"function"==typeof n.onload||this.end(n)}),f.on("xhr-load-added",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&!this.xhrGuids[n]&&(this.xhrGuids[n]=!0,this.totalCbs+=1)}),f.on("xhr-load-removed",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&this.xhrGuids[n]&&(delete this.xhrGuids[n],this.totalCbs-=1)}),f.on("addEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-added",[t[1],t[2]],e)}),f.on("removeEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-removed",[t[1],t[2]],e)}),f.on("fn-start",function(t,e,n){e instanceof m&&("onload"===n&&(this.onload=!0),("load"===(t[0]&&t[0].type)||this.onload)&&(this.xhrCbStart=a.now()))}),f.on("fn-end",function(t,e){this.xhrCbStart&&f.emit("xhr-cb-time",[a.now()-this.xhrCbStart,this.onload,e],e)})}},{}],15:[function(t,e,n){e.exports=function(t){var e=document.createElement("a"),n=window.location,r={};e.href=t,r.port=e.port;var o=e.href.split("://");!r.port&&o[1]&&(r.port=o[1].split("/")[0].split("@").pop().split(":")[1]),r.port&&"0"!==r.port||(r.port="https"===o[0]?"443":"80"),r.hostname=e.hostname||n.hostname,r.pathname=e.pathname,r.protocol=o[0],"/"!==r.pathname.charAt(0)&&(r.pathname="/"+r.pathname);var i=!e.protocol||":"===e.protocol||e.protocol===n.protocol,a=e.hostname===document.domain&&e.port===n.port;return r.sameOrigin=i&&(!e.hostname||a),r}},{}],16:[function(t,e,n){function r(){}function o(t,e,n){return function(){return i(t,[f.now()].concat(c(arguments)),e?null:this,n),e?void 0:this}}var i=t("handle"),a=t(19),c=t(20),s=t("ee").get("tracer"),f=t("loader"),u=NREUM;"undefined"==typeof window.newrelic&&(newrelic=u);var d=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],p="api-",h=p+"ixn-";a(d,function(t,e){u[e]=o(p+e,!0,"api")}),u.addPageAction=o(p+"addPageAction",!0),u.setCurrentRouteName=o(p+"routeName",!0),e.exports=newrelic,u.interaction=function(){return(new r).get()};var l=r.prototype={createTracer:function(t,e){var n={},r=this,o="function"==typeof e;return i(h+"tracer",[f.now(),t,n],r),function(){if(s.emit((o?"":"no-")+"fn-start",[f.now(),r,o],n),o)try{return e.apply(this,arguments)}finally{s.emit("fn-end",[f.now()],n)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(t,e){l[e]=o(h+e)}),newrelic.noticeError=function(t){"string"==typeof t&&(t=new Error(t)),i("err",[t,f.now()])}},{}],17:[function(t,e,n){e.exports=function(t){if("string"==typeof t&&t.length)return t.length;if("object"==typeof t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer&&t.byteLength)return t.byteLength;if("undefined"!=typeof Blob&&t instanceof Blob&&t.size)return t.size;if(!("undefined"!=typeof FormData&&t instanceof FormData))try{return JSON.stringify(t).length}catch(e){return}}}},{}],18:[function(t,e,n){var r=0,o=navigator.userAgent.match(/Firefox[\/\s](\d+\.\d+)/);o&&(r=+o[1]),e.exports=r},{}],19:[function(t,e,n){function r(t,e){var n=[],r="",i=0;for(r in t)o.call(t,r)&&(n[i]=e(r,t[r]),i+=1);return n}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],20:[function(t,e,n){function r(t,e,n){e||(e=0),"undefined"==typeof n&&(n=t?t.length:0);for(var r=-1,o=n-e||0,i=Array(o<0?0:o);++r<o;)i[r]=t[e+r];return i}e.exports=r},{}],21:[function(t,e,n){e.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],22:[function(t,e,n){function r(t){return!(t&&t instanceof Function&&t.apply&&!t[a])}var o=t("ee"),i=t(20),a="nr@original",c=Object.prototype.hasOwnProperty,s=!1;e.exports=function(t,e){function n(t,e,n,o){function nrWrapper(){var r,a,c,s;try{a=this,r=i(arguments),c="function"==typeof n?n(r,a):n||{}}catch(f){p([f,"",[r,a,o],c])}u(e+"start",[r,a,o],c);try{return s=t.apply(a,r)}catch(d){throw u(e+"err",[r,a,d],c),d}finally{u(e+"end",[r,a,s],c)}}return r(t)?t:(e||(e=""),nrWrapper[a]=t,d(t,nrWrapper),nrWrapper)}function f(t,e,o,i){o||(o="");var a,c,s,f="-"===o.charAt(0);for(s=0;s<e.length;s++)c=e[s],a=t[c],r(a)||(t[c]=n(a,f?c+o:o,i,c))}function u(n,r,o){if(!s||e){var i=s;s=!0;try{t.emit(n,r,o,e)}catch(a){p([a,n,r,o])}s=i}}function d(t,e){if(Object.defineProperty&&Object.keys)try{var n=Object.keys(t);return n.forEach(function(n){Object.defineProperty(e,n,{get:function(){return t[n]},set:function(e){return t[n]=e,e}})}),e}catch(r){p([r])}for(var o in t)c.call(t,o)&&(e[o]=t[o]);return e}function p(e){try{t.emit("internal-error",e)}catch(n){}}return t||(t=o),n.inPlace=f,n.flag=a,n}},{}],ee:[function(t,e,n){function r(){}function o(t){function e(t){return t&&t instanceof r?t:t?s(t,c,i):i()}function n(n,r,o,i){if(!p.aborted||i){t&&t(n,r,o);for(var a=e(o),c=l(n),s=c.length,f=0;f<s;f++)c[f].apply(a,r);var d=u[y[n]];return d&&d.push([b,n,r,a]),a}}function h(t,e){w[t]=l(t).concat(e)}function l(t){return w[t]||[]}function m(t){return d[t]=d[t]||o(n)}function v(t,e){f(t,function(t,n){e=e||"feature",y[n]=e,e in u||(u[e]=[])})}var w={},y={},b={on:h,emit:n,get:m,listeners:l,context:e,buffer:v,abort:a,aborted:!1};return b}function i(){return new r}function a(){(u.api||u.feature)&&(p.aborted=!0,u=p.backlog={})}var c="nr@context",s=t("gos"),f=t(19),u={},d={},p=e.exports=o();p.backlog=u},{}],gos:[function(t,e,n){function r(t,e,n){if(o.call(t,e))return t[e];var r=n();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(t,e,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return t[e]=r,r}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],handle:[function(t,e,n){function r(t,e,n,r){o.buffer([t],r),o.emit(t,e,n)}var o=t("ee").get("handle");e.exports=r,r.ee=o},{}],id:[function(t,e,n){function r(t){var e=typeof t;return!t||"object"!==e&&"function"!==e?-1:t===window?0:a(t,i,function(){return o++})}var o=1,i="nr@id",a=t("gos");e.exports=r},{}],loader:[function(t,e,n){function r(){if(!x++){var t=g.info=NREUM.info,e=p.getElementsByTagName("script")[0];if(setTimeout(u.abort,3e4),!(t&&t.licenseKey&&t.applicationID&&e))return u.abort();f(y,function(e,n){t[e]||(t[e]=n)}),s("mark",["onload",a()+g.offset],null,"api");var n=p.createElement("script");n.src="https://"+t.agent,e.parentNode.insertBefore(n,e)}}function o(){"complete"===p.readyState&&i()}function i(){s("mark",["domContent",a()+g.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(c=Math.max((new Date).getTime(),c))-g.offset}var c=(new Date).getTime(),s=t("handle"),f=t(19),u=t("ee"),d=window,p=d.document,h="addEventListener",l="attachEvent",m=d.XMLHttpRequest,v=m&&m.prototype;NREUM.o={ST:setTimeout,CT:clearTimeout,XHR:m,REQ:d.Request,EV:d.Event,PR:d.Promise,MO:d.MutationObserver};var w=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-spa-1026.min.js"},b=m&&v&&v[h]&&!/CriOS/.test(navigator.userAgent),g=e.exports={offset:c,now:a,origin:w,features:{},xhrWrappable:b};t(16),p[h]?(p[h]("DOMContentLoaded",i,!1),d[h]("load",r,!1)):(p[l]("onreadystatechange",o),d[l]("onload",r)),s("mark",["firstbyte",c],null,"api");var x=0,E=t(21)},{}]},{},["loader",2,14,5,3,4]);</script><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/css" rel="stylesheet" type="text/css"><title>CHAPTER 2: Networking with Node.js - Node.js Recipes: A Problem-Solution Approach</title><link rel="stylesheet" href="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/74741d96e0ae.css" type="text/css"><link rel="stylesheet" type="text/css" href="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/annotator.e34eec1a0d5a.css"><link rel="stylesheet" href="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/font-awesome.min.css"><style type="text/css" title="ibis-book">
    #sbo-rt-content div{margin:1em 1em 1em 1em}#sbo-rt-content a{text-decoration:none}#sbo-rt-content img{max-width:100%;margin-top:10pt}#sbo-rt-content p.booktitle{font-weight:bold;font-size:2.5em;margin-top:2em;margin-bottom:8em;text-align:center}#sbo-rt-content p.bookauthor{font-weight:bold;font-size:1.7em;margin-top:0;margin-right:2em;margin-bottom:0;text-align:left}#sbo-rt-content p.booksubtitle{font-weight:bold;font-size:1.7em;margin-top:0;margin-bottom:7em;text-align:center;color:#8A8A8A}#sbo-rt-content .bookimage{font-size:1.2em;margin-top:0;margin-bottom:1em;text-align:left}#sbo-rt-content .fmpara{font-size:.9em;text-indent:0;margin-top:.5em;margin-bottom:.3em;text-align:justify}#sbo-rt-content .fmpara1{font-size:.9em;text-indent:0;margin-top:.4em;margin-bottom:.3em;text-align:right}#sbo-rt-content .inpara{text-indent:0;margin-top:.4em;margin-left:3em;margin-bottom:.3em}#sbo-rt-content .pub{margin-top:10em;margin-bottom:1em;text-align:right;margin-right:5em}#sbo-rt-content .copyright{font-size:.9em;margin-top:.4em;margin-bottom:.4em;margin-left:1.2em;margin-right:1.2em;text-align:left}#sbo-rt-content .copyright1{font-size:.9em;margin-top:.1em;margin-bottom:.1em;margin-left:4em;margin-right:3.3em;text-align:left;text-indent:-1.6em}#sbo-rt-content .copyright2{font-size:.9em;margin-top:.1em;margin-bottom:.1em;margin-left:4.2em}#sbo-rt-content .dedication{font-size:1.2em;margin-bottom:0;margin-top:3.5em;text-align:center;margin-right:1em;font-style:italic}#sbo-rt-content .dedication1{font-size:1.2em;margin-bottom:0;margin-top:.5em;text-align:center;margin-right:1em;font-style:normal}#sbo-rt-content .dedication2{font-size:1.2em;margin-bottom:0;margin-top:1.5em;text-align:center;margin-right:1em;font-style:italic}#sbo-rt-content .content-title{font-size:1.6em;margin-top:3em;margin-bottom:.1em;text-align:left;font-weight:bold}#sbo-rt-content .fmtitle{font-size:2.5em;margin-top:1em;margin-bottom:1em;text-align:left;font-weight:bold;border-bottom:1.1px solid black;padding-bottom:.8em}#sbo-rt-content .right{text-indent:0;margin-top:1em;margin-right:1.5em;margin-bottom:.3em;text-align:right}#sbo-rt-content .right1{text-indent:0;margin-top:0;margin-right:1.5em;margin-bottom:.2em;text-align:right}#sbo-rt-content .chapimage{margin-left:.2em;margin-top:1.5em;margin-bottom:1.5em;text-align:left}#sbo-rt-content p.ChapterNumber{font-weight:bold;font-size:1.7em;margin-top:10px;margin-left:0;margin-bottom:5px;text-align:left}#sbo-rt-content p.ChapterTitle{font-weight:bold;font-size:2.5em;margin-top:0;margin-bottom:1em;margin-left:0;text-align:left;border-bottom:1.1px solid black;padding-bottom:.8em}#sbo-rt-content p.PartNumber{font-weight:bold;font-size:1.7em;margin-top:10px;margin-left:0;margin-bottom:5px;text-align:left;padding-bottom:.8em}#sbo-rt-content p.partTitle{font-weight:bold;font-size:2.5em;margin-top:1em;margin-bottom:1em;margin-left:0;text-align:left}#sbo-rt-content .paraaftertitle{font-size:100%;text-indent:0;margin-top:0;margin-left:0;margin-bottom:0}#sbo-rt-content p.noindent{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:0;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.noindent1{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:1em}#sbo-rt-content p.noindent2{font-size:100%;text-indent:0;margin-top:1.5em;margin-bottom:1em}#sbo-rt-content p.noindent3{font-size:100%;text-indent:0;margin-top:.8em;margin-bottom:.2em;margin-left:0;margin-right:0;text-align:center}#sbo-rt-content p.noindent4{font-size:100%;text-indent:0;margin-top:.8em;margin-bottom:.2em;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content span.listing{font-weight:bold}#sbo-rt-content p.indent{font-size:100%;text-indent:1.2em;margin-top:.1em;margin-bottom:.1em;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.indent1{font-size:100%;text-indent:1.2em;margin-top:0;margin-bottom:0;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.indent1a{font-size:100%;text-indent:1.5em;margin-top:0;margin-bottom:0;margin-left:0;margin-right:4.5em;text-align:right}#sbo-rt-content p.indent2{font-size:100%;margin-top:.8em;margin-bottom:.8em;margin-left:2.4em;margin-right:2.4em;text-align:justify;font-style:italic}#sbo-rt-content p.indent3{font-size:100%;text-indent:1em;margin-top:.8em;margin-bottom:.8em;margin-left:1.8em;margin-right:1.8em;text-align:left}#sbo-rt-content p.indent4{font-size:100%;text-indent:1.3em;margin-top:.5em;margin-bottom:.5em;margin-left:2em;margin-right:0;text-align:left}#sbo-rt-content .blockquote{font-size:100%;text-indent:.2em;margin-top:1em;margin-left:3em;margin-right:2em;margin-bottom:1em;font-style:italic}#sbo-rt-content .blockquote1{font-size:100%;text-indent:.2em;margin-top:1em;margin-left:3em;margin-bottom:0;font-style:italic}#sbo-rt-content p.Heading1{font-weight:bold;font-size:2em;text-indent:0;margin-top:1.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2{font-size:1.6em;text-indent:0;margin-top:1.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2_2{font-size:1.6em;text-indent:0;margin-top:.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2a{font-size:1.5em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;font-weight:bold}#sbo-rt-content p.Heading3{font-weight:bold;font-size:1.45em;text-indent:0;margin-top:1.2em;margin-bottom:.1em}#sbo-rt-content p.Heading3a{font-weight:normal;font-size:1.25em;text-indent:0;margin-top:1.2em;margin-bottom:.1em}#sbo-rt-content p.Heading4{font-size:1.3em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;text-align:left}#sbo-rt-content .img{max-width:100%;margin-top:10pt}#sbo-rt-content .img1{text-align:left}#sbo-rt-content .img1a{text-align:right;margin-right:5em;margin-top:5em}#sbo-rt-content .img2{text-align:left}#sbo-rt-content div.Figure{font-size:small;margin-top:1.5em;margin-bottom:1.5em}#sbo-rt-content .para-1{font-size:100%;margin-top:1em;text-indent:1.5em;margin-bottom:0;text-align:left}#sbo-rt-content .para-2{font-size:.9em;text-indent:-1.4em;margin-left:2.4em;margin-top:.5em;margin-bottom:0}#sbo-rt-content .figurecaption{font-size:small;margin-top:0;margin-bottom:0;text-align:justify}#sbo-rt-content .image{text-align:center}#sbo-rt-content .codecaption{font-size:100%;margin-top:.6em;margin-bottom:.6em;text-align:justify;font-style:italic}#sbo-rt-content .PCode{font-size:small;margin-top:1em;margin-bottom:1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-1{font-size:small;margin-top:1em;margin-bottom:.1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-2{font-size:small;margin-top:0;margin-bottom:0;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-3{font-size:small;margin-top:0;margin-bottom:1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content div.singlethin{border-bottom:solid 3px;margin-left:1em;margin-right:1em;margin-bottom:1em}#sbo-rt-content div.singlethin1{margin-left:2em;margin-right:2em}#sbo-rt-content .inlinecode{font-family:monospace}#sbo-rt-content div.notepara{font-size:110%;text-indent:0;margin-top:1em;border-top:solid 1px;border-bottom:solid 1px;margin-bottom:1em;text-align:justify}#sbo-rt-content span.pink-box{font-weight:bold;padding-left:1.3em;padding-right:1.3em;border:1.1px solid black;font-size:1.5em;margin-top:.5em;margin-bottom:.5em;text-indent:0;text-align:justify}#sbo-rt-content span.courier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%}#sbo-rt-content div.courier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%;margin-top:1em;margin-bottom:1em}#sbo-rt-content div.boxcourier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%;margin-top:1em;margin-bottom:1em;margin-left:1.5em;margin-right:1.5em;text-align:left}#sbo-rt-content span.courier1{font-family:Courier New;font-weight:normal;font-style:normal;font-size:95%}#sbo-rt-content .boxhead{font-size:1.25em;font-weight:bold;padding-left:.1em;padding-bottom:.1em;padding-top:.1em;margin-top:0;text-indent:0;text-align:center;border:3px solid black}#sbo-rt-content div.box{margin-top:1em;margin-bottom:1em}#sbo-rt-content .boxpara{font-size:110%;text-indent:0;margin-left:1.5em;margin-right:1.5em;margin-top:.5em;margin-bottom:.5em;text-align:left}#sbo-rt-content .alpha{font-size:1.2em;font-weight:bold;margin-left:.2em;margin-top:1em;margin-bottom:.3em;text-align:left}#sbo-rt-content .index{font-size:small;margin-left:.2em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .index1{font-size:small;margin-left:1em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .index2{font-size:small;margin-left:2em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .cover{text-align:center}#sbo-rt-content .top{border-top:1.1px solid black;border-bottom:2px solid black}#sbo-rt-content .bot{border-bottom:2px solid black}#sbo-rt-content table.bodytable,#sbo-rt-content table{border-collapse:collapse;margin-bottom:8px;font-size:small;margin-top:10pt;width:95%;border-top:0 solid black;border-bottom:0 solid black}#sbo-rt-content table.fmtable{margin-bottom:1em;font-size:1em;margin-left:4em;border-top:0 solid #FFF;border-bottom:0 solid #FFF}#sbo-rt-content table{margin-bottom:1em;border-top:1.1px solid black;border-bottom:1.1px solid black;border-collapse:collapse}#sbo-rt-content th{border-top:1px solid black;border-bottom:1px solid black;padding-right:1.5em}#sbo-rt-content td{font-size:small;vertical-align:top;padding-right:1.5em;margin-top:0;margin-bottom:1em}#sbo-rt-content .tablepara{font-size:small;text-indent:0;margin-top:0;margin-bottom:.5em;padding-right:1.5em}#sbo-rt-content .tablepara1{font-size:small;margin-left:2em;margin-top:0;margin-bottom:0;padding-right:1.5em}#sbo-rt-content .header{border-bottom:1.1px solid black;text-indent:0;text-align:left}#sbo-rt-content .TabCapt{font-style:italic;margin-left:0;text-indent:0}#sbo-rt-content .FigCapt{font-style:italic;font-size:.9em}#sbo-rt-content .CaptNr{font-weight:bold}#sbo-rt-content .ttitle{font-style:Italic;margin-bottom:1em}#sbo-rt-content p.paraaftertitle1{font-size:.9em;text-indent:0;margin-top:.5em;margin-bottom:.8em;text-align:left}#sbo-rt-content p.para{font-size:small;text-indent:20px;margin-top:0;margin-bottom:0;text-align:justify}#sbo-rt-content p.quote{font-style:italic;font-size:100%;margin-top:1.5em;margin-left:2.5em;margin-right:2.5em;margin-bottom:0}#sbo-rt-content p.quotesource{font-size:small;text-indent:0;margin-top:1em;margin-bottom:1em;text-align:right}#sbo-rt-content p.chaptersubtitle{font-size:x-large;text-indent:0;margin-top:0;margin-left:0;margin-bottom:0;text-align:left}#sbo-rt-content p.line{margin-top:.3em;border-bottom:1px solid black}#sbo-rt-content p.line1{margin-top:.3em;margin-bottom:1.5em;border-bottom:1px solid black}#sbo-rt-content p.line2{margin-top:5em;margin-bottom:5em;border-bottom:1px solid black;text-align:center;margin-left:15em;margin-right:15em}#sbo-rt-content li{margin-bottom:.5em;margin-top:.5em}#sbo-rt-content p.alpha{font-size:1.2em;font-weight:bold;margin-left:.2em;margin-top:1em;margin-bottom:.3em;text-align:left}#sbo-rt-content ul.bulleted{font-size:100%;text-align:justify;margin-left:2.5em;margin-right:3em;margin-top:1em;margin-bottom:1em;text-indent:0}#sbo-rt-content ol.OrderedList{font-size:100%;text-align:left;margin-left:2.5em;margin-right:3em;margin-top:1em;margin-bottom:1em}#sbo-rt-content ul.bulleted1{font-size:100%;text-align:left;margin-left:1em;margin-right:5em;margin-top:1em;margin-bottom:1em;list-style-type:none}#sbo-rt-content ul.bulleted1_a{font-size:100%;text-align:justify;margin-left:0;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0;list-style-type:none}#sbo-rt-content ul.bulleted2{font-size:100%;text-align:justify;margin-left:2.3em;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0}#sbo-rt-content ul.bulleted4{font-size:100%;text-align:center;margin-left:1.3em;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0;list-style-type:none}#sbo-rt-content .numbered{font-size:small;text-align:justify;margin-left:2em;margin-right:2em;margin-top:.5em;margin-bottom:.5em;text-indent:1em}#sbo-rt-content .bulletedin{font-size:100%;text-align:justify;margin-left:4em;margin-right:4em;margin-top:.5em;margin-bottom:.5em}#sbo-rt-content ul.None{font-size:.9em;text-align:justify;margin-left:3em;margin-right:2em;margin-top:.5em;margin-bottom:.5em;list-style-type:none}#sbo-rt-content .Listing{font-size:small;margin-bottom:0}#sbo-rt-content .PCode1{font-size:small;margin-top:.7em;margin-bottom:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode2{font-size:small;margin-top:1em;margin-bottom:.1em;margin-left:2.2em;text-align:left;font-family:monospace}#sbo-rt-content .PCode3{font-size:small;margin-top:0;margin-left:2.2em;margin-bottom:.1em;text-align:left;font-family:monospace}#sbo-rt-content .NoteCaption{font-size:small;margin-top:1.3em;margin-left:5em;margin-right:5em;border:1.1px solid black;padding:.5em;margin-bottom:1.3em}#sbo-rt-content .Table{font-size:100%;margin-bottom:1em;margin-left:0}#sbo-rt-content .toc{font-size:1.1em;margin-top:.2em;margin-bottom:.2em;text-align:left;font-weight:bold}#sbo-rt-content .toca{font-size:1.1em;margin-top:.8em;margin-bottom:.4em;text-align:left;font-weight:bold}#sbo-rt-content .toc1{font-size:1.1em;margin-top:.4em;margin-bottom:.3em;text-align:left;text-indent:1.4em;font-weight:normal}#sbo-rt-content .toc2{font-size:1.2em;margin-top:.4em;margin-bottom:.3em;text-align:left;font-weight:bold}#sbo-rt-content .toc3{font-size:.9em;margin-top:.4em;margin-bottom:.3em;text-align:left;text-indent:3.5em;font-weight:normal}#sbo-rt-content .toc4{font-size:1.1em;margin-top:.2em;margin-bottom:.5em;text-align:left;font-weight:bold}#sbo-rt-content .tocch{font-size:1.3em;margin-top:.7em;margin-bottom:.7em;text-align:left;font-weight:bold}#sbo-rt-content .noborder{margin-bottom:1em;border-top:0 solid #FFF;border-bottom:0 solid #FFF}#sbo-rt-content .authurright{text-align:right;margin-top:0;margin-bottom:0}#sbo-rt-content .FormalPara{font-size:small;margin-bottom:.7em}#sbo-rt-content .FontName1{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content span.FontName2{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content span.FontName3{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content .rightarrow{margin-top:0}#sbo-rt-content div.thinline{margin-top:1em;margin-bottom:1em;border-top:solid 4px #AFAFB0;border-bottom:solid 4px #AFAFB0}#sbo-rt-content span.line{text-decoration:underline}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content div.box{border-top:solid 2px;border-bottom:solid 2px}#sbo-rt-content .app{font-size:150%;margin-left:.8em}#sbo-rt-content .page{text-decoration:none;color:#000}#sbo-rt-content .cXXX{text-decoration:none;color:#000}#sbo-rt-content .textindent{margin-left:1.7em;margin-top:1em;margin-bottom:1em;font-size:100%}#sbo-rt-content .textindent1{margin-left:1.7em;margin-top:0;margin-bottom:0;font-size:100%}#sbo-rt-content .textindent2{margin-left:1.7em;margin-top:0;margin-bottom:0;font-size:100%;text-indent:1em}#sbo-rt-content p.FootNote{margin-top:.8em;margin-bottom:0;font-size:85%;text-indent:0;text-align:left;margin-left:1.1em;margin-right:1.1em}#sbo-rt-content pre{margin-left:0;font-family:monospace;white-space:pre-wrap}#sbo-rt-content p.Heading4a{font-size:1.15em;font-weight:bold;text-indent:1em;margin-top:1.3em;margin-bottom:.3em;border-top:3px solid #4d4d4c;border-left:solid 3px #4d4d4c;border-right:solid 3px #4d4d4c;border-bottom:solid 3px #4d4d4c;text-align:center}#sbo-rt-content p.noindent8{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:1em;text-align:center;font-weight:bold;color:#8A8A8A}#sbo-rt-content .tocb{font-size:1.4em;margin-top:.5em;margin-bottom:.2em;text-align:left;font-weight:bold}#sbo-rt-content .part{font-weight:normal;font-size:1em;margin-bottom:5px;text-align:left;padding-left:1.3em;padding-bottom:10em;padding-right:1.3em;border:1.1px solid black}#sbo-rt-content p.Heading5{font-size:1em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;text-align:center}#sbo-rt-content p.noindent5s{font-size:100%;text-indent:0;margin-top:.1em;margin-bottom:.1em;margin-left:0;margin-right:0;text-align:right}#sbo-rt-content span.strike{text-decoration:line-through}
    </style><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9781430260585/chapter/9781430260585_Ch02.xhtml",
          "book_id": "9781430260585",
          "chapter_uri": "9781430260585_Ch02.xhtml",
          "position": 0,
          "user_uuid": "29525685-85c9-45c7-9eda-3c178d86398e",
          "next_chapter_uri": "/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch03.xhtml"
        
      },
      title: "Node.js Recipes: A Problem\u002DSolution Approach",
      author_list: "Cory Gackenheimer",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: false,
      show_ios_app_teaser: false
    };
    // ]]></script><script src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/modernizr.js"></script><script>
    
      
        

        

        
          
            window.PUBLIC_ANNOTATIONS = true;
          
        

      

      
        window.MOBILE_PUBLIC_ANNOTATIONS = false;
      

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

    
      window.PRIVACY_CONTROL_SWITCH = true;
    

    
      window.PUBLISHER_PAGES = true;
    

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "https://www.safaribooksonline.com/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://www.safaribooksonline.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml"><meta name="description" content="CHAPTER 2 Networking with Node.js Node.js is designed to function well in a networked environment. Its nonblocking, event-driven architecture allows for the use of highly scalable, networked applications ... "><meta property="og:title" content="CHAPTER 2: Networking with Node.js"><meta itemprop="isPartOf" content="/library/view/nodejs-recipes-a/9781430260585/"><meta itemprop="name" content="CHAPTER 2: Networking with Node.js"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781430260585/"><meta property="og:description" itemprop="description" content="CHAPTER 2 Networking with Node.js Node.js is designed to function well in a networked environment. Its nonblocking, event-driven architecture allows for the use of highly scalable, networked applications ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Apress"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781430260585"><meta property="og:book:author" itemprop="author" content="Cory Gackenheimer"><meta property="og:book:tag" itemprop="about" content="JavaScript"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript>&lt;meta http-equiv="refresh" content="0; url=/library/no-js/" /&gt;</noscript><script type="text/javascript">
  (function(i,s,o,g,r,a,m) {
    i['GoogleAnalyticsObject']=r;
    i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();
    a=s.createElement(o),m=s.getElementsByTagName(o)[0];
    a.async=1;
    a.src=g;
    m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  var matches = document.cookie.match(/BrowserCookie\s*=\s*([a-f0-9\-]{36})/),
      user_uuid = null;

  if (matches && matches.length === 2) {
    user_uuid = matches[1];
  }


  ga('create', 'UA-39299553-7', {'userId': '29525685-85c9-45c7-9eda-3c178d86398e' });


ga('set', 'dimension1', 'Trial');
ga('set', 'dimension6', user_uuid);


  ga('set', 'dimension2', '29525685-85c9-45c7-9eda-3c178d86398e');
  






  //enable enhanced link tracking
  ga('require', 'linkid', 'linkid.js');

  // reading interface will track pageviews itself
  if (document.location.pathname.indexOf("/library/view") !== 0) {
    ga('send', 'pageview');
  }
</script><script defer="" src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/vendor.34024413b1d4.js"></script><script defer="" src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/reader.a05323b190d3.js"></script><script async="" src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/MathJax.js"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts subscribe-panel library">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        





<a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>
              
                Queue
              
            </span></a></li><li class="search"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" width="20" height="20" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>offers icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M35.9 20.6L27 15.5C26.1 15 24.7 15 23.7 15.5L14.9 20.6C13.9 21.1 13.2 22.4 13.2 23.4L13.2 41.4C13.2 42.4 13.9 43.7 14.9 44.2L23.3 49C24.2 49.5 25.6 49.5 26.6 49L35.9 43.6C36.8 43.1 37.6 41.8 37.6 40.8L37.6 23.4C37.6 22.4 36.8 21.1 35.9 20.6L35.9 20.6ZM40 8.2C39.1 7.6 37.6 7.6 36.7 8.2L30.2 11.9C29.3 12.4 29.3 13.2 30.2 13.8L39.1 18.8C40 19.4 40.7 20.6 40.7 21.7L40.7 39C40.7 40.1 41.4 40.5 42.4 40L48.2 36.6C49.1 36.1 49.8 34.9 49.8 33.8L49.8 15.6C49.8 14.6 49.1 13.3 48.2 12.8L40 8.2 40 8.2ZM27 10.1L33.6 6.4C34.5 5.9 34.5 5 33.6 4.5L26.6 0.5C25.6 0 24.2 0 23.3 0.5L16.7 4.2C15.8 4.7 15.8 5.6 16.7 6.1L23.7 10.1C24.7 10.6 26.1 10.6 27 10.1ZM10.1 21.7C10.1 20.6 10.8 19.4 11.7 18.8L20.6 13.8C21.5 13.2 21.5 12.4 20.6 11.9L13.6 7.9C12.7 7.4 11.2 7.4 10.3 7.9L1.6 12.8C0.7 13.3 0 14.6 0 15.6L0 33.8C0 34.9 0.7 36.1 1.6 36.6L8.4 40.5C9.3 41 10.1 40.6 10.1 39.6L10.1 21.7 10.1 21.7Z"></path></g></svg><span>Offers &amp; Deals</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletters</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/001o00000169U9HAAU/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" width="20" height="20" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://www.safaribooksonline.com/public/support" class="l1 no-icon">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a><span class="l2 t-nag-notification" id="nav-nag"><strong class="trial-green">10</strong> days left in your trial.
  
  

  
    
      

<a class="" href="https://www.safaribooksonline.com/subscribe/">Subscribe</a>.


    
  

  

</span></li><li><a href="https://www.safaribooksonline.com/public/support" class="l2">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Node.js Recipes: A Problem-Solution Approach
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781430260585/chapter/9781430260585_Ch02.xhtml" data-for-analytics="9781430260585:9781430260585_Ch02.xhtml" aria-label="Add to Queue"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml&amp;text=Node.js%20Recipes%3A%20A%20Problem-Solution%20Approach&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20CHAPTER%202%3A%20Networking%20with%20Node.js&amp;body=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml%0D%0Afrom%20Node.js%20Recipes%3A%20A%20Problem-Solution%20Approach%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
        
        



 <!--[if lt IE 9]>
  
<![endif]-->



  <script defer="" src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/djangoMessagesPage.845b17d78025.js"></script>


        
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch01.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">CHAPTER 1: Understanding Node.js</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch03.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">CHAPTER 3: Using the File System</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content" style="transform: none;"><div class="annotator-wrapper"><p class="ChapterNumber"><a id="Chap_2"></a>CHAPTER 2</p>
<p class="chapimage"><img src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/frontdot.jpg" alt="image" width="82" height="25" data-mfp-src="/library/view/nodejs-recipes-a/9781430260585/images/frontdot.jpg"></p>
<p class="ChapterTitle">Networking with Node.js</p>
<div>
<p class="noindent">Node.js is designed to function well in a networked environment. Its nonblocking, event-driven architecture allows for the use of highly scalable, networked applications. In this chapter you will discover many of the implementation details surrounding Node.js and its networking<a id="cXXX.27r"></a> capabilities. In particular the recipes you will see will cover these topics:<a id="cXXX.84"></a></p>
<ul class="bulleted">
<li>Setting up a server</li>
<li>Creating connections to your server</li>
<li>Configuring server defaults</li>
<li>Creating a client</li>
<li>Using sockets to communicate between servers</li>
<li>Retrieving details about connected servers</li>
<li>Controlling socket details</li>
</ul>
<p class="indent">Once you have read this chapter, you should have the capability not only to build a simple networked application but also perhaps to have a robust solution to incorporate into your workflow.</p>
<p id="Sec1" class="Heading1">2-1. Setting Up a Server<a id="cXXX.27m"></a></p>
<div>
<p id="Sec2" class="Heading2_2">Problem</p>
<p class="noindent">You need to set up a server to provide a networked Node.js application.</p>
</div>
<div>
<p id="Sec3" class="Heading2">Solution</p>
<p class="noindent">In Node.js, the standard solution for building a networked application that serves data between endpoints is to utilize a built-in Node.js module called <span class="FontName1">net</span>. This module provides all you need to set up a Node.js TCP server. To set up a network server, you must first require the module (see <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list1" id="_list1">Listing 2-1</a>).</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list1" id="list1">Listing 2-1</a></i></b>.&nbsp;&nbsp;Requiring the <span class="FontName1">net</span> Module<a id="cXXX.85"></a></p>
<pre><span class="FontName1">var net = require('net');</span></pre>
<p class="indent">After requiring this module, creating the server happens with the <span class="FontName1">createServer()</span> method<a id="cXXX.86"></a>. This method takes an optional parameter, which will set default options on the server, and a <span class="FontName1">connectionListener</span> argument<a id="cXXX.87"></a>, which will listen for connections to your server. To truly enable your newly created server, you will need to tell your server on which port to listen. This is accomplished by a call to the <span class="FontName1">listen()</span> method<a id="cXXX.88"></a> that is provided by the <span class="FontName1">net</span> module. A fully operational server is shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list2" id="_list2">Listing 2-2</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list2" id="list2">Listing 2-2</a></i></b>.&nbsp;&nbsp;A Simple TCP Server<a id="cXXX.89"></a></p>
<pre><span class="FontName1">var net = require('net');</span><br>&nbsp;<br><span class="FontName1">var server = net.createServer(function(connectionListener) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connected');</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//Get the configured address for the server</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(this.address());</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//get connections takes callback function</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.getConnections(function(err, count) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('Error getting connections');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('Connections count: ' + count);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connectionListener.on('end', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('disconnected');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//Write to the connected socket</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connectionListener.write('heyyo\r\n');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.on('error', function(err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('Server error: ' + err);</span><br><span class="FontName1">});</span><br><span class="FontName1">server.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(data.toString());</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">/**</span><br><span class="FontName1">* listen()</span><br><span class="FontName1">*/</span><br><span class="FontName1">server.listen(8181, function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('server is listening');</span><br><span class="FontName1">});</span></pre>
<p class="indent">Now you have created a simple server. Assuming you have named your server file server.js, you can easily run it with node <span class="FontName1">server.js</span>.</p>
</div>
<div>
<p id="Sec4" class="Heading2">How It Works</p>
<p class="noindent">Let us examine this server in more detail. First, you recall how Node.js modules are loaded as described in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch01.xhtml">Chapter 1</a>. This is how the native Node.js module <span class="FontName1">net</span> is loaded, <span class="FontName1">require('net')</span><a id="cXXX.90"></a>
<span class="FontName1">;.</span> The server is created via the module’s exported <span class="FontName1">createServer()</span> method, which instantiates an internal server object within the <span class="FontName1">net</span> module as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list3" id="_list3">Listing 2-3</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list3" id="list3">Listing 2-3</a></i></b>.&nbsp;&nbsp;net Module createServer Method</p>
<pre><span class="FontName1">exports.createServer = function() {</span><br>&nbsp;&nbsp;<span class="FontName1">return new Server(arguments[0], arguments[1]);</span><br><span class="FontName1">};</span></pre>
<p class="indent">This method takes two arguments, so it must be that within the server function, there is some sort of determination as to which argument represents the options object that is optionally passed into the <span class="FontName1">createServer()</span> method, which is the connection listener. If you investigate a little further into this function, you see that what Node.js uses to determine these arguments is a simple check of their properties. If it is determined that the type of the first argument is a function, then it cannot be that the first argument is the options object, making the first argument the connection listener. Alternatively, if the first argument is not a function, it is assumed to be the options object, and the second argument<span class="FontName1">—</span>if it is a function<span class="FontName1">—</span>is used as the connection listener.</p>
<p class="indent">The connection listener<a id="cXXX.91"></a>, like many functions in Node.js programming, is a simple callback. Once the server object in the <span class="FontName1">net</span> module has identified it as a function, it is passed as the callback to a server connection<a id="cXXX.29v"></a> listener, which takes the form similar to <span class="FontName1">server.on<a id="cXXX.29t"></a>('connection', connectionListener);</span>. This will now pass any new connection back to your listener in your application. This logic is shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list4" id="_list4">Listing 2-4</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list4" id="list4">Listing 2-4</a></i></b>.&nbsp;&nbsp;Determining the Server Options<a id="cXXX.92"></a> and Connection Listener<a id="cXXX.93"></a></p>
<pre><span class="FontName1">var self = this;</span><br>&nbsp;<br><span class="FontName1">var options;</span><br>&nbsp;<br><span class="FontName1">if (typeof arguments[0] == 'function') {</span><br>&nbsp;&nbsp;<span class="FontName1">options = {};</span><br>&nbsp;&nbsp;<span class="FontName1">self.on('connection', arguments[0]);</span><br><span class="FontName1">} else {</span><br>&nbsp;&nbsp;<span class="FontName1">options = arguments[0] || {};</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (typeof arguments[1] == 'function') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self.on('connection', arguments[1]);</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">}</span></pre>
<p class="indent">A new connection happens after the server you have created begins to listen on a port. The port is determined by the first argument that you pass to the <span class="FontName1">listen()</span> function<a id="cXXX.94"></a><a id="cXXX.95"></a> of your server. The <span class="FontName1">listen()</span> function can also take a path, if your server is to listen on a UNIX path, or any connectable handle object. In the example server in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list2">Listing 2-2</a>, the port was set as 8181. The second parameter was a callback, which is executed once the server successfully begins to listen to the port, or path, where it is defined. The <span class="FontName1">listen()</span> event also assumes a host. The host can be any IPv4 address, but if it is omitted, Node.js will assume you are targeting the <span class="FontName1">localhost</span>. You now have a simple server that will listen on a port of your choosing.</p>
<p class="indent">As you can see in the server you created in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list2">Listing 2-2</a>, you can also gain some insight into the current configuration of your server. First, you can retrieve the information about the address on which the server is listening. This information is fetched by calling the <span class="FontName1">server.address()</span> method<a id="cXXX.96"></a>. This will return an object that shows the address, family, and port of the server (see <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list5" id="_list5">Listing 2-5</a>).</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list5" id="list5">Listing 2-5</a></i></b>.&nbsp;&nbsp;server.address( )<a id="cXXX.97"></a></p>
<pre><span class="FontName1">{</span><br>&nbsp;&nbsp;<span class="FontName1">address: '127.0.0.1',</span><br>&nbsp;&nbsp;<span class="FontName1">family: 'IPv4',</span><br>&nbsp;&nbsp;<span class="FontName1">port: 8181</span><br><span class="FontName1">}</span></pre>
<p class="indent">In addition to retrieving the server address, you can also get the count of the number of connections to your server. This is done by calling the <span class="FontName1">getConnections()</span><a id="cXXX.98"></a><a id="cXXX.99"></a> method within your code. The <span class="FontName1">getConnections()</span> function takes a callback function that should accept two arguments: an error argument and a count argument. This will allow you both to check for an error when getting connections and to get the current count of connections to the server. This is shown in the <span class="FontName1">connectionListener</span> callback within the server created in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list2">Listing 2-2</a>.</p>
<p class="indent">The server object in the <span class="FontName1">net</span> module of Node.js is an <span class="FontName1">event emitter</span>, which is a common paradigm in Node.js programming. An <span class="FontName1">event emitter</span> provides a common language in which an object can register, remove, and listen for events that are either generated by the system or customized by the developer. The server object exposes several events, some of which you have already seen, such as the connection and listening events. The connection event happens each time a new socket connects to the server, whereas the listening event, as you have seen, is emitted once the server begins to listen. Two other events that are a base for the <span class="FontName1">net.Server</span> object are close and error. The error event is emitted when the server encounters an error. The error event also emits the close event immediately after the error is emitted. The close event simply shuts down the server; however, it will wait until each of the connected socket’s connections end.</p>
</div>
<p id="Sec5" class="Heading1">2-2. Creating Connections to Your Server</p>
<div>
<p id="Sec6" class="Heading2_2">Problem</p>
<p class="noindent">You need to create a connection to a networked server.</p>
</div>
<div>
<p id="Sec7" class="Heading2">Solution</p>
<p class="noindent">In order to build a connection to your server, you need to know the port or UNIX path on which is it listening. Once you know this, you can create a connection via Node.js. For this you will once again use the Node.js native <span class="FontName1">net</span> module, which exposes a <span class="FontName1">createConnection</span> method<a id="cXXX.100"></a><a id="cXXX.101"></a> for connecting to a remote (or local) instance.</p>
<p class="indent">To utilize the <span class="FontName1">net</span> module to connect to a server via Node.js, you, once again, must set the connection to the <span class="FontName1">net</span> module via a CommonJS require as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list6" id="_list6">Listing 2-6</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list6" id="list6">Listing 2-6</a></i></b>.&nbsp;&nbsp;Importing the net Module<a id="cXXX.102"></a> for Connections</p>
<pre><span class="FontName1">var net = require('net');</span></pre>
<p class="indent">Then the next step is to call the <span class="FontName1">createConnection</span> method passing in the port or UNIX path on which to connect. Optionally, you can also pass the host if you need to specify an IP address. Now we can create a connectListener that logs the connection to the console, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list7" id="_list7">Listing 2-7</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list7" id="list7">Listing 2-7</a></i></b>.&nbsp;&nbsp;Creating a Connection to Your Server</p>
<pre><span class="FontName1">var net = require('net');</span><br><span class="FontName1">// createConnection</span><br><span class="FontName1">var connection = net.createConnection({port: 8181, host:'127.0.0.1'},</span><br><span class="FontName1">// connectListener callback</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connection successful');</span><br><span class="FontName1">});</span></pre>
</div>
<div>
<p id="Sec8" class="Heading2">How It Works</p>
<p class="noindent">In this section you created a connection to a TCP server<a id="cXXX.103"></a>. This was done with Node.js’s <span class="FontName1">net</span> module. This contained the <span class="FontName1">createConnection</span> function, which is the same as the <span class="FontName1">connect()</span> function. The connect method first checks the arguments that you passed to it. It will evaluate which options are set.</p>
<p class="indent">Checking the arguments sent is done by first checking if the first argument is an object, then subsequently parsing that object if it is indeed an object. If the first argument is not an object, it is evaluated to see if it is a valid pipe name, in which case it will be set as the UNIX path option. If it is not the name of a pipe, it will default to a port number.&nbsp;&nbsp;The final check of the parameters is for the optional callback argument, which is evaluated by checking to see if the last parameter passed to the <span class="FontName1">connect()</span> function<a id="cXXX.104"></a> is a function itself. This whole process is run in a function called <span class="FontName1">normalizeConnectArgs</span>, shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list8" id="_list8">Listing 2-8</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list8" id="list8">Listing 2-8</a></i></b>.&nbsp;&nbsp;Extracting createConnection Arguments<a id="cXXX.105"></a></p>
<pre><span class="FontName1">function normalizeConnectArgs(args) {</span><br>&nbsp;&nbsp;<span class="FontName1">var options = {};</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (typeof args[0] === 'object') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// connect(options, [cb])</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">options = args[0];</span><br>&nbsp;&nbsp;<span class="FontName1">} else if (isPipeName(args[0])) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// connect(path, [cb]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">options.path = args[0];</span><br>&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// connect(port, [host], [cb])</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">options.port = args[0];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (typeof args[1] === 'string') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">options.host = args[1];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">var cb = args[args.length - 1];</span><br>&nbsp;&nbsp;<span class="FontName1">return (typeof cb === 'function') ? [options, cb] : [options];</span><br><span class="FontName1">}</span></pre>
<p class="indent">Next, the <span class="FontName1">net</span> module creates a new socket object, passing in the newly normalized connect arguments. This socket has a method on its prototype called <span class="FontName1">connect</span>.</p>
<p class="indent">This connect method on the socket is called, passing to it the normalized arguments as well. The connect method will try to create a new socket handle and connect to the path or port and host combination that was specified in the arguments. If the host is not specified for a given port, then it is assumed that the host being targeted is the <span class="FontName1">localhost</span>, or <span class="FontName1">127.0.0.1</span>. Where this gets interesting is that, if a hostname or IP address is provided in the arguments, Node.js will require the <span class="FontName1">dns</span> module and perform a DNS lookup to locate the host. This again will default to the <span class="FontName1">localhost</span> if the lookup returns null without an error, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list9" id="_list9">Listing 2-9</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list9" id="list9">Listing 2-9</a></i></b>.&nbsp;&nbsp;Socket.prototype.connect’s Method<a id="cXXX.452a"></a><a id="cXXX.31p"></a><a id="cXXX.106"></a><a id="cXXX.107"></a> to Resolve Path, Port, and Host</p>
<pre><span class="FontName1">/* ... */</span><br><span class="FontName1">if (pipe) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connect(self, options.path);</span><br>&nbsp;<br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">} else if (!options.host) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">debug('connect: missing host');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connect(self, '127.0.0.1', options.port, 4);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var host = options.host;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">debug('connect: find host ' + host);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">require('dns').lookup(host, function(err, ip, addressType) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// It's possible we were destroyed while looking this up.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// XXX it would be great if we could cancel the promise returned by</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// the lookup.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (!self._connecting) return;</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// net.createConnection() creates a net.Socket object and</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// immediately calls net.Socket.connect() on it (that's us).</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// There are no event listeners registered yet so defer the</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// error event to the next tick.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">process.nextTick(function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self.emit('error', err);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self._destroy();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">timers.active(self);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">addressType = addressType || 4;</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// node_net.cc handles null host names graciously but user land</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// expects remoteAddress to have a meaningful value</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ip = ip || (addressType === 4 ? '127.0.0.1' : '0:0:0:0:0:0:0:1');</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connect(self, ip, options.port, addressType, options.localAddress);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">/* ... */</span></pre>
<p class="indent">As can be seen in the listing, the result of discovering the path, port, or port and host is to call the function <span class="FontName1">connect()</span>. This function simply connects the socket handle to the path or port and host. Once the connection request has connected, the <span class="FontName1">connectListener</span> callback is called as the code for the <span class="FontName1">connect</span> function shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list10" id="_list10">Listing 2-10</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list10" id="list10">Listing 2-10</a></i></b>.&nbsp;&nbsp;function connect( )<a id="cXXX.108"></a><a id="cXXX.109"></a> Implementation in the net Module</p>
<pre><span class="FontName1">function connect(self, address, port, addressType, localAddress) {</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">assert.ok(self._connecting);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (localAddress) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var r;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (addressType == 6) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">r = self._handle.bind6(localAddress);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">r = self._handle.bind(localAddress);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (r) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self._destroy(errnoException(process._errno, 'bind'));</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">var connectReq;</span><br>&nbsp;&nbsp;<span class="FontName1">if (addressType == 6) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connectReq = self._handle.connect6(address, port);</span><br>&nbsp;&nbsp;<span class="FontName1">} else if (addressType == 4) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connectReq = self._handle.connect(address, port);</span><br>&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connectReq = self._handle.connect(address, afterConnect);</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (connectReq !== null) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connectReq.oncomplete = afterConnect;</span><br>&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self._destroy(errnoException(process._errno, 'connect'));</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">}</span></pre>
<p class="indent">This was the function in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list8">Listing 2-8</a> where you logged “connection successful” to the console. As you will see in Section 2-4 there is much more to listening and connecting a client than simply logging a string to the console, but first you will examine the various ways in which to configure your server and the default settings that accompany the configuration options.</p>
</div>
<p id="Sec9" class="Heading1">2-3. Configuring Server Defaults<a id="cXXX.33n"></a></p>
<div>
<p id="Sec10" class="Heading2_2">Problem</p>
<p class="noindent">You are creating a server in Node.js and you need to control the accessible defaults for the server.</p>
</div>
<div>
<p id="Sec11" class="Heading2">Solution</p>
<p class="noindent">When you create any type of networked server, you often find that the default configuration might need to be tweaked to meet your specific needs. Aside from setting the host and port for a TCP server, you might like to be able to set the maximum number of connections, or control what the system backlog queue length for pending connections is configured as in your server. Many of these settings have default values on your server.</p>
<p class="indent">Naturally, one of the simplest parts of your server that you can control is the port and host where the server will be listening. These are set when calling the <span class="FontName1">listen()</span> method on your server. The listen method (as seen in Section 2-1) also takes the listener callback, but a third parameter that is optionally placed before this callback is the backlog setting, which limits your server’s connection queue length. Putting these defaults into place, you can see what the <span class="FontName1">listen()</span> function will look like in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list11" id="_list11">Listing 2-11</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list11" id="list11">Listing 2-11</a></i></b>.&nbsp;&nbsp;Setting the listen( ) Defaults<a id="cXXX.110"></a><a id="cXXX.111"></a></p>
<pre><span class="FontName1">server.listen(8181, '127.0.0.1', 12, function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// listen on 127.0.0.1:8181</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// backlog queue capped at 12</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('server is listening');</span><br><span class="FontName1">});</span></pre>
<p class="indent">Another default to consider is the option set when calling the <span class="FontName1">createServer()</span> method, which allows for a half-open connection and which defaults to false but is set in the method as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list12" id="_list12">Listing 2-12</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list12" id="list12">Listing 2-12</a></i></b>.&nbsp;&nbsp;allowHalfOpen: true<a id="cXXX.34y"></a><a id="cXXX.34a"></a><a id="cXXX.112"></a><a id="cXXX.113"></a></p>
<pre><span class="FontName1">var server = net.createServer({ allowHalfOpen: true }, function(connectionListener) {</span><br><span class="FontName1">/* connection Listener stuffs */</span><br><span class="FontName1">});</span></pre>
<p class="indent">Setting a maximum number of connections to your server can also be quite useful in your Node.js application. If you wish to limit this, you must explicitly set the number, as it defaults to undefined. This is best set in the <span class="FontName1">connectionListene</span><a id="cXXX.114"></a>
<span class="FontName1">r</span> callback, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list13" id="_list13">Listing 2-13</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list13" id="list13">Listing 2-13</a></i></b>.&nbsp;&nbsp;Setting a Maximum Number of Connections to Your Server</p>
<pre><span class="FontName1">var server = net.createServer({ allowHalfOpen: true }, function(connectionListener) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connected');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//get maxConnections - default undefined</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(this.maxConnections);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// set maxConnections to 4</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.maxConnections = 4;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// check set maxConnections is 4</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(this.maxConnections);</span><br><span class="FontName1">});</span></pre>
</div>
<div>
<p id="Sec12" class="Heading2">How It Works</p>
<p class="noindent">Setting and overriding server defaults happens by checking them against the default settings; then they are overwritten. What happens when you pass a backlog argument to the <span class="FontName1">listen()</span> method<a id="cXXX.115"></a> in Node.js? First, the default value that is passed into the backlog argument is 511. The value 511 is passed because of how the backlog size is determined by the operating system kernel.</p>
<div class="blockquote">
<p class="indent"><i>// Use a backlog of 512 entries. We pass 511 to the listen( ) call because</i></p>
<p class="indent"><i>// the kernel does: backlogsize = roundup_pow_of_two(backlogsize + 1);</i></p>
<p class="indent"><i>// which will thus give us a backlog of 512 entries.</i></p>
</div>
<p class="indent">This is interesting to know. Because you set the backlog queue to be capped at 12 in the <span class="FontName1">server.listen()</span><a id="cXXX.116"></a> example from <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list11">Listing 2-11</a>, you can now know that this will be calculated to be 16. This is because the value you set, 12, is incremented by one, then rounded up to the nearest power of 2, which is 16. It should be noted that in the example <span class="FontName1">server.listen</span> from <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list11">Listing 2-11</a>, you set the value of the host address as 127.0.0.1, which is IPv4. However, Node.js just as easily handles IPv6 connections, so you could change your default server listen to use IPv6, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list14" id="_list14">Listing 2-14</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list14" id="list14">Listing 2-14</a></i></b>.&nbsp;&nbsp;Configuring a Server Using IPv6</p>
<pre><span class="FontName1">server.listen(8181, '::1', 12, function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(server.address());</span><br><span class="FontName1">});</span></pre>
<p class="indent">Subsequently the <span class="FontName1">server.address()</span> function<a id="cXXX.117"></a> will log the new host and also the family will now be IPv6 instead of IPv4.</p>
<pre><span class="FontName1">{ address: '::1', family: 'IPv6', port: 8181 }</span></pre>
<p class="indent">Allowing a half-open connection was an option you set in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list12">Listing 2-12</a>, <span class="FontName1">{ allowHalfOpen: true }</span>.&nbsp;&nbsp;This sets the connection to allow for what you may find to be a more finely grained control of your server’s connection. This will allow a connection to send the TCP FIN packet, the packet that requests a termination of the connection but does not automatically send the response FIN packet to the connection.</p>
<p class="indent">This means that you will leave one half of the TCP connection open, allowing the socket to remain writable but not readable. To officially close the connection, you must explicitly send the FIN packet by calling the .end( ) method on the connection.</p>
<p class="indent">You also saw how you could set a limit to the maximum number of connections to your server via Node.js and the <span class="FontName1">net</span> module’s <span class="FontName1">maxConnections</span> setting. This, by default, is undefined, but in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list13">Listing 2-13</a> it was set to a low number of 4. This means your connections are limited to 4, but what happens when you connect, or attempt to connect, to a server that has a maximum number of connections set? You can see what the Node.js source does to this setting in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list15" id="_list15">Listing 2-15</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list15" id="list15">Listing 2-15</a></i></b>.&nbsp;&nbsp;Node.js Handles the maxConnections Setting<a id="cXXX.118"></a></p>
<pre><span class="FontName1">if (self.maxConnections &amp;&amp; self._connections &gt;= self.maxConnections) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientHandle.close();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return;</span><br><span class="FontName1">}</span></pre>
<p class="indent">This gives you a little more insight into why maxConnections defaults to undefined. This is because if it isn’t set, there is no need for Node.js to bother with this section of code. However, if it is set, a simple check will see if the current number of connections on the server is greater than or equal to the maxConnections setting<a id="cXXX.119"></a>, and it will close the connection. If you have a Node.js client connection<a id="cXXX.35x"></a> you wish to connect (which you will read more about in Section 2-4), but the number of connections exceeds this limit, you will see the connection’s close event emitted, and you can handle it appropriately, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list16" id="_list16">Listing 2-16</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list16" id="list16">Listing 2-16</a></i></b>.&nbsp;&nbsp;Handling the close Event on a Connection Handle</p>
<pre><span class="FontName1">connection.on('close', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connection closed');</span><br><span class="FontName1">});</span></pre>
<p class="indent">If, on the other hand, you have simply hit the server endpoint via Telnet <span class="FontName1">(telnet ::1 8181)</span>, the response will be “connection closed by foreign host,” as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#Fig1" id="_Fig1">Figure 2-1</a>.</p>
<div class="Figure" id="Fig1">
<p class="img">
<img src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/9781430260585_Fig02-01.jpg" alt="9781430260585_Fig02-01.jpg" width="400" height="129" data-mfp-src="/library/view/nodejs-recipes-a/9781430260585/images/9781430260585_Fig02-01.jpg"></p>
<p class="FigCapt">
<span class="CaptNr">
<a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_Fig1">Figure 2-1</a>. </span>Telnet connection closed<a id="cXXX.121"></a><a id="cXXX.120"></a></p>
</div>
</div>
<p id="Sec13" class="Heading1">2-4. Creating a Client</p>
<div>
<p id="Sec14" class="Heading2_2">Problem</p>
<p class="noindent">You want to create a client that connects to a networked server by using Node.js.</p>
</div>
<div>
<p id="Sec15" class="Heading2">Solution</p>
<p class="noindent">Creating a functional Node.js client extends from the concepts you learned about in Section 2-2. That is to say that a client is simply a connection to a server endpoint. Earlier you saw how to initiate a connection; in this section you will learn how to take that connected socket and understand the events that can be associated with it.</p>
<p class="indent">Let us make an assumption that we will connect our client to a simple Node.js server, similar to that which you created in Section 2-1. However, this server will receive a message from the client and also write a message to the client. This message will be a simple text message that shows a count of the current connections to the server. This server is shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list17" id="_list17">Listing 2-17</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list17" id="list17">Listing 2-17</a></i></b>.&nbsp;&nbsp;Simple Node.js Server<a id="cXXX.122"></a> to Echo Back to the Client</p>
<pre><span class="FontName1">var net = require('net');</span><br>&nbsp;<br><span class="FontName1">var server = net.createServer(function(connectionListener) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//get connection count</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.getConnections(function(err, count) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('Error getting connections');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// send out info for this socket</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>connectionListener.write('connections to server: ' + count + '\r\n');</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connectionListener.on('end', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('disconnected');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//Make sure there is something happening</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>connectionListener.write('heyo\r\n');</b><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connectionListener.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('message for you sir: ' + data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Handle connection errors</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connectionListener.on('error', function(err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('server error: ' + err);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.on('error', function(err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('Server error: ' + err);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(data.toString());</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.listen(8181, function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('server is listening');</span><br><span class="FontName1">});</span></pre>
<p class="indent">First, you see that, when creating a connected client using the <span class="FontName1">net</span> module in Node.js, you need to register the underlying events that can be emitted via the Node.js event emitter. In the example client you will create, these events are set to listen for <span class="FontName1">data</span>, <span class="FontName1">end</span>, and <span class="FontName1">error</span>. These events take a callback, which can be used to process the data transmitted via these events. This takes the example of the server shown in Section 2-2 and turns it into something that looks like what you see in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list18" id="_list18">Listing 2-18</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list18" id="list18">Listing 2-18</a></i></b>.&nbsp;&nbsp;Client with Socket Events<a id="cXXX.123"></a></p>
<pre><span class="FontName1">var net = require('net');</span><br>&nbsp;<br><span class="FontName1">// createConnection</span><br><span class="FontName1">var connection = net.createConnection({port: 8181, host:'127.0.0.1'},</span><br><span class="FontName1">// connectListener callback</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connection successful');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>this.write('hello');</b><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">connection.on(</span> <b>'data'</b> <span class="FontName1">, function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(data.toString());</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">connection.on(</span><b>'error'</b><span class="FontName1">, function(error) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(error);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">connection.on(</span><b>'end'</b><span class="FontName1">, function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connection ended');</span><br><span class="FontName1">});</span></pre>
<p class="indent">As you see, there are many options for registering event listeners on a client. These events are gateways to determining the state of a server or to processing a response buffer from a server. These can help you to determine the state and information sent from a networked client in your Node.js application.</p>
<p class="indent">Also present in the client (see <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list18">Listing 2-18</a>) is the simplest form of communication to the server that you can send: the <span class="FontName1">write()</span> method<a id="cXXX.124"></a> on a socket. The socket in this case is the one that you created when you instantiate your connection. This simply sends a string, “hello,” to the server once the connection is established. This is handled on the client via the <span class="FontName1">connectionListener's</span> data event binding.</p>
<pre><span class="FontName1">connectionListener.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('message for you sir: ' + data);</span><br><span class="FontName1">});</span></pre>
<p class="indent">If you have everything running properly, you will see the client interacting with your server in the console output as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list19" id="_list19">Listings 2-19</a> and <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list20" id="_list20">2-20</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list19" id="list19">Listing 2-19</a></i></b>.&nbsp;&nbsp;Server Interaction<a id="cXXX.125"></a> on the Command Line</p>
<pre><span class="FontName1">$ node server.js</span><br><span class="FontName1">server is listening</span><br><span class="FontName1">message for you sir: hello</span></pre>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list20" id="list20">Listing 2-20</a></i></b>.&nbsp;&nbsp;Client Communicating with the Server</p>
<pre><span class="FontName1">$ node client.js</span><br><span class="FontName1">Connection successful</span><br><span class="FontName1">Heyo</span></pre>
</div>
<div>
<p id="Sec16" class="Heading2">How It Works</p>
<p class="noindent">As you investigate how this client connects and communicates with your server, you again see that we have created a connection to a server using the <span class="FontName1">net</span> module that is native to Node.js. This module carries with it the ability to communicate smoothly between TCP servers and clients. In the example you created in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list17">Listing 2-17</a>, you created a connection that listened on a port and a host as described in Section 2-2. Once you created this connection, which you set to the variable ‘client’, it takes three arguments. These are exposed because the client is actually a representation of a TCP socket.</p>
<p class="indent">Regardless, the socket is created when you implement the <span class="FontName1">net.createConnection()</span> method. This means that you now have access to the options and events that are passed between sockets. This can be demonstrated by looking at the Node.js source for these sockets. In Node.js, the <span class="FontName1">net</span> socket is a representation of a stream. This means that to understand the code that is executing when <span class="FontName1">connection.end</span> happens you can see it is really a representation of the <span class="FontName1">socket.end</span> method, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list21" id="_list21">Listing 2-21</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list21" id="list21">Listing 2-21</a></i></b>.&nbsp;&nbsp;Socket.end Method<a id="cXXX.126"></a><a id="cXXX.127"></a></p>
<pre><span class="FontName1">Socket.prototype.end = function(data, encoding) {</span><br>&nbsp;&nbsp;<span class="FontName1">stream.Duplex.prototype.end.call(this, data, encoding);</span><br>&nbsp;&nbsp;<span class="FontName1">this.writable = false;</span><br>&nbsp;&nbsp;<span class="FontName1">DTRACE_NET_STREAM_END(this);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">// just in case we're waiting for an EOF.</span><br>&nbsp;&nbsp;<span class="FontName1">if (this.readable &amp;&amp; !this._readableState.endEmitted)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.read(0);</span><br>&nbsp;&nbsp;<span class="FontName1">return;</span><br><span class="FontName1">};</span></pre>
<p class="indent">You can see from <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list21">Listing 2-21</a> that you have access to the socket that is in reality a stream. The ‘end’ method calls the end to this stream and immediately sets the stream to not be writable. The end event is triggered when the other end of the stream sends the FIN packet, which you saw in the previous sections. There you examined the half-open socket connection; however, in this case, the socket is no longer writable. Then there is one last round of checks to see if there is still a readable entity in the stream, which it reads before it returns, finalizing the “end” of the socket.</p>
<p class="indent">In Listings 2-19 and 2-20 you saw the server was started with the command <span class="FontName1">node server.js</span>. This immediately produces the <span class="FontName1">.listen()</span> callback, which prints the message “server is listening” to your console. You then start the client <span class="FontName1">(node client.js</span>) and you invoke the <span class="FontName1">connectListener</span> callback that prints “Connection successful” in your console. This connection also initiates a <span class="FontName1">Socket.write()</span> from the server and a <span class="FontName1">Socket.write()</span> from the client. You will learn more about utilizing sockets to communicate in the next section, but for now you really need to understand that the end result of <span class="FontName1">Socket.write</span> is that each socket sends its data along the socket. This results in producing the “hello” message from the client on the server and the “heyo” message on the client via the server.</p>
<p class="indent">If you examine the data event, the event that handles the receipt of the data for your client, you see it is emitted each time data are received. When you listen for this event, which you register with <span class="FontName1">client.on('data'...),</span> you will be able to see data that are transmitted from your server. Data, in Node.js, is transmitted as a buffer or a string. It is emitted as a buffer by default, but if you set the <span class="FontName1">socket.setEncoding()</span> function<a id="cXXX.128"></a>, you will see that the data are transmitted as a string. In this solution you sent this data via the <span class="FontName1">Socket.write()</span> method, which defaults to sending the data with UTF-8 encoding. The data event is triggered in the stream module of Node.js. The stream module is triggered from the <span class="FontName1">socket.write()</span> method<a id="cXXX.129"></a> in the <span class="FontName1">net</span> module within Node.js as in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list22" id="_list22">Listing 2-22</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list22" id="list22">Listing 2-22</a></i></b>.&nbsp;&nbsp;Triggering the Streams Module from socket.write( )</p>
<pre><span class="FontName1">if (typeof chunk !== 'string' &amp;&amp; !Buffer.isBuffer(chunk))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">throw new TypeError('invalid data');</span><br>&nbsp;&nbsp;<b>return stream.Duplex.prototype.write.apply(this, arguments);</b></pre>
<p class="indent">Once you have worked your data into the stream interface, you meander it through the module until you find yourself where the readable stream exists. Stream.Readable is an instance of a readable stream that has a function, <span class="FontName1">emitDataEvents</span><a id="cXXX.130"></a>
<span class="FontName1"></span> . This is the “data” that will be read into the server that you send from your client. This lets an event listener, which is registered on the data event, actually go through the readable event on the stream, emitting the <span class="FontName1">stream.read()</span><a id="cXXX.131"></a> as the “data” returned <span class="FontName1">.on('data')</span>. This section of the source can be viewed in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list23" id="_list23">Listing 2-23</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list23" id="list23">Listing 2-23</a></i></b>.&nbsp;&nbsp;Emitting the Data Event from the Stream Module<a id="cXXX.132"></a></p>
<pre><span class="FontName1">stream.readable = true;</span><br><span class="FontName1">stream.pipe = Stream.prototype.pipe;</span><br><span class="FontName1">stream.on = stream.addListener = Stream.prototype.on;</span><br>&nbsp;<br><span class="FontName1">stream.on('readable', function() {</span><br>&nbsp;&nbsp;<span class="FontName1">readable = true;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">var c;</span><br>&nbsp;&nbsp;<span class="FontName1">while (!paused &amp;&amp; (null !== (</span><b>c = stream.read()</b><span class="FontName1">)))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<b>stream.emit('data', c);</b><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (c === null) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">readable = false;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">stream._readableState.needReadable = true;</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">});</span></pre>
<p class="indent">This section of the code highlights the main point about transferring data as streams. You can see that within the <span class="FontName1">emitDataEvents()</span> method<a id="cXXX.133"></a><a id="cXXX.134"></a> the stream listens for its own readable event. Once the readable event registers, then the stream.read( ) event is called, passing the data to the variable “c.” Then the stream emits the data event, while passing the argument “c.”</p>
<p class="indent">The other event listener that was created for the Node.js client in this section was registered on the error event. This event is emitted when the socket encounters an error. A great example of this is that, if you have your client connected to the server, you will get an error when the connection to the server fails. If you shut down the server, the error you will receive is a connection reset. This will be an object that looks like <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list24" id="_list24">Listing 2-24</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list24" id="list24">Listing 2-24</a></i></b>.&nbsp;&nbsp;Error: Connection Reset<a id="cXXX.39q"></a><a id="cXXX.135"></a></p>
<pre><span class="FontName1">{ [Error: read ECONNRESET] code: 'ECONNRESET', errno: 'ECONNRESET', syscall: 'read' }</span></pre>
<p class="indent">You now should be able to build a networked client in a Node.js environment. The process of communicating via sockets will be covered in more detail in Section 2-5.</p>
</div>
<p id="Sec17" class="Heading1">2-5. Using Sockets<a id="cXXX.152a"></a> to Communicate Between Servers<a id="cXXX.136"></a></p>
<div>
<p id="Sec18" class="Heading2_2">Problem</p>
<p class="noindent">You want to build a networked application in Node.js and utilize sockets to communicate between instances.</p>
</div>
<div>
<p id="Sec19" class="Heading2">Solution</p>
<p class="noindent">Sockets are native to the Node.js <span class="FontName1">net</span> module<a id="cXXX.137"></a>. This means that if you wish to utilize sockets, you need to require the <span class="FontName1">net</span> module in your script. You will then create a new instance of a socket by calling the <span class="FontName1">Socket()</span> constructor<a id="cXXX.138"></a>. Then to connect a socket, you simply create a connection with the <span class="FontName1">socket.connect()</span> method<a id="cXXX.139"></a>, directing the socket to which port and host you wish to connect (see <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list25" id="_list25">Listing 2-25</a>).</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list25" id="list25">Listing 2-25</a></i></b>.&nbsp;&nbsp;Creating a Socket Connection<a id="cXXX.140"></a></p>
<pre><span class="FontName1">var net = require('net');</span><br>&nbsp;<br><span class="FontName1">var socket = new net.Socket();</span><br>&nbsp;<br><span class="FontName1">socket.connect(/* port */ 8181, /*host*/ '127.0.0.1' /, *callback*/ );</span></pre>
<p class="indent">Assuming there is a connection that can be made on port 8181 of the <span class="FontName1">localhost</span>, you now have a socket connected to this server. At this point, there is nothing but a connected stream via this socket. Any data transmitted will be lost. Now let us take a closer look at a socket connection to a simple server to share messages between each other. To do this you can create a simple server (<a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list26" id="_list26">Listing 2-26</a>) that will listen for the socket and its data as well as send a response back to the sockets.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list26" id="list26">Listing 2-26</a></i></b>.&nbsp;&nbsp;Server to Communicate<a id="cXXX.141"></a> to Sockets</p>
<pre><span class="FontName1">var net = require('net');</span><br>&nbsp;<br><span class="FontName1">var server = net.createServer(connectionListener);</span><br>&nbsp;<br><span class="FontName1">server.listen(8181, '127.0.0.1');</span><br>&nbsp;<br><span class="FontName1">function connectionListener(conn) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('new client connected');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//greet the client</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">conn.write('hello');</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// read what the client has to say and respond</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">conn.on('readable', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var data = JSON.parse(this.read());</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (data.name) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.write('hello ' + data.name);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//handle errors</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">conn.on('error', function(e) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('' + e);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">}</span></pre>
<p class="indent">This server will listen for a connection, and then greet the new connection with a “hello” via the socket stream. It will also listen for data from the socket, which is expected to be a JSON object in this case. You can then parse the data from the “readable” stream and return a response with the data parsed.</p>
<p class="indent">The socket connection, shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list27" id="_list27">Listing 2-27</a>, shows how you can create this socket that will connect to the server from <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list26">Listing 2-26</a> and send communication between the two.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list27" id="list27">Listing 2-27</a></i></b>.&nbsp;&nbsp;Socket Connection</p>
<pre><span class="FontName1">var net = require('net');</span><br>&nbsp;<br><span class="FontName1">var socket = new net.Socket(/* fd: null, type: null, allowHalfOpen: false */);</span><br>&nbsp;<br><span class="FontName1">socket.connect(8181, '127.0.0.1' /*, connectListener&nbsp;&nbsp;replaces on('connect') */);</span><br>&nbsp;<br><span class="FontName1">socket.on('connect', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connected to: ' + this.remoteAddress);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var obj = { name: 'Frodo', occupation: 'adventurer' };</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.write(JSON.stringify(obj));</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">socket.on('error', function(error) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('' + error);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Don't persist this socket if there is a connection error</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.destroy();</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">socket.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('from server: ' + data);</span><br><span class="FontName1">});</span><br><span class="FontName1">socket.setEncoding('utf-8'); /* utf8, utf16le, ucs2, ascii, hex */</span><br>&nbsp;<br><span class="FontName1">socket.setTimeout(2e3 /* milliseconds */ , function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('timeout completed');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var obj = { name: 'timeout', message: 'I came from a timeout'};</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.write(JSON.stringify(obj));</span><br><span class="FontName1">});</span></pre>
<p class="indent">Putting the server and the client server together<span class="FontName1">—</span>running the server first, so that your socket has an endpoint to connect to<span class="FontName1">—</span>you are able to successfully communicate with the socket connections. The initiating server console will look like <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list28" id="_list28">Listing 2-28</a> while the client server output will look like <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list29" id="_list29">Listing 2-29</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list28" id="list28">Listing 2-28</a></i></b>.&nbsp;&nbsp;Server Output<a id="cXXX.142"></a></p>
<pre><span class="FontName1">$ node server.js</span><br><span class="FontName1">new client connected</span></pre>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list29" id="list29">Listing 2-29</a></i></b>.&nbsp;&nbsp;Connected Socket Output</p>
<pre><span class="FontName1">$ node socket.js</span><br><span class="FontName1">Connected to: 127.0.0.1</span><br><span class="FontName1">From server: hellohello Frodo</span><br><span class="FontName1">Timeout completed</span><br><span class="FontName1">From server: hello timeout</span></pre>
</div>
<div>
<p id="Sec20" class="Heading2">How It Works</p>
<p class="noindent">A <span class="FontName1">net.Socket</span> connection, as you have seen, is a Node.js object that represents a TCP or UNIX socket. In Node.js this means that it implements a duplex stream interface. A duplex stream in node represents two <span class="FontName1">event emitters</span>, objects that publish events in Node.js. The two <span class="FontName1">event emitters</span> that make up duplex streams are readable streams and writable streams, which you can see from the Node.js duplex stream source in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list30" id="_list30">Listing 2-30</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list30" id="list30">Listing 2-30</a></i></b>.&nbsp;&nbsp;Duplex Stream Calls Readable<a id="cXXX.143"></a><a id="cXXX.144"></a> and Writable Streams<a id="cXXX.145"></a><a id="cXXX.146"></a></p>
<pre><span class="FontName1">function Duplex(options) {</span><br>&nbsp;&nbsp;<span class="FontName1">if (!(this instanceof Duplex))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return new Duplex(options);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">Readable.call(this, options);</span><br>&nbsp;&nbsp;<span class="FontName1">Writable.call(this, options);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (options &amp;&amp; options.readable === false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.readable = false;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (options &amp;&amp; options.writable === false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.writable = false;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.allowHalfOpen = true;</span><br>&nbsp;&nbsp;<span class="FontName1">if (options &amp;&amp; options.allowHalfOpen === false)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.allowHalfOpen = false;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.once('end', onend);</span><br><span class="FontName1">}</span></pre>
<p class="indent">The readable streams<a id="cXXX.147"></a> interface will take in data from a stream buffer and emit it as a data event on the socket. The writable streams, on the other hand, will emit data in the form of a write, or an end, event. Together these make up a socket. The socket has a few interesting properties and methods, some of which you utilized in Listings 2-26 and 2-27 to create your socket communication servers.</p>
<p class="indent">In the first server instance, within the <span class="FontName1">connectionListener</span><a id="cXXX.148"></a> callback, the conn argument was passed. Because a <span class="FontName1">net.Server</span> object is really a socket that will listen for connections, this conn argument represents the socket you want to work with. The very first thing this server does is emit a greeting to the connection. This happens with <span class="FontName1">conn.write('hello');</span> which is a <span class="FontName1">socket.write()</span> method.</p>
<p class="indent">The <span class="FontName1">socket.write()</span> method<a id="cXXX.149"></a> takes one required argument, the data that are to be written, and two optional arguments. These optional arguments are encoding, which can be used to set the encoding type of the socket. The encoding defaults to utf8 but other valid values are utf-8, utf16le, ucs2, ascii, and hex.</p>
<p class="indent">Next, in the server’s <span class="FontName1">connectionListener</span> the socket was bound to the readable event. This readable event is from the stream module. This event is triggered each time that the stream sends data that are ready to be read. The way to retrieve the data that are sent via the readable event is to call the <span class="FontName1">read()</span> event to read the data. In the example from <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list26">Listing 2-26</a>, you expect the data to be a JSON string, which you can then parse to reveal the JSON object. This is then used to emit another message back to the connection via the <span class="FontName1">write()</span> method.</p>
<p class="indent">The final event binding in place on the server is a handling of errors by binding to the error event on the connection. Without this, the server will crash anytime an error occurs on the connection. This could be a killed connection, or any other error, but regardless of the type of error, there is nothing better to place on your Node.js code (or any code for that matter) than great error-handling capabilities.</p>
<p class="indent">Now look at the socket connections you made in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list27">Listing 2-27</a>. This shows the other side of our communication story. It starts with the instantiation of a new <span class="FontName1">net.Socket()</span><a id="cXXX.150"></a>
<span class="FontName1"></span>. In the example, there are no arguments passed to the constructor function. The constructor can take an options object that has keys of fd, type, and allowHalfOpen.</p>
<p class="indent">fd is the file descriptor<a id="cXXX.151"></a>, or what the socket handle should be; this defaults to null. The type key also defaults to a null value but can take the values tcp4, tcp6, or unix to determine the type of the socket you wish to instantiate. Again, as you have seen in previous sections, the allowHalfOpen option can be set to allow the socket to remain open once the initial FIN packet is transferred.</p>
<p class="indent">In order to connect the socket, you call the <span class="FontName1">connect()</span> event<a id="cXXX.152"></a> on the socket, with the host and port specified. This initializes the TCP or UNIX socket handle, beginning the connection. The host argument is optional, as is a callback function that was omitted in the example. The callback in the example was replaced, because the callback function on the connect function is the same as the <span class="FontName1">socket.on('connect', ...)</span> event listener, which is bound to the socket in our example listening for the connection to be established.</p>
<p class="indent">Inside of the <span class="FontName1">connect</span> event callback, the first thing your solution does is to gain a little knowledge about the connection by logging the <span class="FontName1">remoteAddress()</span><a id="cXXX.153"></a><a id="cXXX.154"></a> of the socket. You will see more about getting information about connected servers in the following section of this chapter. After this information, you create an object with some information, make it a string using the <span class="FontName1">JSON.stringify</span> method<a id="cXXX.155"></a>, then send it along the socket with the <span class="FontName1">write()</span> method. The object must be encoded as a string; if not, the write method will fail, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list31" id="_list31">Listing 2-31</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list31" id="list31">Listing 2-31</a></i></b>.&nbsp;&nbsp;socket.write from Node.js net Module</p>
<pre><span class="FontName1">Socket.prototype.write = function(chunk, encoding, cb) {</span><br>&nbsp;&nbsp;<b>if (typeof chunk !== 'string' &amp;&amp;</b>
<b>!Buffer.isBuffer(chunk))</b><br>&nbsp;&nbsp;&nbsp;&nbsp;<b>throw new TypeError('invalid data');</b><br>&nbsp;&nbsp;<span class="FontName1">return stream.Duplex.prototype.write.apply(this, arguments);</span><br><span class="FontName1">};</span></pre>
<p class="indent">The socket is then bound to the <span class="FontName1">error</span> event<a id="cXXX.156"></a>. This event will handle all errors from the socket, but one thing that is noteworthy here is that once the error is handled, via the callback provided to the <span class="FontName1">on('error')</span> listener, the <span class="FontName1">socket.destroy();</span> method is invoked. The destroy method provides a useful and graceful way to prevent any further I/O activity from happening and to close a socket. It goes through the closing of the socket handle, emitting any error callbacks as necessary during the destroy process. Finally, the close event is emitted after the handle is closed, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list32" id="_list32">Listing 2-32</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list32" id="list32">Listing 2-32</a></i></b>.&nbsp;&nbsp;Closing a Socket within socket.destroy( )<a id="cXXX.157"></a><a id="cXXX.158"></a></p>
<pre><span class="FontName1">Socket.prototype._destroy = function(exception, cb) {</span><br>&nbsp;&nbsp;<span class="FontName1">debug('destroy');</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">var self = this;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">function fireErrorCallbacks() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (cb) cb(exception);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (exception &amp;&amp; !self.errorEmitted) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">process.nextTick(function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self.emit('error', exception);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self.errorEmitted = true;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (this.destroyed) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">debug('already destroyed, fire error callbacks');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fireErrorCallbacks();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return;</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">self._connecting = false;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.readable = this.writable = false;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">timers.unenroll(this);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">debug('close');</span><br>&nbsp;&nbsp;<span class="FontName1">if (this._handle) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (this !== process.stderr)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">debug('close handle');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var isException = exception ? true : false;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._handle.close(function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">debug('emit close');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self.emit('close', isException);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._handle.onread = noop;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._handle = null;</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">fireErrorCallbacks();</span><br>&nbsp;&nbsp;<span class="FontName1">this.destroyed = true;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (this.server) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">COUNTER_NET_SERVER_CONNECTION_CLOSE(this);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">debug('has server');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.server._connections--;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (this.server._emitCloseIfDrained) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.server._emitCloseIfDrained();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">};</span></pre>
<p class="indent">After the error handler for your socket, the socket is bound to the data event. This event will produce the data from a readable stream sent from the connection, essentially calling the stream.read( ) method and emitting that as the data event. This provides a useful place to parse and process the information sent from the connection.</p>
<p class="indent">As you saw above, for the write( ) method on the socket, there is the option to set the encoding for the data that are sent via the socket buffer. This can be configured for the entire socket by setting the setEncoding(&lt;type&gt;) parameter on the socket. In the example above, it was set to the default for strings of utf-8 but could be changed to any of the valid types of encoding. Changing this setting to each of the valid types causes different output, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list33" id="_list33">Listing 2-33</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list33" id="list33">Listing 2-33</a></i></b>.&nbsp;&nbsp;Variations on Encoding<a id="cXXX.159"></a></p>
<pre><span class="FontName1"># utf8</span><br><span class="FontName1">connected to: 127.0.0.1</span><br><span class="FontName1">from server: hello</span><br><span class="FontName1">from server: hello Frodo</span><br><span class="FontName1">timeout completed</span><br><span class="FontName1">from server: hello timeout</span><br>&nbsp;<br><span class="FontName1"># hex</span><br><span class="FontName1">connected to: 127.0.0.1</span><br><span class="FontName1">from server: 68656c6c6f</span><br><span class="FontName1">from server: 68656c6c6f2046726f646f</span><br><span class="FontName1">timeout completed</span><br><span class="FontName1">from server: 68656c6c6f2074696d656f7574</span><br>&nbsp;<br><span class="FontName1"># ucs2</span><br><span class="FontName1">connected to: 127.0.0.1</span><br><span class="FontName1">from server:</span> <img src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/ch02un1.jpg" alt="image" width="50" height="24" data-mfp-src="/library/view/nodejs-recipes-a/9781430260585/images/ch02un1.jpg"><br><span class="FontName1">from server:</span> <img src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/ch02un2.jpg" alt="image" width="150" height="23" data-mfp-src="/library/view/nodejs-recipes-a/9781430260585/images/ch02un2.jpg"><br><span class="FontName1">timeout completed</span><br><span class="FontName1">from server:</span><img src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/ch02un3.jpg" alt="image" width="120" height="22" data-mfp-src="/library/view/nodejs-recipes-a/9781430260585/images/ch02un3.jpg"><br>&nbsp;<br><span class="FontName1"># ascii</span><br><span class="FontName1">connected to: 127.0.0.1</span><br><span class="FontName1">from server: hello</span><br><span class="FontName1">from server: hello Frodo</span><br><span class="FontName1">timeout completed</span><br><span class="FontName1">from server: hello timeout</span><br>&nbsp;<br><span class="FontName1"># utf16le</span><br><span class="FontName1">connected to: 127.0.0.1</span><br><span class="FontName1">from server: hello</span><br><span class="FontName1">from server: hello Frodo</span><br><span class="FontName1">timeout completed</span><br><span class="FontName1">from server: hello timeout</span></pre>
<p class="indent">Finally, you saw that the socket can “wait” by using the setTimeout function<a id="cXXX.160"></a><a id="cXXX.161"></a>. The setTimeout takes a parameter that dictates the number of milliseconds you choose to wait, and a callback. In the example application, this was used to send a message to the connection, from the socket on a two-second delay. For the callback to work (shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list34" id="_list34">Listing 2-34</a>), the number of milliseconds must be greater than zero, finite, and not a number (NaN). If this is the case, then Node.js will add this callback to the list of timers and emit the timeout event once the timeout has occurred.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list34" id="list34">Listing 2-34</a></i></b>.&nbsp;&nbsp;socket.setTimeout</p>
<pre><span class="FontName1">Socket.prototype.setTimeout = function(msecs, callback) {</span><br>&nbsp;&nbsp;<span class="FontName1">if (msecs &gt; 0 &amp;&amp; !isNaN(msecs) &amp;&amp; isFinite(msecs)) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">timers.enroll(this, msecs);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">timers.active(this);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (callback) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.once('timeout', callback);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">} else if (msecs === 0) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">timers.unenroll(this);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (callback) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.removeListener('timeout', callback);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">};</span></pre>
<p class="indent">There are other events and parameters on a net.Socket that were not covered in the socket example from <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list27">Listing 2-27</a>. These are outlined in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#Tab1" id="_Tab1">Table 2-1</a> below.</p>
<div class="Table">
<p class="TabCapt">
<span class="CaptNr">
<a id="Tab1" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_Tab1">Table 2-1</a>. </span>Socket Parameters and Events<a id="cXXX.162"></a></p>
<table>
<thead>
<tr class="header">
<th>Socket Parameter or Event</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td> socket.end([data],[encoding])</td>
<td> This event sends the FIN packet to the connected end of the socket, basically closing half the connection. The server can still send data if allowHalfOpen is set. You can specify data to send and an encoding, but both of those parameters are optional.</td>
</tr>
<tr>
<td> socket.pause( )</td>
<td> This does exactly as you might expect: it pauses data being sent on the socket.</td>
</tr>
<tr>
<td> socket.resume( )</td>
<td> This resumes the data transmission on a socket.</td>
</tr>
<tr>
<td> socket.setNoDelay([noDelay])</td>
<td> This determines whether or not the TCP connection will buffer data before sending the data off. This is known as the “Nagle algorithm” and the noDelay boolean parameter defaults to true.</td>
</tr>
<tr>
<td> socket.setKeepAlive([enable], [initialDelay])</td>
<td> This will enable or disable the keepalive functionality of the socket. This means there will be a keepalive probe sent after the last data packet is received and the initialDelay time, which defaults to zero. The enable boolean parameter defaults to false.</td>
</tr>
<tr>
<td> socket.unref( )</td>
<td> Calling this on the socket will check the Node.js event system, and if the socket is the only remaining socket in this system, it will be allowed to exit.</td>
</tr>
<tr>
<td> socket.ref( )</td>
<td> This, once set on a socket, will prevent the event system in Node.js from letting the program exit if it’s the only socket remaining. This is the opposite of the default behavior, which would let the program exit if it is the only remaining socket.</td>
</tr>
<tr>
<td> socket.remotePort</td>
<td> This is the port to which the socket is connected.</td>
</tr>
<tr>
<td> socket.localAddress</td>
<td> This is the address from which the socket originated.</td>
</tr>
<tr>
<td> socket.localPort</td>
<td> This is the port from which the socket originates.</td>
</tr>
<tr>
<td> socket.bytesRead</td>
<td> This gathers the number of bytes read from the data transmission.</td>
</tr>
<tr>
<td> socket.bytesWritten</td>
<td> This indicates the amount of bytes written.</td>
</tr>
</tbody>
</table>
</div>
<p class="indent">These properties and events will be covered in more detail in the final two sections of this chapter in which you will discover how to retrieve details about connected servers and how to control these properties and details within the sockets themselves.</p>
</div>
<p id="Sec21" class="Heading1">2-6. Retrieving Details About Connected Servers<a id="cXXX.46f"></a></p>
<div>
<p id="Sec22" class="Heading2_2">Problem</p>
<p class="noindent">You want to be able to fetch details about the connected servers and sockets in your Node.js application.</p>
</div>
<div>
<p id="Sec23" class="Heading2">Solution</p>
<p class="noindent">To retrieve details about your connected servers, you need to employ the knowledge about the net.Server<a id="cXXX.163"></a> and net.Socket module<a id="cXXX.164"></a>s that you were presented with in the previous sections. There are many details that you may be interested in knowing about a connection, but one that may be of interest is gathering the number of bytes transmitted and received between connections. This is handled with the <span class="FontName1">socket.bytesRead</span> and <span class="FontName1">socket.bytesWritten</span> properties. These could be valuable for any number of reasons, but many utilize it for benchmarking and logging progress in their applications. <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list35" id="_list35">Listing 2-35</a> creates a server with a looping connection that tallies up the total number of bytes written and read during the Node.js’s process execution.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list35" id="list35">Listing 2-35</a></i></b>.&nbsp;&nbsp;Tallying Bytes<a id="cXXX.165"></a></p>
<pre><span class="FontName1">var net = require('net');</span><br>&nbsp;<br><span class="FontName1">var PORT = 8181,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">totalRead = 0,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">totalWritten = 0,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connectionCount = 0;</span><br>&nbsp;<br><span class="FontName1">var server = net.Server(connectionListener);</span><br>&nbsp;<br><span class="FontName1">function connectionListener(conn) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//tally the bytes on end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">conn.on('end', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">totalRead += conn.bytesRead;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">}</span><br>&nbsp;<br><span class="FontName1">server.listen(PORT);</span><br>&nbsp;<br><span class="FontName1">//Connect a socket</span><br><span class="FontName1">var socket = net.createConnection(PORT);</span><br>&nbsp;<br><span class="FontName1">socket.on('connect', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// plan on writing the data more than once</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connectionCount++;</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// My = 2 Bytes</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.write('My', function () {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Precious = 8 Bytes</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.end('Precious');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">// tally the bytes written on end</span><br><span class="FontName1">socket.on('end', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">totalWritten += socket.bytesWritten;</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">socket.on('close', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Each time we should get +=10 bytes Read and Written</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('total read: ' + totalRead);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('total written: ' + totalWritten);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// We're gonna do this a few times</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (connectionCount &lt; 5) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.connect(PORT);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">server.close();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">});</span></pre>
<p class="indent">You now have access to the amount of bytes that are being sent between your server and your connections. This is terrific, but now you want to be able to reveal the details of where this server resides and where the sockets are coming from. To do this, you use the socket properties, <span class="FontName1">remoteAddress</span>, and <span class="FontName1">remotePort</span> (<a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list36" id="_list36">Listing 2-36</a>). You can add these into the example above by adding a line in the <span class="FontName1">connectionListener</span> callback function and another line in the <span class="FontName1">socket.on('connect')</span> event.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list36" id="list36">Listing 2-36</a></i></b>.&nbsp;&nbsp;Adding Some Address and Port Sniffers<a id="cXXX.166"></a></p>
<pre><span class="FontName1">console.log(socket.remoteAddress + ":" + socket.remotePort);</span></pre>
</div>
<div>
<p id="Sec24" class="Heading2">How It Works</p>
<p class="noindent">Getting information about connected servers is actually quite easy. These data points that tell you how many bytes have been sent or received can be quite valuable when creating a Node.js application. How does Node.js build these data and present them to the <span class="FontName1">net</span> module for your consumption? If you examine the net module source code you will find that the bytesRead value is always set to zero when a new socket handle is created, as you might expect. This value is then incremented by the length of the buffer that is read during the buffer handle’s onread function (shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list37" id="_list37">Listing 2-37</a>).</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list37" id="list37">Listing 2-37</a></i></b>.&nbsp;&nbsp;onread Event<span class="FontName1">—</span>Increments<a id="cXXX.167"></a> bytesRead by Length</p>
<pre><span class="FontName1">function onread(buffer, offset, length) {</span><br>&nbsp;&nbsp;<span class="FontName1">var handle = this;</span><br>&nbsp;&nbsp;<span class="FontName1">var self = handle.owner;</span><br>&nbsp;&nbsp;<span class="FontName1">assert(handle === self._handle, 'handle != self._handle');</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">timers.active(self);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">var end = offset + length;</span><br>&nbsp;&nbsp;<span class="FontName1">debug('onread', process._errno, offset, length, end);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (buffer) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">debug('got data');</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// read success.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// In theory (and in practice) calling readStop right now</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// will prevent this from being called again until _read() gets</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// called again.</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// if we didn't get any bytes, that doesn't necessarily mean EOF.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// wait for the next one.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (offset === end) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">debug('not any data, keep waiting');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// if it's not enough data, we'll just call handle.readStart()</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// again right away.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<b>self.bytesRead += length;</b><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Optimization: emit the original buffer with end points</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var ret = true;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (self.ondata) self.ondata(buffer, offset, end);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">else ret = self.push(buffer.slice(offset, end));</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (handle.reading &amp;&amp; !ret) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">handle.reading = false;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">debug('readStop');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var r = handle.readStop();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (r)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self._destroy(errnoException(process._errno, 'read'));</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">} else if (process._errno == 'EOF') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">debug('EOF');</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (self._readableState.length === 0)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self.readable = false;</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (self.onend) self.once('end', self.onend);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// push a null to signal the end of data.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self.push(null);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// internal end event so that we know that the actual socket</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// is no longer readable, and we can start the shutdown</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// procedure. No need to wait for all the data to be consumed.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self.emit('_socketEnd');</span><br>&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">debug('error', process._errno);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Error</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self._destroy(errnoException(process._errno, 'read'));</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">}</span></pre>
<p class="indent">Fetching the bytesWritten value is not quite as straightforward as incrementing a value by the length parameter that is passed into the onread function. In fact, as can be seen in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list38" id="_list38">Listing 2-38</a>, the bytesWritten parameter is generated by reading the chunk length of a buffer, or the actual byte length itself.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list38" id="list38">Listing 2-38</a></i></b>.&nbsp;&nbsp;bytesWritten<a id="cXXX.168"></a></p>
<pre><span class="FontName1">Socket.prototype.__defineGetter__('</span><b>bytesWritten</b><span class="FontName1">', function() {</span><br>&nbsp;&nbsp;<span class="FontName1">var bytes = this._bytesDispatched,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">state = this._writableState,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">data = this._pendingData,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">encoding = this._pendingEncoding;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">state.buffer.forEach(function(el) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (Buffer.isBuffer(el.chunk))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>bytes += el.chunk.length</b><span class="FontName1">;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>bytes += Buffer.byteLength(el.chunk, el.encoding);</b><br>&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (Buffer.isBuffer(data))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>bytes += data.length;</b><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>bytes += Buffer.byteLength(data, encoding);</b><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<b>return bytes</b><span class="FontName1">;</span><br><span class="FontName1">});</span></pre>
<p class="indent">The remoteAddress and remotePort parameters come from the socket handle itself. These represent an abstraction (<a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#list39" id="_list39">Listing 2-39</a>) on top of the Node.js handle’s getpeername object, which holds an address and a port parameter.&nbsp;&nbsp;This makes it simple for Node.js to define a getter for the remotePort and remoteAddress parameters.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#_list39" id="list39">Listing 2-39</a></i></b>.&nbsp;&nbsp;getpeername Method<a id="cXXX.169"></a> and the remoteAddress<a id="cXXX.170"></a> and remotePort Properties<a id="cXXX.171"></a></p>
<pre><span class="FontName1">Socket.prototype._getpeername = function() {</span><br>&nbsp;&nbsp;<span class="FontName1">if (!this._handle || !this._handle.getpeername) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return {};</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">if (!this._peername) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._peername = this._handle.getpeername();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// getpeername() returns null on error</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (this._peername === null) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return {};</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">return this._peername;</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">Socket.prototype.__defineGetter__('remoteAddress', function() {</span><br>&nbsp;&nbsp;<span class="FontName1">return this._getpeername().address;</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">Socket.prototype.__defineGetter__('remotePort', function() {</span><br>&nbsp;&nbsp;<span class="FontName1">return this._getpeername().port;</span><br><span class="FontName1">});</span></pre>
<p class="indent">You have seen how well Node.js defines properties on the server and sockets that support networked applications, making them easy to retrieve and to work with. Gaining these details about connected services can provide much-needed information when you develop a Node.js application.</p>
</div>
</div>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#">
			
				Add Note
			
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch01.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">CHAPTER 1: Understanding Node.js</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch03.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">CHAPTER 3: Using the File System</div>
        </a>
    
  
  </div>


        
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781430260585/chapter/9781430260585_Ch02.xhtml" data-for-analytics="9781430260585:9781430260585_Ch02.xhtml" aria-label="Add to Queue">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel  collapsed slideUp">
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" class="js-toggle-nag ss-navigateup" title="Toggle open or close footer"></a>
        <div class="sample-message">
          <p class="usage-data t-collapsed-text">Enjoy Safari?
            <a class="ga-active-trial-subscribe-nag" href="https://www.safaribooksonline.com/subscribe/">
              Subscribe Today
              
            </a>
          </p>
          

        <div class="expanded">
          <h2>You have 10 days left in your trial, Raviguru0007. </h2>
          <p class="t-expanded-text">Safari is your trusted guide for building a remarkable career. We hope you've been enjoying your trial—ready to join?</p>
          <a href="https://www.safaribooksonline.com/subscribe/" class="button-primary">
            Subscribe Today
            
          </a>
          
          <footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
    <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" class="icon-up" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/contact/">Contact Us</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
    </ul>
    <span class="copyright">© 2017 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/membership-agreement/">Membership Agreement</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>

        </div>
      </div>
    </div>

    
    



        
      </div>
      




  <footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
    <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" class="icon-up" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2017 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>

<script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"applicationTime":430,"agent":"","applicationID":"3275661","errorBeacon":"bam.nr-data.net","beacon":"bam.nr-data.net","queueTime":0,"transactionName":"YgdaZ0NSW0cEB0RdWltNfkZfUEFdCgofXFBHDVYdR1pQQxZeRl1QQj1aWkU=","licenseKey":"510f1a6865"}</script>


    

    <script src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/saved_resource" charset="utf-8"></script>
    <script src="./CHAPTER 2_ Networking with Node.js - Node.js Recipes_ A Problem-Solution Approach_files/saved_resource(1)" charset="utf-8"></script>
  

<div class="annotator-notice">Sorry we could not read the annotations from the store</div><div class="font-flyout" style="top: 200.013px; left: 1217px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml#">Reset</a>
</div>
</div></body></html>