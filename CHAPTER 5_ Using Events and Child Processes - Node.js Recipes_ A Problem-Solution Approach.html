<!DOCTYPE html>
<!-- saved from url=(0102)https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="1573407" data-user-uuid="29525685-85c9-45c7-9eda-3c178d86398e" data-username="raviguru0007" data-account-type="Trial" data-activated-trial-date="04/17/2017" data-archive="9781430260585" data-publishers="Apress" data-htmlfile-name="9781430260585_Ch05.xhtml" data-epub-title="Node.js Recipes: A Problem-Solution Approach" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781430260585"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><script type="text/javascript" src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/510f1a6865"></script><script src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/nr-spa-1026.min.js"></script><script type="text/javascript" async="" src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/linkid.js"></script><script async="" src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/analytics.js"></script><script type="text/javascript">(window.NREUM||(NREUM={})).loader_config={xpid:"VQQDUVVVGwACU1RUAQA="};window.NREUM||(NREUM={}),__nr_require=function(t,e,n){function r(n){if(!e[n]){var o=e[n]={exports:{}};t[n][0].call(o.exports,function(e){var o=t[n][1][e];return r(o||e)},o,o.exports)}return e[n].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,e,n){function r(t){try{c.console&&console.log(t)}catch(e){}}var o,i=t("ee"),a=t(19),c={};try{o=localStorage.getItem("__nr_flags").split(","),console&&"function"==typeof console.log&&(c.console=!0,o.indexOf("dev")!==-1&&(c.dev=!0),o.indexOf("nr_dev")!==-1&&(c.nrDev=!0))}catch(s){}c.nrDev&&i.on("internal-error",function(t){r(t.stack)}),c.dev&&i.on("fn-err",function(t,e,n){r(n.stack)}),c.dev&&(r("NR AGENT IN DEVELOPMENT MODE"),r("flags: "+a(c,function(t,e){return t}).join(", ")))},{}],2:[function(t,e,n){function r(t,e,n,r,o){try{d?d-=1:i("err",[o||new UncaughtException(t,e,n)])}catch(c){try{i("ierr",[c,s.now(),!0])}catch(u){}}return"function"==typeof f&&f.apply(this,a(arguments))}function UncaughtException(t,e,n){this.message=t||"Uncaught error with no additional information",this.sourceURL=e,this.line=n}function o(t){i("err",[t,s.now()])}var i=t("handle"),a=t(20),c=t("ee"),s=t("loader"),f=window.onerror,u=!1,d=0;s.features.err=!0,t(1),window.onerror=r;try{throw new Error}catch(p){"stack"in p&&(t(12),t(11),"addEventListener"in window&&t(6),s.xhrWrappable&&t(13),u=!0)}c.on("fn-start",function(t,e,n){u&&(d+=1)}),c.on("fn-err",function(t,e,n){u&&(this.thrown=!0,o(n))}),c.on("fn-end",function(){u&&!this.thrown&&d>0&&(d-=1)}),c.on("internal-error",function(t){i("ierr",[t,s.now(),!0])})},{}],3:[function(t,e,n){t("loader").features.ins=!0},{}],4:[function(t,e,n){function r(){C++,N=y.hash,this[u]=M.now()}function o(){C--,y.hash!==N&&i(0,!0);var t=M.now();this[l]=~~this[l]+t-this[u],this[d]=t}function i(t,e){x.emit("newURL",[""+y,e])}function a(t,e){t.on(e,function(){this[e]=M.now()})}var c="-start",s="-end",f="-body",u="fn"+c,d="fn"+s,p="cb"+c,h="cb"+s,l="jsTime",m="fetch",v="addEventListener",w=window,y=w.location;if(w[v]){var b=t(9),g=t(10),x=t(8),E=t(6),O=t(12),R=t(7),P=t(13),T=t("ee"),S=T.get("tracer");t(14);var M=t("loader");M.features.spa=!0;var N,j=w[v],C=0;T.on(u,r),T.on(p,r),T.on(d,o),T.on(h,o),T.buffer([u,d,"xhr-done","xhr-resolved"]),E.buffer([u]),O.buffer(["setTimeout"+s,"clearTimeout"+c,u]),P.buffer([u,"new-xhr","send-xhr"+c]),R.buffer([m+c,m+"-done",m+f+c,m+f+s]),x.buffer(["newURL"]),b.buffer([u]),g.buffer(["propagate",p,h,"executor-err","resolve"+c]),S.buffer([u,"no-"+u]),a(P,"send-xhr"+c),a(T,"xhr-resolved"),a(T,"xhr-done"),a(R,m+c),a(R,m+"-done"),x.on("pushState-end",i),x.on("replaceState-end",i),j("hashchange",i,!0),j("load",i,!0),j("popstate",function(){i(0,C>1)},!0)}},{}],5:[function(t,e,n){function r(t){}if(window.performance&&window.performance.timing&&window.performance.getEntriesByType){var o=t("ee"),i=t("handle"),a=t(12),c=t(11),s="learResourceTimings",f="addEventListener",u="resourcetimingbufferfull",d="bstResource",p="resource",h="-start",l="-end",m="fn"+h,v="fn"+l,w="bstTimer",y="pushState",b=t("loader");b.features.stn=!0,t(8);var g=NREUM.o.EV;o.on(m,function(t,e){var n=t[0];n instanceof g&&(this.bstStart=b.now())}),o.on(v,function(t,e){var n=t[0];n instanceof g&&i("bst",[n,e,this.bstStart,b.now()])}),a.on(m,function(t,e,n){this.bstStart=b.now(),this.bstType=n}),a.on(v,function(t,e){i(w,[e,this.bstStart,b.now(),this.bstType])}),c.on(m,function(){this.bstStart=b.now()}),c.on(v,function(t,e){i(w,[e,this.bstStart,b.now(),"requestAnimationFrame"])}),o.on(y+h,function(t){this.time=b.now(),this.startPath=location.pathname+location.hash}),o.on(y+l,function(t){i("bstHist",[location.pathname+location.hash,this.startPath,this.time])}),f in window.performance&&(window.performance["c"+s]?window.performance[f](u,function(t){i(d,[window.performance.getEntriesByType(p)]),window.performance["c"+s]()},!1):window.performance[f]("webkit"+u,function(t){i(d,[window.performance.getEntriesByType(p)]),window.performance["webkitC"+s]()},!1)),document[f]("scroll",r,{passive:!0}),document[f]("keypress",r,!1),document[f]("click",r,!1)}},{}],6:[function(t,e,n){function r(t){for(var e=t;e&&!e.hasOwnProperty(u);)e=Object.getPrototypeOf(e);e&&o(e)}function o(t){c.inPlace(t,[u,d],"-",i)}function i(t,e){return t[1]}var a=t("ee").get("events"),c=t(22)(a,!0),s=t("gos"),f=XMLHttpRequest,u="addEventListener",d="removeEventListener";e.exports=a,"getPrototypeOf"in Object?(r(document),r(window),r(f.prototype)):f.prototype.hasOwnProperty(u)&&(o(window),o(f.prototype)),a.on(u+"-start",function(t,e){var n=t[1],r=s(n,"nr@wrapped",function(){function t(){if("function"==typeof n.handleEvent)return n.handleEvent.apply(n,arguments)}var e={object:t,"function":n}[typeof n];return e?c(e,"fn-",null,e.name||"anonymous"):n});this.wrapped=t[1]=r}),a.on(d+"-start",function(t){t[1]=this.wrapped||t[1]})},{}],7:[function(t,e,n){function r(t,e,n){var r=t[e];"function"==typeof r&&(t[e]=function(){var t=r.apply(this,arguments);return o.emit(n+"start",arguments,t),t.then(function(e){return o.emit(n+"end",[null,e],t),e},function(e){throw o.emit(n+"end",[e],t),e})})}var o=t("ee").get("fetch"),i=t(19);e.exports=o;var a=window,c="fetch-",s=c+"body-",f=["arrayBuffer","blob","json","text","formData"],u=a.Request,d=a.Response,p=a.fetch,h="prototype";u&&d&&p&&(i(f,function(t,e){r(u[h],e,s),r(d[h],e,s)}),r(a,"fetch",c),o.on(c+"end",function(t,e){var n=this;e?e.clone().arrayBuffer().then(function(t){n.rxSize=t.byteLength,o.emit(c+"done",[null,e],n)}):o.emit(c+"done",[t],n)}))},{}],8:[function(t,e,n){var r=t("ee").get("history"),o=t(22)(r);e.exports=r,o.inPlace(window.history,["pushState","replaceState"],"-")},{}],9:[function(t,e,n){var r=t("ee").get("mutation"),o=t(22)(r),i=NREUM.o.MO;e.exports=r,i&&(window.MutationObserver=function(t){return this instanceof i?new i(o(t,"fn-")):i.apply(this,arguments)},MutationObserver.prototype=i.prototype)},{}],10:[function(t,e,n){function r(t){var e=a.context(),n=c(t,"executor-",e),r=new f(n);return a.context(r).getCtx=function(){return e},a.emit("new-promise",[r,e],e),r}function o(t,e){return e}var i=t(22),a=t("ee").get("promise"),c=i(a),s=t(19),f=NREUM.o.PR;e.exports=a,f&&(window.Promise=r,["all","race"].forEach(function(t){var e=f[t];f[t]=function(n){function r(t){return function(){a.emit("propagate",[null,!o],i),o=o||!t}}var o=!1;s(n,function(e,n){Promise.resolve(n).then(r("all"===t),r(!1))});var i=e.apply(f,arguments),c=f.resolve(i);return c}}),["resolve","reject"].forEach(function(t){var e=f[t];f[t]=function(t){var n=e.apply(f,arguments);return t!==n&&a.emit("propagate",[t,!0],n),n}}),f.prototype["catch"]=function(t){return this.then(null,t)},f.prototype=Object.create(f.prototype,{constructor:{value:r}}),s(Object.getOwnPropertyNames(f),function(t,e){try{r[e]=f[e]}catch(n){}}),a.on("executor-start",function(t){t[0]=c(t[0],"resolve-",this),t[1]=c(t[1],"resolve-",this)}),a.on("executor-err",function(t,e,n){t[1](n)}),c.inPlace(f.prototype,["then"],"then-",o),a.on("then-start",function(t,e){this.promise=e,t[0]=c(t[0],"cb-",this),t[1]=c(t[1],"cb-",this)}),a.on("then-end",function(t,e,n){this.nextPromise=n;var r=this.promise;a.emit("propagate",[r,!0],n)}),a.on("cb-end",function(t,e,n){a.emit("propagate",[n,!0],this.nextPromise)}),a.on("propagate",function(t,e,n){this.getCtx&&!e||(this.getCtx=function(){if(t instanceof Promise)var e=a.context(t);return e&&e.getCtx?e.getCtx():this})}),r.toString=function(){return""+f})},{}],11:[function(t,e,n){var r=t("ee").get("raf"),o=t(22)(r),i="equestAnimationFrame";e.exports=r,o.inPlace(window,["r"+i,"mozR"+i,"webkitR"+i,"msR"+i],"raf-"),r.on("raf-start",function(t){t[0]=o(t[0],"fn-")})},{}],12:[function(t,e,n){function r(t,e,n){t[0]=a(t[0],"fn-",null,n)}function o(t,e,n){this.method=n,this.timerDuration="number"==typeof t[1]?t[1]:0,t[0]=a(t[0],"fn-",this,n)}var i=t("ee").get("timer"),a=t(22)(i),c="setTimeout",s="setInterval",f="clearTimeout",u="-start",d="-";e.exports=i,a.inPlace(window,[c,"setImmediate"],c+d),a.inPlace(window,[s],s+d),a.inPlace(window,[f,"clearImmediate"],f+d),i.on(s+u,r),i.on(c+u,o)},{}],13:[function(t,e,n){function r(t,e){d.inPlace(e,["onreadystatechange"],"fn-",c)}function o(){var t=this,e=u.context(t);t.readyState>3&&!e.resolved&&(e.resolved=!0,u.emit("xhr-resolved",[],t)),d.inPlace(t,v,"fn-",c)}function i(t){w.push(t),l&&(b=-b,g.data=b)}function a(){for(var t=0;t<w.length;t++)r([],w[t]);w.length&&(w=[])}function c(t,e){return e}function s(t,e){for(var n in t)e[n]=t[n];return e}t(6);var f=t("ee"),u=f.get("xhr"),d=t(22)(u),p=NREUM.o,h=p.XHR,l=p.MO,m="readystatechange",v=["onload","onerror","onabort","onloadstart","onloadend","onprogress","ontimeout"],w=[];e.exports=u;var y=window.XMLHttpRequest=function(t){var e=new h(t);try{u.emit("new-xhr",[e],e),e.addEventListener(m,o,!1)}catch(n){try{u.emit("internal-error",[n])}catch(r){}}return e};if(s(h,y),y.prototype=h.prototype,d.inPlace(y.prototype,["open","send"],"-xhr-",c),u.on("send-xhr-start",function(t,e){r(t,e),i(e)}),u.on("open-xhr-start",r),l){var b=1,g=document.createTextNode(b);new l(a).observe(g,{characterData:!0})}else f.on("fn-end",function(t){t[0]&&t[0].type===m||a()})},{}],14:[function(t,e,n){function r(t){var e=this.params,n=this.metrics;if(!this.ended){this.ended=!0;for(var r=0;r<d;r++)t.removeEventListener(u[r],this.listener,!1);if(!e.aborted){if(n.duration=a.now()-this.startTime,4===t.readyState){e.status=t.status;var i=o(t,this.lastSize);if(i&&(n.rxSize=i),this.sameOrigin){var s=t.getResponseHeader("X-NewRelic-App-Data");s&&(e.cat=s.split(", ").pop())}}else e.status=0;n.cbTime=this.cbTime,f.emit("xhr-done",[t],t),c("xhr",[e,n,this.startTime])}}}function o(t,e){var n=t.responseType;if("json"===n&&null!==e)return e;var r="arraybuffer"===n||"blob"===n||"json"===n?t.response:t.responseText;return l(r)}function i(t,e){var n=s(e),r=t.params;r.host=n.hostname+":"+n.port,r.pathname=n.pathname,t.sameOrigin=n.sameOrigin}var a=t("loader");if(a.xhrWrappable){var c=t("handle"),s=t(15),f=t("ee"),u=["load","error","abort","timeout"],d=u.length,p=t("id"),h=t(18),l=t(17),m=window.XMLHttpRequest;a.features.xhr=!0,t(13),f.on("new-xhr",function(t){var e=this;e.totalCbs=0,e.called=0,e.cbTime=0,e.end=r,e.ended=!1,e.xhrGuids={},e.lastSize=null,h&&(h>34||h<10)||window.opera||t.addEventListener("progress",function(t){e.lastSize=t.loaded},!1)}),f.on("open-xhr-start",function(t){this.params={method:t[0]},i(this,t[1]),this.metrics={}}),f.on("open-xhr-end",function(t,e){"loader_config"in NREUM&&"xpid"in NREUM.loader_config&&this.sameOrigin&&e.setRequestHeader("X-NewRelic-ID",NREUM.loader_config.xpid)}),f.on("send-xhr-start",function(t,e){var n=this.metrics,r=t[0],o=this;if(n&&r){var i=l(r);i&&(n.txSize=i)}this.startTime=a.now(),this.listener=function(t){try{"abort"===t.type&&(o.params.aborted=!0),("load"!==t.type||o.called===o.totalCbs&&(o.onloadCalled||"function"!=typeof e.onload))&&o.end(e)}catch(n){try{f.emit("internal-error",[n])}catch(r){}}};for(var c=0;c<d;c++)e.addEventListener(u[c],this.listener,!1)}),f.on("xhr-cb-time",function(t,e,n){this.cbTime+=t,e?this.onloadCalled=!0:this.called+=1,this.called!==this.totalCbs||!this.onloadCalled&&"function"==typeof n.onload||this.end(n)}),f.on("xhr-load-added",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&!this.xhrGuids[n]&&(this.xhrGuids[n]=!0,this.totalCbs+=1)}),f.on("xhr-load-removed",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&this.xhrGuids[n]&&(delete this.xhrGuids[n],this.totalCbs-=1)}),f.on("addEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-added",[t[1],t[2]],e)}),f.on("removeEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-removed",[t[1],t[2]],e)}),f.on("fn-start",function(t,e,n){e instanceof m&&("onload"===n&&(this.onload=!0),("load"===(t[0]&&t[0].type)||this.onload)&&(this.xhrCbStart=a.now()))}),f.on("fn-end",function(t,e){this.xhrCbStart&&f.emit("xhr-cb-time",[a.now()-this.xhrCbStart,this.onload,e],e)})}},{}],15:[function(t,e,n){e.exports=function(t){var e=document.createElement("a"),n=window.location,r={};e.href=t,r.port=e.port;var o=e.href.split("://");!r.port&&o[1]&&(r.port=o[1].split("/")[0].split("@").pop().split(":")[1]),r.port&&"0"!==r.port||(r.port="https"===o[0]?"443":"80"),r.hostname=e.hostname||n.hostname,r.pathname=e.pathname,r.protocol=o[0],"/"!==r.pathname.charAt(0)&&(r.pathname="/"+r.pathname);var i=!e.protocol||":"===e.protocol||e.protocol===n.protocol,a=e.hostname===document.domain&&e.port===n.port;return r.sameOrigin=i&&(!e.hostname||a),r}},{}],16:[function(t,e,n){function r(){}function o(t,e,n){return function(){return i(t,[f.now()].concat(c(arguments)),e?null:this,n),e?void 0:this}}var i=t("handle"),a=t(19),c=t(20),s=t("ee").get("tracer"),f=t("loader"),u=NREUM;"undefined"==typeof window.newrelic&&(newrelic=u);var d=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],p="api-",h=p+"ixn-";a(d,function(t,e){u[e]=o(p+e,!0,"api")}),u.addPageAction=o(p+"addPageAction",!0),u.setCurrentRouteName=o(p+"routeName",!0),e.exports=newrelic,u.interaction=function(){return(new r).get()};var l=r.prototype={createTracer:function(t,e){var n={},r=this,o="function"==typeof e;return i(h+"tracer",[f.now(),t,n],r),function(){if(s.emit((o?"":"no-")+"fn-start",[f.now(),r,o],n),o)try{return e.apply(this,arguments)}finally{s.emit("fn-end",[f.now()],n)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(t,e){l[e]=o(h+e)}),newrelic.noticeError=function(t){"string"==typeof t&&(t=new Error(t)),i("err",[t,f.now()])}},{}],17:[function(t,e,n){e.exports=function(t){if("string"==typeof t&&t.length)return t.length;if("object"==typeof t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer&&t.byteLength)return t.byteLength;if("undefined"!=typeof Blob&&t instanceof Blob&&t.size)return t.size;if(!("undefined"!=typeof FormData&&t instanceof FormData))try{return JSON.stringify(t).length}catch(e){return}}}},{}],18:[function(t,e,n){var r=0,o=navigator.userAgent.match(/Firefox[\/\s](\d+\.\d+)/);o&&(r=+o[1]),e.exports=r},{}],19:[function(t,e,n){function r(t,e){var n=[],r="",i=0;for(r in t)o.call(t,r)&&(n[i]=e(r,t[r]),i+=1);return n}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],20:[function(t,e,n){function r(t,e,n){e||(e=0),"undefined"==typeof n&&(n=t?t.length:0);for(var r=-1,o=n-e||0,i=Array(o<0?0:o);++r<o;)i[r]=t[e+r];return i}e.exports=r},{}],21:[function(t,e,n){e.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],22:[function(t,e,n){function r(t){return!(t&&t instanceof Function&&t.apply&&!t[a])}var o=t("ee"),i=t(20),a="nr@original",c=Object.prototype.hasOwnProperty,s=!1;e.exports=function(t,e){function n(t,e,n,o){function nrWrapper(){var r,a,c,s;try{a=this,r=i(arguments),c="function"==typeof n?n(r,a):n||{}}catch(f){p([f,"",[r,a,o],c])}u(e+"start",[r,a,o],c);try{return s=t.apply(a,r)}catch(d){throw u(e+"err",[r,a,d],c),d}finally{u(e+"end",[r,a,s],c)}}return r(t)?t:(e||(e=""),nrWrapper[a]=t,d(t,nrWrapper),nrWrapper)}function f(t,e,o,i){o||(o="");var a,c,s,f="-"===o.charAt(0);for(s=0;s<e.length;s++)c=e[s],a=t[c],r(a)||(t[c]=n(a,f?c+o:o,i,c))}function u(n,r,o){if(!s||e){var i=s;s=!0;try{t.emit(n,r,o,e)}catch(a){p([a,n,r,o])}s=i}}function d(t,e){if(Object.defineProperty&&Object.keys)try{var n=Object.keys(t);return n.forEach(function(n){Object.defineProperty(e,n,{get:function(){return t[n]},set:function(e){return t[n]=e,e}})}),e}catch(r){p([r])}for(var o in t)c.call(t,o)&&(e[o]=t[o]);return e}function p(e){try{t.emit("internal-error",e)}catch(n){}}return t||(t=o),n.inPlace=f,n.flag=a,n}},{}],ee:[function(t,e,n){function r(){}function o(t){function e(t){return t&&t instanceof r?t:t?s(t,c,i):i()}function n(n,r,o,i){if(!p.aborted||i){t&&t(n,r,o);for(var a=e(o),c=l(n),s=c.length,f=0;f<s;f++)c[f].apply(a,r);var d=u[y[n]];return d&&d.push([b,n,r,a]),a}}function h(t,e){w[t]=l(t).concat(e)}function l(t){return w[t]||[]}function m(t){return d[t]=d[t]||o(n)}function v(t,e){f(t,function(t,n){e=e||"feature",y[n]=e,e in u||(u[e]=[])})}var w={},y={},b={on:h,emit:n,get:m,listeners:l,context:e,buffer:v,abort:a,aborted:!1};return b}function i(){return new r}function a(){(u.api||u.feature)&&(p.aborted=!0,u=p.backlog={})}var c="nr@context",s=t("gos"),f=t(19),u={},d={},p=e.exports=o();p.backlog=u},{}],gos:[function(t,e,n){function r(t,e,n){if(o.call(t,e))return t[e];var r=n();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(t,e,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return t[e]=r,r}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],handle:[function(t,e,n){function r(t,e,n,r){o.buffer([t],r),o.emit(t,e,n)}var o=t("ee").get("handle");e.exports=r,r.ee=o},{}],id:[function(t,e,n){function r(t){var e=typeof t;return!t||"object"!==e&&"function"!==e?-1:t===window?0:a(t,i,function(){return o++})}var o=1,i="nr@id",a=t("gos");e.exports=r},{}],loader:[function(t,e,n){function r(){if(!x++){var t=g.info=NREUM.info,e=p.getElementsByTagName("script")[0];if(setTimeout(u.abort,3e4),!(t&&t.licenseKey&&t.applicationID&&e))return u.abort();f(y,function(e,n){t[e]||(t[e]=n)}),s("mark",["onload",a()+g.offset],null,"api");var n=p.createElement("script");n.src="https://"+t.agent,e.parentNode.insertBefore(n,e)}}function o(){"complete"===p.readyState&&i()}function i(){s("mark",["domContent",a()+g.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(c=Math.max((new Date).getTime(),c))-g.offset}var c=(new Date).getTime(),s=t("handle"),f=t(19),u=t("ee"),d=window,p=d.document,h="addEventListener",l="attachEvent",m=d.XMLHttpRequest,v=m&&m.prototype;NREUM.o={ST:setTimeout,CT:clearTimeout,XHR:m,REQ:d.Request,EV:d.Event,PR:d.Promise,MO:d.MutationObserver};var w=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-spa-1026.min.js"},b=m&&v&&v[h]&&!/CriOS/.test(navigator.userAgent),g=e.exports={offset:c,now:a,origin:w,features:{},xhrWrappable:b};t(16),p[h]?(p[h]("DOMContentLoaded",i,!1),d[h]("load",r,!1)):(p[l]("onreadystatechange",o),d[l]("onload",r)),s("mark",["firstbyte",c],null,"api");var x=0,E=t(21)},{}]},{},["loader",2,14,5,3,4]);</script><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/css" rel="stylesheet" type="text/css"><title>CHAPTER 5: Using Events and Child Processes - Node.js Recipes: A Problem-Solution Approach</title><link rel="stylesheet" href="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/74741d96e0ae.css" type="text/css"><link rel="stylesheet" type="text/css" href="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/annotator.e34eec1a0d5a.css"><link rel="stylesheet" href="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/font-awesome.min.css"><style type="text/css" title="ibis-book">
    #sbo-rt-content div{margin:1em 1em 1em 1em}#sbo-rt-content a{text-decoration:none}#sbo-rt-content img{max-width:100%;margin-top:10pt}#sbo-rt-content p.booktitle{font-weight:bold;font-size:2.5em;margin-top:2em;margin-bottom:8em;text-align:center}#sbo-rt-content p.bookauthor{font-weight:bold;font-size:1.7em;margin-top:0;margin-right:2em;margin-bottom:0;text-align:left}#sbo-rt-content p.booksubtitle{font-weight:bold;font-size:1.7em;margin-top:0;margin-bottom:7em;text-align:center;color:#8A8A8A}#sbo-rt-content .bookimage{font-size:1.2em;margin-top:0;margin-bottom:1em;text-align:left}#sbo-rt-content .fmpara{font-size:.9em;text-indent:0;margin-top:.5em;margin-bottom:.3em;text-align:justify}#sbo-rt-content .fmpara1{font-size:.9em;text-indent:0;margin-top:.4em;margin-bottom:.3em;text-align:right}#sbo-rt-content .inpara{text-indent:0;margin-top:.4em;margin-left:3em;margin-bottom:.3em}#sbo-rt-content .pub{margin-top:10em;margin-bottom:1em;text-align:right;margin-right:5em}#sbo-rt-content .copyright{font-size:.9em;margin-top:.4em;margin-bottom:.4em;margin-left:1.2em;margin-right:1.2em;text-align:left}#sbo-rt-content .copyright1{font-size:.9em;margin-top:.1em;margin-bottom:.1em;margin-left:4em;margin-right:3.3em;text-align:left;text-indent:-1.6em}#sbo-rt-content .copyright2{font-size:.9em;margin-top:.1em;margin-bottom:.1em;margin-left:4.2em}#sbo-rt-content .dedication{font-size:1.2em;margin-bottom:0;margin-top:3.5em;text-align:center;margin-right:1em;font-style:italic}#sbo-rt-content .dedication1{font-size:1.2em;margin-bottom:0;margin-top:.5em;text-align:center;margin-right:1em;font-style:normal}#sbo-rt-content .dedication2{font-size:1.2em;margin-bottom:0;margin-top:1.5em;text-align:center;margin-right:1em;font-style:italic}#sbo-rt-content .content-title{font-size:1.6em;margin-top:3em;margin-bottom:.1em;text-align:left;font-weight:bold}#sbo-rt-content .fmtitle{font-size:2.5em;margin-top:1em;margin-bottom:1em;text-align:left;font-weight:bold;border-bottom:1.1px solid black;padding-bottom:.8em}#sbo-rt-content .right{text-indent:0;margin-top:1em;margin-right:1.5em;margin-bottom:.3em;text-align:right}#sbo-rt-content .right1{text-indent:0;margin-top:0;margin-right:1.5em;margin-bottom:.2em;text-align:right}#sbo-rt-content .chapimage{margin-left:.2em;margin-top:1.5em;margin-bottom:1.5em;text-align:left}#sbo-rt-content p.ChapterNumber{font-weight:bold;font-size:1.7em;margin-top:10px;margin-left:0;margin-bottom:5px;text-align:left}#sbo-rt-content p.ChapterTitle{font-weight:bold;font-size:2.5em;margin-top:0;margin-bottom:1em;margin-left:0;text-align:left;border-bottom:1.1px solid black;padding-bottom:.8em}#sbo-rt-content p.PartNumber{font-weight:bold;font-size:1.7em;margin-top:10px;margin-left:0;margin-bottom:5px;text-align:left;padding-bottom:.8em}#sbo-rt-content p.partTitle{font-weight:bold;font-size:2.5em;margin-top:1em;margin-bottom:1em;margin-left:0;text-align:left}#sbo-rt-content .paraaftertitle{font-size:100%;text-indent:0;margin-top:0;margin-left:0;margin-bottom:0}#sbo-rt-content p.noindent{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:0;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.noindent1{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:1em}#sbo-rt-content p.noindent2{font-size:100%;text-indent:0;margin-top:1.5em;margin-bottom:1em}#sbo-rt-content p.noindent3{font-size:100%;text-indent:0;margin-top:.8em;margin-bottom:.2em;margin-left:0;margin-right:0;text-align:center}#sbo-rt-content p.noindent4{font-size:100%;text-indent:0;margin-top:.8em;margin-bottom:.2em;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content span.listing{font-weight:bold}#sbo-rt-content p.indent{font-size:100%;text-indent:1.2em;margin-top:.1em;margin-bottom:.1em;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.indent1{font-size:100%;text-indent:1.2em;margin-top:0;margin-bottom:0;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.indent1a{font-size:100%;text-indent:1.5em;margin-top:0;margin-bottom:0;margin-left:0;margin-right:4.5em;text-align:right}#sbo-rt-content p.indent2{font-size:100%;margin-top:.8em;margin-bottom:.8em;margin-left:2.4em;margin-right:2.4em;text-align:justify;font-style:italic}#sbo-rt-content p.indent3{font-size:100%;text-indent:1em;margin-top:.8em;margin-bottom:.8em;margin-left:1.8em;margin-right:1.8em;text-align:left}#sbo-rt-content p.indent4{font-size:100%;text-indent:1.3em;margin-top:.5em;margin-bottom:.5em;margin-left:2em;margin-right:0;text-align:left}#sbo-rt-content .blockquote{font-size:100%;text-indent:.2em;margin-top:1em;margin-left:3em;margin-right:2em;margin-bottom:1em;font-style:italic}#sbo-rt-content .blockquote1{font-size:100%;text-indent:.2em;margin-top:1em;margin-left:3em;margin-bottom:0;font-style:italic}#sbo-rt-content p.Heading1{font-weight:bold;font-size:2em;text-indent:0;margin-top:1.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2{font-size:1.6em;text-indent:0;margin-top:1.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2_2{font-size:1.6em;text-indent:0;margin-top:.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2a{font-size:1.5em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;font-weight:bold}#sbo-rt-content p.Heading3{font-weight:bold;font-size:1.45em;text-indent:0;margin-top:1.2em;margin-bottom:.1em}#sbo-rt-content p.Heading3a{font-weight:normal;font-size:1.25em;text-indent:0;margin-top:1.2em;margin-bottom:.1em}#sbo-rt-content p.Heading4{font-size:1.3em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;text-align:left}#sbo-rt-content .img{max-width:100%;margin-top:10pt}#sbo-rt-content .img1{text-align:left}#sbo-rt-content .img1a{text-align:right;margin-right:5em;margin-top:5em}#sbo-rt-content .img2{text-align:left}#sbo-rt-content div.Figure{font-size:small;margin-top:1.5em;margin-bottom:1.5em}#sbo-rt-content .para-1{font-size:100%;margin-top:1em;text-indent:1.5em;margin-bottom:0;text-align:left}#sbo-rt-content .para-2{font-size:.9em;text-indent:-1.4em;margin-left:2.4em;margin-top:.5em;margin-bottom:0}#sbo-rt-content .figurecaption{font-size:small;margin-top:0;margin-bottom:0;text-align:justify}#sbo-rt-content .image{text-align:center}#sbo-rt-content .codecaption{font-size:100%;margin-top:.6em;margin-bottom:.6em;text-align:justify;font-style:italic}#sbo-rt-content .PCode{font-size:small;margin-top:1em;margin-bottom:1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-1{font-size:small;margin-top:1em;margin-bottom:.1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-2{font-size:small;margin-top:0;margin-bottom:0;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-3{font-size:small;margin-top:0;margin-bottom:1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content div.singlethin{border-bottom:solid 3px;margin-left:1em;margin-right:1em;margin-bottom:1em}#sbo-rt-content div.singlethin1{margin-left:2em;margin-right:2em}#sbo-rt-content .inlinecode{font-family:monospace}#sbo-rt-content div.notepara{font-size:110%;text-indent:0;margin-top:1em;border-top:solid 1px;border-bottom:solid 1px;margin-bottom:1em;text-align:justify}#sbo-rt-content span.pink-box{font-weight:bold;padding-left:1.3em;padding-right:1.3em;border:1.1px solid black;font-size:1.5em;margin-top:.5em;margin-bottom:.5em;text-indent:0;text-align:justify}#sbo-rt-content span.courier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%}#sbo-rt-content div.courier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%;margin-top:1em;margin-bottom:1em}#sbo-rt-content div.boxcourier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%;margin-top:1em;margin-bottom:1em;margin-left:1.5em;margin-right:1.5em;text-align:left}#sbo-rt-content span.courier1{font-family:Courier New;font-weight:normal;font-style:normal;font-size:95%}#sbo-rt-content .boxhead{font-size:1.25em;font-weight:bold;padding-left:.1em;padding-bottom:.1em;padding-top:.1em;margin-top:0;text-indent:0;text-align:center;border:3px solid black}#sbo-rt-content div.box{margin-top:1em;margin-bottom:1em}#sbo-rt-content .boxpara{font-size:110%;text-indent:0;margin-left:1.5em;margin-right:1.5em;margin-top:.5em;margin-bottom:.5em;text-align:left}#sbo-rt-content .alpha{font-size:1.2em;font-weight:bold;margin-left:.2em;margin-top:1em;margin-bottom:.3em;text-align:left}#sbo-rt-content .index{font-size:small;margin-left:.2em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .index1{font-size:small;margin-left:1em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .index2{font-size:small;margin-left:2em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .cover{text-align:center}#sbo-rt-content .top{border-top:1.1px solid black;border-bottom:2px solid black}#sbo-rt-content .bot{border-bottom:2px solid black}#sbo-rt-content table.bodytable,#sbo-rt-content table{border-collapse:collapse;margin-bottom:8px;font-size:small;margin-top:10pt;width:95%;border-top:0 solid black;border-bottom:0 solid black}#sbo-rt-content table.fmtable{margin-bottom:1em;font-size:1em;margin-left:4em;border-top:0 solid #FFF;border-bottom:0 solid #FFF}#sbo-rt-content table{margin-bottom:1em;border-top:1.1px solid black;border-bottom:1.1px solid black;border-collapse:collapse}#sbo-rt-content th{border-top:1px solid black;border-bottom:1px solid black;padding-right:1.5em}#sbo-rt-content td{font-size:small;vertical-align:top;padding-right:1.5em;margin-top:0;margin-bottom:1em}#sbo-rt-content .tablepara{font-size:small;text-indent:0;margin-top:0;margin-bottom:.5em;padding-right:1.5em}#sbo-rt-content .tablepara1{font-size:small;margin-left:2em;margin-top:0;margin-bottom:0;padding-right:1.5em}#sbo-rt-content .header{border-bottom:1.1px solid black;text-indent:0;text-align:left}#sbo-rt-content .TabCapt{font-style:italic;margin-left:0;text-indent:0}#sbo-rt-content .FigCapt{font-style:italic;font-size:.9em}#sbo-rt-content .CaptNr{font-weight:bold}#sbo-rt-content .ttitle{font-style:Italic;margin-bottom:1em}#sbo-rt-content p.paraaftertitle1{font-size:.9em;text-indent:0;margin-top:.5em;margin-bottom:.8em;text-align:left}#sbo-rt-content p.para{font-size:small;text-indent:20px;margin-top:0;margin-bottom:0;text-align:justify}#sbo-rt-content p.quote{font-style:italic;font-size:100%;margin-top:1.5em;margin-left:2.5em;margin-right:2.5em;margin-bottom:0}#sbo-rt-content p.quotesource{font-size:small;text-indent:0;margin-top:1em;margin-bottom:1em;text-align:right}#sbo-rt-content p.chaptersubtitle{font-size:x-large;text-indent:0;margin-top:0;margin-left:0;margin-bottom:0;text-align:left}#sbo-rt-content p.line{margin-top:.3em;border-bottom:1px solid black}#sbo-rt-content p.line1{margin-top:.3em;margin-bottom:1.5em;border-bottom:1px solid black}#sbo-rt-content p.line2{margin-top:5em;margin-bottom:5em;border-bottom:1px solid black;text-align:center;margin-left:15em;margin-right:15em}#sbo-rt-content li{margin-bottom:.5em;margin-top:.5em}#sbo-rt-content p.alpha{font-size:1.2em;font-weight:bold;margin-left:.2em;margin-top:1em;margin-bottom:.3em;text-align:left}#sbo-rt-content ul.bulleted{font-size:100%;text-align:justify;margin-left:2.5em;margin-right:3em;margin-top:1em;margin-bottom:1em;text-indent:0}#sbo-rt-content ol.OrderedList{font-size:100%;text-align:left;margin-left:2.5em;margin-right:3em;margin-top:1em;margin-bottom:1em}#sbo-rt-content ul.bulleted1{font-size:100%;text-align:left;margin-left:1em;margin-right:5em;margin-top:1em;margin-bottom:1em;list-style-type:none}#sbo-rt-content ul.bulleted1_a{font-size:100%;text-align:justify;margin-left:0;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0;list-style-type:none}#sbo-rt-content ul.bulleted2{font-size:100%;text-align:justify;margin-left:2.3em;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0}#sbo-rt-content ul.bulleted4{font-size:100%;text-align:center;margin-left:1.3em;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0;list-style-type:none}#sbo-rt-content .numbered{font-size:small;text-align:justify;margin-left:2em;margin-right:2em;margin-top:.5em;margin-bottom:.5em;text-indent:1em}#sbo-rt-content .bulletedin{font-size:100%;text-align:justify;margin-left:4em;margin-right:4em;margin-top:.5em;margin-bottom:.5em}#sbo-rt-content ul.None{font-size:.9em;text-align:justify;margin-left:3em;margin-right:2em;margin-top:.5em;margin-bottom:.5em;list-style-type:none}#sbo-rt-content .Listing{font-size:small;margin-bottom:0}#sbo-rt-content .PCode1{font-size:small;margin-top:.7em;margin-bottom:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode2{font-size:small;margin-top:1em;margin-bottom:.1em;margin-left:2.2em;text-align:left;font-family:monospace}#sbo-rt-content .PCode3{font-size:small;margin-top:0;margin-left:2.2em;margin-bottom:.1em;text-align:left;font-family:monospace}#sbo-rt-content .NoteCaption{font-size:small;margin-top:1.3em;margin-left:5em;margin-right:5em;border:1.1px solid black;padding:.5em;margin-bottom:1.3em}#sbo-rt-content .Table{font-size:100%;margin-bottom:1em;margin-left:0}#sbo-rt-content .toc{font-size:1.1em;margin-top:.2em;margin-bottom:.2em;text-align:left;font-weight:bold}#sbo-rt-content .toca{font-size:1.1em;margin-top:.8em;margin-bottom:.4em;text-align:left;font-weight:bold}#sbo-rt-content .toc1{font-size:1.1em;margin-top:.4em;margin-bottom:.3em;text-align:left;text-indent:1.4em;font-weight:normal}#sbo-rt-content .toc2{font-size:1.2em;margin-top:.4em;margin-bottom:.3em;text-align:left;font-weight:bold}#sbo-rt-content .toc3{font-size:.9em;margin-top:.4em;margin-bottom:.3em;text-align:left;text-indent:3.5em;font-weight:normal}#sbo-rt-content .toc4{font-size:1.1em;margin-top:.2em;margin-bottom:.5em;text-align:left;font-weight:bold}#sbo-rt-content .tocch{font-size:1.3em;margin-top:.7em;margin-bottom:.7em;text-align:left;font-weight:bold}#sbo-rt-content .noborder{margin-bottom:1em;border-top:0 solid #FFF;border-bottom:0 solid #FFF}#sbo-rt-content .authurright{text-align:right;margin-top:0;margin-bottom:0}#sbo-rt-content .FormalPara{font-size:small;margin-bottom:.7em}#sbo-rt-content .FontName1{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content span.FontName2{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content span.FontName3{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content .rightarrow{margin-top:0}#sbo-rt-content div.thinline{margin-top:1em;margin-bottom:1em;border-top:solid 4px #AFAFB0;border-bottom:solid 4px #AFAFB0}#sbo-rt-content span.line{text-decoration:underline}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content div.box{border-top:solid 2px;border-bottom:solid 2px}#sbo-rt-content .app{font-size:150%;margin-left:.8em}#sbo-rt-content .page{text-decoration:none;color:#000}#sbo-rt-content .cXXX{text-decoration:none;color:#000}#sbo-rt-content .textindent{margin-left:1.7em;margin-top:1em;margin-bottom:1em;font-size:100%}#sbo-rt-content .textindent1{margin-left:1.7em;margin-top:0;margin-bottom:0;font-size:100%}#sbo-rt-content .textindent2{margin-left:1.7em;margin-top:0;margin-bottom:0;font-size:100%;text-indent:1em}#sbo-rt-content p.FootNote{margin-top:.8em;margin-bottom:0;font-size:85%;text-indent:0;text-align:left;margin-left:1.1em;margin-right:1.1em}#sbo-rt-content pre{margin-left:0;font-family:monospace;white-space:pre-wrap}#sbo-rt-content p.Heading4a{font-size:1.15em;font-weight:bold;text-indent:1em;margin-top:1.3em;margin-bottom:.3em;border-top:3px solid #4d4d4c;border-left:solid 3px #4d4d4c;border-right:solid 3px #4d4d4c;border-bottom:solid 3px #4d4d4c;text-align:center}#sbo-rt-content p.noindent8{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:1em;text-align:center;font-weight:bold;color:#8A8A8A}#sbo-rt-content .tocb{font-size:1.4em;margin-top:.5em;margin-bottom:.2em;text-align:left;font-weight:bold}#sbo-rt-content .part{font-weight:normal;font-size:1em;margin-bottom:5px;text-align:left;padding-left:1.3em;padding-bottom:10em;padding-right:1.3em;border:1.1px solid black}#sbo-rt-content p.Heading5{font-size:1em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;text-align:center}#sbo-rt-content p.noindent5s{font-size:100%;text-indent:0;margin-top:.1em;margin-bottom:.1em;margin-left:0;margin-right:0;text-align:right}#sbo-rt-content span.strike{text-decoration:line-through}
    </style><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9781430260585/chapter/9781430260585_Ch05.xhtml",
          "book_id": "9781430260585",
          "chapter_uri": "9781430260585_Ch05.xhtml",
          "position": 0,
          "user_uuid": "29525685-85c9-45c7-9eda-3c178d86398e",
          "next_chapter_uri": "/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch06.xhtml"
        
      },
      title: "Node.js Recipes: A Problem\u002DSolution Approach",
      author_list: "Cory Gackenheimer",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: false,
      show_ios_app_teaser: false
    };
    // ]]></script><script src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/modernizr.js"></script><script>
    
      
        

        

        
          
            window.PUBLIC_ANNOTATIONS = true;
          
        

      

      
        window.MOBILE_PUBLIC_ANNOTATIONS = false;
      

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

    
      window.PRIVACY_CONTROL_SWITCH = true;
    

    
      window.PUBLISHER_PAGES = true;
    

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "https://www.safaribooksonline.com/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://www.safaribooksonline.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml"><meta name="description" content="CHAPTER 5 Using Events and Child Processes As you have already seen in this book, Node.js has a robust framework for handling many routines and important tasks. In this ... "><meta property="og:title" content="CHAPTER 5: Using Events and Child Processes"><meta itemprop="isPartOf" content="/library/view/nodejs-recipes-a/9781430260585/"><meta itemprop="name" content="CHAPTER 5: Using Events and Child Processes"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781430260585/"><meta property="og:description" itemprop="description" content="CHAPTER 5 Using Events and Child Processes As you have already seen in this book, Node.js has a robust framework for handling many routines and important tasks. In this ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Apress"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781430260585"><meta property="og:book:author" itemprop="author" content="Cory Gackenheimer"><meta property="og:book:tag" itemprop="about" content="JavaScript"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript>&lt;meta http-equiv="refresh" content="0; url=/library/no-js/" /&gt;</noscript><script type="text/javascript">
  (function(i,s,o,g,r,a,m) {
    i['GoogleAnalyticsObject']=r;
    i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();
    a=s.createElement(o),m=s.getElementsByTagName(o)[0];
    a.async=1;
    a.src=g;
    m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  var matches = document.cookie.match(/BrowserCookie\s*=\s*([a-f0-9\-]{36})/),
      user_uuid = null;

  if (matches && matches.length === 2) {
    user_uuid = matches[1];
  }


  ga('create', 'UA-39299553-7', {'userId': '29525685-85c9-45c7-9eda-3c178d86398e' });


ga('set', 'dimension1', 'Trial');
ga('set', 'dimension6', user_uuid);


  ga('set', 'dimension2', '29525685-85c9-45c7-9eda-3c178d86398e');
  






  //enable enhanced link tracking
  ga('require', 'linkid', 'linkid.js');

  // reading interface will track pageviews itself
  if (document.location.pathname.indexOf("/library/view") !== 0) {
    ga('send', 'pageview');
  }
</script><script defer="" src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/vendor.34024413b1d4.js"></script><script defer="" src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/reader.a05323b190d3.js"></script><script async="" src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/MathJax.js"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts subscribe-panel library">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        





<a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>
              
                Queue
              
            </span></a></li><li class="search"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" width="20" height="20" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>offers icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M35.9 20.6L27 15.5C26.1 15 24.7 15 23.7 15.5L14.9 20.6C13.9 21.1 13.2 22.4 13.2 23.4L13.2 41.4C13.2 42.4 13.9 43.7 14.9 44.2L23.3 49C24.2 49.5 25.6 49.5 26.6 49L35.9 43.6C36.8 43.1 37.6 41.8 37.6 40.8L37.6 23.4C37.6 22.4 36.8 21.1 35.9 20.6L35.9 20.6ZM40 8.2C39.1 7.6 37.6 7.6 36.7 8.2L30.2 11.9C29.3 12.4 29.3 13.2 30.2 13.8L39.1 18.8C40 19.4 40.7 20.6 40.7 21.7L40.7 39C40.7 40.1 41.4 40.5 42.4 40L48.2 36.6C49.1 36.1 49.8 34.9 49.8 33.8L49.8 15.6C49.8 14.6 49.1 13.3 48.2 12.8L40 8.2 40 8.2ZM27 10.1L33.6 6.4C34.5 5.9 34.5 5 33.6 4.5L26.6 0.5C25.6 0 24.2 0 23.3 0.5L16.7 4.2C15.8 4.7 15.8 5.6 16.7 6.1L23.7 10.1C24.7 10.6 26.1 10.6 27 10.1ZM10.1 21.7C10.1 20.6 10.8 19.4 11.7 18.8L20.6 13.8C21.5 13.2 21.5 12.4 20.6 11.9L13.6 7.9C12.7 7.4 11.2 7.4 10.3 7.9L1.6 12.8C0.7 13.3 0 14.6 0 15.6L0 33.8C0 34.9 0.7 36.1 1.6 36.6L8.4 40.5C9.3 41 10.1 40.6 10.1 39.6L10.1 21.7 10.1 21.7Z"></path></g></svg><span>Offers &amp; Deals</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletters</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/001o00000169U9HAAU/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" width="20" height="20" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://www.safaribooksonline.com/public/support" class="l1 no-icon">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a><span class="l2 t-nag-notification" id="nav-nag"><strong class="trial-green">10</strong> days left in your trial.
  
  

  
    
      

<a class="" href="https://www.safaribooksonline.com/subscribe/">Subscribe</a>.


    
  

  

</span></li><li><a href="https://www.safaribooksonline.com/public/support" class="l2">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Node.js Recipes: A Problem-Solution Approach
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781430260585/chapter/9781430260585_Ch05.xhtml" data-for-analytics="9781430260585:9781430260585_Ch05.xhtml"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml&amp;text=Node.js%20Recipes%3A%20A%20Problem-Solution%20Approach&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20CHAPTER%205%3A%20Using%20Events%20and%20Child%20Processes&amp;body=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml%0D%0Afrom%20Node.js%20Recipes%3A%20A%20Problem-Solution%20Approach%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
        
        



 <!--[if lt IE 9]>
  
<![endif]-->



  <script defer="" src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/djangoMessagesPage.845b17d78025.js"></script>


        
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">CHAPTER 4: Building a Web Server</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch06.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">CHAPTER 6: Implementing Security and Cryptography</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content" style="transform: none;"><div class="annotator-wrapper"><p class="ChapterNumber"><a id="Chap_5"></a>CHAPTER 5</p>
<p class="chapimage"><img src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/frontdot.jpg" alt="image" width="82" height="25" data-mfp-src="/library/view/nodejs-recipes-a/9781430260585/images/frontdot.jpg"></p>
<p class="ChapterTitle">Using Events and Child Processes</p>
<div>
<p class="noindent">As you have already seen in this book, Node.js has a robust framework for handling many routines and important tasks. In this chapter you will get a full understanding of a few concepts that you saw in earlier chapters. You will first take an in-depth look at a cornerstone of Node.js, <span class="FontName1">EventEmitters</span>. Regarding these you will see recipes on how to create custom events and add listeners for them, as well as how to create single events. All of this will come together to demonstrate how you can reduce an unending callback nightmare by strategically implementing events in Node.js.</p>
<p class="indent">Next, you will unravel the mysteries that are involved with extending a Node.js process with a child process. You will see how to spawn a child process and how to execute shell commands and files. You will then learn how to fork a process, which will lead us into the ability to cluster processes in Node.js.</p>
<p id="Sec1" class="Heading1">5-1. Creating a Custom Event</p>
<div>
<p id="Sec2" class="Heading2_2">Problem</p>
<p class="noindent">You have created a Node.js application, but you need to communicate within it by emitting a custom event.</p>
</div>
<div>
<p id="Sec3" class="Heading2">Solution</p>
<p class="noindent">In this solution you will create a Node.js application that will demonstrate how to create and listen for custom events. You will create an event that executes after a timeout period has expired. This represents a situation in your application that will occur when an operation completes. This then will call a function, <span class="FontName1">doATask</span>, which will return a status of whether the operation was successful or failed. There are two approaches to accomplish this.</p>
<p class="indent">First, you will create events that are specific to the status. This requires checking the status and creating an event specifically for that status, as well as binding to those specific events to handle the special cases. This is demonstrated in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list1" id="_list1">Listing 5-1</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_list1" id="list1">Listing 5-1</a></i></b>.&nbsp;&nbsp;Custom Events for Individual Statuses</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Custom Events</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var events = require('events'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitter = new events.EventEmitter();</span><br>&nbsp;<br><span class="FontName1">function doATask(status) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (status === 'success') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>emitter.emit('taskSuccess');</b> <span class="FontName1">// Specific event</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else if (status === 'fail') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>emitter.emit('taskFail');</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">}</span><br>&nbsp;<br><span class="FontName1">emitter.on('taskSuccess', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('task success!');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">emitter.on('taskFail', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('task fail');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">// call task with success status</span><br><span class="FontName1">setTimeout(doATask, 500, 'success');</span><br>&nbsp;<br><span class="FontName1">// set task to fail</span><br><span class="FontName1">setTimeout(doATask, 1000, 'fail');</span></pre>
<p class="indent">While you see that this effectively gets the events to propagate appropriately, this still causes you to create two individual events to emit. This can easily be modified to be more streamlined and efficient<a id="cXXX.312"></a>, as you will see in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list2" id="_list2">Listing 5-2</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_list2" id="list2">Listing 5-2</a></i></b>.&nbsp;&nbsp;One Emitter to Rule Them All</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Custom Events</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var events = require('events'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitter = new events.EventEmitter();</span><br>&nbsp;<br><span class="FontName1">function doATask(status) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// This event passes arguments to detail status</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>emitter.emit('taskComplete', 'complete', status);</b><br><span class="FontName1">}</span><br>&nbsp;<br><span class="FontName1">// register listener for task complete</span><br><span class="FontName1">emitter.on('taskComplete', function(type, status) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('the task is ', type, ' with status ', status);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">// call task with success status</span><br><span class="FontName1">setTimeout(doATask, 500, 'success');</span><br>&nbsp;<br><span class="FontName1">// set task to fail</span><br><span class="FontName1">setTimeout(doATask, 1000, 'fail');</span></pre>
<p class="indent">This is a much leaner and more efficient implementation. You can emit a single event that will work for multiple states in your application. In these examples you have seen an implementation in which the events are all handled and emitted from the same source file. In <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list3" id="_list3">Listing 5-3</a> you see an example of sharing an event emitter to emit an event that will be received in a module outside of the current module.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_list3" id="list3">Listing 5-3</a></i></b>.&nbsp;&nbsp;Emitting Module<a id="cXXX.313"></a></p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Custom Events</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var events = require('events'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitter = new events.EventEmitter(),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">myModule = require('./5-1-3.js')(emitter);</span><br>&nbsp;<br><span class="FontName1">emitter.on('custom', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('custom event received');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">emitter.emit('custom');</span></pre>
<p class="indent">One other way in which you are able to create custom events for your application is to utilize the global process object. This Node.js object is an <span class="FontName1">EventEmitter</span>, and it will allow you to register events that will be shared within the process. This type of event is emitted from the code from <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list4" id="_list4">Listing 5-4</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_list4" id="list4">Listing 5-4</a></i></b>.&nbsp;&nbsp;Emitting an Event on the Node.js Process<a id="cXXX.314"></a></p>
<pre><span class="FontName1">/* Module.js file */</span><br><span class="FontName1">var myMod = module.exports = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitEvent: function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">process.emit('globalEvent');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">};</span></pre>
</div>
<div>
<p id="Sec4" class="Heading2">How It Works</p>
<p class="noindent">In this example you saw multiple ways in which you are able to create custom events<a id="cXXX.111q"></a>. These events can be emitted anywhere there is a Node.js <span class="FontName1">EventEmitter</span>. The Node.js <span class="FontName1">EventEmitter</span> class is one of the cornerstones of communication between and within the modules that make up your application.</p>
<p class="indent">The first thing that you encounter when you build an event is the <span class="FontName1">EventEmitter</span> class. This class consists of an object collection of events that refer to the different types of events that are registered. The concept of type is simply the name that you give your event such as <span class="FontName1">taskComplete</span> or <span class="FontName1">taskFail</span>. This is important when you actually emit the event using the <span class="FontName1">EventEmitter's</span> emit method<a id="cXXX.315"></a>.</p>
<p class="noindent2"><b><i>Listing 5-5</i></b>.&nbsp;&nbsp;EventEmitter’s Emit Method</p>
<pre><span class="FontName1">EventEmitter.prototype.emit = function(type) {</span><br>&nbsp;&nbsp;<span class="FontName1">var er, handler, len, args, i, listeners;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (!this._events)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._events = {};</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">// If there is no 'error' event listener then throw.</span><br>&nbsp;&nbsp;<span class="FontName1">if (type === 'error') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (!this._events.error ||</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">(typeof this._events.error === 'object' &amp;&amp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">!this._events.error.length)) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">er = arguments[1];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (this.domain) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (!er) er = new TypeError('Uncaught, unspecified "error" event.');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">er.domainEmitter = this;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">er.domain = this.domain;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">er.domainThrown = false;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.domain.emit('error', er);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else if (er instanceof Error) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">throw er; // Unhandled 'error' event</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">throw TypeError('Uncaught, unspecified "error" event.');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return false;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">handler = this._events[type];</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (typeof handler === 'undefined')</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return false;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (this.domain &amp;&amp; this !== process)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.domain.enter();</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (typeof handler === 'function') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">switch (arguments.length) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// fast cases</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 1:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">handler.call(this);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 2:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">handler.call(this, arguments[1]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 3:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">handler.call(this, arguments[1], arguments[2]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// slower</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">default:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">len = arguments.length;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">args = new Array(len - 1);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">for (i = 1; i &lt; len; i++)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">args[i - 1] = arguments[i];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">handler.apply(this, args);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">} else if (typeof handler === 'object') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">len = arguments.length;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">args = new Array(len - 1);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">for (i = 1; i &lt; len; i++)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">args[i - 1] = arguments[i];</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">listeners = handler.slice();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">len = listeners.length;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">for (i = 0; i &lt; len; i++)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">listeners[i].apply(this, args);</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (this.domain &amp;&amp; this !== process)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.domain.exit();</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">return true;</span><br><span class="FontName1">};</span></pre>
<p class="indent">This method consists of two main parts. First, there is the special handling of “error” events. This will emit the error event as you expect, unless there is not a listener for the error event. In this case then Node.js will throw the error and the method will return false. The second part of this method is the portion where nonerror events are handled.</p>
<p class="indent">After checking to make sure that there is a handler for the given event of the specified type, Node.js then checks to see if the event handler is a function. If it is a function, Node.js will parse the arguments from the emit method and apply those to the handler. This is how <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list2">Listing 5-2</a> is able to pass the parameters to the <span class="FontName1">taskComplete</span> event. The extra arguments supplied are applied when the emit method invokes the handler.</p>
<p class="indent">The other solutions all utilize the same emit method, but they get the result of emitting events in different ways. <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list4">Listing 5-4</a> represents a Node.js module that is shared throughout an application. This module contains a function that will emit an event to the rest of the app. The way this is accomplished in this solution is to leverage the knowledge that the main Node.js process is an <span class="FontName1">EventEmitter</span>. This means you simply emit the event by invoking <span class="FontName1">process.emit('globalEvent')</span>, and a portion of the application that is sharing that process will receive the event.</p>
</div>
<p id="Sec5" class="Heading1">5-2. Adding a Listener for Custom Events</p>
<div>
<p id="Sec6" class="Heading2_2">Problem</p>
<p class="noindent">You have emitted custom events in the previous section, but without an appropriate way to bind to these events you are unable to use them. For this you need to add listeners to those events.</p>
</div>
<div>
<p id="Sec7" class="Heading2">Solution</p>
<p class="noindent">This solution is the counterpart to Section 5-1. In the previous section you implemented <span class="FontName1">EventEmitters</span> and emitted the events. Now you need to add listeners for those events so you can handle them in your application. The process is just as simple as emitting events, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list6" id="_list6">Listing 5-6</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_list6" id="list6">Listing 5-6</a></i></b>.&nbsp;&nbsp;Adding Event Listeners to Custom Events and System Events<a id="cXXX.316"></a></p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Custom Events</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var events = require('events'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitter = new events.EventEmitter();</span><br>&nbsp;<br><span class="FontName1">function doATask(status) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (status === 'success') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitter.emit('taskSuccess'); // Specific event</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else if (status === 'fail') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitter.emit('taskFail');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// This event passes arguments to detail status</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitter.emit('taskComplete', 'complete', status);</span><br><span class="FontName1">}</span><br><b>emitter.on('newListener', function(){</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>console.log('a new listener was added');</b><br><b>});</b><br><b>emitter.on('taskSuccess', function() {</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>console.log('task success!');</b><br><b>});</b><br>&nbsp;<br><b>emitter.on('taskFail', function() {</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>console.log('task fail');</b><br><b>});</b><br>&nbsp;<br><b>// register listener for task complete</b><br><b>emitter.on('taskComplete', function(type, status) {</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>console.log('the task is ', type, ' with status ', status);</b><br><b>});</b><br>&nbsp;<br><span class="FontName1">// call task with success status</span><br><span class="FontName1">setTimeout(doATask, 2e3, 'success');</span><br>&nbsp;<br><span class="FontName1">// set task to fail</span><br><span class="FontName1">setTimeout(doATask, 4e3, 'fail');</span></pre>
<p class="indent">You can also pass your <span class="FontName1">EventEmitter</span> to an external module and then listen for events from within that separate section of code.</p>
<p class="noindent2"><b><i>Listing 5-7</i></b>.&nbsp;&nbsp;Event Listening from an External Module<a id="cXXX.317"></a></p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* External Module</span><br><span class="FontName1">*/</span><br><span class="FontName1">module.exports = function(emitter) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitter.on('custom', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('bazinga');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">};</span></pre>
<p class="indent">Just as you had emitted the event by using the Node.js process <span class="FontName1">EventEmitter</span>, you are able to bind listeners to that process and receive the events.</p>
<p class="noindent2"><b><i>Listing 5-8</i></b>.&nbsp;&nbsp;Node.js Processwide Listener</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Global event</span><br><span class="FontName1">*/</span><br><span class="FontName1">var ext = require('./5-1-5.js');</span><br>&nbsp;<br><span class="FontName1">process.on('globalEvent', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('global event');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">ext.emitEvent();</span></pre>
</div>
<div>
<p id="Sec8" class="Heading2">How It Works</p>
<p class="noindent">As you examine the solution in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list6">Listing 5-6</a> you should quickly notice how to go about adding a listener to an event. This is as simple as calling the <span class="FontName1">EventEmitter.on()</span> method<a id="cXXX.318"></a><a id="cXXX.319"></a>. The .<span class="FontName1">on</span> method of the <span class="FontName1">EventEmitter</span> accepts two arguments: first, the event type name; second, the listener callback, which will accept any of the arguments that were passed to the <span class="FontName1">emit()</span> event. The .<span class="FontName1">on</span> method is really just a wrapper to the <span class="FontName1">EventEmitter addListener<a id="cXXX.115r"></a></span> function<a id="cXXX.320"></a><a id="cXXX.321"></a>, which takes the same two arguments. You could call this method directly in place of calling the .<span class="FontName1">on</span> function as they are the same.</p>
<p class="noindent2"><b><i>Listing 5-9</i></b>.&nbsp;&nbsp;EventEmitter addListener</p>
<pre><span class="FontName1">EventEmitter.prototype.addListener = function(type, listener) {</span><br>&nbsp;&nbsp;<span class="FontName1">var m;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (typeof listener !== 'function')</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">throw TypeError('listener must be a function');</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (!this._events)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._events = {};</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">// To avoid recursion in the case that type === "newListener"! Before</span><br>&nbsp;&nbsp;<span class="FontName1">// adding it to the listeners, first emit "newListener".</span><br>&nbsp;&nbsp;<span class="FontName1">if (this._events.newListener)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.emit('newListener', type, typeof listener.listener === 'function' ?</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">listener.listener : listener);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (!this._events[type])</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Optimize the case of one listener. Don't need the extra array object.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._events[type] = listener;</span><br>&nbsp;&nbsp;<span class="FontName1">else if (typeof this._events[type] === 'object')</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// If we've already got an array, just append.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._events[type].push(listener);</span><br>&nbsp;&nbsp;<span class="FontName1">else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Adding the second element, need to change to array.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._events[type] = [this._events[type], listener];</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">// Check for listener leak</span><br>&nbsp;&nbsp;<span class="FontName1">if (typeof this._events[type] === 'object' &amp;&amp; !this._events[type].warned) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var m;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (this._maxListeners !== undefined) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">m = this._maxListeners;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">m = EventEmitter.defaultMaxListeners;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (m &amp;&amp; m &gt; 0 &amp;&amp; this._events[type].length &gt; m) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._events[type].warned = true;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.error('(node) warning: possible EventEmitter memory ' +</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'leak detected. %d listeners added. ' +</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'Use emitter.setMaxListeners() to increase limit.',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._events[type].length);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.trace();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">return this;</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">EventEmitter.prototype.on = EventEmitter.prototype.addListener;</span></pre>
<p class="indent">The <span class="FontName1">addListener</span> method<a id="cXXX.322"></a>, as you can see from the source snippet, accomplishes several tasks. First, after verifying that the listener callback is a function, the <span class="FontName1">addListener</span> method emits its own event ‘<span class="FontName1">newListener</span>’ in order to signify that a new listener of a given type has been added.</p>
<p class="indent">The second thing that happens is the <span class="FontName1">addListener</span> function<a id="cXXX.323"></a> will push the listener function to the event to which it is bound. In the previous section, this function is what became the handler function for each event type. The <span class="FontName1">emit()</span> function will then either <span class="FontName1">.call()</span> or <span class="FontName1">.apply()</span> to that function, depending on the number of arguments that are provided by the emitter itself.</p>
<p class="indent">Lastly in the <span class="FontName1">addListener</span> function<a id="cXXX.324"></a>, you will find that Node.js is very kind and attempts to protect you from potential memory leaks. It does this by checking to see if the number of listeners exceeds a predefined limit that defaults to 10. You can, of course, configure this to be a higher number by using the <span class="FontName1">setMaxListeners()</span> method<a id="cXXX.325"></a> as instructed by the helpful warning that appears once you exceed this number of listeners.</p>
</div>
<p id="Sec9" class="Heading1">5-3. Implementing a One-time Event</p>
<div>
<p id="Sec10" class="Heading2_2">Problem</p>
<p class="noindent">You need to implement an event in your Node.js application that you only wish to execute one time.</p>
</div>
<div>
<p id="Sec11" class="Heading2">Solution</p>
<p class="noindent">Imagine that you have an application that has an important task to accomplish. This task needs to be accomplished, but only one time. Imagine that you have an event that listens for a member of a chat room who will either exit the application or disconnect. This event only needs to be handled once. It wouldn’t make sense for this event to be broadcast to other users of the application twice, so you limit the number of times you handle the event.</p>
<p class="indent">There are two ways to do this. One is to manually handle registering the event and then remove the event listener once the event has been received once.</p>
<p class="noindent2"><b><i>Listing 5-10</i></b>.&nbsp;&nbsp;Registering an Event Listener Once, Manually</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Implementing a One time event</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var events = require('events'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitter = new events.EventEmitter();</span><br>&nbsp;<br><span class="FontName1">function listener() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('one Timer');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitter.removeListener('oneTimer', listener);</span><br><span class="FontName1">}</span><br><span class="FontName1">emitter.on('oneTimer', listener);</span><br>&nbsp;<br><span class="FontName1">emitter.emit('oneTimer');</span><br><span class="FontName1">emitter.emit('oneTimer');</span></pre>
<p class="indent">This requires a secondary call within the listener function in order to be able to remove the listener from the event. This can become unwieldy as the project grows, so Node.js has a native implementation for the same effect.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_list11" id="list11">Listing 5-11</a></i></b>.&nbsp;&nbsp;emtter.once()<a id="cXXX.326"></a></p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Implementing a One-time event</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var events = require('events'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">emitter = new events.EventEmitter();</span><br>&nbsp;<br><span class="FontName1">/* EASIER */</span><br>&nbsp;<br><span class="FontName1">emitter.once('onceOnly', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('one Only');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">emitter.emit('onceOnly');</span><br><span class="FontName1">emitter.emit('onceOnly');</span></pre>
</div>
<div>
<p id="Sec12" class="Heading2">How It Works</p>
<p class="noindent">The first example of registering an event listener to bind only once to the emitted event is quite clear to see and understand. You first bind to the event with a function callback for the listener. You then handle that callback within the listener and remove that listener from the event. This prevents any further handlings of the event from the same emitter.</p>
<p class="indent">This works because of the <span class="FontName1">removeListener</span> method<a id="cXXX.327"></a><a id="cXXX.328"></a>, which accepts an event type and a specific listener function.</p>
<p class="noindent2"><b><i>Listing 5-12</i></b>.&nbsp;&nbsp;EventEmitter removeListener method</p>
<pre><span class="FontName1">EventEmitter.prototype.removeListener = function(type, listener) {</span><br>&nbsp;&nbsp;<span class="FontName1">var list, position, length, i;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (typeof listener !== 'function')</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">throw TypeError('listener must be a function');</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (!this._events || !this._events[type])</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return this;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">list = this._events[type];</span><br>&nbsp;&nbsp;<span class="FontName1">length = list.length;</span><br>&nbsp;&nbsp;<span class="FontName1">position = -1;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (list === listener ||</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">(typeof list.listener === 'function' &amp;&amp; list.listener === listener)) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._events[type] = undefined;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (this._events.removeListener)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.emit('removeListener', type, listener);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">} else if (typeof list === 'object') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">for (i = length; i-- &gt; 0;) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (list[i] === listener ||</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">(list[i].listener &amp;&amp; list[i].listener === listener)) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">position = i;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (position &lt; 0)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return this;</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (list.length === 1) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">list.length = 0;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this._events[type] = undefined;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">list.splice(position, 1);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (this._events.removeListener)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.emit('removeListener', type, listener);</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">return this;</span><br><span class="FontName1">};</span></pre>
<p class="indent">The <span class="FontName1">removeListener</span> function<a id="cXXX.329"></a><a id="cXXX.330"></a> will target the specific event that you need to remove by recursively searching through the events object in order to find the type and function combination that you are searching for. It will then remove the event binding so that the listener will no longer be registered on subsequent events.</p>
<p class="indent">A similar method to your handmade emit once function is the <span class="FontName1">EventEmitter.once</span> method<a id="cXXX.331"></a><a id="cXXX.332"></a>.</p>
<p class="noindent2"><b><i>Listing 5-13</i></b>.&nbsp;&nbsp;EventEmitter once method</p>
<pre><span class="FontName1">EventEmitter.prototype.once = function(type, listener) {</span><br>&nbsp;&nbsp;<span class="FontName1">if (typeof listener !== 'function')</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">throw TypeError('listener must be a function');</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">function g() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.removeListener(type, g);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">listener.apply(this, arguments);</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">g.listener = listener;</span><br>&nbsp;&nbsp;<span class="FontName1">this.on(type, g);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">return this;</span><br><span class="FontName1">};</span></pre>
<p class="indent">This method accepts the listener and the event type that you wish to bind to one time. It then creates an internal function that will then apply the listener. Before this listener is called in the internal function, the actual listener is removed from the event. This works just as your custom one-time method works, because it removes the listener the first time that the event executes.</p>
<p class="indent">In the next section we will investigate how to incorporate using these events and custom events in general to reduce the amount of callbacks in your Node.js application.</p>
</div>
<p id="Sec13" class="Heading1">5-4. Reducing Callbacks Using Events</p>
<div>
<p id="Sec14" class="Heading2_2">Problem</p>
<p class="noindent">You have a Node.js application that has multiple callback functions<a id="cXXX.333"></a>. This code has become a little unwieldy so you would like to reduce the callbacks by utilizing <span class="FontName1">EventEmitter</span>.</p>
</div>
<div>
<p id="Sec15" class="Heading2">Solution</p>
<p class="noindent">Imagine a shopping application that has to access data from a database, manipulate that data, then refresh the database and send the status back to the client. This could be fetching a shopping cart, adding an item, and letting the customer know that the cart has been updated. The first example of this is written using callbacks.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_list14" id="list14">Listing 5-14</a></i></b>.&nbsp;&nbsp;Shopping Cart Using Callbacks</p>
<pre><span class="FontName1">var initialize = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">retrieveCart(function(err, data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) console.log(err);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">data['new'] = 'other thing';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">updateCart(data, function(err, result) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) console.log(err);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">sendResults(result, function(err, status) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) console.log(err);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(status);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">// simulated call to a database</span><br><span class="FontName1">var retrieveCart = function(callback) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var data = { item: 'thing' };</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return callback(null, data );</span><br><span class="FontName1">};</span><br><span class="FontName1">// simulated call to a database</span><br><span class="FontName1">var updateCart = function(data, callback) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return callback(null, data);</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var sendResults = function(data, callback) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return callback(null, 'Cart Updated');</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">initialize();</span></pre>
<p class="indent">First, understand that there is nothing wrong with using callbacks in Node.js. In fact, it is probably the most popular way to handle asynchronous programming in Node.js. However, you can also see that, in the case where you have a nontrivial amount of callbacks that must happen in succession such as in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list14" id="_list14">Listing 5-14</a>, the code can become less easy to follow. To rectify this you can incorporate events to manage the application flow in an arguably more concise way.</p>
<p class="noindent2"><b><i>Listing 5-15</i></b>.&nbsp;&nbsp;Using Events Instead of Callbacks</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Reducing callbacks</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var events = require('events');</span><br>&nbsp;<br><span class="FontName1">var MyCart = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.data = { item: 'thing' };</span><br><span class="FontName1">};</span><br><span class="FontName1">MyCart.prototype = new events.EventEmitter();</span><br>&nbsp;<br><span class="FontName1">MyCart.prototype.retrieveCart = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//Fetch Data then emit</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.emit('data', this.data);</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">MyCart.prototype.updateCart = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Update data then emit</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.emit('result', this.data);</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">MyCart.prototype.sendResults = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(this.data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.emit('complete');</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var cart = new MyCart();</span><br>&nbsp;<br><span class="FontName1">cart.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">cart.data['new'] = 'other thing';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">cart.updateCart();</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">cart.on('result', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">cart.sendResults(data);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">cart.on('complete', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('Cart Updated');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">cart.retrieveCart();</span></pre>
<p class="indent">With the different solutions to the same task, both utilize a similar amount of code, but the amount of callback has been reduced considerably by moving to an event-driven module instead of the callback flow.</p>
</div>
<div>
<p id="Sec16" class="Heading2">How It Works</p>
<p class="noindent">Using callback exclusively can become a burden when you want to examine the code that is critical to your application. This can also cause a headache to developers who are contributing to your project, because they might not be as familiar with the project to know where the given callback function is nested. This can also become a problem when you wish to refactor your application to add another method to execute during a callback. These are all reasons that you might choose to move to the event-driven model.</p>
<p class="indent">In the event-driven solution from <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list11" id="_list11">Listing 5-11</a>, you start off by creating a new object called <span class="FontName1">MyCart</span>. You can assume <span class="FontName1">MyCart</span> initializes with an item stored in it, <span class="FontName1">MyCart</span>.<span class="FontName1">data</span>. Your <span class="FontName1">MyCart</span> object then inherits the <span class="FontName1">events</span>.<span class="FontName1">EventEmitter</span> object. This now means that <span class="FontName1">MyCart</span> can send and receive data through the Node.js event module.</p>
<p class="indent">Now that your object can emit and listen for events, you augment your object by making methods that utilize the <span class="FontName1">EventEmitter</span>. For example, you created a <span class="FontName1">retrieveCart</span> method<a id="cXXX.334"></a>, which would fetch data from a data store; once completed, the ‘<span class="FontName1">data</span>’ event is emitted, passing along any data retrieved from the cart. Similarly you create an <span class="FontName1">updateCart</span> method and a <span class="FontName1">sendResults</span> method that will alert the client of the result of the update.</p>
<p class="indent">You then instantiate a new instance of <span class="FontName1">MyCart</span>. This new cart can now bind to the events that will be sent from the <span class="FontName1">MyCart</span> object. You have a separate function to handle each of the events. This makes the code much more maintainable and in many cases more extensible. For example, say you need to add another logging function to <span class="FontName1">MyCart</span>. You can now bind that to each event and log the interactions without rewriting the entire callback flow.</p>
</div>
<p id="Sec17" class="Heading1">5-5. Spawning a Child with .spawn<a id="cXXX.335"></a></p>
<div>
<p id="Sec18" class="Heading2_2">Problem</p>
<p class="noindent">You need to create a child process<a id="cXXX.121c"></a> to execute an auxiliary action in your Node.js application.</p>
</div>
<div>
<p id="Sec19" class="Heading2">Solution</p>
<p class="noindent">There are many reasons why you would want to spawn a child process from your Node.js application. Several of these could simply be to execute a command-line task without the need to require or build an entire module for the application. In this solution you will highlight two command-line applications and a third solution that will execute another Node.js process from the spawn method<a id="cXXX.336"></a>.</p>
<p class="noindent2"><b><i>Listing 5-16</i></b>.&nbsp;&nbsp;Spawning Children</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* .spawn</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var spawn = require('child_process').spawn,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">pwd = spawn('pwd'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ls = spawn('ls', ['-G']),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">nd = spawn('node', ['5-4-1.js']);</span><br>&nbsp;<br><span class="FontName1">pwd.stdout.setEncoding('utf8');</span><br>&nbsp;<br><span class="FontName1">pwd.stdout.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(data);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">pwd.stderr.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(data);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">pwd.on('close', function(){</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('closed');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">ls.stdout.setEncoding('utf8');</span><br>&nbsp;<br><span class="FontName1">ls.stdout.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(data);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">nd.stdout.setEncoding('utf8');</span><br>&nbsp;<br><span class="FontName1">nd.stdout.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(data);</span><br><span class="FontName1">});</span></pre>
<p class="indent">The first spawn is to just run the ‘<span class="FontName1">pwd</span>’ command in the current directory; the second is to list all the files in that directory. These are just command-line utilities built into the operating system. However, the third example in this solution executes the command to run a Node.js file; then, like the previous examples, you log the output to the console.</p>
</div>
<div>
<p id="Sec20" class="Heading2">How It Works</p>
<p class="noindent">Spawning is one method for invoking a child process in Node.js and is a method of the <span class="FontName1">child_process</span> module. The <span class="FontName1">child_process</span> module creates a way to stream data through <span class="FontName1">stdout</span>, <span class="FontName1">stdin</span>, and <span class="FontName1">stderr</span>. Because of the nature of this module this can be done in a nonblocking way, fitting nicely into the Node.js model.</p>
<p class="indent">The <span class="FontName1">child_process</span> spawn method will instantiate a <span class="FontName1">ChildProcess</span> object, which is a Node.js <span class="FontName1">EventEmitter</span>. The events that are associated with the <span class="FontName1">ChildProcess</span> object are shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#Tab1" id="_Tab1">Table 5-1</a>.</p>
<div class="Table">
<p class="TabCapt">
<span class="CaptNr">
<a id="Tab1" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_Tab1">Table 5-1</a>. </span>ChildProcess Events </p>
<table>
<thead>
<tr class="header">
<th>Event</th>
<th>Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td> ‘message’</td>
<td> Transfers a message object, which is JSON, or a value. This can also transfer a socket or server object as an optional second parameter.</td>
</tr>
<tr>
<td> ‘error’</td>
<td> Transmits the error to the callback. This can happen when the child process fails to spawn, is unable to be killed, or the message transfer fails.</td>
</tr>
<tr>
<td> ‘close’</td>
<td> Happens when all of the stdio streams of the child process are completed. This will transmit the exit code and the signal that was sent with it.</td>
</tr>
<tr>
<td> ‘disconnect’</td>
<td> Emits when you terminate a connection by utilizing the .disconnect() method on the child (or parent).</td>
</tr>
<tr>
<td> ‘exit’</td>
<td> Emits after the child process ends. If the process terminated normally, code is the final exit code of the process, otherwise null. If the process terminated due to receipt of a signal, signal is the string name of the signal, otherwise null.</td>
</tr>
</tbody>
</table>
</div>
<p class="indent">Aside from these <span class="FontName1">ChildProcess</span> events, the spawned child is also a stream, as you saw above. The stream contains the data from the standard I/O of the child processes. The methods that are associated with these streams are outlined in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#Tab2" id="_Tab2">Table 5-2</a> along with other methods on the child.</p>
<div class="Table">
<p class="TabCapt">
<span class="CaptNr">
<a id="Tab2" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_Tab2">Table 5-2</a>. </span>Stream Events of the Child Process and Other Methods </p>
<table>
<thead>
<tr class="header">
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td> .stdin</td>
<td> A writable stream that is representative of the child process stdin.</td>
</tr>
<tr>
<td> .stdout</td>
<td> A readable stream representing the stdout of the child process.</td>
</tr>
<tr>
<td> .stderr</td>
<td> A readable stream of the stderr of the child process.</td>
</tr>
<tr>
<td> .pid</td>
<td> The child process process identifier (PID).</td>
</tr>
<tr>
<td> .kill</td>
<td> Kills a process, optionally sends the termination signal.</td>
</tr>
<tr>
<td> .disconnect</td>
<td> Disconnects from the parent.</td>
</tr>
<tr>
<td> .send</td>
<td> Sends a message to a .fork’d process. (There is more detail on this in Section 5-8.)</td>
</tr>
</tbody>
</table>
</div>
<p class="indent">Now that you have a little more understanding of what the <span class="FontName1">ChildProcess</span> is and how that fits into the <span class="FontName1">child_process</span> module, you can see that your solution of spawning a child process invokes the process directly. You create three spawned processes. Each of these begins with a command argument. This argument, ‘<span class="FontName1">pwd</span>,’ ‘<span class="FontName1">ls</span>,’ ‘<span class="FontName1">node</span>’ is the command that will be executed as if you were running it on the command line in your terminal application. The next argument in the <span class="FontName1">child_process.spawn</span> method is an optional array of arguments to pass to the command argument.</p>
<p class="indent">You see then that the spawned processes from this example are the same as running the following in the command line of your terminal:</p>
<pre><span class="FontName1">$ pwd &amp;</span><br><span class="FontName1">$ ls –G &amp;</span><br><span class="FontName1">$ node 5-4-1.js &amp;</span></pre>
<p class="indent">You can read the output of these commands from your spawned process as well. This happens by listening to the <span class="FontName1">child_process.stdout</span> stream. If you bind to the data event you see the standard output of these commands just as if you were running the command in the terminal. In the case of the third spawn, you see the output from the entire module from the previous section of this chapter.</p>
<p class="indent">There is also an optional third argument that can be present in the <span class="FontName1">child_process.spawn</span> method. This argument represents the set of options to help set up the spawned process. These options can have the values shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#Tab3" id="_Tab3">Table 5-3</a>.</p>
<div class="Table">
<p class="TabCapt">
<span class="CaptNr">
<a id="Tab3" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_Tab3">Table 5-3</a>. </span>Spawn Options </p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td> cwd</td>
<td> String</td>
<td> Current working directory of the child process.</td>
</tr>
<tr>
<td> stdio</td>
<td> Array or string</td>
<td> The stdio configuration of the child process.</td>
</tr>
<tr>
<td> customFds</td>
<td> Array</td>
<td> Deprecated functionality.</td>
</tr>
<tr>
<td> env</td>
<td> Object</td>
<td> Environment key-value pairs.</td>
</tr>
<tr>
<td> detached</td>
<td> Boolean</td>
<td> This child process will become a group leader.</td>
</tr>
<tr>
<td> uid</td>
<td> Number</td>
<td> Sets the user identity of the process.</td>
</tr>
<tr>
<td> gid</td>
<td> Number</td>
<td> Sets the group identity of the process.</td>
</tr>
</tbody>
</table>
</div>
</div>
<p id="Sec21" class="Heading1">5-6. Running Shell Commands with .exec<a id="cXXX.337"></a><a id="cXXX.338"></a></p>
<div>
<p id="Sec22" class="Heading2_2">Problem</p>
<p class="noindent">You want to directly execute a shell command as a child process from your Node.js application.</p>
</div>
<div>
<p id="Sec23" class="Heading2">Solution</p>
<p class="noindent">In the previous section, you saw how you could easily spawn a child process by using the <span class="FontName1">child_process</span> module. This could be a long-running process where you then wish to access the <span class="FontName1">stdio</span> streams that are available on the process. Similar to this is the <span class="FontName1">child_process.exec</span> method. The difference between these two methods is that the .spawn method will return all the data as a stream, whereas the .exec method returns data as a buffer. With this method you can execute a shell command, <span class="FontName1">cmd.exe</span> in Windows or <span class="FontName1">/bin/sh</span> elsewhere, directly from your Node.js application. With the solution in this section, you will list a set of files and log the result of that operation to the console. You will then search your system for all running processes that contain the word node, again logging the output to your console.</p>
<p class="noindent2"><b><i>Listing 5-17</i></b>.&nbsp;&nbsp;.exec</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Running Shell commands with .exec</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var exec = require('child_process').exec;</span><br>&nbsp;<br><span class="FontName1">exec('ls -g', function(error, stdout, stderr) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (error) console.log(error);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(stdout);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">exec('ps ax | grep node', function(error, stdout, stderr) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (error) console.log(error);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(stdout);</span><br><span class="FontName1">});</span></pre>
</div>
<div>
<p id="Sec24" class="Heading2">How It Works</p>
<p class="noindent">This solution works by leveraging the aspects of both the <span class="FontName1">child_process.spawn</span> method and the <span class="FontName1">child_process.execFile</span> method that you will examine in the next section. Essentially, when you tell the <span class="FontName1">child_process</span> to use the <span class="FontName1">exec</span> method, you are telling it to run a process with the <span class="FontName1">/bin/sh</span> file (<span class="FontName1">cmd.exe</span> on Windows) as the executable.</p>
<p class="noindent2"><b><i>Listing 5-18</i></b>.&nbsp;&nbsp;Child Process .exec Function</p>
<pre><span class="FontName1">exports.exec = function(command /*, options, callback */) {</span><br>&nbsp;&nbsp;<span class="FontName1">var file, args, options, callback;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (typeof arguments[1] === 'function') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">options = undefined;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">callback = arguments[1];</span><br>&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">options = arguments[1];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">callback = arguments[2];</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (process.platform === 'win32') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<b>file = 'cmd.exe';</b><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">args = ['/s', '/c', '"' + command + '"'];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Make a shallow copy before patching so we don't clobber the user's</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// options object.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">options = util._extend({}, options);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">options.windowsVerbatimArguments = true;</span><br>&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<b>file = '/bin/sh';</b><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">args = ['-c', command];</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<b>return exports.execFile(file, args, options, callback);</b><br><span class="FontName1">};</span></pre>
<p class="indent">This function does, in fact, call the <span class="FontName1">execFile</span> method. You will see in the next section that this means the process spawns based on the file parameter passed to the function.</p>
<pre><b>var</b>
<span class="FontName1">child</span>
<b>=</b>
<span class="FontName1">spawn(file, args, {</span><br>&nbsp;&nbsp;<span class="FontName1">cwd</span>
<b>:</b>
<span class="FontName1">options.cwd,</span><br>&nbsp;&nbsp;<span class="FontName1">env</span>
<b>:</b>
<span class="FontName1">options.env,</span><br>&nbsp;&nbsp;<span class="FontName1">windowsVerbatimArguments</span>
<b>: !!</b>
<span class="FontName1">options.windowsVerbatimArguments</span><br><span class="FontName1">});</span></pre>
<p class="indent">This means that anything you want to run in the command line, you can run via <span class="FontName1">exec</span>. That is why when you attempt to run the <span class="FontName1">exec</span> function as <span class="FontName1">ps ax | grep node</span> to identify all running processes that contain the word node in them, you see the <span class="FontName1">stdout</span> results just as you would if you had run it in the shell.</p>
<pre><span class="FontName1">17774 s001&nbsp;&nbsp;S+&nbsp;&nbsp;&nbsp;&nbsp; 0:00.06 node 5-6-1.js</span><br><span class="FontName1">17776 s001&nbsp;&nbsp;S+&nbsp;&nbsp;&nbsp;&nbsp; 0:00.00 /bin/sh -c ps ax | grep node</span><br><span class="FontName1">17778 s001&nbsp;&nbsp;S+&nbsp;&nbsp;&nbsp;&nbsp; 0:00.00 grep node</span><br><span class="FontName1">11503 s002&nbsp;&nbsp;S+&nbsp;&nbsp;&nbsp;&nbsp; 0:00.07 node</span></pre>
</div>
<p id="Sec25" class="Heading1">5-7. Executing Shell Files with .execFile<a id="cXXX.339"></a><a id="cXXX.340"></a></p>
<div>
<p id="Sec26" class="Heading2_2">Problem</p>
<p class="noindent">Within your application, you need to execute a file as a child process to your Node.js process.</p>
</div>
<div>
<p id="Sec27" class="Heading2">Solution</p>
<p class="noindent">You are already somewhat familiar with this method of the <span class="FontName1">child_process</span> module. In this solution, you have a shell script that contains several steps that you wish to execute from your Node.js application. These could be done in Node.js directly either by spawning them or calling the <span class="FontName1">.exec</span> method. However, by calling them once as a file you can group them together and still get the benefit of having their combined output buffered to the callback function of <span class="FontName1">execFile</span>. You can see in the next two listings the example Node.js application and the file that is to be executed.</p>
<p class="noindent2"><b><i>Listing 5-19</i></b>.&nbsp;&nbsp;Using .execFile</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* execFile</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var execFile = require('child_process').execFile;</span><br>&nbsp;<br><span class="FontName1">execFile('./5-7-1.sh', function(error, stdout, stderr) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(stdout);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(stderr);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(error);</span><br><span class="FontName1">});</span></pre>
<p class="noindent2"><b><i>Listing 5-20</i></b>.&nbsp;&nbsp;Shell File to Execute</p>
<pre><span class="FontName1">#!/bin/sh</span><br><span class="FontName1">echo "running this shell script from child_process.execFile"</span><br><span class="FontName1"># run another node process</span><br><span class="FontName1">node 5-6-1.js</span><br><span class="FontName1"># and another</span><br><span class="FontName1">node 5-5-1.js</span><br>&nbsp;<br><span class="FontName1">ps ax | grep node</span></pre>
</div>
<div>
<p id="Sec28" class="Heading2">How It Works</p>
<p class="noindent">As you begin to examine how the <span class="FontName1">execFile</span> method works, you quickly realize it is a derivative of the <span class="FontName1">.spawn</span> method. This method is quite intricate and does a lot of things in order to execute a file. First, the <span class="FontName1">execFile</span> function will accept four arguments. The first is the file and is required to find the file and path to execute.</p>
<p class="indent">The second is the args array, which will pass the arguments to the file to be executed; the third consists of the particular options to set on the spawned process; and the fourth is a callback. The options, as you can see, are defaulted to common settings such as utf8 encoding, timeout set to zero, and the others as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list21" id="_list21">Listing 5-21</a>. This callback is just like the callback available from <span class="FontName1">child_process.exec</span> in that it passes a buffered set of <span class="FontName1">error</span>, <span class="FontName1">stdout</span>, and <span class="FontName1">stderr</span> to the function and you are able to consume those streams directly from the callback.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_list21" id="list21">Listing 5-21</a></i></b>.&nbsp;&nbsp;Setting File, Args, and Options of execFile</p>
<pre><span class="FontName1">exports.execFile = function(file /* args, options, callback */) {</span><br>&nbsp;&nbsp;<span class="FontName1">var args, optionArg, callback;</span><br>&nbsp;&nbsp;<span class="FontName1">var options = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">encoding: 'utf8',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">timeout: 0,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">maxBuffer: 200 * 1024,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">killSignal: 'SIGTERM',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">cwd: null,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">env: null</span><br>&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">// Parse the parameters.</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (typeof arguments[arguments.length - 1] === 'function') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">callback = arguments[arguments.length - 1];</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (Array.isArray(arguments[1])) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">args = arguments[1];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">options = util._extend(options, arguments[2]);</span><br>&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">args = [];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">options = util._extend(options, arguments[1]);</span><br>&nbsp;&nbsp;<span class="FontName1">}</span></pre>
<p class="indent">Node.js now spawns the child process by passing in the options object. The child that is spawned is then passed along through various event listeners and callbacks in order to get the <span class="FontName1">stdio</span> streams aggregated into the callback function that is provided to the <span class="FontName1">execFile</span> method before returning the child itself, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#list22" id="_list22">Listing 5-22</a>. This is a difference from the .spawn method that would return the <span class="FontName1">stdout</span> and <span class="FontName1">stderr</span> streams directly. Here, using the .<span class="FontName1">exec</span> method you are returning a buffer that is created from the <span class="FontName1">stdout</span> and <span class="FontName1">stderr</span> streams.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#_list22" id="list22">Listing 5-22</a></i></b>.&nbsp;&nbsp;Spawning execFile</p>
<pre>&nbsp;&nbsp;<span class="FontName1">var child = spawn(file, args, {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">cwd: options.cwd,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">env: options.env,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">windowsVerbatimArguments: !!options.windowsVerbatimArguments</span><br>&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">var stdout = '';</span><br>&nbsp;&nbsp;<span class="FontName1">var stderr = '';</span><br>&nbsp;&nbsp;<span class="FontName1">var killed = false;</span><br>&nbsp;&nbsp;<span class="FontName1">var exited = false;</span><br>&nbsp;&nbsp;<span class="FontName1">var timeoutId;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">var err;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">function exithandler(code, signal) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (exited) return;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">exited = true;</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (timeoutId) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clearTimeout(timeoutId);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">timeoutId = null;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (!callback) return;</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">callback(err, stdout, stderr);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else if (code === 0 &amp;&amp; signal === null) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">callback(null, stdout, stderr);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var e = new Error('Command failed: ' + stderr);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">e.killed = child.killed || killed;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">e.code = code;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">e.signal = signal;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">callback(e, stdout, stderr);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">function errorhandler(e) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">err = e;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">child.stdout.destroy();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">child.stderr.destroy();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">exithandler();</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">function kill() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">child.stdout.destroy();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">child.stderr.destroy();</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">killed = true;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">try {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">child.kill(options.killSignal);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} catch (e) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">err = e;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">exithandler();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (options.timeout &gt; 0) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">timeoutId = setTimeout(function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">kill();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">timeoutId = null;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}, options.timeout);</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">child.stdout.setEncoding(options.encoding);</span><br>&nbsp;&nbsp;<span class="FontName1">child.stderr.setEncoding(options.encoding);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">child.stdout.addListener('data', function(chunk) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">stdout += chunk;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (stdout.length &gt; options.maxBuffer) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">err = new Error('stdout maxBuffer exceeded.');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">kill();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">child.stderr.addListener('data', function(chunk) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">stderr += chunk;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (stderr.length &gt; options.maxBuffer) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">err = new Error('stderr maxBuffer exceeded.');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">kill();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">child.addListener('close', exithandler);</span><br>&nbsp;&nbsp;<span class="FontName1">child.addListener('error', errorhandler);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">return child;</span><br><span class="FontName1">};</span></pre>
</div>
<p id="Sec29" class="Heading1">5-8. Using .fork<a id="cXXX.341"></a><a id="cXXX.342"></a> for Interprocess Communication </p>
<div>
<p id="Sec30" class="Heading2_2">Problem</p>
<p class="noindent">You need to create a child process in Node.js but you also need to be able to easily communicate between these child processes.</p>
</div>
<div>
<p id="Sec31" class="Heading2">Solution</p>
<p class="noindent">The solution to using the fork method to communicate between processes is straightforward. You will build a main process that will create an HTTP server. This process will also fork a child process and pass the server object to that child. The child will then be able to process requests from that server even though the server was not created on the child process. The server object and all messages are sent to the child process via the .<span class="FontName1">send()</span> method.</p>
<p class="noindent2"><b><i>Listing 5-23</i></b>.&nbsp;&nbsp;Parent Process</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* .fork main</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var cp = require('child_process');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">http = require('http');</span><br>&nbsp;<br><span class="FontName1">var child = cp.fork('5-8-2.js');</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(req, res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end('hello');</span><br><span class="FontName1">}).listen(8080);</span><br>&nbsp;<br><span class="FontName1">child.send('hello');</span><br><span class="FontName1">child.send('server', server);</span></pre>
<p class="noindent2"><b><i>Listing 5-24</i></b>.&nbsp;&nbsp;Forked Process</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* forked process</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">process.on('message', function(msg, hndl) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(msg);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (msg === 'server') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">hndl.on('connection', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connected on the child');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br><span class="FontName1">});</span></pre>
</div>
<div>
<p id="Sec32" class="Heading2">How It Works</p>
<p class="noindent">Creating a forked process is nearly identical to that of making a spawned process, as you saw in Section 5-5. The main difference is the cross-process communication that is made available by the <span class="FontName1">child.send</span> method.</p>
<p class="indent">This <span class="FontName1">send</span> event sends a message string and an optional handle. The handle can be one of five types: <span class="FontName1">net.Socket, net.Server, net.Native, dgram.Socket, or dgram.Native</span>. At first glance this could be daunting to have to accommodate these different types of methods. Fortunately, Node.js converts the handle types for you. This handling also applies to the response from the spawned processes.</p>
<p class="indent">The event that occurs when a message is sent to the child process is the ‘<span class="FontName1">message</span>’ event. In this solution you saw that the ‘<span class="FontName1">message</span>’ event contained the named type of the message. First you sent a greeting message. Next you sent a server object. This object was then bound to the ‘<span class="FontName1">connection</span>’ event once the event was determined to be a server. You then handled the connection just as you would in a single process module.</p>
</div>
<p id="Sec33" class="Heading1">Summary</p>
<p class="noindent">In this chapter you investigated and implemented solutions for two important modules that are native to Node.js: events and child processes.</p>
<p class="indent">In the events module you first created a custom event, then you solved how to bind to that event with a listener. After that you examined the special case of adding a one-time event listener when you only want one binding. Finally, you were able to see how, utilizing the Node.js event module, you can very clearly reduce the amount of callbacks by using events to drive functionality.</p>
<p class="indent">In the second part of this chapter you examined the child process module. You first saw how to spawn a child process to run a command outside of the main process. Then you saw how to directly run shell commands and files by using the <span class="FontName1">exec</span> and <span class="FontName1">execFile</span> methods. These both derived from the spawn process, as did the <span class="FontName1">.fork()</span> process, which is a special case of spawn that allows for simple interprocess communication, providing limitless possibilities for multiprocess Node.js applications.</p>
</div>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#">
			
				Add Note
			
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">CHAPTER 4: Building a Web Server</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch06.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">CHAPTER 6: Implementing Security and Cryptography</div>
        </a>
    
  
  </div>


        
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781430260585/chapter/9781430260585_Ch05.xhtml" data-for-analytics="9781430260585:9781430260585_Ch05.xhtml">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel  collapsed slideUp">
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" class="js-toggle-nag ss-navigateup" title="Toggle open or close footer"></a>
        <div class="sample-message">
          <p class="usage-data t-collapsed-text">Enjoy Safari?
            <a class="ga-active-trial-subscribe-nag" href="https://www.safaribooksonline.com/subscribe/">
              Subscribe Today
              
            </a>
          </p>
          

        <div class="expanded">
          <h2>You have 10 days left in your trial, Raviguru0007. </h2>
          <p class="t-expanded-text">Safari is your trusted guide for building a remarkable career. We hope you've been enjoying your trial—ready to join?</p>
          <a href="https://www.safaribooksonline.com/subscribe/" class="button-primary">
            Subscribe Today
            
          </a>
          
          <footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
    <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" class="icon-up" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/contact/">Contact Us</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
    </ul>
    <span class="copyright">© 2017 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/membership-agreement/">Membership Agreement</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>

        </div>
      </div>
    </div>

    
    



        
      </div>
      




  <footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
    <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" class="icon-up" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2017 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>

<script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"queueTime":0,"beacon":"bam.nr-data.net","errorBeacon":"bam.nr-data.net","licenseKey":"510f1a6865","agent":"","applicationTime":326,"applicationID":"3275661","transactionName":"YgdaZ0NSW0cEB0RdWltNfkZfUEFdCgofXFBHDVYdR1pQQxZeRl1QQj1aWkU="}</script>


    

    <script src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/saved_resource" charset="utf-8"></script>
    <script src="./CHAPTER 5_ Using Events and Child Processes - Node.js Recipes_ A Problem-Solution Approach_files/saved_resource(1)" charset="utf-8"></script>
  

<div class="annotator-notice annotator-notice-show annotator-notice-error">Sorry we could not read the annotations from the store</div><div class="font-flyout" style="top: 200.003px; left: 1217px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml#">Reset</a>
</div>
</div></body></html>