<!DOCTYPE html>
<!-- saved from url=(0102)https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="1573407" data-user-uuid="29525685-85c9-45c7-9eda-3c178d86398e" data-username="raviguru0007" data-account-type="Trial" data-activated-trial-date="04/17/2017" data-archive="9781430260585" data-publishers="Apress" data-htmlfile-name="9781430260585_Ch04.xhtml" data-epub-title="Node.js Recipes: A Problem-Solution Approach" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781430260585"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><script type="text/javascript" src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/510f1a6865"></script><script src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/nr-spa-1026.min.js"></script><script type="text/javascript" async="" src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/linkid.js"></script><script async="" src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/analytics.js"></script><script type="text/javascript">(window.NREUM||(NREUM={})).loader_config={xpid:"VQQDUVVVGwACU1RUAQA="};window.NREUM||(NREUM={}),__nr_require=function(t,e,n){function r(n){if(!e[n]){var o=e[n]={exports:{}};t[n][0].call(o.exports,function(e){var o=t[n][1][e];return r(o||e)},o,o.exports)}return e[n].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,e,n){function r(t){try{c.console&&console.log(t)}catch(e){}}var o,i=t("ee"),a=t(19),c={};try{o=localStorage.getItem("__nr_flags").split(","),console&&"function"==typeof console.log&&(c.console=!0,o.indexOf("dev")!==-1&&(c.dev=!0),o.indexOf("nr_dev")!==-1&&(c.nrDev=!0))}catch(s){}c.nrDev&&i.on("internal-error",function(t){r(t.stack)}),c.dev&&i.on("fn-err",function(t,e,n){r(n.stack)}),c.dev&&(r("NR AGENT IN DEVELOPMENT MODE"),r("flags: "+a(c,function(t,e){return t}).join(", ")))},{}],2:[function(t,e,n){function r(t,e,n,r,o){try{d?d-=1:i("err",[o||new UncaughtException(t,e,n)])}catch(c){try{i("ierr",[c,s.now(),!0])}catch(u){}}return"function"==typeof f&&f.apply(this,a(arguments))}function UncaughtException(t,e,n){this.message=t||"Uncaught error with no additional information",this.sourceURL=e,this.line=n}function o(t){i("err",[t,s.now()])}var i=t("handle"),a=t(20),c=t("ee"),s=t("loader"),f=window.onerror,u=!1,d=0;s.features.err=!0,t(1),window.onerror=r;try{throw new Error}catch(p){"stack"in p&&(t(12),t(11),"addEventListener"in window&&t(6),s.xhrWrappable&&t(13),u=!0)}c.on("fn-start",function(t,e,n){u&&(d+=1)}),c.on("fn-err",function(t,e,n){u&&(this.thrown=!0,o(n))}),c.on("fn-end",function(){u&&!this.thrown&&d>0&&(d-=1)}),c.on("internal-error",function(t){i("ierr",[t,s.now(),!0])})},{}],3:[function(t,e,n){t("loader").features.ins=!0},{}],4:[function(t,e,n){function r(){C++,N=y.hash,this[u]=M.now()}function o(){C--,y.hash!==N&&i(0,!0);var t=M.now();this[l]=~~this[l]+t-this[u],this[d]=t}function i(t,e){x.emit("newURL",[""+y,e])}function a(t,e){t.on(e,function(){this[e]=M.now()})}var c="-start",s="-end",f="-body",u="fn"+c,d="fn"+s,p="cb"+c,h="cb"+s,l="jsTime",m="fetch",v="addEventListener",w=window,y=w.location;if(w[v]){var b=t(9),g=t(10),x=t(8),E=t(6),O=t(12),R=t(7),P=t(13),T=t("ee"),S=T.get("tracer");t(14);var M=t("loader");M.features.spa=!0;var N,j=w[v],C=0;T.on(u,r),T.on(p,r),T.on(d,o),T.on(h,o),T.buffer([u,d,"xhr-done","xhr-resolved"]),E.buffer([u]),O.buffer(["setTimeout"+s,"clearTimeout"+c,u]),P.buffer([u,"new-xhr","send-xhr"+c]),R.buffer([m+c,m+"-done",m+f+c,m+f+s]),x.buffer(["newURL"]),b.buffer([u]),g.buffer(["propagate",p,h,"executor-err","resolve"+c]),S.buffer([u,"no-"+u]),a(P,"send-xhr"+c),a(T,"xhr-resolved"),a(T,"xhr-done"),a(R,m+c),a(R,m+"-done"),x.on("pushState-end",i),x.on("replaceState-end",i),j("hashchange",i,!0),j("load",i,!0),j("popstate",function(){i(0,C>1)},!0)}},{}],5:[function(t,e,n){function r(t){}if(window.performance&&window.performance.timing&&window.performance.getEntriesByType){var o=t("ee"),i=t("handle"),a=t(12),c=t(11),s="learResourceTimings",f="addEventListener",u="resourcetimingbufferfull",d="bstResource",p="resource",h="-start",l="-end",m="fn"+h,v="fn"+l,w="bstTimer",y="pushState",b=t("loader");b.features.stn=!0,t(8);var g=NREUM.o.EV;o.on(m,function(t,e){var n=t[0];n instanceof g&&(this.bstStart=b.now())}),o.on(v,function(t,e){var n=t[0];n instanceof g&&i("bst",[n,e,this.bstStart,b.now()])}),a.on(m,function(t,e,n){this.bstStart=b.now(),this.bstType=n}),a.on(v,function(t,e){i(w,[e,this.bstStart,b.now(),this.bstType])}),c.on(m,function(){this.bstStart=b.now()}),c.on(v,function(t,e){i(w,[e,this.bstStart,b.now(),"requestAnimationFrame"])}),o.on(y+h,function(t){this.time=b.now(),this.startPath=location.pathname+location.hash}),o.on(y+l,function(t){i("bstHist",[location.pathname+location.hash,this.startPath,this.time])}),f in window.performance&&(window.performance["c"+s]?window.performance[f](u,function(t){i(d,[window.performance.getEntriesByType(p)]),window.performance["c"+s]()},!1):window.performance[f]("webkit"+u,function(t){i(d,[window.performance.getEntriesByType(p)]),window.performance["webkitC"+s]()},!1)),document[f]("scroll",r,{passive:!0}),document[f]("keypress",r,!1),document[f]("click",r,!1)}},{}],6:[function(t,e,n){function r(t){for(var e=t;e&&!e.hasOwnProperty(u);)e=Object.getPrototypeOf(e);e&&o(e)}function o(t){c.inPlace(t,[u,d],"-",i)}function i(t,e){return t[1]}var a=t("ee").get("events"),c=t(22)(a,!0),s=t("gos"),f=XMLHttpRequest,u="addEventListener",d="removeEventListener";e.exports=a,"getPrototypeOf"in Object?(r(document),r(window),r(f.prototype)):f.prototype.hasOwnProperty(u)&&(o(window),o(f.prototype)),a.on(u+"-start",function(t,e){var n=t[1],r=s(n,"nr@wrapped",function(){function t(){if("function"==typeof n.handleEvent)return n.handleEvent.apply(n,arguments)}var e={object:t,"function":n}[typeof n];return e?c(e,"fn-",null,e.name||"anonymous"):n});this.wrapped=t[1]=r}),a.on(d+"-start",function(t){t[1]=this.wrapped||t[1]})},{}],7:[function(t,e,n){function r(t,e,n){var r=t[e];"function"==typeof r&&(t[e]=function(){var t=r.apply(this,arguments);return o.emit(n+"start",arguments,t),t.then(function(e){return o.emit(n+"end",[null,e],t),e},function(e){throw o.emit(n+"end",[e],t),e})})}var o=t("ee").get("fetch"),i=t(19);e.exports=o;var a=window,c="fetch-",s=c+"body-",f=["arrayBuffer","blob","json","text","formData"],u=a.Request,d=a.Response,p=a.fetch,h="prototype";u&&d&&p&&(i(f,function(t,e){r(u[h],e,s),r(d[h],e,s)}),r(a,"fetch",c),o.on(c+"end",function(t,e){var n=this;e?e.clone().arrayBuffer().then(function(t){n.rxSize=t.byteLength,o.emit(c+"done",[null,e],n)}):o.emit(c+"done",[t],n)}))},{}],8:[function(t,e,n){var r=t("ee").get("history"),o=t(22)(r);e.exports=r,o.inPlace(window.history,["pushState","replaceState"],"-")},{}],9:[function(t,e,n){var r=t("ee").get("mutation"),o=t(22)(r),i=NREUM.o.MO;e.exports=r,i&&(window.MutationObserver=function(t){return this instanceof i?new i(o(t,"fn-")):i.apply(this,arguments)},MutationObserver.prototype=i.prototype)},{}],10:[function(t,e,n){function r(t){var e=a.context(),n=c(t,"executor-",e),r=new f(n);return a.context(r).getCtx=function(){return e},a.emit("new-promise",[r,e],e),r}function o(t,e){return e}var i=t(22),a=t("ee").get("promise"),c=i(a),s=t(19),f=NREUM.o.PR;e.exports=a,f&&(window.Promise=r,["all","race"].forEach(function(t){var e=f[t];f[t]=function(n){function r(t){return function(){a.emit("propagate",[null,!o],i),o=o||!t}}var o=!1;s(n,function(e,n){Promise.resolve(n).then(r("all"===t),r(!1))});var i=e.apply(f,arguments),c=f.resolve(i);return c}}),["resolve","reject"].forEach(function(t){var e=f[t];f[t]=function(t){var n=e.apply(f,arguments);return t!==n&&a.emit("propagate",[t,!0],n),n}}),f.prototype["catch"]=function(t){return this.then(null,t)},f.prototype=Object.create(f.prototype,{constructor:{value:r}}),s(Object.getOwnPropertyNames(f),function(t,e){try{r[e]=f[e]}catch(n){}}),a.on("executor-start",function(t){t[0]=c(t[0],"resolve-",this),t[1]=c(t[1],"resolve-",this)}),a.on("executor-err",function(t,e,n){t[1](n)}),c.inPlace(f.prototype,["then"],"then-",o),a.on("then-start",function(t,e){this.promise=e,t[0]=c(t[0],"cb-",this),t[1]=c(t[1],"cb-",this)}),a.on("then-end",function(t,e,n){this.nextPromise=n;var r=this.promise;a.emit("propagate",[r,!0],n)}),a.on("cb-end",function(t,e,n){a.emit("propagate",[n,!0],this.nextPromise)}),a.on("propagate",function(t,e,n){this.getCtx&&!e||(this.getCtx=function(){if(t instanceof Promise)var e=a.context(t);return e&&e.getCtx?e.getCtx():this})}),r.toString=function(){return""+f})},{}],11:[function(t,e,n){var r=t("ee").get("raf"),o=t(22)(r),i="equestAnimationFrame";e.exports=r,o.inPlace(window,["r"+i,"mozR"+i,"webkitR"+i,"msR"+i],"raf-"),r.on("raf-start",function(t){t[0]=o(t[0],"fn-")})},{}],12:[function(t,e,n){function r(t,e,n){t[0]=a(t[0],"fn-",null,n)}function o(t,e,n){this.method=n,this.timerDuration="number"==typeof t[1]?t[1]:0,t[0]=a(t[0],"fn-",this,n)}var i=t("ee").get("timer"),a=t(22)(i),c="setTimeout",s="setInterval",f="clearTimeout",u="-start",d="-";e.exports=i,a.inPlace(window,[c,"setImmediate"],c+d),a.inPlace(window,[s],s+d),a.inPlace(window,[f,"clearImmediate"],f+d),i.on(s+u,r),i.on(c+u,o)},{}],13:[function(t,e,n){function r(t,e){d.inPlace(e,["onreadystatechange"],"fn-",c)}function o(){var t=this,e=u.context(t);t.readyState>3&&!e.resolved&&(e.resolved=!0,u.emit("xhr-resolved",[],t)),d.inPlace(t,v,"fn-",c)}function i(t){w.push(t),l&&(b=-b,g.data=b)}function a(){for(var t=0;t<w.length;t++)r([],w[t]);w.length&&(w=[])}function c(t,e){return e}function s(t,e){for(var n in t)e[n]=t[n];return e}t(6);var f=t("ee"),u=f.get("xhr"),d=t(22)(u),p=NREUM.o,h=p.XHR,l=p.MO,m="readystatechange",v=["onload","onerror","onabort","onloadstart","onloadend","onprogress","ontimeout"],w=[];e.exports=u;var y=window.XMLHttpRequest=function(t){var e=new h(t);try{u.emit("new-xhr",[e],e),e.addEventListener(m,o,!1)}catch(n){try{u.emit("internal-error",[n])}catch(r){}}return e};if(s(h,y),y.prototype=h.prototype,d.inPlace(y.prototype,["open","send"],"-xhr-",c),u.on("send-xhr-start",function(t,e){r(t,e),i(e)}),u.on("open-xhr-start",r),l){var b=1,g=document.createTextNode(b);new l(a).observe(g,{characterData:!0})}else f.on("fn-end",function(t){t[0]&&t[0].type===m||a()})},{}],14:[function(t,e,n){function r(t){var e=this.params,n=this.metrics;if(!this.ended){this.ended=!0;for(var r=0;r<d;r++)t.removeEventListener(u[r],this.listener,!1);if(!e.aborted){if(n.duration=a.now()-this.startTime,4===t.readyState){e.status=t.status;var i=o(t,this.lastSize);if(i&&(n.rxSize=i),this.sameOrigin){var s=t.getResponseHeader("X-NewRelic-App-Data");s&&(e.cat=s.split(", ").pop())}}else e.status=0;n.cbTime=this.cbTime,f.emit("xhr-done",[t],t),c("xhr",[e,n,this.startTime])}}}function o(t,e){var n=t.responseType;if("json"===n&&null!==e)return e;var r="arraybuffer"===n||"blob"===n||"json"===n?t.response:t.responseText;return l(r)}function i(t,e){var n=s(e),r=t.params;r.host=n.hostname+":"+n.port,r.pathname=n.pathname,t.sameOrigin=n.sameOrigin}var a=t("loader");if(a.xhrWrappable){var c=t("handle"),s=t(15),f=t("ee"),u=["load","error","abort","timeout"],d=u.length,p=t("id"),h=t(18),l=t(17),m=window.XMLHttpRequest;a.features.xhr=!0,t(13),f.on("new-xhr",function(t){var e=this;e.totalCbs=0,e.called=0,e.cbTime=0,e.end=r,e.ended=!1,e.xhrGuids={},e.lastSize=null,h&&(h>34||h<10)||window.opera||t.addEventListener("progress",function(t){e.lastSize=t.loaded},!1)}),f.on("open-xhr-start",function(t){this.params={method:t[0]},i(this,t[1]),this.metrics={}}),f.on("open-xhr-end",function(t,e){"loader_config"in NREUM&&"xpid"in NREUM.loader_config&&this.sameOrigin&&e.setRequestHeader("X-NewRelic-ID",NREUM.loader_config.xpid)}),f.on("send-xhr-start",function(t,e){var n=this.metrics,r=t[0],o=this;if(n&&r){var i=l(r);i&&(n.txSize=i)}this.startTime=a.now(),this.listener=function(t){try{"abort"===t.type&&(o.params.aborted=!0),("load"!==t.type||o.called===o.totalCbs&&(o.onloadCalled||"function"!=typeof e.onload))&&o.end(e)}catch(n){try{f.emit("internal-error",[n])}catch(r){}}};for(var c=0;c<d;c++)e.addEventListener(u[c],this.listener,!1)}),f.on("xhr-cb-time",function(t,e,n){this.cbTime+=t,e?this.onloadCalled=!0:this.called+=1,this.called!==this.totalCbs||!this.onloadCalled&&"function"==typeof n.onload||this.end(n)}),f.on("xhr-load-added",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&!this.xhrGuids[n]&&(this.xhrGuids[n]=!0,this.totalCbs+=1)}),f.on("xhr-load-removed",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&this.xhrGuids[n]&&(delete this.xhrGuids[n],this.totalCbs-=1)}),f.on("addEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-added",[t[1],t[2]],e)}),f.on("removeEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-removed",[t[1],t[2]],e)}),f.on("fn-start",function(t,e,n){e instanceof m&&("onload"===n&&(this.onload=!0),("load"===(t[0]&&t[0].type)||this.onload)&&(this.xhrCbStart=a.now()))}),f.on("fn-end",function(t,e){this.xhrCbStart&&f.emit("xhr-cb-time",[a.now()-this.xhrCbStart,this.onload,e],e)})}},{}],15:[function(t,e,n){e.exports=function(t){var e=document.createElement("a"),n=window.location,r={};e.href=t,r.port=e.port;var o=e.href.split("://");!r.port&&o[1]&&(r.port=o[1].split("/")[0].split("@").pop().split(":")[1]),r.port&&"0"!==r.port||(r.port="https"===o[0]?"443":"80"),r.hostname=e.hostname||n.hostname,r.pathname=e.pathname,r.protocol=o[0],"/"!==r.pathname.charAt(0)&&(r.pathname="/"+r.pathname);var i=!e.protocol||":"===e.protocol||e.protocol===n.protocol,a=e.hostname===document.domain&&e.port===n.port;return r.sameOrigin=i&&(!e.hostname||a),r}},{}],16:[function(t,e,n){function r(){}function o(t,e,n){return function(){return i(t,[f.now()].concat(c(arguments)),e?null:this,n),e?void 0:this}}var i=t("handle"),a=t(19),c=t(20),s=t("ee").get("tracer"),f=t("loader"),u=NREUM;"undefined"==typeof window.newrelic&&(newrelic=u);var d=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],p="api-",h=p+"ixn-";a(d,function(t,e){u[e]=o(p+e,!0,"api")}),u.addPageAction=o(p+"addPageAction",!0),u.setCurrentRouteName=o(p+"routeName",!0),e.exports=newrelic,u.interaction=function(){return(new r).get()};var l=r.prototype={createTracer:function(t,e){var n={},r=this,o="function"==typeof e;return i(h+"tracer",[f.now(),t,n],r),function(){if(s.emit((o?"":"no-")+"fn-start",[f.now(),r,o],n),o)try{return e.apply(this,arguments)}finally{s.emit("fn-end",[f.now()],n)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(t,e){l[e]=o(h+e)}),newrelic.noticeError=function(t){"string"==typeof t&&(t=new Error(t)),i("err",[t,f.now()])}},{}],17:[function(t,e,n){e.exports=function(t){if("string"==typeof t&&t.length)return t.length;if("object"==typeof t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer&&t.byteLength)return t.byteLength;if("undefined"!=typeof Blob&&t instanceof Blob&&t.size)return t.size;if(!("undefined"!=typeof FormData&&t instanceof FormData))try{return JSON.stringify(t).length}catch(e){return}}}},{}],18:[function(t,e,n){var r=0,o=navigator.userAgent.match(/Firefox[\/\s](\d+\.\d+)/);o&&(r=+o[1]),e.exports=r},{}],19:[function(t,e,n){function r(t,e){var n=[],r="",i=0;for(r in t)o.call(t,r)&&(n[i]=e(r,t[r]),i+=1);return n}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],20:[function(t,e,n){function r(t,e,n){e||(e=0),"undefined"==typeof n&&(n=t?t.length:0);for(var r=-1,o=n-e||0,i=Array(o<0?0:o);++r<o;)i[r]=t[e+r];return i}e.exports=r},{}],21:[function(t,e,n){e.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],22:[function(t,e,n){function r(t){return!(t&&t instanceof Function&&t.apply&&!t[a])}var o=t("ee"),i=t(20),a="nr@original",c=Object.prototype.hasOwnProperty,s=!1;e.exports=function(t,e){function n(t,e,n,o){function nrWrapper(){var r,a,c,s;try{a=this,r=i(arguments),c="function"==typeof n?n(r,a):n||{}}catch(f){p([f,"",[r,a,o],c])}u(e+"start",[r,a,o],c);try{return s=t.apply(a,r)}catch(d){throw u(e+"err",[r,a,d],c),d}finally{u(e+"end",[r,a,s],c)}}return r(t)?t:(e||(e=""),nrWrapper[a]=t,d(t,nrWrapper),nrWrapper)}function f(t,e,o,i){o||(o="");var a,c,s,f="-"===o.charAt(0);for(s=0;s<e.length;s++)c=e[s],a=t[c],r(a)||(t[c]=n(a,f?c+o:o,i,c))}function u(n,r,o){if(!s||e){var i=s;s=!0;try{t.emit(n,r,o,e)}catch(a){p([a,n,r,o])}s=i}}function d(t,e){if(Object.defineProperty&&Object.keys)try{var n=Object.keys(t);return n.forEach(function(n){Object.defineProperty(e,n,{get:function(){return t[n]},set:function(e){return t[n]=e,e}})}),e}catch(r){p([r])}for(var o in t)c.call(t,o)&&(e[o]=t[o]);return e}function p(e){try{t.emit("internal-error",e)}catch(n){}}return t||(t=o),n.inPlace=f,n.flag=a,n}},{}],ee:[function(t,e,n){function r(){}function o(t){function e(t){return t&&t instanceof r?t:t?s(t,c,i):i()}function n(n,r,o,i){if(!p.aborted||i){t&&t(n,r,o);for(var a=e(o),c=l(n),s=c.length,f=0;f<s;f++)c[f].apply(a,r);var d=u[y[n]];return d&&d.push([b,n,r,a]),a}}function h(t,e){w[t]=l(t).concat(e)}function l(t){return w[t]||[]}function m(t){return d[t]=d[t]||o(n)}function v(t,e){f(t,function(t,n){e=e||"feature",y[n]=e,e in u||(u[e]=[])})}var w={},y={},b={on:h,emit:n,get:m,listeners:l,context:e,buffer:v,abort:a,aborted:!1};return b}function i(){return new r}function a(){(u.api||u.feature)&&(p.aborted=!0,u=p.backlog={})}var c="nr@context",s=t("gos"),f=t(19),u={},d={},p=e.exports=o();p.backlog=u},{}],gos:[function(t,e,n){function r(t,e,n){if(o.call(t,e))return t[e];var r=n();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(t,e,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return t[e]=r,r}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],handle:[function(t,e,n){function r(t,e,n,r){o.buffer([t],r),o.emit(t,e,n)}var o=t("ee").get("handle");e.exports=r,r.ee=o},{}],id:[function(t,e,n){function r(t){var e=typeof t;return!t||"object"!==e&&"function"!==e?-1:t===window?0:a(t,i,function(){return o++})}var o=1,i="nr@id",a=t("gos");e.exports=r},{}],loader:[function(t,e,n){function r(){if(!x++){var t=g.info=NREUM.info,e=p.getElementsByTagName("script")[0];if(setTimeout(u.abort,3e4),!(t&&t.licenseKey&&t.applicationID&&e))return u.abort();f(y,function(e,n){t[e]||(t[e]=n)}),s("mark",["onload",a()+g.offset],null,"api");var n=p.createElement("script");n.src="https://"+t.agent,e.parentNode.insertBefore(n,e)}}function o(){"complete"===p.readyState&&i()}function i(){s("mark",["domContent",a()+g.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(c=Math.max((new Date).getTime(),c))-g.offset}var c=(new Date).getTime(),s=t("handle"),f=t(19),u=t("ee"),d=window,p=d.document,h="addEventListener",l="attachEvent",m=d.XMLHttpRequest,v=m&&m.prototype;NREUM.o={ST:setTimeout,CT:clearTimeout,XHR:m,REQ:d.Request,EV:d.Event,PR:d.Promise,MO:d.MutationObserver};var w=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-spa-1026.min.js"},b=m&&v&&v[h]&&!/CriOS/.test(navigator.userAgent),g=e.exports={offset:c,now:a,origin:w,features:{},xhrWrappable:b};t(16),p[h]?(p[h]("DOMContentLoaded",i,!1),d[h]("load",r,!1)):(p[l]("onreadystatechange",o),d[l]("onload",r)),s("mark",["firstbyte",c],null,"api");var x=0,E=t(21)},{}]},{},["loader",2,14,5,3,4]);</script><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/css" rel="stylesheet" type="text/css"><title>CHAPTER 4: Building a Web Server - Node.js Recipes: A Problem-Solution Approach</title><link rel="stylesheet" href="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/74741d96e0ae.css" type="text/css"><link rel="stylesheet" type="text/css" href="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/annotator.e34eec1a0d5a.css"><link rel="stylesheet" href="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/font-awesome.min.css"><style type="text/css" title="ibis-book">
    #sbo-rt-content div{margin:1em 1em 1em 1em}#sbo-rt-content a{text-decoration:none}#sbo-rt-content img{max-width:100%;margin-top:10pt}#sbo-rt-content p.booktitle{font-weight:bold;font-size:2.5em;margin-top:2em;margin-bottom:8em;text-align:center}#sbo-rt-content p.bookauthor{font-weight:bold;font-size:1.7em;margin-top:0;margin-right:2em;margin-bottom:0;text-align:left}#sbo-rt-content p.booksubtitle{font-weight:bold;font-size:1.7em;margin-top:0;margin-bottom:7em;text-align:center;color:#8A8A8A}#sbo-rt-content .bookimage{font-size:1.2em;margin-top:0;margin-bottom:1em;text-align:left}#sbo-rt-content .fmpara{font-size:.9em;text-indent:0;margin-top:.5em;margin-bottom:.3em;text-align:justify}#sbo-rt-content .fmpara1{font-size:.9em;text-indent:0;margin-top:.4em;margin-bottom:.3em;text-align:right}#sbo-rt-content .inpara{text-indent:0;margin-top:.4em;margin-left:3em;margin-bottom:.3em}#sbo-rt-content .pub{margin-top:10em;margin-bottom:1em;text-align:right;margin-right:5em}#sbo-rt-content .copyright{font-size:.9em;margin-top:.4em;margin-bottom:.4em;margin-left:1.2em;margin-right:1.2em;text-align:left}#sbo-rt-content .copyright1{font-size:.9em;margin-top:.1em;margin-bottom:.1em;margin-left:4em;margin-right:3.3em;text-align:left;text-indent:-1.6em}#sbo-rt-content .copyright2{font-size:.9em;margin-top:.1em;margin-bottom:.1em;margin-left:4.2em}#sbo-rt-content .dedication{font-size:1.2em;margin-bottom:0;margin-top:3.5em;text-align:center;margin-right:1em;font-style:italic}#sbo-rt-content .dedication1{font-size:1.2em;margin-bottom:0;margin-top:.5em;text-align:center;margin-right:1em;font-style:normal}#sbo-rt-content .dedication2{font-size:1.2em;margin-bottom:0;margin-top:1.5em;text-align:center;margin-right:1em;font-style:italic}#sbo-rt-content .content-title{font-size:1.6em;margin-top:3em;margin-bottom:.1em;text-align:left;font-weight:bold}#sbo-rt-content .fmtitle{font-size:2.5em;margin-top:1em;margin-bottom:1em;text-align:left;font-weight:bold;border-bottom:1.1px solid black;padding-bottom:.8em}#sbo-rt-content .right{text-indent:0;margin-top:1em;margin-right:1.5em;margin-bottom:.3em;text-align:right}#sbo-rt-content .right1{text-indent:0;margin-top:0;margin-right:1.5em;margin-bottom:.2em;text-align:right}#sbo-rt-content .chapimage{margin-left:.2em;margin-top:1.5em;margin-bottom:1.5em;text-align:left}#sbo-rt-content p.ChapterNumber{font-weight:bold;font-size:1.7em;margin-top:10px;margin-left:0;margin-bottom:5px;text-align:left}#sbo-rt-content p.ChapterTitle{font-weight:bold;font-size:2.5em;margin-top:0;margin-bottom:1em;margin-left:0;text-align:left;border-bottom:1.1px solid black;padding-bottom:.8em}#sbo-rt-content p.PartNumber{font-weight:bold;font-size:1.7em;margin-top:10px;margin-left:0;margin-bottom:5px;text-align:left;padding-bottom:.8em}#sbo-rt-content p.partTitle{font-weight:bold;font-size:2.5em;margin-top:1em;margin-bottom:1em;margin-left:0;text-align:left}#sbo-rt-content .paraaftertitle{font-size:100%;text-indent:0;margin-top:0;margin-left:0;margin-bottom:0}#sbo-rt-content p.noindent{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:0;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.noindent1{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:1em}#sbo-rt-content p.noindent2{font-size:100%;text-indent:0;margin-top:1.5em;margin-bottom:1em}#sbo-rt-content p.noindent3{font-size:100%;text-indent:0;margin-top:.8em;margin-bottom:.2em;margin-left:0;margin-right:0;text-align:center}#sbo-rt-content p.noindent4{font-size:100%;text-indent:0;margin-top:.8em;margin-bottom:.2em;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content span.listing{font-weight:bold}#sbo-rt-content p.indent{font-size:100%;text-indent:1.2em;margin-top:.1em;margin-bottom:.1em;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.indent1{font-size:100%;text-indent:1.2em;margin-top:0;margin-bottom:0;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.indent1a{font-size:100%;text-indent:1.5em;margin-top:0;margin-bottom:0;margin-left:0;margin-right:4.5em;text-align:right}#sbo-rt-content p.indent2{font-size:100%;margin-top:.8em;margin-bottom:.8em;margin-left:2.4em;margin-right:2.4em;text-align:justify;font-style:italic}#sbo-rt-content p.indent3{font-size:100%;text-indent:1em;margin-top:.8em;margin-bottom:.8em;margin-left:1.8em;margin-right:1.8em;text-align:left}#sbo-rt-content p.indent4{font-size:100%;text-indent:1.3em;margin-top:.5em;margin-bottom:.5em;margin-left:2em;margin-right:0;text-align:left}#sbo-rt-content .blockquote{font-size:100%;text-indent:.2em;margin-top:1em;margin-left:3em;margin-right:2em;margin-bottom:1em;font-style:italic}#sbo-rt-content .blockquote1{font-size:100%;text-indent:.2em;margin-top:1em;margin-left:3em;margin-bottom:0;font-style:italic}#sbo-rt-content p.Heading1{font-weight:bold;font-size:2em;text-indent:0;margin-top:1.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2{font-size:1.6em;text-indent:0;margin-top:1.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2_2{font-size:1.6em;text-indent:0;margin-top:.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2a{font-size:1.5em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;font-weight:bold}#sbo-rt-content p.Heading3{font-weight:bold;font-size:1.45em;text-indent:0;margin-top:1.2em;margin-bottom:.1em}#sbo-rt-content p.Heading3a{font-weight:normal;font-size:1.25em;text-indent:0;margin-top:1.2em;margin-bottom:.1em}#sbo-rt-content p.Heading4{font-size:1.3em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;text-align:left}#sbo-rt-content .img{max-width:100%;margin-top:10pt}#sbo-rt-content .img1{text-align:left}#sbo-rt-content .img1a{text-align:right;margin-right:5em;margin-top:5em}#sbo-rt-content .img2{text-align:left}#sbo-rt-content div.Figure{font-size:small;margin-top:1.5em;margin-bottom:1.5em}#sbo-rt-content .para-1{font-size:100%;margin-top:1em;text-indent:1.5em;margin-bottom:0;text-align:left}#sbo-rt-content .para-2{font-size:.9em;text-indent:-1.4em;margin-left:2.4em;margin-top:.5em;margin-bottom:0}#sbo-rt-content .figurecaption{font-size:small;margin-top:0;margin-bottom:0;text-align:justify}#sbo-rt-content .image{text-align:center}#sbo-rt-content .codecaption{font-size:100%;margin-top:.6em;margin-bottom:.6em;text-align:justify;font-style:italic}#sbo-rt-content .PCode{font-size:small;margin-top:1em;margin-bottom:1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-1{font-size:small;margin-top:1em;margin-bottom:.1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-2{font-size:small;margin-top:0;margin-bottom:0;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-3{font-size:small;margin-top:0;margin-bottom:1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content div.singlethin{border-bottom:solid 3px;margin-left:1em;margin-right:1em;margin-bottom:1em}#sbo-rt-content div.singlethin1{margin-left:2em;margin-right:2em}#sbo-rt-content .inlinecode{font-family:monospace}#sbo-rt-content div.notepara{font-size:110%;text-indent:0;margin-top:1em;border-top:solid 1px;border-bottom:solid 1px;margin-bottom:1em;text-align:justify}#sbo-rt-content span.pink-box{font-weight:bold;padding-left:1.3em;padding-right:1.3em;border:1.1px solid black;font-size:1.5em;margin-top:.5em;margin-bottom:.5em;text-indent:0;text-align:justify}#sbo-rt-content span.courier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%}#sbo-rt-content div.courier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%;margin-top:1em;margin-bottom:1em}#sbo-rt-content div.boxcourier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%;margin-top:1em;margin-bottom:1em;margin-left:1.5em;margin-right:1.5em;text-align:left}#sbo-rt-content span.courier1{font-family:Courier New;font-weight:normal;font-style:normal;font-size:95%}#sbo-rt-content .boxhead{font-size:1.25em;font-weight:bold;padding-left:.1em;padding-bottom:.1em;padding-top:.1em;margin-top:0;text-indent:0;text-align:center;border:3px solid black}#sbo-rt-content div.box{margin-top:1em;margin-bottom:1em}#sbo-rt-content .boxpara{font-size:110%;text-indent:0;margin-left:1.5em;margin-right:1.5em;margin-top:.5em;margin-bottom:.5em;text-align:left}#sbo-rt-content .alpha{font-size:1.2em;font-weight:bold;margin-left:.2em;margin-top:1em;margin-bottom:.3em;text-align:left}#sbo-rt-content .index{font-size:small;margin-left:.2em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .index1{font-size:small;margin-left:1em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .index2{font-size:small;margin-left:2em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .cover{text-align:center}#sbo-rt-content .top{border-top:1.1px solid black;border-bottom:2px solid black}#sbo-rt-content .bot{border-bottom:2px solid black}#sbo-rt-content table.bodytable,#sbo-rt-content table{border-collapse:collapse;margin-bottom:8px;font-size:small;margin-top:10pt;width:95%;border-top:0 solid black;border-bottom:0 solid black}#sbo-rt-content table.fmtable{margin-bottom:1em;font-size:1em;margin-left:4em;border-top:0 solid #FFF;border-bottom:0 solid #FFF}#sbo-rt-content table{margin-bottom:1em;border-top:1.1px solid black;border-bottom:1.1px solid black;border-collapse:collapse}#sbo-rt-content th{border-top:1px solid black;border-bottom:1px solid black;padding-right:1.5em}#sbo-rt-content td{font-size:small;vertical-align:top;padding-right:1.5em;margin-top:0;margin-bottom:1em}#sbo-rt-content .tablepara{font-size:small;text-indent:0;margin-top:0;margin-bottom:.5em;padding-right:1.5em}#sbo-rt-content .tablepara1{font-size:small;margin-left:2em;margin-top:0;margin-bottom:0;padding-right:1.5em}#sbo-rt-content .header{border-bottom:1.1px solid black;text-indent:0;text-align:left}#sbo-rt-content .TabCapt{font-style:italic;margin-left:0;text-indent:0}#sbo-rt-content .FigCapt{font-style:italic;font-size:.9em}#sbo-rt-content .CaptNr{font-weight:bold}#sbo-rt-content .ttitle{font-style:Italic;margin-bottom:1em}#sbo-rt-content p.paraaftertitle1{font-size:.9em;text-indent:0;margin-top:.5em;margin-bottom:.8em;text-align:left}#sbo-rt-content p.para{font-size:small;text-indent:20px;margin-top:0;margin-bottom:0;text-align:justify}#sbo-rt-content p.quote{font-style:italic;font-size:100%;margin-top:1.5em;margin-left:2.5em;margin-right:2.5em;margin-bottom:0}#sbo-rt-content p.quotesource{font-size:small;text-indent:0;margin-top:1em;margin-bottom:1em;text-align:right}#sbo-rt-content p.chaptersubtitle{font-size:x-large;text-indent:0;margin-top:0;margin-left:0;margin-bottom:0;text-align:left}#sbo-rt-content p.line{margin-top:.3em;border-bottom:1px solid black}#sbo-rt-content p.line1{margin-top:.3em;margin-bottom:1.5em;border-bottom:1px solid black}#sbo-rt-content p.line2{margin-top:5em;margin-bottom:5em;border-bottom:1px solid black;text-align:center;margin-left:15em;margin-right:15em}#sbo-rt-content li{margin-bottom:.5em;margin-top:.5em}#sbo-rt-content p.alpha{font-size:1.2em;font-weight:bold;margin-left:.2em;margin-top:1em;margin-bottom:.3em;text-align:left}#sbo-rt-content ul.bulleted{font-size:100%;text-align:justify;margin-left:2.5em;margin-right:3em;margin-top:1em;margin-bottom:1em;text-indent:0}#sbo-rt-content ol.OrderedList{font-size:100%;text-align:left;margin-left:2.5em;margin-right:3em;margin-top:1em;margin-bottom:1em}#sbo-rt-content ul.bulleted1{font-size:100%;text-align:left;margin-left:1em;margin-right:5em;margin-top:1em;margin-bottom:1em;list-style-type:none}#sbo-rt-content ul.bulleted1_a{font-size:100%;text-align:justify;margin-left:0;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0;list-style-type:none}#sbo-rt-content ul.bulleted2{font-size:100%;text-align:justify;margin-left:2.3em;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0}#sbo-rt-content ul.bulleted4{font-size:100%;text-align:center;margin-left:1.3em;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0;list-style-type:none}#sbo-rt-content .numbered{font-size:small;text-align:justify;margin-left:2em;margin-right:2em;margin-top:.5em;margin-bottom:.5em;text-indent:1em}#sbo-rt-content .bulletedin{font-size:100%;text-align:justify;margin-left:4em;margin-right:4em;margin-top:.5em;margin-bottom:.5em}#sbo-rt-content ul.None{font-size:.9em;text-align:justify;margin-left:3em;margin-right:2em;margin-top:.5em;margin-bottom:.5em;list-style-type:none}#sbo-rt-content .Listing{font-size:small;margin-bottom:0}#sbo-rt-content .PCode1{font-size:small;margin-top:.7em;margin-bottom:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode2{font-size:small;margin-top:1em;margin-bottom:.1em;margin-left:2.2em;text-align:left;font-family:monospace}#sbo-rt-content .PCode3{font-size:small;margin-top:0;margin-left:2.2em;margin-bottom:.1em;text-align:left;font-family:monospace}#sbo-rt-content .NoteCaption{font-size:small;margin-top:1.3em;margin-left:5em;margin-right:5em;border:1.1px solid black;padding:.5em;margin-bottom:1.3em}#sbo-rt-content .Table{font-size:100%;margin-bottom:1em;margin-left:0}#sbo-rt-content .toc{font-size:1.1em;margin-top:.2em;margin-bottom:.2em;text-align:left;font-weight:bold}#sbo-rt-content .toca{font-size:1.1em;margin-top:.8em;margin-bottom:.4em;text-align:left;font-weight:bold}#sbo-rt-content .toc1{font-size:1.1em;margin-top:.4em;margin-bottom:.3em;text-align:left;text-indent:1.4em;font-weight:normal}#sbo-rt-content .toc2{font-size:1.2em;margin-top:.4em;margin-bottom:.3em;text-align:left;font-weight:bold}#sbo-rt-content .toc3{font-size:.9em;margin-top:.4em;margin-bottom:.3em;text-align:left;text-indent:3.5em;font-weight:normal}#sbo-rt-content .toc4{font-size:1.1em;margin-top:.2em;margin-bottom:.5em;text-align:left;font-weight:bold}#sbo-rt-content .tocch{font-size:1.3em;margin-top:.7em;margin-bottom:.7em;text-align:left;font-weight:bold}#sbo-rt-content .noborder{margin-bottom:1em;border-top:0 solid #FFF;border-bottom:0 solid #FFF}#sbo-rt-content .authurright{text-align:right;margin-top:0;margin-bottom:0}#sbo-rt-content .FormalPara{font-size:small;margin-bottom:.7em}#sbo-rt-content .FontName1{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content span.FontName2{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content span.FontName3{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content .rightarrow{margin-top:0}#sbo-rt-content div.thinline{margin-top:1em;margin-bottom:1em;border-top:solid 4px #AFAFB0;border-bottom:solid 4px #AFAFB0}#sbo-rt-content span.line{text-decoration:underline}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content div.box{border-top:solid 2px;border-bottom:solid 2px}#sbo-rt-content .app{font-size:150%;margin-left:.8em}#sbo-rt-content .page{text-decoration:none;color:#000}#sbo-rt-content .cXXX{text-decoration:none;color:#000}#sbo-rt-content .textindent{margin-left:1.7em;margin-top:1em;margin-bottom:1em;font-size:100%}#sbo-rt-content .textindent1{margin-left:1.7em;margin-top:0;margin-bottom:0;font-size:100%}#sbo-rt-content .textindent2{margin-left:1.7em;margin-top:0;margin-bottom:0;font-size:100%;text-indent:1em}#sbo-rt-content p.FootNote{margin-top:.8em;margin-bottom:0;font-size:85%;text-indent:0;text-align:left;margin-left:1.1em;margin-right:1.1em}#sbo-rt-content pre{margin-left:0;font-family:monospace;white-space:pre-wrap}#sbo-rt-content p.Heading4a{font-size:1.15em;font-weight:bold;text-indent:1em;margin-top:1.3em;margin-bottom:.3em;border-top:3px solid #4d4d4c;border-left:solid 3px #4d4d4c;border-right:solid 3px #4d4d4c;border-bottom:solid 3px #4d4d4c;text-align:center}#sbo-rt-content p.noindent8{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:1em;text-align:center;font-weight:bold;color:#8A8A8A}#sbo-rt-content .tocb{font-size:1.4em;margin-top:.5em;margin-bottom:.2em;text-align:left;font-weight:bold}#sbo-rt-content .part{font-weight:normal;font-size:1em;margin-bottom:5px;text-align:left;padding-left:1.3em;padding-bottom:10em;padding-right:1.3em;border:1.1px solid black}#sbo-rt-content p.Heading5{font-size:1em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;text-align:center}#sbo-rt-content p.noindent5s{font-size:100%;text-indent:0;margin-top:.1em;margin-bottom:.1em;margin-left:0;margin-right:0;text-align:right}#sbo-rt-content span.strike{text-decoration:line-through}
    </style><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9781430260585/chapter/9781430260585_Ch04.xhtml",
          "book_id": "9781430260585",
          "chapter_uri": "9781430260585_Ch04.xhtml",
          "position": 0,
          "user_uuid": "29525685-85c9-45c7-9eda-3c178d86398e",
          "next_chapter_uri": "/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml"
        
      },
      title: "Node.js Recipes: A Problem\u002DSolution Approach",
      author_list: "Cory Gackenheimer",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: false,
      show_ios_app_teaser: false
    };
    // ]]></script><script src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/modernizr.js"></script><script>
    
      
        

        

        
          
            window.PUBLIC_ANNOTATIONS = true;
          
        

      

      
        window.MOBILE_PUBLIC_ANNOTATIONS = false;
      

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

    
      window.PRIVACY_CONTROL_SWITCH = true;
    

    
      window.PUBLISHER_PAGES = true;
    

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "https://www.safaribooksonline.com/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://www.safaribooksonline.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml"><meta name="description" content="CHAPTER 4 Building a Web Server Web servers are the quintessential applications to be built with Node.js. This is due to Node.js’s main goal. Node.js is ... "><meta property="og:title" content="CHAPTER 4: Building a Web Server"><meta itemprop="isPartOf" content="/library/view/nodejs-recipes-a/9781430260585/"><meta itemprop="name" content="CHAPTER 4: Building a Web Server"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781430260585/"><meta property="og:description" itemprop="description" content="CHAPTER 4 Building a Web Server Web servers are the quintessential applications to be built with Node.js. This is due to Node.js’s main goal. Node.js is ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Apress"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781430260585"><meta property="og:book:author" itemprop="author" content="Cory Gackenheimer"><meta property="og:book:tag" itemprop="about" content="JavaScript"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript>&lt;meta http-equiv="refresh" content="0; url=/library/no-js/" /&gt;</noscript><script type="text/javascript">
  (function(i,s,o,g,r,a,m) {
    i['GoogleAnalyticsObject']=r;
    i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();
    a=s.createElement(o),m=s.getElementsByTagName(o)[0];
    a.async=1;
    a.src=g;
    m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  var matches = document.cookie.match(/BrowserCookie\s*=\s*([a-f0-9\-]{36})/),
      user_uuid = null;

  if (matches && matches.length === 2) {
    user_uuid = matches[1];
  }


  ga('create', 'UA-39299553-7', {'userId': '29525685-85c9-45c7-9eda-3c178d86398e' });


ga('set', 'dimension1', 'Trial');
ga('set', 'dimension6', user_uuid);


  ga('set', 'dimension2', '29525685-85c9-45c7-9eda-3c178d86398e');
  






  //enable enhanced link tracking
  ga('require', 'linkid', 'linkid.js');

  // reading interface will track pageviews itself
  if (document.location.pathname.indexOf("/library/view") !== 0) {
    ga('send', 'pageview');
  }
</script><script defer="" src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/vendor.34024413b1d4.js"></script><script defer="" src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/reader.a05323b190d3.js"></script><script async="" src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/MathJax.js"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts subscribe-panel library">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        





<a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>
              
                Queue
              
            </span></a></li><li class="search"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" width="20" height="20" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>offers icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M35.9 20.6L27 15.5C26.1 15 24.7 15 23.7 15.5L14.9 20.6C13.9 21.1 13.2 22.4 13.2 23.4L13.2 41.4C13.2 42.4 13.9 43.7 14.9 44.2L23.3 49C24.2 49.5 25.6 49.5 26.6 49L35.9 43.6C36.8 43.1 37.6 41.8 37.6 40.8L37.6 23.4C37.6 22.4 36.8 21.1 35.9 20.6L35.9 20.6ZM40 8.2C39.1 7.6 37.6 7.6 36.7 8.2L30.2 11.9C29.3 12.4 29.3 13.2 30.2 13.8L39.1 18.8C40 19.4 40.7 20.6 40.7 21.7L40.7 39C40.7 40.1 41.4 40.5 42.4 40L48.2 36.6C49.1 36.1 49.8 34.9 49.8 33.8L49.8 15.6C49.8 14.6 49.1 13.3 48.2 12.8L40 8.2 40 8.2ZM27 10.1L33.6 6.4C34.5 5.9 34.5 5 33.6 4.5L26.6 0.5C25.6 0 24.2 0 23.3 0.5L16.7 4.2C15.8 4.7 15.8 5.6 16.7 6.1L23.7 10.1C24.7 10.6 26.1 10.6 27 10.1ZM10.1 21.7C10.1 20.6 10.8 19.4 11.7 18.8L20.6 13.8C21.5 13.2 21.5 12.4 20.6 11.9L13.6 7.9C12.7 7.4 11.2 7.4 10.3 7.9L1.6 12.8C0.7 13.3 0 14.6 0 15.6L0 33.8C0 34.9 0.7 36.1 1.6 36.6L8.4 40.5C9.3 41 10.1 40.6 10.1 39.6L10.1 21.7 10.1 21.7Z"></path></g></svg><span>Offers &amp; Deals</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletters</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/001o00000169U9HAAU/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" width="20" height="20" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://www.safaribooksonline.com/public/support" class="l1 no-icon">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a><span class="l2 t-nag-notification" id="nav-nag"><strong class="trial-green">10</strong> days left in your trial.
  
  

  
    
      

<a class="" href="https://www.safaribooksonline.com/subscribe/">Subscribe</a>.


    
  

  

</span></li><li><a href="https://www.safaribooksonline.com/public/support" class="l2">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Node.js Recipes: A Problem-Solution Approach
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781430260585/chapter/9781430260585_Ch04.xhtml" data-for-analytics="9781430260585:9781430260585_Ch04.xhtml" aria-label="Add to Queue"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml&amp;text=Node.js%20Recipes%3A%20A%20Problem-Solution%20Approach&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20CHAPTER%204%3A%20Building%20a%20Web%20Server&amp;body=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml%0D%0Afrom%20Node.js%20Recipes%3A%20A%20Problem-Solution%20Approach%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
        
        



 <!--[if lt IE 9]>
  
<![endif]-->



  <script defer="" src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/djangoMessagesPage.845b17d78025.js"></script>


        
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch03.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">CHAPTER 3: Using the File System</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">CHAPTER 5: Using Events and Child Processes</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content" style="transform: none;"><div class="annotator-wrapper"><p class="ChapterNumber"><a id="Chap_4"></a>CHAPTER 4</p>
<p class="chapimage"><img src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/frontdot.jpg" alt="image" width="82" height="25" data-mfp-src="/library/view/nodejs-recipes-a/9781430260585/images/frontdot.jpg"></p>
<p class="ChapterTitle">Building a Web Server</p>
<div>
<p class="noindent">Web servers are the quintessential applications<a id="cXXX.268"></a> to be built with Node.js. This is due to Node.js’s main goal. Node.js is perfect for building highly scalable, event-driven, networked applications—a web server.</p>
<p class="indent">In this chapter you will learn and understand how to build a web server with Node.js. You will see topics covered from simple web servers to handling static files on your server. These topics are only parts of making a web server work properly. To get a full understanding of the web server as it can be implemented via Node.js, you will also learn the following:</p>
<ul class="bulleted">
<li>Creating a Secure Sockets<a id="cXXX.304a"></a> Layer (SSL) server with HTTPS</li>
<li>Configuring headers</li>
<li>Managing HTTP status codes</li>
<li>Processing HTTP requests and responses</li>
<li>Using HTTP events to manage your web server</li>
</ul>
<p id="Sec1" class="Heading1">4-1. Setting Up an HTTP Server</p>
<div>
<p id="Sec2" class="Heading2_2">Problem</p>
<p class="noindent">You need to create a simple web server that is to serve content over HTTP.</p>
</div>
<div>
<p id="Sec3" class="Heading2">Solution</p>
<p class="noindent">In Node.js, web servers are typically set up by using the HTTP module. This provides a layer in which to interact with the HTTP protocol.</p>
<p class="indent">Imagine that you are writing a web server that will send a status message to the client when you connect to the web server. In this solution, <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list1" id="_list1">Listing 4-1</a>, this has been simplified to simply write the response ‘hello’ and then end the response.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list1" id="list1">Listing 4-1</a></i></b>.&nbsp;&nbsp;Simple HTTP Web Server</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Setting up an HTTP server</span><a id="cXXX.269"></a><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http');</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(req, res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('hello');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end();</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.listen(8080);</span></pre>
</div>
<div>
<p id="Sec4" class="Heading2">How It Works</p>
<p class="noindent">This web server is overly simplified so you can investigate how the HTTP module creates a server. In the solution you naturally start off by requiring the http module. This module exposes a function, <span class="FontName1">http.createServer</span>, which is where the server is actually created. The <span class="FontName1">http.createServer</span> method<a id="cXXX.270"></a> instantiates a new Server object. The Server object accepts a <span class="FontName1">requestListener</span> callback function<a id="cXXX.271"></a>. This will send the response and the request arguments to the callback for the web server.</p>
<p class="indent">The new web server is an HTTP server that derives from the <span class="FontName1">net.Server</span> object that you saw in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch02.xhtml">Chapter 2</a>. The server also provides event listeners for the events, <span class="FontName1">connection</span>, <span class="FontName1">request</span>, and <span class="FontName1">clientError</span>.</p>
<p class="noindent2"><b><i>Listing 4-2</i></b>.&nbsp;&nbsp;Server Source, Instantiated by createServer</p>
<pre><span class="FontName1">function Server(requestListener) {</span><br>&nbsp;&nbsp;<span class="FontName1">if (!(this instanceof Server)) return new Server(requestListener);</span><br>&nbsp;&nbsp;<span class="FontName1">net.Server.call(this, { allowHalfOpen: true });</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (requestListener) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.addListener('request', requestListener);</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">// Similar option to this. Too lazy to write my own docs.</span><br>&nbsp;&nbsp;<span class="FontName1">//</span><span class="FontName1"><a href="http://www.squid-cache.org/Doc/config/half_closed_clients/">http://www.squid-cache.org/Doc/config/half_closed_clients/</a></span><br>&nbsp;&nbsp;<span class="FontName1">//</span><span class="FontName1"><a href="http://wiki.squid-cache.org/SquidFaq/InnerWorkings#What_is_a_half-closed_filedescriptor.3F">http://wiki.squid-cache.org/SquidFaq/InnerWorkings#What_is_a_half-closed_filedescriptor.3F</a></span><br>&nbsp;&nbsp;<span class="FontName1">this.httpAllowHalfOpen = false;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.addListener('connection', connectionListener);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.addListener('clientError', function(err, conn) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">conn.destroy(err);</span><br>&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.timeout = 2 * 60 * 1000;</span><br><span class="FontName1">}</span><br><span class="FontName1">util.inherits(Server, net.Server);</span><br>&nbsp;<br><span class="FontName1">Server.prototype.setTimeout = function(msecs, callback) {</span><br>&nbsp;&nbsp;<span class="FontName1">this.timeout = msecs;</span><br>&nbsp;&nbsp;<span class="FontName1">if (callback)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.on('timeout', callback);</span><br><span class="FontName1">};</span><br><br><span class="FontName1">exports.Server = Server;</span></pre>
<p class="indent">You have created your web server. Next, tell the server where you want to listen for requests. This is done via <span class="FontName1">server.listen</span>.&nbsp;&nbsp;The <span class="FontName1">server.listen</span> function<a id="cXXX.272"></a> takes a port as well as an optional hostname, backlog, and a callback. The callback function for the <span class="FontName1">server.listen</span> method<a id="cXXX.273"></a> will listen for the ‘<span class="FontName1">listening’</span> event. Providing a hostname will tell the server where you will be listening for requests to the given port.</p>
<div class="notepara">
<p class="paraaftertitle1"><img src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/sq.jpg" alt="image" width="12" height="12" data-mfp-src="/library/view/nodejs-recipes-a/9781430260585/images/sq.jpg">&nbsp;<b>Note</b>&nbsp;&nbsp;There are two other signatures for <span class="FontName1">server.listen</span>. One alternative is to provide only a UNIX path and a callback. This will begin a socket server on the path. The other is to provide a handle—either a socket or a server—which will then become the new server.</p></div>
<p class="indent">Once your server is listening, you can serve your response from the server. Within the request listener callback that you provided to the <span class="FontName1">http.createServer</span> method are two arguments. These arguments represent the HTTP request and the HTTP response that is being served. In the solution, you wanted to create a web server to send a response to the ‘hello’ connection . This is done by streaming a <span class="FontName1">res.write(‘hello’)</span> function<a id="cXXX.274"></a>. This will render on the client once the <span class="FontName1">response.end()</span> function<a id="cXXX.275"></a> is called.</p>
<p class="indent">
<span class="FontName1">Response.write</span> sends the chunk of the response body as the first parameter. The optional second parameter is used to set the character encoding of this chunk. You might think that a <span class="FontName1">response.write</span> is all that is needed for the response, but that thinking is incorrect. In fact, you need—for every response—to call the <span class="FontName1">response.end()</span> function.</p>
</div>
<p id="Sec5" class="Heading1">4-2. Using SSL to Build an HTTPS Server</p>
<div>
<p id="Sec6" class="Heading2_2">Problem</p>
<p class="noindent">You created a web server, but you want to add the extra level of security by using an SSL-encrypted connection to serve your content over HTTPS.</p>
</div>
<div>
<p id="Sec7" class="Heading2">Solution</p>
<p class="noindent">In order to build an SSL server<a id="cXXX.279a"></a>, you need to have a couple of items in order before you begin. First your client and server must execute a Transport Layer Security (TLS) handshake. To accomplish this you need to have a certificate and key generated in order to authenticate your HTTPS session. These keys are exchanged between the client and the server. Once the keys are exchanged, the process of authenticating and validating the session initiates. Once the keys are deemed valid, the session continues over HTTPS just as a normal HTTP connection would, only with the additional layer of security.</p>
<p class="indent">From there, you can use the HTTPS module in Node.js. This module will act similarly to the HTTP module, but the connection is encrypted via TLS/SSL. You then create an HTTPS server via Node.js as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list3" id="_list3">Listing 4-3</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list3" id="list3">Listing 4-3</a></i></b>.&nbsp;&nbsp;HTTPS Server</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* HTTPS server</span><br><span class="FontName1">*/</span><br><span class="FontName1">var https = require('https');</span><br><span class="FontName1">var fs = require('fs');</span><br>&nbsp;<br><span class="FontName1">var options = {</span><br>&nbsp;&nbsp;<span class="FontName1">key: fs.readFileSync('privatekey.pem'),</span><br>&nbsp;&nbsp;<span class="FontName1">cert: fs.readFileSync('certificate.pem')</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">https.createServer(options, function (req, res) {</span><br>&nbsp;&nbsp;<span class="FontName1">res.writeHead(200);</span><br>&nbsp;&nbsp;<span class="FontName1">res.write("https!\n");</span><br>&nbsp;&nbsp;<span class="FontName1">res.end();</span><br><span class="FontName1">}).listen(8080);</span></pre>
</div>
<div>
<p id="Sec8" class="Heading2">How It Works</p>
<p class="noindent">Creating an HTTPS connection starts with TLS/SSL. This protocol ensures a secure communication between the client and the server. This occurs because there is a handshake between client and server in which the server reveals its certificate and public key to the client. Then when the client sends a response, it is encrypted with the server’s public key, which is validated. If all the data are evaluated to be valid, the session continues over HTTPS.</p>
<p class="indent">But how do you obtain these certificates and keys? In Node.js the SSL/TLS implementation<a id="cXXX.276"></a> utilizes OpenSSL. OpenSSL is an open source implementation of SSL/TLS. This is a protocol that will enable you to easily implement a key and certificate. In order to generate such a key, you will need to open your terminal and enter the commands as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list4" id="_list4">Listing 4-4</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list4" id="list4">Listing 4-4</a></i></b>.&nbsp;&nbsp;Creating TLS/SSL Keys and Certificates<a id="cXXX.277"></a></p>
<pre><span class="FontName1">$ openssl genrsa -out privatekey.pem 1024</span><br><span class="FontName1">$ openssl req -new -key privatekey.pem -out certrequest.csr</span><br><span class="FontName1">$ openssl x509 -req -in certrequest.csr -signkey privatekey.pem -out certificate.pem</span></pre>
<p class="indent">On Windows this is slightly different, because Windows does not include an OpenSSL implementation by default. You should first download a binary distribution from <span class="FontName1"><a href="http://openssl.org/related/binaries.html">http://openssl.org/related/binaries.html</a></span>. By default, this will install to C:\OpenSSL-Win32 on your machine. From there you can open up PowerShell and run the following from the C:\OpenSSL-Win32\bin directory.</p>
<pre><span class="FontName1">PS C:\OpenSSL-Win32\bin&gt; .\openssl.exe genrsa –out privatekey.pem 1024</span><br><span class="FontName1">PS C:\OpenSSL-Win32\bin&gt; .\openssl.exe req –new –key .\privatekey.pem –out certrequest.csr</span><br><span class="FontName1">PS C:\OpenSSL-Win32\bin&gt; .\openssl.exe x509 –req –in .\certrequest.csr –signkey .\privatekey.pem –out certificate.pem</span></pre>
<p class="indent">Once you have created your certificate and your key, you are now able to create your secure server. This begins with the <span class="FontName1">https.createServer</span> method. This function is similar to the <span class="FontName1">http.createServer</span> method with a notable exception to create a secure connection. This is done via an options object. The options used in this example set the certificate and the key for the creation of the <span class="FontName1">tls.Server</span><a id="cXXX.278"></a>. You will see more detail with respect to SSL and TLS in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch06.xhtml">Chapter 6</a>. To actually read the values of the key and certificate files you read them using the file system, as discussed in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch03.xhtml">Chapter 3</a>. Once these are read, you can create your server.</p>
<p class="noindent2"><b><i>Listing 4-5</i></b>.&nbsp;&nbsp;HTTPS Server Inherits tls.Server</p>
<pre><span class="FontName1">function Server(opts, requestListener) {</span><br>&nbsp;&nbsp;<span class="FontName1">if (!(this instanceof Server)) return new Server(opts, requestListener);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (process.features.tls_npn &amp;&amp; !opts.NPNProtocols) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">opts.NPNProtocols = ['http/1.1', 'http/1.0'];</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">tls.Server.call(this, opts, http._connectionListener);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.httpAllowHalfOpen = false;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">if (requestListener) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.addListener('request', requestListener);</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.addListener('clientError', function(err, conn) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">conn.destroy(err);</span><br>&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.timeout = 2 * 60 * 1000;</span><br><span class="FontName1">}</span><br><b>inherits(Server, tls.Server);</b></pre>
<p class="indent">Once the server is created, you should be able to access it with SSL connections. To test this, simply curl the server address and you should see the response ‘https!’ written to your console. If, on the other hand you don’t attempt to reach the HTTPS version of your server, you will not get the expected result from the server.</p>
<p class="noindent2"><b><i>Listing 4-6</i></b>.&nbsp;&nbsp;Use cURL<a id="cXXX.279"></a> to View Your Secure Connection</p>
<pre><span class="FontName1">$ curl –k</span><span class="FontName1"><a href="https://localhost:8080/">https://localhost:8080</a></span> <span class="FontName1"># works</span><br><span class="FontName1">https!</span><br>&nbsp;<br><span class="FontName1">$ curl</span> <span class="FontName1"><a href="http://localhost:8080/">http://localhost:8080</a></span> <span class="FontName1"># nope</span><br><span class="FontName1">curl: (52) Empty response from the server</span></pre>
</div>
<p id="Sec9" class="Heading1">4-3. Processing Requests on Your Server</p>
<div>
<p id="Sec10" class="Heading2_2">Problem</p>
<p class="noindent">You have an HTTP or HTTPS server. This server will need to process incoming requests.</p>
</div>
<div>
<p id="Sec11" class="Heading2">Solution</p>
<p class="noindent">When you build a web server, you need to handle requests. Requests come in many forms and contain what can quickly become an overwhelming set of data. In handling requests you need to be able to sift through the incoming data efficiently in order to handle headers, methods, and URL parameters.</p>
<p class="indent">In this solution, you will create a web server that handles requests. It will likely look similar to many web servers that you are familiar with. This server will handle request headers and deal with them as you see fit. An example of this would be to not send a tracking cookie if the request header contains the “do not track” directive.</p>
<p class="indent">After properly handling the headers, you will likely want to parse the request URLs. This will help you handle 404s and general application<a id="cXXX.85s"></a> routing by processing the incoming path. Aside from the path you may also find interest in the query string parameters that were sent along with the request.</p>
<p class="indent">Finally, you will want to examine the request method that initiated the request. This is the HTTP method, and it will be useful when you create any application, or a representational state transfer (REST) application<a id="cXXX.280"></a><a id="cXXX.281"></a> programming interface (API).</p>
<p class="noindent2"><b><i>Listing 4-7</i></b>.&nbsp;&nbsp;Handling Requests<a id="cXXX.282"></a></p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Processing Requests</span><br><span class="FontName1">*/</span><br><span class="FontName1">var http = require('http'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">url = require('url');</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(req, res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//Handle headers</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (req.headers.dnt == 1) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('Do Not Track');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//Parse the URL</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var url_parsed = url.parse(req.url, true);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//What type of request is this</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (req.method === 'GET') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">handleGetRequest(res, url_parsed);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else if (['POST', 'PUT', 'DELETE'].indexOf(req.method) &gt; -1) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">handleApiRequest(res, url_parsed, req.method);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end('Method not supported');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">handleGetRequest = function(res, url_parsed) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('search: ' + url_parsed.search);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('query: ' + JSON.stringify(url_parsed.query));</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('pathname: ' + url_parsed.pathname);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('path: ' + url_parsed.path);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('href: ' + url_parsed.href);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end('get\n');</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">handleApiRequest = function(res, url_parsed, method) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (url_parsed.path !== '/api') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 404;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end('404\n');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(method);</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">server.listen(8080);</span></pre>
</div>
<div>
<p id="Sec12" class="Heading2">How It Works</p>
<p class="noindent">The web server in this solution is built to handle requests. It does this by examining the details that surround the request received by the server. This request is in actuality an object known as the <span class="FontName1">http.IncomingMessage</span>.</p>
<p class="indent">The <span class="FontName1">http.IncomingMessage</span><a id="cXXX.283"></a> inherits the readable stream interface. On top of this, it builds some objects that are useful in the case of HTTP messages, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list8" id="_list8">Listing 4-8</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list8" id="list8">Listing 4-8</a></i></b>.&nbsp;&nbsp;http.IncomingMessage</p>
<pre><span class="FontName1">function IncomingMessage(socket) {</span><br>&nbsp;&nbsp;<span class="FontName1">Stream.Readable.call(this);</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.socket = socket;</span><br>&nbsp;&nbsp;<span class="FontName1">this.connection = socket;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.httpVersion = null;</span><br>&nbsp;&nbsp;<span class="FontName1">this.complete = false;</span><br>&nbsp;&nbsp;<span class="FontName1">this.headers = {};</span><br>&nbsp;&nbsp;<span class="FontName1">this.trailers = {};</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this.readable = true;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this._pendings = [];</span><br>&nbsp;&nbsp;<span class="FontName1">this._pendingIndex = 0;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">// request (server) only</span><br>&nbsp;&nbsp;<span class="FontName1">this.url = '';</span><br>&nbsp;&nbsp;<span class="FontName1">this.method = null;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">// response (client) only</span><br>&nbsp;&nbsp;<span class="FontName1">this.statusCode = null;</span><br>&nbsp;&nbsp;<span class="FontName1">this.client = this.socket;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this._consuming = false;</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">this._dumped = false;</span><br><span class="FontName1">}</span><br><span class="FontName1">util.inherits(IncomingMessage, Stream.Readable);</span></pre>
<p class="indent">As you can see from the source, the <span class="FontName1">http.IncomingMessage</span> brings with it several objects or settings that are important to your solution. First, it brings the headers. The request headers are objects that directly reflect the key-value pairs that were sent with the request. When I attempt to send a request to this server from my web browser, the headers look as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list9" id="_list9">Listing 4-9</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list9" id="list9">Listing 4-9</a></i></b>.&nbsp;&nbsp;Typical Request Headers</p>
<pre><span class="FontName1">{ host: 'localhost:8080',</span><br>&nbsp;&nbsp;<span class="FontName1">'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.7; rv:20.0) Gecko/20100101 Firefox/20.0',</span><br>&nbsp;&nbsp;<span class="FontName1">accept: 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',</span><br>&nbsp;&nbsp;<span class="FontName1">'accept-language': 'en-us,en;q=0.5',</span><br>&nbsp;&nbsp;<span class="FontName1">'accept-encoding': 'gzip, deflate',</span><br>&nbsp;&nbsp;<span class="FontName1">dnt: '1',</span><br>&nbsp;&nbsp;<span class="FontName1">connection: 'keep-alive' }</span></pre>
<p class="indent">Second, in your web server you need to handle the <span class="FontName1">request.url</span>. This contains all the information that is sent via the request URL. The easiest way to parse this is to utilize the URL module. You can tell the URL module to parse the request.url including the query string.</p>
<p class="indent">The third part of the request that can be valuable for your server is the <span class="FontName1">request.method</span><a id="cXXX.284"></a>
<span class="FontName1">. request.method</span> will provide you with the HTTP method that began your request. In the solution the web server was set up to imitate a web API. In a case such as this, the routing of API methods is not determined completely by the path of the URL but also by the <span class="FontName1">request.method</span>. These methods are simply the string names of the HTTP methods. Your solution handles these different methods in two different ways. First, you serve an HTTP GET request; using that will then log some of the details of the request and respond that the method was indeed a GET. Second, you mimic an API routing scheme with other methods. These are handled by a singular function that will check to make sure you are requesting not only the proper method but also the path. As you can see in the solution these are each handled in such a way that you could cURL each type to see a different result<a id="cXXX.285"></a> as you see in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list10" id="_list10">Listing 4-10</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list10" id="list10">Listing 4-10</a></i></b>.&nbsp;&nbsp;Curling for different results</p>
<pre><span class="FontName1">$ curl -X PUT</span> <span class="FontName1"><a href="http://localhost:8080/api">http://localhost:8080/api</a></span><br><span class="FontName1">put</span><br><span class="FontName1">$ curl -X PUT</span> <span class="FontName1"><a href="http://localhost:8080/apis">http://localhost:8080/apis</a></span><br><span class="FontName1">404</span><br><span class="FontName1">$ curl -X DELETE</span> <span class="FontName1"><a href="http://localhost:8080/api">http://localhost:8080/api</a></span><br><span class="FontName1">delete</span><br><span class="FontName1">$ curl -X TRACE</span> <span class="FontName1"><a href="http://localhost:8080/api">http://localhost:8080/api</a></span><br><span class="FontName1">Method not supported</span></pre>
<p class="indent">By understanding the information that accompanies an <span class="FontName1">http.request</span> in Node.js, you are able to leverage this to build your web server to handle these requests. Next, you will see how to send responses from your server.</p>
</div>
<p id="Sec13" class="Heading1">4-4. Sending Responses from Your Server</p>
<div>
<p id="Sec14" class="Heading2_2">Problem</p>
<p class="noindent">You have your web server, but now you need to be able to send information from the server in the form of a response.</p>
</div>
<div>
<p id="Sec15" class="Heading2">Solution</p>
<p class="noindent">A server response is a Node.js <span class="FontName1">EventEmitter</span> object that is emitted as part of the request event. In this solution you will utilize the response object to directly write the content to the requester. First, you want to send an HTML document. You can do this by creating a response and sending the HTML content directly.</p>
<p class="noindent2"><b><i>Listing 4-11</i></b>.&nbsp;&nbsp;Response.write of HTML</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Sending a response from your server</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http');</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(req, res) {</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.setHeader('Content-Type', 'text/html');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeHead(200, 'woot');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('&lt;!doctype html&gt;');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('&lt;html&gt;');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('&lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;/head&gt;');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('&lt;body&gt;');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('&lt;h2&gt;Hello World&lt;/h2&gt;');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('&lt;/body&gt;&lt;/html&gt;');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end();</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.listen(8080);</span></pre>
<p class="indent">You are now serving HTML content directly in your response. You may need to be able to send other types of content to provide the robust solution for your application. In this case you choose to send a JavaScript Object Notation (JSON)-encoded object so the client can retrieve information from your server. This is similar in implementation with a few minor changes that you will see in detail in the How It Works section.</p>
<p class="noindent2"><b><i>Listing 4-12</i></b>.&nbsp;&nbsp;A JSON<a id="cXXX.286"></a> serverResponse</p>
<pre><span class="FontName1">var http = require('http');</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(req, res) {</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.setHeader('Content-Type', 'application/json');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeHead(200, 'json content');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('{ "wizard": "mithrandir" }');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end();</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.listen(8080);</span></pre>
</div>
<div>
<p id="Sec16" class="Heading2">How It Works</p>
<p class="noindent">You now are serving content from your web server by using the <span class="FontName1">serverResponse</span> object. This object, as utilized in this solution, carries with it some valuable functions. The first line within the <span class="FontName1">requestListener</span> callback is <span class="FontName1">response.setHeader.</span> The <span class="FontName1">setHeader</span> function<a id="cXXX.287"></a> does exactly what the name implies; it sets the headers for the response. These are set in a name and value pairing, <span class="FontName1">res.setHeader(‘Name’, ‘Value’);.</span></p>
<p class="indent">In the solutions, you set the Content-Type header to define the type of content that was being sent with your request. You can also set cookies, custom header parameters, or anything that would accompany a request header from your server.</p>
<p class="indent">The other method that is utilized in this solution to set the response headers is the <span class="FontName1">response.writeHead</span> method<a id="cXXX.288"></a>. This method does not limit your header creation to a single name and value pair. This method takes up to three arguments. The first argument, which is required, sets the HTTP status code for the response. You then have the option to set a custom description, or reason phrase, that corresponds to the status code description. This can be any reason phrase you wish, departing from the HTTP standard descriptions.</p>
<p class="noindent2"><b><i>Listing 4-13</i></b>.&nbsp;&nbsp;HTTP Reason Phrase Override in Node.js</p>
<pre><span class="FontName1">if (typeof arguments[1] == 'string') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">reasonPhrase = arguments[1];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">headerIndex = 2;</span><br>&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">reasonPhrase = STATUS_CODES[statusCode] || 'unknown';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">headerIndex = 1;</span><br>&nbsp;&nbsp;<span class="FontName1">}</span></pre>
<p class="indent">The third parameter is actually a header object that will take the name and value pairs, not just individual name-value pairs, as an entire object. To refactor the solution for the JSON <span class="FontName1">serverResponse</span> above, you could simply make one call to <span class="FontName1">response.writeHead</span> to get the same result.</p>
<p class="noindent2"><b><i>Listing 4-14</i></b>.&nbsp;&nbsp;Combining HTTP Status Code, Reason Phrase, and Headers in a response.writeHead Call</p>
<pre><span class="FontName1">res.writeHead(200, ‘json content’, {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">‘Content-Type’: ‘application/json’});</span></pre>
<p class="indent">You then send a body of your response to the client by using <span class="FontName1">response.write</span>. This function will take a string that represents a chunk of the response body. The second parameter of <span class="FontName1">response.write</span> is to set the encoding of the response, which defaults to utf8. The <span class="FontName1">response.write</span> does not require that you have already set the header via the previously mentioned methods. If the header is not explicitly set, the <span class="FontName1">response.write</span> method<a id="cXXX.289"></a> will implicitly define the header with a status code of 200. The write method then ensures that the headers have been sent. If the headers have not been sent, then they are sent along with the initial write of the data to the client.</p>
<p class="noindent2"><b><i>Listing 4-15</i></b>.&nbsp;&nbsp;If Headers Aren’t Already Sent, Send Them with the First Chunk</p>
<pre><span class="FontName1">if (!this._headerSent) {</span><br>&nbsp;&nbsp;<span class="FontName1">if (typeof data === 'string') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">data = this._header + data;</span><br>&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.output.unshift(this._header);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.outputEncodings.unshift('ascii');</span><br>&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">this._headerSent = true;</span><br><span class="FontName1">}</span><br><span class="FontName1">return this._writeRaw(data, encoding);</span></pre>
<p class="indent">You now have seen and executed the methods for sending a response from your web server. These options are just a subset of what is possible with HTTP responses. The full list of what is available for use is shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#Tab1" id="_Tab1">Table 4-1</a>.</p>
<div class="Table">
<p class="TabCapt">
<span class="CaptNr">
<a id="Tab1" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_Tab1">Table 4-1</a>. </span>HTTP serverResponse Methods<a id="cXXX.290"></a></p>
<table>
<thead>
<tr class="header">
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td> response.addTrailers(headers)</td>
<td> Adds HTTP trailing headers (a header but at the end of the message) to the response. Trailers will only be emitted if chunked encoding is used for the response; if it is not (e.g., if the request was HTTP/1.0), they will be silently discarded.</td>
</tr>
<tr>
<td> response.end([data], [encoding])</td>
<td> Signals to the server that all of the response headers and body have been sent; the server should consider the message complete. The method, response.end(), <i>must</i> be called on each response.</td>
</tr>
<tr>
<td> response.getHeader(name)</td>
<td> Reads out a header that's already been queued but not sent to the client. Note that the name is case-insensitive. This can only be called before headers get implicitly flushed.</td>
</tr>
<tr>
<td> response.headersSent</td>
<td> Boolean (read-only). It is true if headers were sent, but false otherwise.</td>
</tr>
<tr>
<td> response.removeHeader(name)</td>
<td> Removes a header that's queued for implicit sending.</td>
</tr>
<tr>
<td> response.sendDate</td>
<td> When true, the Date header will be automatically generated and sent in the response if it is not already present in the headers. Defaults to true.</td>
</tr>
<tr>
<td> response.setHeader(name, value)</td>
<td> Sets a single header value for implicit headers. If this header already exists in the to-be-sent headers, its value will be replaced. Use an array of strings here if you need to send multiple headers with the same name.</td>
</tr>
<tr>
<td> response.setTimeout(milliseconds, callback)</td>
<td> Sets the socket's timeout value to milliseconds. If a callback is provided, then it is added as a listener on the 'timeout' event on the response object.</td>
</tr>
<tr>
<td> response.statusCode</td>
<td> When using implicit headers (not calling response.writeHead() explicitly), this property controls the status code that will be sent to the client when the headers get flushed.</td>
</tr>
<tr>
<td> response.write(chunk, [encoding])</td>
<td> Sends a chunk of the response body. This method may be called multiple times to provide successive parts of the body.</td>
</tr>
<tr>
<td> writeContinue()</td>
<td> Sends an HTTP/1.1 100 Continue message to the client, indicating that the request body should be sent.</td>
</tr>
<tr>
<td> writeHead(statusCode, [reasonPhrase], [headers])</td>
<td> Sends the response header to the request.</td>
</tr>
</tbody>
</table>
</div>
</div>
<p id="Sec17" class="Heading1">4-5. Handling Headers and Status Codes<a id="cXXX.291"></a></p>
<div>
<p id="Sec18" class="Heading2_2">Problem</p>
<p class="noindent">In building a Node.js web application, you will need to be able to properly deliver and handle header information and HTTP status codes.</p>
</div>
<div>
<p id="Sec19" class="Heading2">Solution</p>
<p class="noindent">In the scenario created for this solution, you can imagine a situation where you need to serve a particular type of file for your web application. This situation could arise when you are building a web application that you wish to publish to a hosted web application store or marketplace such as a Chrome or Firefox OS application.</p>
<p class="indent">In this situation you might provide an application manifest file. This is typically in the form of a JSON file that sets the details of the application in order to make it installable on the hosting platform. This requires a particular header type in order for the hosting platform to recognize this file as a manifest. So in this solution you will manipulate the headers to represent the content type appropriately as well as handle the proper status codes for your application.</p>
<p class="noindent2"><b><i>Listing 4-16</i></b>.&nbsp;&nbsp;Handling Headers and Status Codes</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Headers and status codes</span><br><span class="FontName1">*/</span><br><span class="FontName1">var http = require('http');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">url = require('url');</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(req, res) {</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (req.headers) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('request headers', req.headers);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var parsedUrl = url.parse(req.url);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (parsedUrl.path === '/manifest.webapp' &amp;&amp; req.method === ‘GET’) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// serving an application manifest file type</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeHead(200, { 'Content-Type' : 'application/x-web-app-manifest+json' });</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('{ "name" : "App" }');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write( '"description": "My elevator pitch goes here",');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('"launch_path": "/",');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('"icons": {');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('"128": "/img/icon-128.png" },');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('"developer": {');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write(' "name": "Your name or organization",');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write(' "url": "</span><span class="FontName1"><a href="http://your-homepage-here.org/">http://your-homepage-here.org</a></span><span class="FontName1">" },');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.write('"default_locale": "en" }');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else if (parsedUrl.path !== '/') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 404;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(http.STATUS_CODES[res.statusCode]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeHead(200, { 'Content-Type': 'text/html'});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end('&lt;h2&gt;normalContent&lt;/h2&gt;');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.listen(8080);</span></pre>
</div>
<div>
<p id="Sec20" class="Heading2">How It Works</p>
<p class="noindent">This solution is designed to do two things. First, it is designed to serve static HTML from the root of the application, url path = ‘/’. Second, it is designed to serve a webapp.manifest file, or what you would write to package your application to be hosted on an app marketplace. To do this correctly, you need to control the headers and the status codes.</p>
<p class="indent">The status codes are important because they provide the information regarding the state of your response to the client. The status codes call into one of five categories segregated by each block of integers starting with 100. Status codes in the 100 range are informational codes; codes in the 200 range are the codes representing success; 300 range codes represent redirection. Errors are represented by status codes in the 400 range for client errors, and the 500 range for server errors.</p>
<p class="indent">In this solution your application is designed to serve only content from the root of your web app, or the manifest file itself. Other paths that your server is requested for will result in a 404 status code. This status code is a client error indicating that the path is not found.</p>
<p class="noindent2"><b><i>Listing 4-17</i></b>.&nbsp;&nbsp;Setting a 404 Not Found statusCode</p>
<pre><span class="FontName1">if (parsedUrl.path !== '/') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 404;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(http.STATUS_CODES[res.statusCode]);</span><br><span class="FontName1">}</span></pre>
<p class="indent">This response is written with the data that are passed along with the <span class="FontName1">response.end</span> method. This utilizes the <span class="FontName1">http.STATUS_CODES</span> object, which will find the corresponding status code reason description for the passed <span class="FontName1">response.statusCode</span>.</p>
<p class="indent">The URLs that you are targeting will both return a 200 or “OK” status code. The first of these is for the root of your web application. Along with the status code, you want to serve this root as an HTML document. This is controlled not only by the content that you serve, but also the headers.</p>
<p class="indent">Controlling the headers is important when serving content from any type of web server because the headers direct the client how to handle content, or what to do with the content once it is handled. Examples of this are the Content-Type header, directing the request how to serve the content; Cache-Control header, which tells the client how to handle caching the content; and Content-Length, which indicates the length of the request. These are just three of the standard and nonstandard header names that can be set in the request in Node.js.</p>
<p class="indent">In this solution, when you were sending the application manifest file, you sent a custom nonstandardized header: { 'Content-Type' : 'application/x-web-app-manifest+json' }. This header indicated that the content was of application manifest type and expects to be a JSON file. If you are in the root of your application, the response serves a Content-Type header of ‘text/html’, which as you can probably assume, is meant to be an HTML document. Of course, you could add any additional headers you need to these responses, but it is important to know that the Content-Type of certain responses—such as the manifest file—are required to be precise.</p>
</div>
<p id="Sec21" class="Heading1">4-6. Creating an HTTP Client</p>
<div>
<p id="Sec22" class="Heading2_2">Problem</p>
<p class="noindent">You want to create a Node.js application that will act as an HTTP client.</p>
</div>
<div>
<p id="Sec23" class="Heading2">Solution</p>
<p class="noindent">Creating an HTTP client out of a Node.js application is as straightforward as creating an HTTP server. In this solution you will begin by setting the options for your client. These options tell your application where to send the request and by what means to fetch it. You do this so that you can communicate with the REST API you created for your application in Section 4-3. This will parse a set of arguments, determine which method and path to send to the API, then process the <span class="FontName1">http.request</span>.</p>
<p class="noindent2"><b><i>Listing 4-18</i></b>.&nbsp;&nbsp;HTTP Client<a id="cXXX.293a"></a><a id="cXXX.292"></a></p>
<pre><span class="FontName1">/*</span><br><span class="FontName1">* Creating an HTTP client</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">args = process.argv.slice(2);</span><br>&nbsp;<br><span class="FontName1">//Set defaults</span><br><span class="FontName1">var clientOptions = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">host: 'localhost',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// hostname:'nodejs.org',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">port: '8080',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">path: '/',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">method: 'GET'</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">args.forEach(function(arg) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">switch(arg) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 'GET':</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientOptions.method = 'GET';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 'SUBMIT':</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 'POST':</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientOptions.method = 'POST';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientOptions.path = '/api';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 'UPDATE':</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 'PUT':</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientOptions.path = '/api';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientOptions.method = 'PUT';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 'REMOVE':</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 'DELETE':</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientOptions.method = 'DELETE';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientOptions.path = '/api';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">default:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientOptions.method = 'GET';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientOptions.path = '/';</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var clientReq = http.request(clientOptions, function(res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('status code', res.statusCode);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">switch(res.statusCode) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 200:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.setEncoding('utf8');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('data', data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 404:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('404 error');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientReq.on('error', function(error) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">throw error;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">clientReq.end();</span><br><span class="FontName1">});</span></pre>
</div>
<div>
<p id="Sec24" class="Heading2">How It Works</p>
<p class="noindent">This works by leveraging the Node.js HTTP module. This module provides an interface to easily create a client request, <span class="FontName1">http.request</span>. In the solution, you first utilize the <span class="FontName1">process.argv</span> to strip out any relevant command-line arguments that initiated your application. For this example you simply instantiate the application passing the HTTP method you wish to provide and the application will loop through these, creating a request for each.</p>
<pre><span class="FontName1">$ node 4-6-1.js GET POST PUT DELETE NOTHING</span></pre>
<p class="indent">If you are targeting the server that you created in Section 4-3, you can see a similar result to the following, showing that you successfully hit the API endpoint that your client requested.</p>
<pre><span class="FontName1">status code 200</span><br><span class="FontName1">data get</span><br>&nbsp;<br><span class="FontName1">status code 200</span><br><span class="FontName1">data get</span><br>&nbsp;<br><span class="FontName1">status code 200</span><br><span class="FontName1">data post</span><br>&nbsp;<br><span class="FontName1">status code 200</span><br><span class="FontName1">data put</span><br>&nbsp;<br><span class="FontName1">status code 200</span><br><span class="FontName1">data delete</span></pre>
<p class="indent">That covers how the implementation works, but now you will see how Node.js processes an <span class="FontName1">http.request</span>. The <span class="FontName1">http.request</span> takes two arguments, an options object, and a callback function that will receive the response.</p>
<p class="indent">When you invoke <span class="FontName1">http.request</span>, you initialize a <span class="FontName1">ClientRequest</span> object. The <span class="FontName1">ClientRequest</span> object inherits from the Node.js <span class="FontName1">OutgoingMessage</span> object. The <span class="FontName1">ClientRequest</span> object has a full set of defaults that are processed based on what you pass into the options parameter. As you walk through the <span class="FontName1">ClientResponse</span> object, you will see these defaults becoming configured.</p>
<div class="Table" id="Tab2">
<p class="TabCapt">
<span class="CaptNr">Table 4-2. </span>ClientRequest Object<a id="cXXX.293"></a> Options </p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr>
<td> agent</td>
<td> Controls agent behavior. When an agent is used, the request will default to Connection: keep-alive.</td>
</tr>
<tr>
<td> auth</td>
<td> Basic authentication (i.e., 'user:password’).</td>
</tr>
<tr>
<td> headers</td>
<td> An object containing request headers.</td>
</tr>
<tr>
<td> host</td>
<td> A domain name or IP address of the server to issue the request to (defaults to 'localhost').</td>
</tr>
<tr>
<td> hostname</td>
<td> To support url.parse(), a hostname is preferred over a host.</td>
</tr>
<tr>
<td> localAddress</td>
<td> Local interface to bind for network connections.</td>
</tr>
<tr>
<td> method</td>
<td> A string specifying the HTTP request method (defaults to GET).</td>
</tr>
<tr>
<td> path</td>
<td> Request path (defaults to '/'). Should include a query string if any.</td>
</tr>
<tr>
<td> port</td>
<td> Port of remote server (defaults to 80).</td>
</tr>
<tr>
<td> socketPath</td>
<td> Unix domain socket (use one of host:port or socketPath).</td>
</tr>
</tbody>
</table>
</div>
<p class="indent">The callback function that is passed to the <span class="FontName1">http.request</span> function will be called from within the <span class="FontName1">ClientRequest</span> object, only when the response is returned. You also set up an event listener for the error event in order to capture any errors that may occur during the request. Once the response is returned, you handle the response. In the case of this example, you check the <span class="FontName1">statusCodes</span> and log accordingly. You will see more on handling the responses in the next section.</p>
<p class="indent">It is important to note that for a <span class="FontName1">clientResponse</span> to work you must call the <span class="FontName1">request.end()</span> function<a id="cXXX.294"></a>. This is necessary regardless of the amount of data that are sent via the request body because you must signify the end of the request.</p>
</div>
<p id="Sec25" class="Heading1">4-7. Processing Client Responses<a id="cXXX.295"></a></p>
<div>
<p id="Sec26" class="Heading2_2">Problem</p>
<p class="noindent">You have created an HTTP client; you now need to understand how to handle the client responses.</p>
</div>
<div>
<p id="Sec27" class="Heading2">Solution</p>
<p class="noindent">Properly handling the response that you have received on your HTTP client is important. You need to respond to things like status codes, or particular headers upon which your application depends.</p>
<p class="indent">For this solution you can imagine a scenario in which your HTTP client needs to look for a custom header set by the server, <span class="FontName1">x-ample</span>, which, if set to the proper value, will alert the client to perform a special action. You then will check the status codes to ensure you have a good response before performing your action.</p>
<p class="noindent2"><b><i>Listing 4-19</i></b>.&nbsp;&nbsp;Processing Responses</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Processing client responses</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http');</span><br>&nbsp;<br><span class="FontName1">var clientOptions = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">host: 'localhost',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">port: '8080',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">path: '/',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">method: 'GET'</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var clientReq = http.request(clientOptions, function(res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//Handle custom header for something special</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (res.headers['x-ample'] === 'trigger') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('x-ample header trigger');</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//work with status codes</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">switch(res.statusCode) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 200:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.setEncoding('utf8'); // unless you can read buffer chunks</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('data', data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 404:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('404 error');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">default:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(res.statusCode + ': ' + http.STATUS_CODES[res.statusCode]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('required header not present');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">clientReq.on('error', function(error) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">throw error;</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">clientReq.setHeader('Cache-Control', 'no-cache');</span><br><span class="FontName1">clientReq.end();</span></pre>
</div>
<div>
<p id="Sec28" class="Heading2">How It Works</p>
<p class="noindent">The callback function on the <span class="FontName1">http.request</span> function is an event handler for the ‘<span class="FontName1">response</span>’ event. This event listener is the only way to receive data from the server response<a id="cXXX.286a"></a>. If you omit the ‘response’ listener or callback, your client request will never receive any data from the server.</p>
<p class="indent">Once you have set up a client request with the proper listener to the ‘<span class="FontName1">response</span>’ event, you then are able to get the data from the response. The response is a readable stream, so you are able to process the data either by adding a listener for the ‘<span class="FontName1">data</span>’ event or by calling <span class="FontName1">response.read()</span> once the stream becomes “<span class="FontName1">readable</span>.”</p>
<p class="indent">In this example, you avoid reading the data from the response directly until you have examined a certain value from the response. One of these values is to inspect the headers that are sent from the response. Because the response is a readable stream that contains the headers object, you simply check for the header wish to parse; compare its value against the value required in your application.</p>
<p class="noindent2"><b><i>Listing 4-20</i></b>.&nbsp;&nbsp;Response Headers</p>
<pre><span class="FontName1">if (res.headers['x-ample'] === 'trigger') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('x-ample header trigger');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">/* . . . */</span><br><span class="FontName1">}</span></pre>
<p class="indent">You then continue on with the processing of the response. In this solution the next step is to check the response status code. If the status code is anything besides a 200 OK, you will not read the data from the response. Of course, if everything checks out, you will read the response body.</p>
<p class="noindent2"><b><i>Listing 4-21</i></b>.&nbsp;&nbsp;Response Status Codes</p>
<pre><span class="FontName1">switch(res.statusCode) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">case 200:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>res.setEncoding('utf8');</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>res.on('data', function(data) {</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>console.log('data', data);</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>});</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">case 404:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">console.log('404 error');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">default:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">console.log(res.statusCode + ': ' + http.STATUS_CODES[res.statusCode]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">break;</span><br><span class="FontName1">}</span></pre>
<p class="indent">Reading the response is done in two steps. First, for the purpose of making the response readable, set the encoding to UTF-8.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list22" id="list22">Listing 4-22</a></i></b>.&nbsp;&nbsp;Response Default Encoding</p>
<pre><span class="FontName1">data &lt;Buffer 67 65 74 0a&gt;</span></pre>
<p class="noindent2"><b><i>Listing 4-23</i></b>.&nbsp;&nbsp;Response UTF-8 Encoded</p>
<pre><span class="FontName1">data get</span></pre>
<p class="indent">By strategically reviewing the response object that is returned to your HTTP request callback, you can handle a variety of parameters and tasks that are specific to your Node.js solution.</p>
</div>
<p id="Sec29" class="Heading1">4-8. Processing Client Requests<a id="cXXX.299a"></a></p>
<div>
<p id="Sec30" class="Heading2_2">Problem</p>
<p class="noindent">You have created an HTTP client, and you have learned how to handle responses from it. Now you need to control your client requests in greater detail.</p>
</div>
<div>
<p id="Sec31" class="Heading2">Solution</p>
<p class="noindent">You start off by building an HTTP GET request. A GET request can be formed in two ways. First, if you do not need to control custom headers or when to send the <span class="FontName1">request.end()</span> event, you can swiftly implement an HTTP GET request with Node.js by using <span class="FontName1">http.get()</span><a id="cXXX.296"></a>
<span class="FontName1">.</span></p>
<p class="noindent2"><b><i>Listing 4-24</i></b>.&nbsp;&nbsp;Using http.get()</p>
<pre><span class="FontName1">var http = require('http');</span><br>&nbsp;<br><span class="FontName1">var getReq = http.get('</span><span class="FontName1"><a href="http://localhost:8080/">http://localhost:8080</a></span><span class="FontName1">', function(res) {</span><br>&nbsp;&nbsp;<span class="FontName1">console.log('status code', res.statusCode, ': ', http.STATUS_CODES[res.statusCode]);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">getReq.on('error', function(err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(err);</span><br><span class="FontName1">});</span></pre>
<p class="indent">Alternatively, if you need to be able to control certain aspects of your headers, but you still just need to process an HTTP GET request, you will want to use the full <span class="FontName1">http.request</span> method<a id="cXXX.297"></a> instead.</p>
<p class="noindent2"><b><i>Listing 4-25</i></b>.&nbsp;&nbsp;HTTP GET Using http.request</p>
<pre><span class="FontName1">var http = require('http');</span><br>&nbsp;<br><span class="FontName1">var clientOptions = {</span><br>&nbsp;&nbsp;<span class="FontName1">host: 'localhost',</span><br>&nbsp;&nbsp;<span class="FontName1">port: '8080',</span><br>&nbsp;&nbsp;<span class="FontName1">path: '/',</span><br>&nbsp;&nbsp;<span class="FontName1">method: 'GET',</span><br>&nbsp;&nbsp;<span class="FontName1">headers: { 'Connection': 'keep-alive',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">'Content-Length': 0 }</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var clientReq = http.request(clientOptions, function(res) {</span><br>&nbsp;&nbsp;<span class="FontName1">console.log('status code', res.statusCode, ': ', http.STATUS_CODES[res.statusCode]);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">clientReq.on('continue', function(res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('continue event due to 100-continue');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">clientReq.on('error', function(error) {</span><br>&nbsp;&nbsp;<span class="FontName1">throw error;</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">clientReq.end();</span></pre>
<p class="indent">As you build a Node.js application you may encounter the situation at some point where you need to process a data upload. In Node.js you would process this <span class="FontName1">http.request</span> with the POST method<a id="cXXX.298"></a>. This request then writes the upload with the <span class="FontName1">request.write</span> function.</p>
<p class="noindent2"><b><i>Listing 4-26</i></b>.&nbsp;&nbsp;Uploading with an HTTP POST</p>
<pre><span class="FontName1">var http = require('http');</span><br>&nbsp;<br><span class="FontName1">var opt = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">host : 'localhost',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">port : 8080,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">path : '/upload',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">method : 'POST'</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var upload = http.request(opt, function(res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('status code', res.statusCode, ': ', http.STATUS_CODES[res.statusCode]);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">upload.on('error', function(err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(err);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">upload.write('my upload stuff');</span><br><span class="FontName1">upload.end();</span></pre>
</div>
<div>
<p id="Sec32" class="Heading2">How It Works</p>
<p class="noindent">The first solution for retrieving content via a client request is using <span class="FontName1">http.get()</span>. The HTTP GET is an abstraction of the <span class="FontName1">http.request</span>. In fact the <span class="FontName1">http.get()</span> function<a id="cXXX.299"></a> calls the default <span class="FontName1">http.request</span>, allowing all the default options to be set; it then immediately calls the <span class="FontName1">request.end()</span> method<a id="cXXX.300"></a> and completes the request.</p>
<p class="noindent2"><b><i>Listing 4-27</i></b>.&nbsp;&nbsp;Node.js http Module, GET Method<a id="cXXX.301"></a></p>
<pre><span class="FontName1">exports.get = function(options, cb) {</span><br>&nbsp;&nbsp;<span class="FontName1">var req = exports.request(options, cb);</span><br>&nbsp;&nbsp;<span class="FontName1">req.end();</span><br>&nbsp;&nbsp;<span class="FontName1">return req;</span><br><span class="FontName1">};</span></pre>
<p class="indent">Next, you retrieve content via the <span class="FontName1">http.request</span> method with the method option set to ‘<span class="FontName1">GET</span>’. This is a standard GET request but you also pass along two specific headers with it. The Connection header with the value set to ‘<span class="FontName1">keep-alive</span>’ will tell Node.js to keep the connection to the server open until the next request. The other header set in this solution is the <span class="FontName1">Content-Length</span> header. This header, once set, will prevent Node.js from using the default chunked encoding. In the <span class="FontName1">http.request</span> options, there are two other noteworthy headers that are not used in this solution.</p>
<p class="indent">One of these headers is the <span class="FontName1">Expect</span> Header. Setting this header will immediately send the request headers in order to account for the potential <span class="FontName1">Expect: 100-continue</span> header, which we will see in more detail when handling events in Section 4-9.</p>
<p class="indent">The final noteworthy header for <span class="FontName1">http.request</span> is when you send an authorization header. This header will replace the need for utilizing the <span class="FontName1">auth</span> option when configuring the settings for your <span class="FontName1">http.request</span>.</p>
<p class="indent">The last part of your solution for working with HTTP client requests is to demonstrate how to handle a file upload request. To do this, a few things must happen. First, as you might expect, do not utilize the HTTP GET method. Instead, set the method option to HTTP POST for the upload. You then process the upload by sending the data through the <span class="FontName1">http.request</span>’s write method.</p>
<p class="indent">You now have seen how to handle requests using an HTTP client request on your web server. Next, you will see various events emitted and consumed on your web server.</p>
</div>
<p id="Sec33" class="Heading1">4-9. Responding to Events</p>
<div>
<p id="Sec34" class="Heading2_2">Problem</p>
<p class="noindent">You have a web server that you have built in Node.js. You now need to handle and properly respond to events that are emitted or listened for on your server.</p>
</div>
<div>
<p id="Sec35" class="Heading2">Solution</p>
<p class="noindent">To properly represent this solution, you need to understand both sides of the event. To do this you will build both an HTTP web server and an HTTP client.</p>
<p class="indent">The server (see <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list28" id="_list28">Listing 4-28</a>) is built to handle different methods of requests and events. First, your web server will listen for incoming requests<a id="cXXX.302"></a>. In the event of these requests, you will want to welcome the requester with a plaintext response.</p>
<p class="indent">Second, you will want to monitor connections to this server by listening for the connection event<a id="cXXX.303"></a>. This will then increment the total number of connections that have been made to your server.</p>
<p class="indent">You want your server to handle a few special events as well. One of these events is the event that listens for incoming requests that have sent the ‘<span class="FontName1">Expect: 100-continue</span>’ header. This is for client connections that wish to determine if your server is capable of receiving the message before actually sending the body of the request. The event you need to listen for in this case is the ‘<span class="FontName1">checkContinue</span>’ event<a id="cXXX.304"></a>. You will also want to allow for the ‘<span class="FontName1">Request: Upgrade</span>’ header in order for the request to be upgraded by listening for the ‘<span class="FontName1">upgrade</span>’ event<a id="cXXX.305"></a> on your server. The upgrade header can then be sent to upgrade the transport to TLS or, in this case, WebSockets.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list28" id="list28">Listing 4-28</a></i></b>.&nbsp;&nbsp;Web Server Events</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Responding to events</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">server = http.createServer(),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connections = 0;</span><br>&nbsp;<br><span class="FontName1">// request event</span><br><span class="FontName1">server.on('request', function(req, res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('request');//, req);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeHead(200, { 'Content-Type': 'text/plain'});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end('heyo');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.on('connection', function(socket) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connections++;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connection count: ', connections);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.on('checkContinue', function(req, res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('checkContinue');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeContinue();</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.on('upgrade', function(req, socket, head) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('upgrade');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.write('HTTP/1.1 101 Web Socket Protocol Handshake\r\n' +</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">'Upgrade: WebSocket\r\n' +</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">'Connection: Upgrade\r\n' +</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">'Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=\r\n' +</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">'Sec-WebSocket-Protocol: chat\r\n' +</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">'\r\n');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.pipe(socket);</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.listen(8080);</span></pre>
<p class="indent">In order to properly experience these events you need to have two sets of clients that connect to this server. The first client you will build, <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list22" id="_list22">Listing 4-22</a>, is one in which you need to provide the events necessary in order to provide both the Expect header, ‘<span class="FontName1">Expect: 100-continue</span>’ , and to properly respond to the continue event emitted from the server.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list29" id="list29">Listing 4-29</a></i></b>.&nbsp;&nbsp;Client Events<a id="cXXX.304b"></a> for Handling Expect: 100-continue<a id="cXXX.306"></a></p>
<pre><span class="FontName1">/*</span><br><span class="FontName1">* client events</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http');</span><br>&nbsp;<br><span class="FontName1">var clientOptions = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">host: 'localhost',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// hostname:'nodejs.org',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">port: '8080',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">path: '/',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">method: 'GET',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">headers: { 'Expect': '100-continue' }</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var clientReq = http.request(clientOptions, function(res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('status code', res.statusCode);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">switch(res.statusCode) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 200:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.setEncoding('utf8'); // unless you can read buffer chunks</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('data', data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 404:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('404 error');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">clientReq.on('continue', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('client continue');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">clientReq.on('error', function(error) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">throw error;</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">clientReq.end();</span></pre>
<p class="indent">The second client you will create to demonstrate the events emitted and consumed by your web server is to create one that will handle the upgrade<a id="cXXX.307"></a> to a WebSocket server. This happens in the client that you create in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list30" id="_list30">Listing 4-30</a>, which is similar in design to <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list29" id="_list29">Listing 4-29</a>. However, it handles different events to provide a different implementation.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list30" id="list30">Listing 4-30</a></i></b>.&nbsp;&nbsp;Upgrade Client</p>
<pre><span class="FontName1">/*</span><br><span class="FontName1">* client events</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http');</span><br>&nbsp;<br><span class="FontName1">var clientOptions = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">host: 'localhost',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// hostname:'nodejs.org',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">port: '8080',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">path: '/',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">method: 'GET',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">headers: { 'Connection': 'Upgrade',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'Upgrade': 'websocket',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'Sec-WebSocket-Key': 'dGhlIHNhbXBsZSBub25jZQ==',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'Origin' :'localhost',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'Sec-WebSocket-Protocol': 'chat',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'Sec-WebSocket-Version': 13 }</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var clientReq = http.request(clientOptions, function(res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('status code', res.statusCode);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">switch(res.statusCode) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 200:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.setEncoding('utf8'); // unless you can read buffer chunks</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.on('data', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('data', data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 404:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('404 error');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">clientReq.on('upgrade', function(res, socket, head) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('client upgrade');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">clientReq.on('error', function(error) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">throw error;</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">clientReq.end();</span></pre>
</div>
<div>
<p id="Sec36" class="Heading2">How It Works</p>
<p class="noindent">Events are a critical part of building a successful Node.js application. To that point, building a successful web server in Node.js must incorporate a proper handling of events that are emitted between the client and server. In the solution in this section you created a web server that solves multiple problems all at the same time.</p>
<p class="indent">This server starts off listening for the request event. This request event is emitted each time there is a request to the server. Once the request is received, you send a response to the requester, in this case a simple greeting. The callback to the request event is one that provides both the request and the response object; in fact, this event is the same as adding the callback to the <span class="FontName1">http.createServer</span> function<a id="cXXX.308"></a> directly.</p>
<p class="indent">Your next listener on this is used to track connections to the server by listening to when the connection event is emitted. This happens each time there is a connection to the server. This occurs when you increment a counter each time there is a connection. The connection event sends the connected socket object along in the callback function, allowing you access to the <span class="FontName1">net.Socket</span> if you desire.</p>
<p class="indent">Handling the ‘<span class="FontName1">Expect: 100-continue</span>’ header happens in the next event listener. This listener is bound to the ‘<span class="FontName1">checkContinue</span>’ event. This event is emitted only when the request sends an expect header. If you are not listening for this event, the server will send the appropriate continue response itself.</p>
<p class="noindent2"><b><i>Listing 4-31</i></b>.&nbsp;&nbsp;Node.js Emitting checkContinue When the Expect Header Is Present</p>
<pre><span class="FontName1">if (req.headers.expect !== undefined &amp;&amp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">(req.httpVersionMajor == 1 &amp;&amp; req.httpVersionMinor == 1) &amp;&amp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">continueExpression.test(req.headers['expect'])) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res._expect_continue = true;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (EventEmitter.listenerCount(self, 'checkContinue') &gt; 0) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self.emit('checkContinue', req, res);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeContinue();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">self.emit('request', req, res);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">}</span></pre>
<p class="indent">If you are handling this event appropriately, you need to signify to the request that it is allowable to continue sending the body of the request. This is done by calling the <span class="FontName1">response.writeContinue</span>() function<a id="cXXX.309"></a>. This function writes the appropriate HTTP 100 response to the requester.</p>
<p class="noindent2"><b><i>Listing 4-32</i></b>.&nbsp;&nbsp;response.writeContinue Sending the HTTP 100 Continue Response</p>
<pre><span class="FontName1">ServerResponse.prototype.writeContinue = function() {</span><br>&nbsp;&nbsp;<span class="FontName1">this._writeRaw('HTTP/1.1 100 Continue' + CRLF + CRLF, 'ascii');</span><br>&nbsp;&nbsp;<span class="FontName1">this._sent100 = true;</span><br><span class="FontName1">};</span></pre>
<p class="indent">This continue event only works if you send the appropriate header, as in the client request from <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list22">Listing 4-22</a>: <span class="FontName1">headers: { ‘expect’ : ‘100-continue’ }</span>. You then listen for the connect event from your client request application, signifying when the <span class="FontName1">response.writeContinue()</span> function has been called and the HTTP 100 response has been sent.</p>
<p class="indent">Finally, your server is set up to handle an upgrade to the WebSocket protocol. This protocol is initiated through a handshake process handled by events emitted from both your client request and your web server. This process starts when the client sends an upgrade header: headers: <span class="FontName1">{ 'Connection': 'Upgrade', 'Upgrade': 'websocket'}</span>. Along with these header fields a WebSocket key is sent that the server will then utilize to validate that the request handshake was received. When this header is present, an ‘<span class="FontName1">upgrade’</span> event will be emitted, and you will listen for this upgrade event on your server.</p>
<p class="indent">The ‘upgrade’ event on your server has a callback function with three arguments: the request, the socket, and the header. In order to complete the requesting WebSocket handshake, you must send the appropriate HTTP response. In this case that is a HTTP 101 Web Socket Protocol Handshake with the same upgrade and connection headers. Also sent back is the websocket-accept header, which is a validation of receipt of the key from the request. Once the headers have been sent, then your client can receive an upgrade event as well as complete the WebSocket upgrade handshake.</p>
<p class="indent">This upgrade event also introduces the .pipe method on the socket stream. Streams are an integral part to building many Node.js applications. This is a way of managing in a concise and uniform manner the input and the output of a stream. This can occur by taking a source stream that is readable and piping it to a destination stream that is writable. This results in the return of the destination stream. In this upgrade event callback, you write <span class="FontName1">socket.pipe(socket);</span>. This takes the source (or socket) that you have just called socket.write()<a id="cXXX.310"></a> on in order to add the WebSocket upgrade headers. It then pipes that out to <span class="FontName1">.pipe(socket)</span>, which represents the destination stream.</p>
</div>
<p id="Sec37" class="Heading1">4-10. Serving a Static Page via the File System<a id="cXXX.311"></a></p>
<div>
<p id="Sec38" class="Heading2_2">Problem</p>
<p class="noindent">You are building a web server. Serving HTML directly from your Node.js code is not maintainable or desirable. You need to be able to serve your content from files that reside on the file system itself.</p>
</div>
<div>
<p id="Sec39" class="Heading2">Solution</p>
<p class="noindent">To build a web server that serves content, you need to leverage both the HTTP module and the file system module that are part of the Node.js core. You will build your server to handle errors on the server, and you can then respond with the proper status codes. You will also be sure to send the appropriate response headers with your files you are serving. This means you need to be mindful of the mime type of the content you are serving. To do this, use a simple URL structure to know what routes in your application will request which types of files from your web server.</p>
<p class="noindent2"><b><i>Listing 4-33</i></b>.&nbsp;&nbsp;A Static File Web Server</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* serving static HTML with the file system</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fs = require('fs'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">path = require('path');</span><br>&nbsp;<br><span class="FontName1">//Content types map</span><br><span class="FontName1">var contentTypes = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'.htm'&nbsp;&nbsp;: 'text/html',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'.html' : 'text/html',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'.js'&nbsp;&nbsp; : 'text/javascript',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'.json' : 'application/json',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'.css'&nbsp;&nbsp;: 'text/css'</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(req, res) {</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var fileStream = fs.createReadStream(req.url.split('/')[1]);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fileStream.on('error', function(error) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (error.code === 'ENOENT') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 404;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(http.STATUS_CODES[404]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 500;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(http.STATUS_CODES[500]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//Get the extension</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var extension = path.extname(req.url);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//read the extension against the content type map - default to plain text</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var contentType = contentTypes[extension] || 'text/plain';</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// add the content type header</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeHead(200, { 'Content-Type' : contentType });</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// pipe the stream to the response stream</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fileStream.pipe(res);</span><br>&nbsp;<br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">server.listen(8080);</span></pre>
<p class="indent">You now have a web server from which to serve static files from the file system. To test this functionality, you need to build two test files as well. One will be the base HTML file. The second is a JSON file. This file is to represent the response of a hypothetical API you may build to be accessed from your application. These files are shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list34" id="_list34">Listings 4-34</a> and <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#list35" id="_list35">4-35</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list34" id="list34">Listing 4-34</a></i></b>.&nbsp;&nbsp;Base HTML File to Serve</p>
<pre><span class="FontName1">&lt;!doctype html&gt;</span><br><span class="FontName1">&lt;html&gt;</span><br><span class="FontName1">&lt;head&gt;</span><br><span class="FontName1">&lt;title&gt;Static HTML&lt;/title&gt;</span><br><span class="FontName1">&lt;/head&gt;</span><br><span class="FontName1">&lt;body&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;h2&gt;Node.js Recipes&lt;/h2&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;p&gt; Tasty &lt;/p&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;button id='getJSON'&gt;Get JSON file&lt;/button&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;script type='text/javascript'&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// bind to click</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var btn = document.getElementById('getJSON');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">btn.addEventListener('click', getJSONContent, false);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Send a request to the server for the JSON file</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">function getJSONContent() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var xhr = new XMLHttpRequest();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">xhr.onload = jsonRetrieved;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">xhr.open('GET', '/4-10-1.json', true);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">xhr.send();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// Log to the console</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">function jsonRetrieved() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(this.responseText);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;/script&gt;</span><br><span class="FontName1">&lt;/body&gt;</span><br><span class="FontName1">&lt;/html&gt;</span></pre>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#_list35" id="list35">Listing 4-35</a></i></b>.&nbsp;&nbsp;Sample JSON File to Be Served</p>
<pre><span class="FontName1">{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'Test': 'if',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">'this':'sends'</span><br><span class="FontName1">}</span></pre>
</div>
<div>
<p id="Sec40" class="Heading2">How It Works</p>
<p class="noindent">Let us investigate how your fully functional web server works. First, you utilize the HTTP module for this server. You also augment that module with the file system and the URL modules. This will allow you to fetch and read files from your web server’s file system, and the URL module allows for parsing of the URLs in order to properly route your content.</p>
<p class="indent">Now you create a web server by calling <span class="FontName1">http.createServer</span> and having that server listen to your specified port. The real meat of this solution lies in the <span class="FontName1">requestListener</span> callback. Within this callback you can handle both the incoming request and the outgoing response.</p>
<p class="indent">When you receive a request, the first thing your server does is read the incoming request URL into a stream by using fs.createReadStream. You then immediately bind to the error event of the file stream. This will allow you to create the appropriate error response code to send to the client. In your case you send a 404 not found if the error code is ENOENT (no such file or directory) and fall back to a general 500 server error for other errors.</p>
<p class="indent">You then parse the extension from the request URL. This is done by using the Node.js path module, which has a method ‘extname’ that will return the extension of a given path. This is then used against a content-type object that you have created to map a given extension to the appropriate content type you wish to serve from your server. Once you have mapped the extension to a content type you are able to write that content-type header to the response. This is followed by piping the file stream to the response.</p>
<p class="indent">Next you examine the case of the mocked-up JSON API you have built into your web server. This route is on the URL <span class="FontName1">/*.json</span>. This represents what would possibly be a call to a database to retrieve information, but in our case it retrieves a JSON file that will be sent with “<span class="FontName1">Content-Type: application/json</span>” in the header.</p>
<p class="indent">You can now generically serve any type of content that is requested of your web server. You can test this by running your server and then navigating to various URLs. If you navigate to //localhost:8080/4-10-1.html, you will then be presented with an HTML page. This page has a button you can press that will submit an XMLHttpRequest to your JSON API, logging the content to the console. You can, of course, navigate to the /4-10-1.json route directly, where you will receive the JSON as well. Testing for a 404, you can simply attempt to curl <span class="FontName1"><a href="http://localhost:8080/404">http://localhost:8080/404</a></span> and you will receive the 404 as expected:</p>
<pre><span class="FontName1">&gt; GET /404 HTTP/1.1</span><br><span class="FontName1">&gt; User-Agent: curl/7.21.4 (universal-apple-darwin11.0) libcurl/7.21.4 OpenSSL/0.9.8r zlib/1.2.5</span><br><span class="FontName1">&gt; Host: localhost:8080</span><br><span class="FontName1">&gt; Accept: */*</span><br><span class="FontName1">&gt;</span><br><span class="FontName1">&lt; HTTP/1.1 404 Not Found</span><br><span class="FontName1">&lt; Date: Sat, 18 May 2013 19:17:55 GMT</span><br><span class="FontName1">&lt; Connection: keep-alive</span><br><span class="FontName1">&lt; Transfer-Encoding: chunked</span></pre>
</div>
</div>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#">
			
				Add Note
			
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch03.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">CHAPTER 3: Using the File System</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch05.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">CHAPTER 5: Using Events and Child Processes</div>
        </a>
    
  
  </div>


        
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781430260585/chapter/9781430260585_Ch04.xhtml" data-for-analytics="9781430260585:9781430260585_Ch04.xhtml" aria-label="Add to Queue">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel  collapsed slideUp">
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" class="js-toggle-nag ss-navigateup" title="Toggle open or close footer"></a>
        <div class="sample-message">
          <p class="usage-data t-collapsed-text">Enjoy Safari?
            <a class="ga-active-trial-subscribe-nag" href="https://www.safaribooksonline.com/subscribe/">
              Subscribe Today
              
            </a>
          </p>
          

        <div class="expanded">
          <h2>You have 10 days left in your trial, Raviguru0007. </h2>
          <p class="t-expanded-text">Safari is your trusted guide for building a remarkable career. We hope you've been enjoying your trial—ready to join?</p>
          <a href="https://www.safaribooksonline.com/subscribe/" class="button-primary">
            Subscribe Today
            
          </a>
          
          <footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
    <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" class="icon-up" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/contact/">Contact Us</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
    </ul>
    <span class="copyright">© 2017 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/membership-agreement/">Membership Agreement</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>

        </div>
      </div>
    </div>

    
    



        
      </div>
      




  <footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
    <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" class="icon-up" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2017 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>

<script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"applicationID":"3275661","errorBeacon":"bam.nr-data.net","agent":"","beacon":"bam.nr-data.net","queueTime":0,"licenseKey":"510f1a6865","applicationTime":712,"transactionName":"YgdaZ0NSW0cEB0RdWltNfkZfUEFdCgofXFBHDVYdR1pQQxZeRl1QQj1aWkU="}</script>


    

    <script src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/saved_resource" charset="utf-8"></script>
    <script src="./CHAPTER 4_ Building a Web Server - Node.js Recipes_ A Problem-Solution Approach_files/saved_resource(1)" charset="utf-8"></script>
  

<div class="annotator-notice"></div><div class="font-flyout" style="top: 200.012px; left: 1217px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml#">Reset</a>
</div>
</div></body></html>