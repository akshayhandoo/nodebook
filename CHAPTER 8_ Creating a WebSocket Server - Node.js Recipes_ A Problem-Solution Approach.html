<!DOCTYPE html>
<!-- saved from url=(0102)https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" "="" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="" data-user-id="1573407" data-user-uuid="29525685-85c9-45c7-9eda-3c178d86398e" data-username="raviguru0007" data-account-type="Trial" data-activated-trial-date="04/17/2017" data-archive="9781430260585" data-publishers="Apress" data-htmlfile-name="9781430260585_Ch08.xhtml" data-epub-title="Node.js Recipes: A Problem-Solution Approach" data-debug="0" data-testing="0"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="Safari Books Online"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781430260585"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><script type="text/javascript" src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/510f1a6865"></script><script src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/nr-spa-1026.min.js"></script><script type="text/javascript" async="" src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/linkid.js"></script><script async="" src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/analytics.js"></script><script type="text/javascript">(window.NREUM||(NREUM={})).loader_config={xpid:"VQQDUVVVGwACU1RUAQA="};window.NREUM||(NREUM={}),__nr_require=function(t,e,n){function r(n){if(!e[n]){var o=e[n]={exports:{}};t[n][0].call(o.exports,function(e){var o=t[n][1][e];return r(o||e)},o,o.exports)}return e[n].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,e,n){function r(t){try{c.console&&console.log(t)}catch(e){}}var o,i=t("ee"),a=t(19),c={};try{o=localStorage.getItem("__nr_flags").split(","),console&&"function"==typeof console.log&&(c.console=!0,o.indexOf("dev")!==-1&&(c.dev=!0),o.indexOf("nr_dev")!==-1&&(c.nrDev=!0))}catch(s){}c.nrDev&&i.on("internal-error",function(t){r(t.stack)}),c.dev&&i.on("fn-err",function(t,e,n){r(n.stack)}),c.dev&&(r("NR AGENT IN DEVELOPMENT MODE"),r("flags: "+a(c,function(t,e){return t}).join(", ")))},{}],2:[function(t,e,n){function r(t,e,n,r,o){try{d?d-=1:i("err",[o||new UncaughtException(t,e,n)])}catch(c){try{i("ierr",[c,s.now(),!0])}catch(u){}}return"function"==typeof f&&f.apply(this,a(arguments))}function UncaughtException(t,e,n){this.message=t||"Uncaught error with no additional information",this.sourceURL=e,this.line=n}function o(t){i("err",[t,s.now()])}var i=t("handle"),a=t(20),c=t("ee"),s=t("loader"),f=window.onerror,u=!1,d=0;s.features.err=!0,t(1),window.onerror=r;try{throw new Error}catch(p){"stack"in p&&(t(12),t(11),"addEventListener"in window&&t(6),s.xhrWrappable&&t(13),u=!0)}c.on("fn-start",function(t,e,n){u&&(d+=1)}),c.on("fn-err",function(t,e,n){u&&(this.thrown=!0,o(n))}),c.on("fn-end",function(){u&&!this.thrown&&d>0&&(d-=1)}),c.on("internal-error",function(t){i("ierr",[t,s.now(),!0])})},{}],3:[function(t,e,n){t("loader").features.ins=!0},{}],4:[function(t,e,n){function r(){C++,N=y.hash,this[u]=M.now()}function o(){C--,y.hash!==N&&i(0,!0);var t=M.now();this[l]=~~this[l]+t-this[u],this[d]=t}function i(t,e){x.emit("newURL",[""+y,e])}function a(t,e){t.on(e,function(){this[e]=M.now()})}var c="-start",s="-end",f="-body",u="fn"+c,d="fn"+s,p="cb"+c,h="cb"+s,l="jsTime",m="fetch",v="addEventListener",w=window,y=w.location;if(w[v]){var b=t(9),g=t(10),x=t(8),E=t(6),O=t(12),R=t(7),P=t(13),T=t("ee"),S=T.get("tracer");t(14);var M=t("loader");M.features.spa=!0;var N,j=w[v],C=0;T.on(u,r),T.on(p,r),T.on(d,o),T.on(h,o),T.buffer([u,d,"xhr-done","xhr-resolved"]),E.buffer([u]),O.buffer(["setTimeout"+s,"clearTimeout"+c,u]),P.buffer([u,"new-xhr","send-xhr"+c]),R.buffer([m+c,m+"-done",m+f+c,m+f+s]),x.buffer(["newURL"]),b.buffer([u]),g.buffer(["propagate",p,h,"executor-err","resolve"+c]),S.buffer([u,"no-"+u]),a(P,"send-xhr"+c),a(T,"xhr-resolved"),a(T,"xhr-done"),a(R,m+c),a(R,m+"-done"),x.on("pushState-end",i),x.on("replaceState-end",i),j("hashchange",i,!0),j("load",i,!0),j("popstate",function(){i(0,C>1)},!0)}},{}],5:[function(t,e,n){function r(t){}if(window.performance&&window.performance.timing&&window.performance.getEntriesByType){var o=t("ee"),i=t("handle"),a=t(12),c=t(11),s="learResourceTimings",f="addEventListener",u="resourcetimingbufferfull",d="bstResource",p="resource",h="-start",l="-end",m="fn"+h,v="fn"+l,w="bstTimer",y="pushState",b=t("loader");b.features.stn=!0,t(8);var g=NREUM.o.EV;o.on(m,function(t,e){var n=t[0];n instanceof g&&(this.bstStart=b.now())}),o.on(v,function(t,e){var n=t[0];n instanceof g&&i("bst",[n,e,this.bstStart,b.now()])}),a.on(m,function(t,e,n){this.bstStart=b.now(),this.bstType=n}),a.on(v,function(t,e){i(w,[e,this.bstStart,b.now(),this.bstType])}),c.on(m,function(){this.bstStart=b.now()}),c.on(v,function(t,e){i(w,[e,this.bstStart,b.now(),"requestAnimationFrame"])}),o.on(y+h,function(t){this.time=b.now(),this.startPath=location.pathname+location.hash}),o.on(y+l,function(t){i("bstHist",[location.pathname+location.hash,this.startPath,this.time])}),f in window.performance&&(window.performance["c"+s]?window.performance[f](u,function(t){i(d,[window.performance.getEntriesByType(p)]),window.performance["c"+s]()},!1):window.performance[f]("webkit"+u,function(t){i(d,[window.performance.getEntriesByType(p)]),window.performance["webkitC"+s]()},!1)),document[f]("scroll",r,{passive:!0}),document[f]("keypress",r,!1),document[f]("click",r,!1)}},{}],6:[function(t,e,n){function r(t){for(var e=t;e&&!e.hasOwnProperty(u);)e=Object.getPrototypeOf(e);e&&o(e)}function o(t){c.inPlace(t,[u,d],"-",i)}function i(t,e){return t[1]}var a=t("ee").get("events"),c=t(22)(a,!0),s=t("gos"),f=XMLHttpRequest,u="addEventListener",d="removeEventListener";e.exports=a,"getPrototypeOf"in Object?(r(document),r(window),r(f.prototype)):f.prototype.hasOwnProperty(u)&&(o(window),o(f.prototype)),a.on(u+"-start",function(t,e){var n=t[1],r=s(n,"nr@wrapped",function(){function t(){if("function"==typeof n.handleEvent)return n.handleEvent.apply(n,arguments)}var e={object:t,"function":n}[typeof n];return e?c(e,"fn-",null,e.name||"anonymous"):n});this.wrapped=t[1]=r}),a.on(d+"-start",function(t){t[1]=this.wrapped||t[1]})},{}],7:[function(t,e,n){function r(t,e,n){var r=t[e];"function"==typeof r&&(t[e]=function(){var t=r.apply(this,arguments);return o.emit(n+"start",arguments,t),t.then(function(e){return o.emit(n+"end",[null,e],t),e},function(e){throw o.emit(n+"end",[e],t),e})})}var o=t("ee").get("fetch"),i=t(19);e.exports=o;var a=window,c="fetch-",s=c+"body-",f=["arrayBuffer","blob","json","text","formData"],u=a.Request,d=a.Response,p=a.fetch,h="prototype";u&&d&&p&&(i(f,function(t,e){r(u[h],e,s),r(d[h],e,s)}),r(a,"fetch",c),o.on(c+"end",function(t,e){var n=this;e?e.clone().arrayBuffer().then(function(t){n.rxSize=t.byteLength,o.emit(c+"done",[null,e],n)}):o.emit(c+"done",[t],n)}))},{}],8:[function(t,e,n){var r=t("ee").get("history"),o=t(22)(r);e.exports=r,o.inPlace(window.history,["pushState","replaceState"],"-")},{}],9:[function(t,e,n){var r=t("ee").get("mutation"),o=t(22)(r),i=NREUM.o.MO;e.exports=r,i&&(window.MutationObserver=function(t){return this instanceof i?new i(o(t,"fn-")):i.apply(this,arguments)},MutationObserver.prototype=i.prototype)},{}],10:[function(t,e,n){function r(t){var e=a.context(),n=c(t,"executor-",e),r=new f(n);return a.context(r).getCtx=function(){return e},a.emit("new-promise",[r,e],e),r}function o(t,e){return e}var i=t(22),a=t("ee").get("promise"),c=i(a),s=t(19),f=NREUM.o.PR;e.exports=a,f&&(window.Promise=r,["all","race"].forEach(function(t){var e=f[t];f[t]=function(n){function r(t){return function(){a.emit("propagate",[null,!o],i),o=o||!t}}var o=!1;s(n,function(e,n){Promise.resolve(n).then(r("all"===t),r(!1))});var i=e.apply(f,arguments),c=f.resolve(i);return c}}),["resolve","reject"].forEach(function(t){var e=f[t];f[t]=function(t){var n=e.apply(f,arguments);return t!==n&&a.emit("propagate",[t,!0],n),n}}),f.prototype["catch"]=function(t){return this.then(null,t)},f.prototype=Object.create(f.prototype,{constructor:{value:r}}),s(Object.getOwnPropertyNames(f),function(t,e){try{r[e]=f[e]}catch(n){}}),a.on("executor-start",function(t){t[0]=c(t[0],"resolve-",this),t[1]=c(t[1],"resolve-",this)}),a.on("executor-err",function(t,e,n){t[1](n)}),c.inPlace(f.prototype,["then"],"then-",o),a.on("then-start",function(t,e){this.promise=e,t[0]=c(t[0],"cb-",this),t[1]=c(t[1],"cb-",this)}),a.on("then-end",function(t,e,n){this.nextPromise=n;var r=this.promise;a.emit("propagate",[r,!0],n)}),a.on("cb-end",function(t,e,n){a.emit("propagate",[n,!0],this.nextPromise)}),a.on("propagate",function(t,e,n){this.getCtx&&!e||(this.getCtx=function(){if(t instanceof Promise)var e=a.context(t);return e&&e.getCtx?e.getCtx():this})}),r.toString=function(){return""+f})},{}],11:[function(t,e,n){var r=t("ee").get("raf"),o=t(22)(r),i="equestAnimationFrame";e.exports=r,o.inPlace(window,["r"+i,"mozR"+i,"webkitR"+i,"msR"+i],"raf-"),r.on("raf-start",function(t){t[0]=o(t[0],"fn-")})},{}],12:[function(t,e,n){function r(t,e,n){t[0]=a(t[0],"fn-",null,n)}function o(t,e,n){this.method=n,this.timerDuration="number"==typeof t[1]?t[1]:0,t[0]=a(t[0],"fn-",this,n)}var i=t("ee").get("timer"),a=t(22)(i),c="setTimeout",s="setInterval",f="clearTimeout",u="-start",d="-";e.exports=i,a.inPlace(window,[c,"setImmediate"],c+d),a.inPlace(window,[s],s+d),a.inPlace(window,[f,"clearImmediate"],f+d),i.on(s+u,r),i.on(c+u,o)},{}],13:[function(t,e,n){function r(t,e){d.inPlace(e,["onreadystatechange"],"fn-",c)}function o(){var t=this,e=u.context(t);t.readyState>3&&!e.resolved&&(e.resolved=!0,u.emit("xhr-resolved",[],t)),d.inPlace(t,v,"fn-",c)}function i(t){w.push(t),l&&(b=-b,g.data=b)}function a(){for(var t=0;t<w.length;t++)r([],w[t]);w.length&&(w=[])}function c(t,e){return e}function s(t,e){for(var n in t)e[n]=t[n];return e}t(6);var f=t("ee"),u=f.get("xhr"),d=t(22)(u),p=NREUM.o,h=p.XHR,l=p.MO,m="readystatechange",v=["onload","onerror","onabort","onloadstart","onloadend","onprogress","ontimeout"],w=[];e.exports=u;var y=window.XMLHttpRequest=function(t){var e=new h(t);try{u.emit("new-xhr",[e],e),e.addEventListener(m,o,!1)}catch(n){try{u.emit("internal-error",[n])}catch(r){}}return e};if(s(h,y),y.prototype=h.prototype,d.inPlace(y.prototype,["open","send"],"-xhr-",c),u.on("send-xhr-start",function(t,e){r(t,e),i(e)}),u.on("open-xhr-start",r),l){var b=1,g=document.createTextNode(b);new l(a).observe(g,{characterData:!0})}else f.on("fn-end",function(t){t[0]&&t[0].type===m||a()})},{}],14:[function(t,e,n){function r(t){var e=this.params,n=this.metrics;if(!this.ended){this.ended=!0;for(var r=0;r<d;r++)t.removeEventListener(u[r],this.listener,!1);if(!e.aborted){if(n.duration=a.now()-this.startTime,4===t.readyState){e.status=t.status;var i=o(t,this.lastSize);if(i&&(n.rxSize=i),this.sameOrigin){var s=t.getResponseHeader("X-NewRelic-App-Data");s&&(e.cat=s.split(", ").pop())}}else e.status=0;n.cbTime=this.cbTime,f.emit("xhr-done",[t],t),c("xhr",[e,n,this.startTime])}}}function o(t,e){var n=t.responseType;if("json"===n&&null!==e)return e;var r="arraybuffer"===n||"blob"===n||"json"===n?t.response:t.responseText;return l(r)}function i(t,e){var n=s(e),r=t.params;r.host=n.hostname+":"+n.port,r.pathname=n.pathname,t.sameOrigin=n.sameOrigin}var a=t("loader");if(a.xhrWrappable){var c=t("handle"),s=t(15),f=t("ee"),u=["load","error","abort","timeout"],d=u.length,p=t("id"),h=t(18),l=t(17),m=window.XMLHttpRequest;a.features.xhr=!0,t(13),f.on("new-xhr",function(t){var e=this;e.totalCbs=0,e.called=0,e.cbTime=0,e.end=r,e.ended=!1,e.xhrGuids={},e.lastSize=null,h&&(h>34||h<10)||window.opera||t.addEventListener("progress",function(t){e.lastSize=t.loaded},!1)}),f.on("open-xhr-start",function(t){this.params={method:t[0]},i(this,t[1]),this.metrics={}}),f.on("open-xhr-end",function(t,e){"loader_config"in NREUM&&"xpid"in NREUM.loader_config&&this.sameOrigin&&e.setRequestHeader("X-NewRelic-ID",NREUM.loader_config.xpid)}),f.on("send-xhr-start",function(t,e){var n=this.metrics,r=t[0],o=this;if(n&&r){var i=l(r);i&&(n.txSize=i)}this.startTime=a.now(),this.listener=function(t){try{"abort"===t.type&&(o.params.aborted=!0),("load"!==t.type||o.called===o.totalCbs&&(o.onloadCalled||"function"!=typeof e.onload))&&o.end(e)}catch(n){try{f.emit("internal-error",[n])}catch(r){}}};for(var c=0;c<d;c++)e.addEventListener(u[c],this.listener,!1)}),f.on("xhr-cb-time",function(t,e,n){this.cbTime+=t,e?this.onloadCalled=!0:this.called+=1,this.called!==this.totalCbs||!this.onloadCalled&&"function"==typeof n.onload||this.end(n)}),f.on("xhr-load-added",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&!this.xhrGuids[n]&&(this.xhrGuids[n]=!0,this.totalCbs+=1)}),f.on("xhr-load-removed",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&this.xhrGuids[n]&&(delete this.xhrGuids[n],this.totalCbs-=1)}),f.on("addEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-added",[t[1],t[2]],e)}),f.on("removeEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-removed",[t[1],t[2]],e)}),f.on("fn-start",function(t,e,n){e instanceof m&&("onload"===n&&(this.onload=!0),("load"===(t[0]&&t[0].type)||this.onload)&&(this.xhrCbStart=a.now()))}),f.on("fn-end",function(t,e){this.xhrCbStart&&f.emit("xhr-cb-time",[a.now()-this.xhrCbStart,this.onload,e],e)})}},{}],15:[function(t,e,n){e.exports=function(t){var e=document.createElement("a"),n=window.location,r={};e.href=t,r.port=e.port;var o=e.href.split("://");!r.port&&o[1]&&(r.port=o[1].split("/")[0].split("@").pop().split(":")[1]),r.port&&"0"!==r.port||(r.port="https"===o[0]?"443":"80"),r.hostname=e.hostname||n.hostname,r.pathname=e.pathname,r.protocol=o[0],"/"!==r.pathname.charAt(0)&&(r.pathname="/"+r.pathname);var i=!e.protocol||":"===e.protocol||e.protocol===n.protocol,a=e.hostname===document.domain&&e.port===n.port;return r.sameOrigin=i&&(!e.hostname||a),r}},{}],16:[function(t,e,n){function r(){}function o(t,e,n){return function(){return i(t,[f.now()].concat(c(arguments)),e?null:this,n),e?void 0:this}}var i=t("handle"),a=t(19),c=t(20),s=t("ee").get("tracer"),f=t("loader"),u=NREUM;"undefined"==typeof window.newrelic&&(newrelic=u);var d=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],p="api-",h=p+"ixn-";a(d,function(t,e){u[e]=o(p+e,!0,"api")}),u.addPageAction=o(p+"addPageAction",!0),u.setCurrentRouteName=o(p+"routeName",!0),e.exports=newrelic,u.interaction=function(){return(new r).get()};var l=r.prototype={createTracer:function(t,e){var n={},r=this,o="function"==typeof e;return i(h+"tracer",[f.now(),t,n],r),function(){if(s.emit((o?"":"no-")+"fn-start",[f.now(),r,o],n),o)try{return e.apply(this,arguments)}finally{s.emit("fn-end",[f.now()],n)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(t,e){l[e]=o(h+e)}),newrelic.noticeError=function(t){"string"==typeof t&&(t=new Error(t)),i("err",[t,f.now()])}},{}],17:[function(t,e,n){e.exports=function(t){if("string"==typeof t&&t.length)return t.length;if("object"==typeof t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer&&t.byteLength)return t.byteLength;if("undefined"!=typeof Blob&&t instanceof Blob&&t.size)return t.size;if(!("undefined"!=typeof FormData&&t instanceof FormData))try{return JSON.stringify(t).length}catch(e){return}}}},{}],18:[function(t,e,n){var r=0,o=navigator.userAgent.match(/Firefox[\/\s](\d+\.\d+)/);o&&(r=+o[1]),e.exports=r},{}],19:[function(t,e,n){function r(t,e){var n=[],r="",i=0;for(r in t)o.call(t,r)&&(n[i]=e(r,t[r]),i+=1);return n}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],20:[function(t,e,n){function r(t,e,n){e||(e=0),"undefined"==typeof n&&(n=t?t.length:0);for(var r=-1,o=n-e||0,i=Array(o<0?0:o);++r<o;)i[r]=t[e+r];return i}e.exports=r},{}],21:[function(t,e,n){e.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],22:[function(t,e,n){function r(t){return!(t&&t instanceof Function&&t.apply&&!t[a])}var o=t("ee"),i=t(20),a="nr@original",c=Object.prototype.hasOwnProperty,s=!1;e.exports=function(t,e){function n(t,e,n,o){function nrWrapper(){var r,a,c,s;try{a=this,r=i(arguments),c="function"==typeof n?n(r,a):n||{}}catch(f){p([f,"",[r,a,o],c])}u(e+"start",[r,a,o],c);try{return s=t.apply(a,r)}catch(d){throw u(e+"err",[r,a,d],c),d}finally{u(e+"end",[r,a,s],c)}}return r(t)?t:(e||(e=""),nrWrapper[a]=t,d(t,nrWrapper),nrWrapper)}function f(t,e,o,i){o||(o="");var a,c,s,f="-"===o.charAt(0);for(s=0;s<e.length;s++)c=e[s],a=t[c],r(a)||(t[c]=n(a,f?c+o:o,i,c))}function u(n,r,o){if(!s||e){var i=s;s=!0;try{t.emit(n,r,o,e)}catch(a){p([a,n,r,o])}s=i}}function d(t,e){if(Object.defineProperty&&Object.keys)try{var n=Object.keys(t);return n.forEach(function(n){Object.defineProperty(e,n,{get:function(){return t[n]},set:function(e){return t[n]=e,e}})}),e}catch(r){p([r])}for(var o in t)c.call(t,o)&&(e[o]=t[o]);return e}function p(e){try{t.emit("internal-error",e)}catch(n){}}return t||(t=o),n.inPlace=f,n.flag=a,n}},{}],ee:[function(t,e,n){function r(){}function o(t){function e(t){return t&&t instanceof r?t:t?s(t,c,i):i()}function n(n,r,o,i){if(!p.aborted||i){t&&t(n,r,o);for(var a=e(o),c=l(n),s=c.length,f=0;f<s;f++)c[f].apply(a,r);var d=u[y[n]];return d&&d.push([b,n,r,a]),a}}function h(t,e){w[t]=l(t).concat(e)}function l(t){return w[t]||[]}function m(t){return d[t]=d[t]||o(n)}function v(t,e){f(t,function(t,n){e=e||"feature",y[n]=e,e in u||(u[e]=[])})}var w={},y={},b={on:h,emit:n,get:m,listeners:l,context:e,buffer:v,abort:a,aborted:!1};return b}function i(){return new r}function a(){(u.api||u.feature)&&(p.aborted=!0,u=p.backlog={})}var c="nr@context",s=t("gos"),f=t(19),u={},d={},p=e.exports=o();p.backlog=u},{}],gos:[function(t,e,n){function r(t,e,n){if(o.call(t,e))return t[e];var r=n();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(t,e,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return t[e]=r,r}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],handle:[function(t,e,n){function r(t,e,n,r){o.buffer([t],r),o.emit(t,e,n)}var o=t("ee").get("handle");e.exports=r,r.ee=o},{}],id:[function(t,e,n){function r(t){var e=typeof t;return!t||"object"!==e&&"function"!==e?-1:t===window?0:a(t,i,function(){return o++})}var o=1,i="nr@id",a=t("gos");e.exports=r},{}],loader:[function(t,e,n){function r(){if(!x++){var t=g.info=NREUM.info,e=p.getElementsByTagName("script")[0];if(setTimeout(u.abort,3e4),!(t&&t.licenseKey&&t.applicationID&&e))return u.abort();f(y,function(e,n){t[e]||(t[e]=n)}),s("mark",["onload",a()+g.offset],null,"api");var n=p.createElement("script");n.src="https://"+t.agent,e.parentNode.insertBefore(n,e)}}function o(){"complete"===p.readyState&&i()}function i(){s("mark",["domContent",a()+g.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(c=Math.max((new Date).getTime(),c))-g.offset}var c=(new Date).getTime(),s=t("handle"),f=t(19),u=t("ee"),d=window,p=d.document,h="addEventListener",l="attachEvent",m=d.XMLHttpRequest,v=m&&m.prototype;NREUM.o={ST:setTimeout,CT:clearTimeout,XHR:m,REQ:d.Request,EV:d.Event,PR:d.Promise,MO:d.MutationObserver};var w=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-spa-1026.min.js"},b=m&&v&&v[h]&&!/CriOS/.test(navigator.userAgent),g=e.exports={offset:c,now:a,origin:w,features:{},xhrWrappable:b};t(16),p[h]?(p[h]("DOMContentLoaded",i,!1),d[h]("load",r,!1)):(p[l]("onreadystatechange",o),d[l]("onload",r)),s("mark",["firstbyte",c],null,"api");var x=0,E=t(21)},{}]},{},["loader",2,14,5,3,4]);</script><link rel="apple-touch-icon" href="https://www.safaribooksonline.com/static/images/apple-touch-icon.8cc2fd27400e.png"><link rel="shortcut icon" href="https://www.safaribooksonline.com/favicon.ico" type="image/x-icon"><link href="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/css" rel="stylesheet" type="text/css"><title>CHAPTER 8: Creating a WebSocket Server - Node.js Recipes: A Problem-Solution Approach</title><link rel="stylesheet" href="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/74741d96e0ae.css" type="text/css"><link rel="stylesheet" type="text/css" href="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/annotator.e34eec1a0d5a.css"><link rel="stylesheet" href="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/font-awesome.min.css"><style type="text/css" title="ibis-book">
    #sbo-rt-content div{margin:1em 1em 1em 1em}#sbo-rt-content a{text-decoration:none}#sbo-rt-content img{max-width:100%;margin-top:10pt}#sbo-rt-content p.booktitle{font-weight:bold;font-size:2.5em;margin-top:2em;margin-bottom:8em;text-align:center}#sbo-rt-content p.bookauthor{font-weight:bold;font-size:1.7em;margin-top:0;margin-right:2em;margin-bottom:0;text-align:left}#sbo-rt-content p.booksubtitle{font-weight:bold;font-size:1.7em;margin-top:0;margin-bottom:7em;text-align:center;color:#8A8A8A}#sbo-rt-content .bookimage{font-size:1.2em;margin-top:0;margin-bottom:1em;text-align:left}#sbo-rt-content .fmpara{font-size:.9em;text-indent:0;margin-top:.5em;margin-bottom:.3em;text-align:justify}#sbo-rt-content .fmpara1{font-size:.9em;text-indent:0;margin-top:.4em;margin-bottom:.3em;text-align:right}#sbo-rt-content .inpara{text-indent:0;margin-top:.4em;margin-left:3em;margin-bottom:.3em}#sbo-rt-content .pub{margin-top:10em;margin-bottom:1em;text-align:right;margin-right:5em}#sbo-rt-content .copyright{font-size:.9em;margin-top:.4em;margin-bottom:.4em;margin-left:1.2em;margin-right:1.2em;text-align:left}#sbo-rt-content .copyright1{font-size:.9em;margin-top:.1em;margin-bottom:.1em;margin-left:4em;margin-right:3.3em;text-align:left;text-indent:-1.6em}#sbo-rt-content .copyright2{font-size:.9em;margin-top:.1em;margin-bottom:.1em;margin-left:4.2em}#sbo-rt-content .dedication{font-size:1.2em;margin-bottom:0;margin-top:3.5em;text-align:center;margin-right:1em;font-style:italic}#sbo-rt-content .dedication1{font-size:1.2em;margin-bottom:0;margin-top:.5em;text-align:center;margin-right:1em;font-style:normal}#sbo-rt-content .dedication2{font-size:1.2em;margin-bottom:0;margin-top:1.5em;text-align:center;margin-right:1em;font-style:italic}#sbo-rt-content .content-title{font-size:1.6em;margin-top:3em;margin-bottom:.1em;text-align:left;font-weight:bold}#sbo-rt-content .fmtitle{font-size:2.5em;margin-top:1em;margin-bottom:1em;text-align:left;font-weight:bold;border-bottom:1.1px solid black;padding-bottom:.8em}#sbo-rt-content .right{text-indent:0;margin-top:1em;margin-right:1.5em;margin-bottom:.3em;text-align:right}#sbo-rt-content .right1{text-indent:0;margin-top:0;margin-right:1.5em;margin-bottom:.2em;text-align:right}#sbo-rt-content .chapimage{margin-left:.2em;margin-top:1.5em;margin-bottom:1.5em;text-align:left}#sbo-rt-content p.ChapterNumber{font-weight:bold;font-size:1.7em;margin-top:10px;margin-left:0;margin-bottom:5px;text-align:left}#sbo-rt-content p.ChapterTitle{font-weight:bold;font-size:2.5em;margin-top:0;margin-bottom:1em;margin-left:0;text-align:left;border-bottom:1.1px solid black;padding-bottom:.8em}#sbo-rt-content p.PartNumber{font-weight:bold;font-size:1.7em;margin-top:10px;margin-left:0;margin-bottom:5px;text-align:left;padding-bottom:.8em}#sbo-rt-content p.partTitle{font-weight:bold;font-size:2.5em;margin-top:1em;margin-bottom:1em;margin-left:0;text-align:left}#sbo-rt-content .paraaftertitle{font-size:100%;text-indent:0;margin-top:0;margin-left:0;margin-bottom:0}#sbo-rt-content p.noindent{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:0;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.noindent1{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:1em}#sbo-rt-content p.noindent2{font-size:100%;text-indent:0;margin-top:1.5em;margin-bottom:1em}#sbo-rt-content p.noindent3{font-size:100%;text-indent:0;margin-top:.8em;margin-bottom:.2em;margin-left:0;margin-right:0;text-align:center}#sbo-rt-content p.noindent4{font-size:100%;text-indent:0;margin-top:.8em;margin-bottom:.2em;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content span.listing{font-weight:bold}#sbo-rt-content p.indent{font-size:100%;text-indent:1.2em;margin-top:.1em;margin-bottom:.1em;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.indent1{font-size:100%;text-indent:1.2em;margin-top:0;margin-bottom:0;margin-left:0;margin-right:0;text-align:left}#sbo-rt-content p.indent1a{font-size:100%;text-indent:1.5em;margin-top:0;margin-bottom:0;margin-left:0;margin-right:4.5em;text-align:right}#sbo-rt-content p.indent2{font-size:100%;margin-top:.8em;margin-bottom:.8em;margin-left:2.4em;margin-right:2.4em;text-align:justify;font-style:italic}#sbo-rt-content p.indent3{font-size:100%;text-indent:1em;margin-top:.8em;margin-bottom:.8em;margin-left:1.8em;margin-right:1.8em;text-align:left}#sbo-rt-content p.indent4{font-size:100%;text-indent:1.3em;margin-top:.5em;margin-bottom:.5em;margin-left:2em;margin-right:0;text-align:left}#sbo-rt-content .blockquote{font-size:100%;text-indent:.2em;margin-top:1em;margin-left:3em;margin-right:2em;margin-bottom:1em;font-style:italic}#sbo-rt-content .blockquote1{font-size:100%;text-indent:.2em;margin-top:1em;margin-left:3em;margin-bottom:0;font-style:italic}#sbo-rt-content p.Heading1{font-weight:bold;font-size:2em;text-indent:0;margin-top:1.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2{font-size:1.6em;text-indent:0;margin-top:1.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2_2{font-size:1.6em;text-indent:0;margin-top:.3em;margin-bottom:.3em}#sbo-rt-content p.Heading2a{font-size:1.5em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;font-weight:bold}#sbo-rt-content p.Heading3{font-weight:bold;font-size:1.45em;text-indent:0;margin-top:1.2em;margin-bottom:.1em}#sbo-rt-content p.Heading3a{font-weight:normal;font-size:1.25em;text-indent:0;margin-top:1.2em;margin-bottom:.1em}#sbo-rt-content p.Heading4{font-size:1.3em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;text-align:left}#sbo-rt-content .img{max-width:100%;margin-top:10pt}#sbo-rt-content .img1{text-align:left}#sbo-rt-content .img1a{text-align:right;margin-right:5em;margin-top:5em}#sbo-rt-content .img2{text-align:left}#sbo-rt-content div.Figure{font-size:small;margin-top:1.5em;margin-bottom:1.5em}#sbo-rt-content .para-1{font-size:100%;margin-top:1em;text-indent:1.5em;margin-bottom:0;text-align:left}#sbo-rt-content .para-2{font-size:.9em;text-indent:-1.4em;margin-left:2.4em;margin-top:.5em;margin-bottom:0}#sbo-rt-content .figurecaption{font-size:small;margin-top:0;margin-bottom:0;text-align:justify}#sbo-rt-content .image{text-align:center}#sbo-rt-content .codecaption{font-size:100%;margin-top:.6em;margin-bottom:.6em;text-align:justify;font-style:italic}#sbo-rt-content .PCode{font-size:small;margin-top:1em;margin-bottom:1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-1{font-size:small;margin-top:1em;margin-bottom:.1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-2{font-size:small;margin-top:0;margin-bottom:0;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode-3{font-size:small;margin-top:0;margin-bottom:1em;margin-left:0;text-align:left;font-family:monospace}#sbo-rt-content div.singlethin{border-bottom:solid 3px;margin-left:1em;margin-right:1em;margin-bottom:1em}#sbo-rt-content div.singlethin1{margin-left:2em;margin-right:2em}#sbo-rt-content .inlinecode{font-family:monospace}#sbo-rt-content div.notepara{font-size:110%;text-indent:0;margin-top:1em;border-top:solid 1px;border-bottom:solid 1px;margin-bottom:1em;text-align:justify}#sbo-rt-content span.pink-box{font-weight:bold;padding-left:1.3em;padding-right:1.3em;border:1.1px solid black;font-size:1.5em;margin-top:.5em;margin-bottom:.5em;text-indent:0;text-align:justify}#sbo-rt-content span.courier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%}#sbo-rt-content div.courier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%;margin-top:1em;margin-bottom:1em}#sbo-rt-content div.boxcourier{font-family:Courier New;font-weight:normal;font-style:normal;font-size:100%;margin-top:1em;margin-bottom:1em;margin-left:1.5em;margin-right:1.5em;text-align:left}#sbo-rt-content span.courier1{font-family:Courier New;font-weight:normal;font-style:normal;font-size:95%}#sbo-rt-content .boxhead{font-size:1.25em;font-weight:bold;padding-left:.1em;padding-bottom:.1em;padding-top:.1em;margin-top:0;text-indent:0;text-align:center;border:3px solid black}#sbo-rt-content div.box{margin-top:1em;margin-bottom:1em}#sbo-rt-content .boxpara{font-size:110%;text-indent:0;margin-left:1.5em;margin-right:1.5em;margin-top:.5em;margin-bottom:.5em;text-align:left}#sbo-rt-content .alpha{font-size:1.2em;font-weight:bold;margin-left:.2em;margin-top:1em;margin-bottom:.3em;text-align:left}#sbo-rt-content .index{font-size:small;margin-left:.2em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .index1{font-size:small;margin-left:1em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .index2{font-size:small;margin-left:2em;margin-top:0;margin-bottom:0;text-align:left}#sbo-rt-content .cover{text-align:center}#sbo-rt-content .top{border-top:1.1px solid black;border-bottom:2px solid black}#sbo-rt-content .bot{border-bottom:2px solid black}#sbo-rt-content table.bodytable,#sbo-rt-content table{border-collapse:collapse;margin-bottom:8px;font-size:small;margin-top:10pt;width:95%;border-top:0 solid black;border-bottom:0 solid black}#sbo-rt-content table.fmtable{margin-bottom:1em;font-size:1em;margin-left:4em;border-top:0 solid #FFF;border-bottom:0 solid #FFF}#sbo-rt-content table{margin-bottom:1em;border-top:1.1px solid black;border-bottom:1.1px solid black;border-collapse:collapse}#sbo-rt-content th{border-top:1px solid black;border-bottom:1px solid black;padding-right:1.5em}#sbo-rt-content td{font-size:small;vertical-align:top;padding-right:1.5em;margin-top:0;margin-bottom:1em}#sbo-rt-content .tablepara{font-size:small;text-indent:0;margin-top:0;margin-bottom:.5em;padding-right:1.5em}#sbo-rt-content .tablepara1{font-size:small;margin-left:2em;margin-top:0;margin-bottom:0;padding-right:1.5em}#sbo-rt-content .header{border-bottom:1.1px solid black;text-indent:0;text-align:left}#sbo-rt-content .TabCapt{font-style:italic;margin-left:0;text-indent:0}#sbo-rt-content .FigCapt{font-style:italic;font-size:.9em}#sbo-rt-content .CaptNr{font-weight:bold}#sbo-rt-content .ttitle{font-style:Italic;margin-bottom:1em}#sbo-rt-content p.paraaftertitle1{font-size:.9em;text-indent:0;margin-top:.5em;margin-bottom:.8em;text-align:left}#sbo-rt-content p.para{font-size:small;text-indent:20px;margin-top:0;margin-bottom:0;text-align:justify}#sbo-rt-content p.quote{font-style:italic;font-size:100%;margin-top:1.5em;margin-left:2.5em;margin-right:2.5em;margin-bottom:0}#sbo-rt-content p.quotesource{font-size:small;text-indent:0;margin-top:1em;margin-bottom:1em;text-align:right}#sbo-rt-content p.chaptersubtitle{font-size:x-large;text-indent:0;margin-top:0;margin-left:0;margin-bottom:0;text-align:left}#sbo-rt-content p.line{margin-top:.3em;border-bottom:1px solid black}#sbo-rt-content p.line1{margin-top:.3em;margin-bottom:1.5em;border-bottom:1px solid black}#sbo-rt-content p.line2{margin-top:5em;margin-bottom:5em;border-bottom:1px solid black;text-align:center;margin-left:15em;margin-right:15em}#sbo-rt-content li{margin-bottom:.5em;margin-top:.5em}#sbo-rt-content p.alpha{font-size:1.2em;font-weight:bold;margin-left:.2em;margin-top:1em;margin-bottom:.3em;text-align:left}#sbo-rt-content ul.bulleted{font-size:100%;text-align:justify;margin-left:2.5em;margin-right:3em;margin-top:1em;margin-bottom:1em;text-indent:0}#sbo-rt-content ol.OrderedList{font-size:100%;text-align:left;margin-left:2.5em;margin-right:3em;margin-top:1em;margin-bottom:1em}#sbo-rt-content ul.bulleted1{font-size:100%;text-align:left;margin-left:1em;margin-right:5em;margin-top:1em;margin-bottom:1em;list-style-type:none}#sbo-rt-content ul.bulleted1_a{font-size:100%;text-align:justify;margin-left:0;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0;list-style-type:none}#sbo-rt-content ul.bulleted2{font-size:100%;text-align:justify;margin-left:2.3em;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0}#sbo-rt-content ul.bulleted4{font-size:100%;text-align:center;margin-left:1.3em;margin-right:5em;margin-top:1em;margin-bottom:1em;text-indent:0;list-style-type:none}#sbo-rt-content .numbered{font-size:small;text-align:justify;margin-left:2em;margin-right:2em;margin-top:.5em;margin-bottom:.5em;text-indent:1em}#sbo-rt-content .bulletedin{font-size:100%;text-align:justify;margin-left:4em;margin-right:4em;margin-top:.5em;margin-bottom:.5em}#sbo-rt-content ul.None{font-size:.9em;text-align:justify;margin-left:3em;margin-right:2em;margin-top:.5em;margin-bottom:.5em;list-style-type:none}#sbo-rt-content .Listing{font-size:small;margin-bottom:0}#sbo-rt-content .PCode1{font-size:small;margin-top:.7em;margin-bottom:0;text-align:left;font-family:monospace}#sbo-rt-content .PCode2{font-size:small;margin-top:1em;margin-bottom:.1em;margin-left:2.2em;text-align:left;font-family:monospace}#sbo-rt-content .PCode3{font-size:small;margin-top:0;margin-left:2.2em;margin-bottom:.1em;text-align:left;font-family:monospace}#sbo-rt-content .NoteCaption{font-size:small;margin-top:1.3em;margin-left:5em;margin-right:5em;border:1.1px solid black;padding:.5em;margin-bottom:1.3em}#sbo-rt-content .Table{font-size:100%;margin-bottom:1em;margin-left:0}#sbo-rt-content .toc{font-size:1.1em;margin-top:.2em;margin-bottom:.2em;text-align:left;font-weight:bold}#sbo-rt-content .toca{font-size:1.1em;margin-top:.8em;margin-bottom:.4em;text-align:left;font-weight:bold}#sbo-rt-content .toc1{font-size:1.1em;margin-top:.4em;margin-bottom:.3em;text-align:left;text-indent:1.4em;font-weight:normal}#sbo-rt-content .toc2{font-size:1.2em;margin-top:.4em;margin-bottom:.3em;text-align:left;font-weight:bold}#sbo-rt-content .toc3{font-size:.9em;margin-top:.4em;margin-bottom:.3em;text-align:left;text-indent:3.5em;font-weight:normal}#sbo-rt-content .toc4{font-size:1.1em;margin-top:.2em;margin-bottom:.5em;text-align:left;font-weight:bold}#sbo-rt-content .tocch{font-size:1.3em;margin-top:.7em;margin-bottom:.7em;text-align:left;font-weight:bold}#sbo-rt-content .noborder{margin-bottom:1em;border-top:0 solid #FFF;border-bottom:0 solid #FFF}#sbo-rt-content .authurright{text-align:right;margin-top:0;margin-bottom:0}#sbo-rt-content .FormalPara{font-size:small;margin-bottom:.7em}#sbo-rt-content .FontName1{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content span.FontName2{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content span.FontName3{font-size:100%;font-family:"Courier New",Courier,monospace}#sbo-rt-content .rightarrow{margin-top:0}#sbo-rt-content div.thinline{margin-top:1em;margin-bottom:1em;border-top:solid 4px #AFAFB0;border-bottom:solid 4px #AFAFB0}#sbo-rt-content span.line{text-decoration:underline}#sbo-rt-content span.underline{text-decoration:underline}#sbo-rt-content div.box{border-top:solid 2px;border-bottom:solid 2px}#sbo-rt-content .app{font-size:150%;margin-left:.8em}#sbo-rt-content .page{text-decoration:none;color:#000}#sbo-rt-content .cXXX{text-decoration:none;color:#000}#sbo-rt-content .textindent{margin-left:1.7em;margin-top:1em;margin-bottom:1em;font-size:100%}#sbo-rt-content .textindent1{margin-left:1.7em;margin-top:0;margin-bottom:0;font-size:100%}#sbo-rt-content .textindent2{margin-left:1.7em;margin-top:0;margin-bottom:0;font-size:100%;text-indent:1em}#sbo-rt-content p.FootNote{margin-top:.8em;margin-bottom:0;font-size:85%;text-indent:0;text-align:left;margin-left:1.1em;margin-right:1.1em}#sbo-rt-content pre{margin-left:0;font-family:monospace;white-space:pre-wrap}#sbo-rt-content p.Heading4a{font-size:1.15em;font-weight:bold;text-indent:1em;margin-top:1.3em;margin-bottom:.3em;border-top:3px solid #4d4d4c;border-left:solid 3px #4d4d4c;border-right:solid 3px #4d4d4c;border-bottom:solid 3px #4d4d4c;text-align:center}#sbo-rt-content p.noindent8{font-size:100%;text-indent:0;margin-top:1em;margin-bottom:1em;text-align:center;font-weight:bold;color:#8A8A8A}#sbo-rt-content .tocb{font-size:1.4em;margin-top:.5em;margin-bottom:.2em;text-align:left;font-weight:bold}#sbo-rt-content .part{font-weight:normal;font-size:1em;margin-bottom:5px;text-align:left;padding-left:1.3em;padding-bottom:10em;padding-right:1.3em;border:1.1px solid black}#sbo-rt-content p.Heading5{font-size:1em;text-indent:0;margin-top:1.3em;margin-bottom:.3em;text-align:center}#sbo-rt-content p.noindent5s{font-size:100%;text-indent:0;margin-top:.1em;margin-bottom:.1em;margin-left:0;margin-right:0;text-align:right}#sbo-rt-content span.strike{text-decoration:line-through}
    </style><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9781430260585/chapter/9781430260585_Ch08.xhtml",
          "book_id": "9781430260585",
          "chapter_uri": "9781430260585_Ch08.xhtml",
          "position": 0,
          "user_uuid": "29525685-85c9-45c7-9eda-3c178d86398e",
          "next_chapter_uri": "/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch09.xhtml"
        
      },
      title: "Node.js Recipes: A Problem\u002DSolution Approach",
      author_list: "Cory Gackenheimer",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: false,
      show_ios_app_teaser: false
    };
    // ]]></script><script src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/modernizr.js"></script><script>
    
      
        

        

        
          
            window.PUBLIC_ANNOTATIONS = true;
          
        

      

      
        window.MOBILE_PUBLIC_ANNOTATIONS = false;
      

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

    
      window.PRIVACY_CONTROL_SWITCH = true;
    

    
      window.PUBLISHER_PAGES = true;
    

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "https://www.safaribooksonline.com/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://www.safaribooksonline.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml"><meta name="description" content="CHAPTER 8 Creating a WebSocket Server This chapter begins a departure from the previous chapters in the book. Previously, the chapters concentrated heavily on the Node.js core and its ... "><meta property="og:title" content="CHAPTER 8: Creating a WebSocket Server"><meta itemprop="isPartOf" content="/library/view/nodejs-recipes-a/9781430260585/"><meta itemprop="name" content="CHAPTER 8: Creating a WebSocket Server"><meta property="og:url" itemprop="url" content="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://www.safaribooksonline.com/library/cover/9781430260585/"><meta property="og:description" itemprop="description" content="CHAPTER 8 Creating a WebSocket Server This chapter begins a departure from the previous chapters in the book. Previously, the chapters concentrated heavily on the Node.js core and its ... "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Apress"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781430260585"><meta property="og:book:author" itemprop="author" content="Cory Gackenheimer"><meta property="og:book:tag" itemprop="about" content="JavaScript"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@safari"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript>&lt;meta http-equiv="refresh" content="0; url=/library/no-js/" /&gt;</noscript><script type="text/javascript">
  (function(i,s,o,g,r,a,m) {
    i['GoogleAnalyticsObject']=r;
    i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();
    a=s.createElement(o),m=s.getElementsByTagName(o)[0];
    a.async=1;
    a.src=g;
    m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  var matches = document.cookie.match(/BrowserCookie\s*=\s*([a-f0-9\-]{36})/),
      user_uuid = null;

  if (matches && matches.length === 2) {
    user_uuid = matches[1];
  }


  ga('create', 'UA-39299553-7', {'userId': '29525685-85c9-45c7-9eda-3c178d86398e' });


ga('set', 'dimension1', 'Trial');
ga('set', 'dimension6', user_uuid);


  ga('set', 'dimension2', '29525685-85c9-45c7-9eda-3c178d86398e');
  






  //enable enhanced link tracking
  ga('require', 'linkid', 'linkid.js');

  // reading interface will track pageviews itself
  if (document.location.pathname.indexOf("/library/view") !== 0) {
    ga('send', 'pageview');
  }
</script><script defer="" src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/vendor.34024413b1d4.js"></script><script defer="" src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/reader.a05323b190d3.js"></script><script async="" src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/MathJax.js"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts subscribe-panel library">

    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        





<a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li class="t-logo"><a href="https://www.safaribooksonline.com/home/" class="l0 None safari-home nav-icn js-keyboard-nav-home"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>Safari Home Icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M4 9.9L4 9.9 4 18 16 18 16 9.9 10 4 4 9.9ZM2.6 8.1L2.6 8.1 8.7 1.9 10 0.5 11.3 1.9 17.4 8.1 18 8.7 18 9.5 18 18.1 18 20 16.1 20 3.9 20 2 20 2 18.1 2 9.5 2 8.7 2.6 8.1Z"></path><rect x="10" y="12" width="3" height="7"></rect><rect transform="translate(18.121320, 10.121320) rotate(-315.000000) translate(-18.121320, -10.121320) " x="16.1" y="9.1" width="4" height="2"></rect><rect transform="translate(2.121320, 10.121320) scale(-1, 1) rotate(-315.000000) translate(-2.121320, -10.121320) " x="0.1" y="9.1" width="4" height="2"></rect></g></svg><span>Safari Home</span></a></li><li><a href="https://www.safaribooksonline.com/r/" class="t-recommendations-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recommendations icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M50 25C50 18.2 44.9 12.5 38.3 11.7 37.5 5.1 31.8 0 25 0 18.2 0 12.5 5.1 11.7 11.7 5.1 12.5 0 18.2 0 25 0 31.8 5.1 37.5 11.7 38.3 12.5 44.9 18.2 50 25 50 31.8 50 37.5 44.9 38.3 38.3 44.9 37.5 50 31.8 50 25ZM25 3.1C29.7 3.1 33.6 6.9 34.4 11.8 30.4 12.4 26.9 15.1 25 18.8 23.1 15.1 19.6 12.4 15.6 11.8 16.4 6.9 20.3 3.1 25 3.1ZM34.4 15.6C33.6 19.3 30.7 22.2 27.1 22.9 27.8 19.2 30.7 16.3 34.4 15.6ZM22.9 22.9C19.2 22.2 16.3 19.3 15.6 15.6 19.3 16.3 22.2 19.2 22.9 22.9ZM3.1 25C3.1 20.3 6.9 16.4 11.8 15.6 12.4 19.6 15.1 23.1 18.8 25 15.1 26.9 12.4 30.4 11.8 34.4 6.9 33.6 3.1 29.7 3.1 25ZM22.9 27.1C22.2 30.7 19.3 33.6 15.6 34.4 16.3 30.7 19.2 27.8 22.9 27.1ZM25 46.9C20.3 46.9 16.4 43.1 15.6 38.2 19.6 37.6 23.1 34.9 25 31.3 26.9 34.9 30.4 37.6 34.4 38.2 33.6 43.1 29.7 46.9 25 46.9ZM27.1 27.1C30.7 27.8 33.6 30.7 34.4 34.4 30.7 33.6 27.8 30.7 27.1 27.1ZM38.2 34.4C37.6 30.4 34.9 26.9 31.3 25 34.9 23.1 37.6 19.6 38.2 15.6 43.1 16.4 46.9 20.3 46.9 25 46.9 29.7 43.1 33.6 38.2 34.4Z"></path></g></svg><span>Recommended</span></a></li><li><a href="https://www.safaribooksonline.com/s/" class="t-queue-nav l0 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>
              
                Queue
              
            </span></a></li><li class="search"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li><a href="https://www.safaribooksonline.com/history/" class="t-recent-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>recent items icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 0C11.2 0 0 11.2 0 25 0 38.8 11.2 50 25 50 38.8 50 50 38.8 50 25 50 11.2 38.8 0 25 0ZM6.3 25C6.3 14.6 14.6 6.3 25 6.3 35.4 6.3 43.8 14.6 43.8 25 43.8 35.4 35.4 43.8 25 43.8 14.6 43.8 6.3 35.4 6.3 25ZM31.8 31.5C32.5 30.5 32.4 29.2 31.6 28.3L27.1 23.8 27.1 12.8C27.1 11.5 26.2 10.4 25 10.4 23.9 10.4 22.9 11.5 22.9 12.8L22.9 25.7 28.8 31.7C29.2 32.1 29.7 32.3 30.2 32.3 30.8 32.3 31.3 32 31.8 31.5Z"></path></g></svg><span>History</span></a></li><li><a href="https://www.safaribooksonline.com/topics" class="t-topics-link l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 55" width="20" height="20" version="1.1" fill="#4A3C31"><desc>topics icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 55L50 41.262 50 13.762 25 0 0 13.762 0 41.262 25 55ZM8.333 37.032L8.333 17.968 25 8.462 41.667 17.968 41.667 37.032 25 46.538 8.333 37.032Z"></path></g></svg><span>Topics</span></a></li><li><a href="https://www.safaribooksonline.com/tutorials/" class="l1 nav-icn t-tutorials-nav js-toggle-menu-item None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>tutorials icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M15.8 18.2C15.8 18.2 15.9 18.2 16 18.2 16.1 18.2 16.2 18.2 16.4 18.2 16.5 18.2 16.7 18.1 16.9 18 17 17.9 17.1 17.8 17.2 17.7 17.3 17.6 17.4 17.5 17.4 17.4 17.5 17.2 17.6 16.9 17.6 16.7 17.6 16.6 17.6 16.5 17.6 16.4 17.5 16.2 17.5 16.1 17.4 15.9 17.3 15.8 17.2 15.6 17 15.5 16.8 15.3 16.6 15.3 16.4 15.2 16.2 15.2 16 15.2 15.8 15.2 15.7 15.2 15.5 15.3 15.3 15.4 15.2 15.4 15.1 15.5 15 15.7 14.9 15.8 14.8 15.9 14.7 16 14.7 16.1 14.6 16.3 14.6 16.4 14.6 16.5 14.6 16.6 14.6 16.6 14.6 16.7 14.6 16.9 14.6 17 14.6 17.1 14.7 17.3 14.7 17.4 14.8 17.6 15 17.7 15.1 17.9 15.2 18 15.3 18 15.5 18.1 15.5 18.1 15.6 18.2 15.7 18.2 15.7 18.2 15.7 18.2 15.8 18.2L15.8 18.2ZM9.4 11.5C9.5 11.5 9.5 11.5 9.6 11.5 9.7 11.5 9.9 11.5 10 11.5 10.2 11.5 10.3 11.4 10.5 11.3 10.6 11.2 10.8 11.1 10.9 11 10.9 10.9 11 10.8 11.1 10.7 11.2 10.5 11.2 10.2 11.2 10 11.2 9.9 11.2 9.8 11.2 9.7 11.2 9.5 11.1 9.4 11 9.2 10.9 9.1 10.8 8.9 10.6 8.8 10.5 8.7 10.3 8.6 10 8.5 9.9 8.5 9.7 8.5 9.5 8.5 9.3 8.5 9.1 8.6 9 8.7 8.8 8.7 8.7 8.8 8.6 9 8.5 9.1 8.4 9.2 8.4 9.3 8.2 9.5 8.2 9.8 8.2 10 8.2 10.1 8.2 10.2 8.2 10.3 8.2 10.5 8.3 10.6 8.4 10.7 8.5 10.9 8.6 11.1 8.7 11.2 8.9 11.3 9 11.4 9.1 11.4 9.2 11.4 9.3 11.5 9.3 11.5 9.3 11.5 9.4 11.5 9.4 11.5L9.4 11.5ZM3 4.8C3.1 4.8 3.1 4.8 3.2 4.8 3.4 4.8 3.5 4.8 3.7 4.8 3.8 4.8 4 4.7 4.1 4.6 4.3 4.5 4.4 4.4 4.5 4.3 4.6 4.2 4.6 4.1 4.7 4 4.8 3.8 4.8 3.5 4.8 3.3 4.8 3.1 4.8 3 4.8 2.9 4.7 2.8 4.7 2.6 4.6 2.5 4.5 2.3 4.4 2.2 4.2 2.1 4 1.9 3.8 1.9 3.6 1.8 3.5 1.8 3.3 1.8 3.1 1.8 2.9 1.8 2.7 1.9 2.6 2 2.4 2.1 2.3 2.2 2.2 2.3 2.1 2.4 2 2.5 2 2.6 1.8 2.8 1.8 3 1.8 3.3 1.8 3.4 1.8 3.5 1.8 3.6 1.8 3.8 1.9 3.9 2 4 2.1 4.2 2.2 4.4 2.4 4.5 2.5 4.6 2.6 4.7 2.7 4.7 2.8 4.7 2.9 4.8 2.9 4.8 3 4.8 3 4.8 3 4.8L3 4.8ZM13.1 15.2C13.2 15.1 13.2 15.1 13.2 15.1 13.3 14.9 13.4 14.7 13.6 14.5 13.8 14.2 14.1 14 14.4 13.8 14.7 13.6 15.1 13.5 15.5 13.4 15.9 13.4 16.3 13.4 16.7 13.5 17.2 13.5 17.6 13.7 17.9 13.9 18.2 14.1 18.5 14.4 18.7 14.7 18.9 15 19.1 15.3 19.2 15.6 19.3 15.9 19.4 16.1 19.4 16.4 19.4 17 19.3 17.5 19.1 18.1 19 18.3 18.9 18.5 18.7 18.7 18.5 19 18.3 19.2 18 19.4 17.7 19.6 17.3 19.8 16.9 19.9 16.6 20 16.3 20 16 20 15.8 20 15.6 20 15.4 19.9 15.4 19.9 15.4 19.9 15.4 19.9 15.2 19.9 15 19.8 14.9 19.8 14.8 19.7 14.7 19.7 14.6 19.7 14.4 19.6 14.3 19.5 14.1 19.3 13.7 19.1 13.4 18.7 13.2 18.4 13.1 18.1 12.9 17.8 12.9 17.5 12.8 17.3 12.8 17.1 12.8 16.9L3.5 14.9C3.3 14.9 3.1 14.8 3 14.8 2.7 14.7 2.4 14.5 2.1 14.3 1.7 14 1.4 13.7 1.2 13.3 1 13 0.9 12.6 0.8 12.3 0.7 12 0.7 11.7 0.7 11.4 0.7 11 0.8 10.5 1 10.1 1.1 9.8 1.3 9.5 1.6 9.2 1.8 8.9 2.1 8.7 2.4 8.5 2.8 8.3 3.2 8.1 3.6 8.1 3.9 8 4.2 8 4.5 8 4.6 8 4.8 8 4.9 8.1L6.8 8.5C6.8 8.4 6.8 8.4 6.8 8.4 6.9 8.2 7.1 8 7.2 7.8 7.5 7.5 7.7 7.3 8 7.1 8.4 6.9 8.7 6.8 9.1 6.7 9.5 6.7 10 6.7 10.4 6.8 10.8 6.8 11.2 7 11.5 7.2 11.8 7.5 12.1 7.7 12.4 8 12.6 8.3 12.7 8.6 12.8 8.9 12.9 9.2 13 9.4 13 9.7 13 9.7 13 9.8 13 9.8 13.6 9.9 14.2 10.1 14.9 10.2 15 10.2 15 10.2 15.1 10.2 15.3 10.2 15.4 10.2 15.6 10.2 15.8 10.1 16 10 16.2 9.9 16.4 9.8 16.5 9.6 16.6 9.5 16.8 9.2 16.9 8.8 16.9 8.5 16.9 8.3 16.9 8.2 16.8 8 16.8 7.8 16.7 7.7 16.6 7.5 16.5 7.3 16.3 7.2 16.2 7.1 16 7 15.9 6.9 15.8 6.9 15.7 6.9 15.6 6.8 15.5 6.8L6.2 4.8C6.2 5 6 5.2 5.9 5.3 5.7 5.6 5.5 5.8 5.3 6 4.9 6.2 4.5 6.4 4.1 6.5 3.8 6.6 3.5 6.6 3.2 6.6 3 6.6 2.8 6.6 2.7 6.6 2.6 6.6 2.6 6.5 2.6 6.5 2.5 6.5 2.3 6.5 2.1 6.4 1.8 6.3 1.6 6.1 1.3 6 1 5.7 0.7 5.4 0.5 5 0.3 4.7 0.2 4.4 0.1 4.1 0 3.8 0 3.6 0 3.3 0 2.8 0.1 2.2 0.4 1.7 0.5 1.5 0.7 1.3 0.8 1.1 1.1 0.8 1.3 0.6 1.6 0.5 2 0.3 2.3 0.1 2.7 0.1 3.1 0 3.6 0 4 0.1 4.4 0.2 4.8 0.3 5.1 0.5 5.5 0.8 5.7 1 6 1.3 6.2 1.6 6.3 1.9 6.4 2.3 6.5 2.5 6.6 2.7 6.6 3 6.6 3 6.6 3.1 6.6 3.1 9.7 3.8 12.8 4.4 15.9 5.1 16.1 5.1 16.2 5.2 16.4 5.2 16.7 5.3 16.9 5.5 17.2 5.6 17.5 5.9 17.8 6.2 18.1 6.5 18.3 6.8 18.4 7.2 18.6 7.5 18.6 7.9 18.7 8.2 18.7 8.6 18.7 9 18.6 9.4 18.4 9.8 18.3 10.1 18.2 10.3 18 10.6 17.8 10.9 17.5 11.1 17.3 11.3 16.9 11.6 16.5 11.8 16 11.9 15.7 12 15.3 12 15 12 14.8 12 14.7 12 14.5 11.9 13.9 11.8 13.3 11.7 12.6 11.5 12.5 11.7 12.4 11.9 12.3 12 12.1 12.3 11.9 12.5 11.7 12.7 11.3 12.9 10.9 13.1 10.5 13.2 10.2 13.3 9.9 13.3 9.6 13.3 9.4 13.3 9.2 13.3 9 13.2 9 13.2 9 13.2 9 13.2 8.8 13.2 8.7 13.2 8.5 13.1 8.2 13 8 12.8 7.7 12.6 7.4 12.4 7.1 12 6.8 11.7 6.7 11.4 6.6 11.1 6.5 10.8 6.4 10.6 6.4 10.4 6.4 10.2 5.8 10.1 5.2 9.9 4.5 9.8 4.4 9.8 4.4 9.8 4.3 9.8 4.1 9.8 4 9.8 3.8 9.8 3.6 9.9 3.4 10 3.2 10.1 3 10.2 2.9 10.4 2.8 10.5 2.6 10.8 2.5 11.1 2.5 11.5 2.5 11.6 2.5 11.8 2.6 12 2.6 12.1 2.7 12.3 2.8 12.5 2.9 12.6 3.1 12.8 3.2 12.9 3.3 13 3.5 13.1 3.6 13.1 3.7 13.1 3.8 13.2 3.9 13.2L13.1 15.2 13.1 15.2Z"></path></g></svg><span>Tutorials</span></a></li><li class="nav-offers flyout-parent"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" class="l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>offers icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M35.9 20.6L27 15.5C26.1 15 24.7 15 23.7 15.5L14.9 20.6C13.9 21.1 13.2 22.4 13.2 23.4L13.2 41.4C13.2 42.4 13.9 43.7 14.9 44.2L23.3 49C24.2 49.5 25.6 49.5 26.6 49L35.9 43.6C36.8 43.1 37.6 41.8 37.6 40.8L37.6 23.4C37.6 22.4 36.8 21.1 35.9 20.6L35.9 20.6ZM40 8.2C39.1 7.6 37.6 7.6 36.7 8.2L30.2 11.9C29.3 12.4 29.3 13.2 30.2 13.8L39.1 18.8C40 19.4 40.7 20.6 40.7 21.7L40.7 39C40.7 40.1 41.4 40.5 42.4 40L48.2 36.6C49.1 36.1 49.8 34.9 49.8 33.8L49.8 15.6C49.8 14.6 49.1 13.3 48.2 12.8L40 8.2 40 8.2ZM27 10.1L33.6 6.4C34.5 5.9 34.5 5 33.6 4.5L26.6 0.5C25.6 0 24.2 0 23.3 0.5L16.7 4.2C15.8 4.7 15.8 5.6 16.7 6.1L23.7 10.1C24.7 10.6 26.1 10.6 27 10.1ZM10.1 21.7C10.1 20.6 10.8 19.4 11.7 18.8L20.6 13.8C21.5 13.2 21.5 12.4 20.6 11.9L13.6 7.9C12.7 7.4 11.2 7.4 10.3 7.9L1.6 12.8C0.7 13.3 0 14.6 0 15.6L0 33.8C0 34.9 0.7 36.1 1.6 36.6L8.4 40.5C9.3 41 10.1 40.6 10.1 39.6L10.1 21.7 10.1 21.7Z"></path></g></svg><span>Offers &amp; Deals</span></a><ul class="flyout"><li><a href="https://www.safaribooksonline.com/oreilly-newsletters/" class="l2 nav-icn"><span>Newsletters</span></a></li></ul></li><li class="nav-highlights"><a href="https://www.safaribooksonline.com/u/001o00000169U9HAAU/" class="t-highlights-nav l1 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 35" width="20" height="20" version="1.1" fill="#4A3C31"><desc>highlights icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M13.325 18.071L8.036 18.071C8.036 11.335 12.36 7.146 22.5 5.594L22.5 0C6.37 1.113 0 10.632 0 22.113 0 29.406 3.477 35 10.403 35 15.545 35 19.578 31.485 19.578 26.184 19.578 21.556 17.211 18.891 13.325 18.071L13.325 18.071ZM40.825 18.071L35.565 18.071C35.565 11.335 39.86 7.146 50 5.594L50 0C33.899 1.113 27.5 10.632 27.5 22.113 27.5 29.406 30.977 35 37.932 35 43.045 35 47.078 31.485 47.078 26.184 47.078 21.556 44.74 18.891 40.825 18.071L40.825 18.071Z"></path></g></svg><span>Highlights</span></a></li><li><a href="https://www.safaribooksonline.com/u/" class="t-settings-nav l1 js-settings nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://www.safaribooksonline.com/public/support" class="l1 no-icon">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l1 no-icon">Sign Out</a></li></ul><ul class="profile"><li><a href="https://www.safaribooksonline.com/u/" class="l2 nav-icn None"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a><span class="l2 t-nag-notification" id="nav-nag"><strong class="trial-green">10</strong> days left in your trial.
  
  

  
    
      

<a class="" href="https://www.safaribooksonline.com/subscribe/">Subscribe</a>.


    
  

  

</span></li><li><a href="https://www.safaribooksonline.com/public/support" class="l2">Support</a></li><li><a href="https://www.safaribooksonline.com/accounts/logout/" class="l2">Sign Out</a></li></ul></div></li></ul></nav></header>


      </div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Node.js Recipes: A Problem-Solution Approach
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" title="Search in archive" class="js-search-controls search-controls"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781430260585/chapter/9781430260585_Ch08.xhtml" data-for-analytics="9781430260585:9781430260585_Ch08.xhtml" aria-label="Add to Queue"><span>Add to Queue</span></button></li><li class="js-font-control-panel font-control-activator"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml&amp;text=Node.js%20Recipes%3A%20A%20Problem-Solution%20Approach&amp;via=safari"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%20CHAPTER%208%3A%20Creating%20a%20WebSocket%20Server&amp;body=https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml%0D%0Afrom%20Node.js%20Recipes%3A%20A%20Problem-Solution%20Approach%0D%0A"><span>Email</span></a></li></ul></li>
      </ul>
    </div>

    <section role="document">
        
        



 <!--[if lt IE 9]>
  
<![endif]-->



  <script defer="" src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/djangoMessagesPage.845b17d78025.js"></script>


        
	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch07.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">CHAPTER 7: Discovering Other Node.js Modules</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch09.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">CHAPTER 9: Using Web Server Frameworks</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content" style="transform: none;"><div class="annotator-wrapper"><p class="ChapterNumber"><a id="Chap_8"></a>CHAPTER 8</p>
<p class="chapimage"><img src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/frontdot.jpg" alt="image" width="82" height="25" data-mfp-src="/library/view/nodejs-recipes-a/9781430260585/images/frontdot.jpg"></p>
<p class="ChapterTitle">Creating a WebSocket Server</p>
<div>
<p class="noindent">This chapter begins a departure from the previous chapters in the book. Previously, the chapters concentrated heavily on the Node.js core and its functionality. This was to build a better understanding of the fundamental architecture and platform availabilities that are included with Node.js. However, Node.js is a thriving success because of the ecosystem of third-party modules and the extensibility that they provide. This chapter, and those that follow, will provide you will a taste of the Node.js community and what it can offer you in your application development. This chapter begins by discussing WebSockets.</p>
<p class="indent">Before WebSockets, there were many methods for communicating in a WebSocket-like fashion between a client and a server. Many of these used some form of polling from client to server, where the client would connect to the server, which would then either respond with a status directly or hold the HTTP connection open for a long duration waiting for an event. This creates many HTTP requests and is not a fully two-way communication between client and server. So the HTML 5 specification drafted the WebSocket protocol to allow for this two-way communication with a persistent connection.</p>
<p class="indent">WebSockets are based on the WebSocket protocol, defined as a two-way communication with a remote host<a id="cXXX.418"></a>, or bidirectional communication<a id="cXXX.419"></a> over TCP. WebSocket communication is message-based, which makes it easier to handle than a communication mechanism such as TCP streams. The WebSocket implementation at first glance may appear like an HTTP instance, but the HTTP portion of the interface is just to create a handshake between the client and the server and subsequently upgrade the connection to the WebSocket protocol. Once the handshake is successful, both the client and the server are able to send messages to the other.WebSocket messages are composed of frames, which in terms of the protocol are sections of information that determine what type of message is being sent. These can be the type of content (binary or text), or control frames that can be used to signal that a connection should be closed. WebSocket endpoints are accessed by using the <span class="FontName1">ws://</span> URI scheme and the <span class="FontName1">wss://</span> for a Secure Sockets Layer<a id="cXXX.420"></a> (SSL)<a id="cXXX.421"></a> connection<a id="cXXX.422"></a>.</p>
<p class="indent">WebSockets thrive in Node.js because of the event-driven nature of Node.js and the ability to quickly and efficiently create a WebSocket server, either manually or through a third-party tool. Because of this natural fit with Node.js, the barrier for entry into the world of WebSockets makes it easy tocreate WebSocket-supported servers with Node.js.</p>
<p class="indent">You briefly saw how to create an upgraded WebSocket connection in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch04.xhtml">Chapter 4</a>, but this chapter will showcase utilizing different frameworks and techniques for building a fullyfledged WebSocket application. Some topics you will cover include the following:</p>
<ul class="bulleted">
<li>Using third-party modules to build WebSocket servers</li>
<li>Listening for events on the client</li>
<li>Building an API with WebSockets</li>
<li>Communicating events from your server with WebSockets</li>
<li>Handling these events in the browser and creating two-way communications</li>
<li>Building a multiuser application with WebSockets</li>
</ul>
<p class="indent">There are several WebSocket implementations that are available to you as a Node.js developer if you do not wish to create your own server. By not creating your own server, you trade off a few things and gain others. You trade off full control of your service from concept to production, but one thing that you gain, if the module you are using is well supported, is the community surrounding the module. This chapter will look at two of these modules: WebSocket-Node and Socket.IO<a id="cXXX.192t"></a>. Both have strong communities to which developers can turn for a sound implementation; however,Socket.IO has become the first place to go for many WebSocket developers.</p>
<p class="Para"></p>
<p id="Sec1" class="Heading1">8-1. Implementing a WebSocket Server with WebSocket-Node</p>
<div>
<p id="Sec2" class="Heading2_2">Problem</p>
<p class="noindent">You would like to begin using the WebSocket-Node module<a id="cXXX.470a"></a><a id="cXXX.210a"></a> in order to create a WebSocket server.</p>
</div>
<div>
<p id="Sec3" class="Heading2">Solution</p>
<p class="noindent">When you first turn to WebSocket-Node for your WebSocket needs, you see that you have the opportunity to utilize a framework that is not highly opinionated as to how you format your WebSocket as it is mostly a JavaScript implementation of the WebSocket Protocol.</p>
<p class="indent">To get Started utilizing this Node.js module, you first need to install from the npm registry, ‘<span class="FontName1">npm install websocket</span><a id="cXXX.470c"></a><a id="cXXX.210c"></a><a id="cXXX.423"></a><a id="cXXX.424"></a>.’ Once you have this installed, you are able to use it as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list1" id="_list1">Listing 8-1</a> where you see that you extend a web server to utilize the upgraded WebSockets<a id="cXXX.425"></a><a id="cXXX.426"></a> connection.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list1" id="list1">Listing 8-1</a></i></b>.&nbsp;&nbsp;Upgrading<a id="cXXX.470d"></a><a id="cXXX.210d"></a> a Web Server to Use WebSockets<a id="cXXX.446a"></a></p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* using WebSocket-Node</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fs = require('fs'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">url = require('url'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">WebSocketServer = require('websocket').server;</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(req, res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var urlParsed = url.parse(req.url,true, true);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fs.readFile(urlParsed.path.split('/')[1], function(err, data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 404;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(http.STATUS_CODES[404]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 200;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">}).listen(8080);</span><br>&nbsp;<br><span class="FontName1">var serverConfig = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">httpServer: server,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">autoAcceptConnections: false</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var wsserver = new WebSocketServer();</span><br>&nbsp;<br><span class="FontName1">wsserver.mount(serverConfig);</span><br>&nbsp;<br><span class="FontName1">wsserver.on('connect', function(connection) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connected');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.send('yo');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">wsserver.on('request', function(req) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('request');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var connection = req.accept('echo-protocol', req.origin);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.on('message', function(message) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (message.type === 'utf8') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(message.utf8Data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">else if (message.type === 'binary') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(message.binaryData);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.on('close', function(reasonCode, description) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connection closed', reasonCode, description);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">wsserver.on('close', function(conn, reason, description) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('closing', reason, description);</span><br><span class="FontName1">});</span></pre>
</div>
<div>
<p id="Sec4" class="Heading2">How It Works</p>
<p class="noindent">When you create a WebSocket server with WebSocket-Node, you accomplish quite a few things with a simple-to-use API. First, you are creating an HTTP server. This is a requirement because the HTTP connection must be upgraded in order to successfully create the WebSocket connection via the handshake process. You then need to create a WebSocket server configuration object, <span class="FontName1">serverConfig</span>, in your solution.</p>
<p class="indent">This configuration<a id="cXXX.470b"></a><a id="cXXX.210b"></a><a id="cXXX.427"></a><a id="cXXX.428"></a> is what will be used to determine the type of WebSocket communication your server will handle. The options that are available to be set on this configuration are shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#Tab1" id="_Tab1">Table 8-1</a>. These defaults are merged with the options that you set and used in the WebSocket server.</p>
<div class="Table">
<p class="TabCapt">
<span class="CaptNr">
<a id="Tab1" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_Tab1">Table 8-1</a>. </span>WebSocket Server Configuration Options </p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td> assembleFragments</td>
<td> This tells the server to automatically assemble messages that are fragmented and then the full message is to be emitted on the ‘message’ event. If this is not true, then the frames are emitted on the ‘frame’ event and the client will need to assemble these frames together itself. Default: true</td>
</tr>
<tr>
<td> .autoAcceptConnections</td>
<td> This tells the server whether or not to accept any WebSocket connection, regardless of the path or the protocol that is specified by the client. This should be avoided in most cases as you are better off inspecting the request to check for allowable origin and protocol. Default: false</td>
</tr>
<tr>
<td> .closeTimeout</td>
<td> This is the number of milliseconds to wait after sending a close frame to see if the acknowledgment is returned before closing the socket anyway. Default: 5000</td>
</tr>
<tr>
<td> .disableNagleAlgorithm</td>
<td> This will determine if the Nagle algorithm is utilized. This algorithm allows for smaller packets to be aggregated together by inserting a small delay before transmission. Default: true (no delay)</td>
</tr>
<tr>
<td> .dropConnectionOnKeepaliveTimeout</td>
<td> This tells the WebSocket server to drop connections to clients that are unable to respond to a keepalive ping within the .keepaliveGracePeriod. Default: true</td>
</tr>
<tr>
<td> .fragmentationThreshold</td>
<td> If an outgoing frame is larger than this number, then it will be fragmented. Default: 0x4000 (16KB)</td>
</tr>
<tr>
<td> .fragmentOutgoingMessages</td>
<td> This setting tells whether to fragment messages that exceed the fragmentationThreshold option. Default: true</td>
</tr>
<tr>
<td> .httpServer</td>
<td> This is the server that you are going to be upgrading the connection to WebSocket protocol. This option is required. Default: null</td>
</tr>
<tr>
<td> .keepAlive</td>
<td> This timer will send out a ping to all clients at each specified .keepaliveInterval. Default: true</td>
</tr>
<tr>
<td> .keepaliveGracePeriod</td>
<td> This is the amount of time, in milliseconds, to wait after sending the keepalive ping before dropping the connection. Default: 10000</td>
</tr>
<tr>
<td> .keepaliveInterval</td>
<td> The amount of time in milliseconds to send a keepalive ping to connected clients. Default: 20000</td>
</tr>
<tr>
<td> .maxReceivedFrameSize</td>
<td> This option is to set the maximum frame size threshold for the WebSocket message frames. Default: 0x10000 (hex) = 64 Kilobytes</td>
</tr>
<tr>
<td> .maxReceivedMessageSize</td>
<td> This is to set the maximum size for messages. This only applies if the option .assembleFragments is set to true. Default: 0x100000 (1 MB)</td>
</tr>
<tr>
<td> .useNativeKeepalive</td>
<td> This will tell the server to use the TCP keepalive instead of the WebSocket ping and pong packets. The difference is that the TCP keepalive is slightly smaller, reducing bandwidth. If set to true, then .keepaliveGracePeriod and .dropConnectionOnKeepaliveTimeout are ignored. Default: false</td>
</tr>
</tbody>
</table>
</div>
<p class="indent">Once you have your configuration set with your HTTP server, you can instantiate a new WebSocket server by calling <span class="FontName1">new WebSocketServer([config])</span>, where [config] means you are optionally passing in the configuration options. In your solution you then call the <span class="FontName1">.mount()</span> method of the new WebSocket server, which will merge the options and bind to the ‘<span class="FontName1">upgrade</span>’ event of the HTTP server.</p>
<p class="indent">Another method that is available to the WebSocket server is<span class="FontName1">unmount()</span>, which will remove the ability to upgrade to the WebSocket protocol from the HTTP server but will not affect any existing connections. <span class="FontName1">closeAllConnections()</span><a id="cXXX.429"></a> is another method that is a graceful shutdown of all connections; <span class="FontName1">shutdown()</span>closes all connections and unmounts from the server.</p>
<p class="indent">There are several events that you are able to listen to as well. In your example, you utilize the ‘<span class="FontName1">request</span>’ , ‘<span class="FontName1">connect</span>’ , and the ‘<span class="FontName1">close</span>’ event.</p>
<p class="indent">The ‘<span class="FontName1">request</span>’ event is emitted when you do not have the configuration option ‘<span class="FontName1">autoAcceptConnections</span><a id="cXXX.430"></a>’ set to true. This will give you the opportunity to inspect the incoming WebSocket request to guarantee that you are aiming to connect to the desired origin and protocol. You can then either <span class="FontName1">accept()</span> or <span class="FontName1">reject()</span> the request. You saw that in the example the <span class="FontName1">accept()</span>method took parameters. The <span class="FontName1">accept()</span>method can take three parameters: a protocol, an origin, and cookies. The protocol will only accept data from a WebSocket connection of the same protocol. The origin allows you to limit WebSocket communication to a specified host. The cookies in the arguments must be an arrayin which name/value pairs accompany the request.</p>
<p class="indent">The ‘<span class="FontName1">connect</span>’ event<a id="cXXX.431"></a> is emitted from the server once the request has been accepted. This event will then pass the <span class="FontName1">WebSocketConnection</span> object to be handled in the callback of the handled event.</p>
<p class="indent">The ‘<span class="FontName1">close</span>’ event<a id="cXXX.432"></a> is emitted when the connection to the WebSocket server is closed for any reason. It will not pass only the <span class="FontName1">WebSocketConnection</span> object, but also a close reason and description to the callback of the event handler.</p>
<p class="indent">You have seen how to create a connection to a WebSocket server using WebSocket-Node, a third-party module for WebSocket implementation. You will now investigate two ways to communicate with the WebSocket server by using a Node.js client or from a client on a web application.</p>
<div class="notepara">
<p class="paraaftertitle1"><img src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/sq.jpg" alt="image" width="12" height="12" data-mfp-src="/library/view/nodejs-recipes-a/9781430260585/images/sq.jpg">&nbsp;<b>Note</b>&nbsp;&nbsp;WebSockets is not fully available across web browsers. Internet Explorer does not implement the protocol until Internet Explorer version 10. Opera Mini (through version 7.0)and the Android browser (through version 4.2) do not support the protocol. In addition to this, some legacy versions of other browsers do not support the most current implementation. For more information, check <span class="FontName1"><a href="http://caniuse.com/#feat=websockets">http://caniuse.com/#feat=websockets</a></span>.</p></div>
</div>
<p id="Sec5" class="Heading1">8-2. Listening for WebSocket Events on the Client</p>
<div>
<p id="Sec6" class="Heading2_2">Problem</p>
<p class="noindent">You want to be able to communicate with a WebSocket server as a client.</p>
</div>
<div>
<p id="Sec7" class="Heading2">Solution</p>
<p class="noindent">There are several ways to connect to a WebSocket connection, and you will see two of these methods in this solution. One way to accomplish this is to utilize the third-party framework, WebSocket-Node, to create a client application<a id="cXXX.433"></a> that will connect to a WebSocket server and communicate between the two endpoints. This is shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list2" id="_list2">Listing 8-2</a> and is different than the more typical approach of utilizing a web page (which you will cover in more detail in Section 8-5) to connect to a WebSocket server and continue to communicate using that protocol.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list2" id="list2">Listing 8-2</a></i></b>.&nbsp;&nbsp;Creating a WebSocket Client with WebSocket-Node</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* A WebSocket Client</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var WebSocketClient = require('websocket').client;</span><br>&nbsp;<br><span class="FontName1">var client = new WebSocketClient();</span><br>&nbsp;<br><span class="FontName1">client.on('connectFailed', function(error) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('Connect Error: ' + error.toString());</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">client.on('connect', function(connection) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('woot: WebSocket client connected');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.on('error', function(error) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(error);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.on('close', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('echo-protocol Connection Closed');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.on('message', function(message) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">switch (message.type) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">case 'utf8':</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">console.log('from server: ', message.utf8Data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">default:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">console.log(JSON.stringify(message));</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.send('heyo');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">client.connect('ws://localhost:8080/', 'echo-protocol');</span></pre>
<p class="indent">As an alternative to the WebSocket-Node implementation in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list2">Listing 8-2</a>, you could create a WebSocket client that will connect by using an HTML page like the one shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list3" id="_list3">Listing 8-3</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list3" id="list3">Listing 8-3</a></i></b>.&nbsp;&nbsp;WebSocket Client HTML Page<a id="cXXX.434"></a></p>
<pre><span class="FontName1">&lt;!doctype html&gt;</span><br><span class="FontName1">&lt;html&gt;</span><br><span class="FontName1">&lt;head&gt;</span><br><span class="FontName1">&lt;/head&gt;</span><br><span class="FontName1">&lt;body&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;h3&gt;WebSockets!&lt;/h3&gt;</span><br><span class="FontName1">&lt;script&gt;</span><br><span class="FontName1">window.onload = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var ws = new WebSocket('ws://localhost:8080', 'echo-protocol');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.onopen = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('opened');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.onmessage = function(event) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(event);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.send(JSON.stringify({ status: 'ok'}));</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br><span class="FontName1">};</span><br><span class="FontName1">&lt;/script&gt;</span><br><span class="FontName1">&lt;/body&gt;</span><br><span class="FontName1">&lt;/html&gt;</span></pre>
</div>
<div>
<p id="Sec8" class="Heading2">How It Works</p>
<p class="noindent">First, you created a client by using the <span class="FontName1">WebSocketClient</span> that is available to be used in a Node.js application that comes with WebSocket-Node. This client creates the upgraded connection to a WebSocket server for you when you call <span class="FontName1">new WebSocketClient();</span>. This constructor function will accept an options object and extend that with the default options, which are shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#Tab2" id="_Tab2">Table 8-2</a>.</p>
<div class="Table">
<p class="TabCapt">
<span class="CaptNr">
<a id="Tab2" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_Tab2">Table 8-2</a>. </span>WebSocketClient Options<a id="cXXX.435"></a> </p>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td> .assembleFragments</td>
<td> This tells the client to automatically assemble fragmented frames into a complete message. Default: true</td>
</tr>
<tr>
<td> .closeTimeout</td>
<td> This is the time to wait, in milliseconds, until the connection is closed after not receiving a response. Default: 5000</td>
</tr>
<tr>
<td> .disableNagleAlgorithm</td>
<td> This tells whether to disable the Nagle algorithm, which will set a small delay before sending messages in order to reduce HTTP traffic. Default: true</td>
</tr>
<tr>
<td> .fragmentOutgoingMessages</td>
<td> This will cause outgoing messages that are larger than the set .fragmentationThreshold to be fragmented. Default: true</td>
</tr>
<tr>
<td> .fragmentationThreshold</td>
<td> This is the size limit at which to split frames into fragments. Default: 16KB</td>
</tr>
<tr>
<td> .webSocketVersion</td>
<td> This is the specified version of the WebSocket protocol to utilize in this connection. Default: 13</td>
</tr>
<tr>
<td> .maxReceivedFrameSize</td>
<td> This will set the maximum size of the frames that are received via the WebSocket protocol. Default: 1 MB</td>
</tr>
<tr>
<td> .maxReceivedMessageSize</td>
<td> This is the maximum size of the messages received via the protocol. It only applies if the .assembleFragments option is set to true. Default: 8 MB</td>
</tr>
<tr>
<td> .tlsOptions</td>
<td> This object can contain Transport Layer Security (TLS) information for secure connections.</td>
</tr>
</tbody>
</table>
</div>
<p class="indent">Once you have created your WebSocket client, you are able to listen for events and messages that are transported via the connection. In your solution, you listen for a ‘<span class="FontName1">connect'</span> event. This event will receive the connection object in the callback, which you will then use to transmit and receive data to the server. The connection is initialized by calling the .<span class="FontName1">connect()</span> function on the WebSocket client. This will accept the URL and the protocol that you wish to bind the endpoints to.</p>
<p class="indent">To transmit a message to the WebSocket server, you utilize the <span class="FontName1">connection.send()</span> method<a id="cXXX.436"></a>. This method will take two arguments: first the data you wish to send, and second, a callback function (which is optional). The data will be processed to check whether the data are a buffer. If the data are a buffer, they will be processed by calling the .<span class="FontName1">sendBytes()</span> method<a id="cXXX.437"></a> of the connection; otherwise it will attempt to use the connection’s .<span class="FontName1">sendUTF()</span> method<a id="cXXX.438"></a> if the data can be converted with the .<span class="FontName1">toString()</span> method<a id="cXXX.439"></a>. The .<span class="FontName1">sendBytes()</span> or .<span class="FontName1">sendUTF()</span> methods will be where your callback is passed. You can see the internal workings of the WebSocket-Node implementation of the send method in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list4" id="_list4">Listing 8-4</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list4" id="list4">Listing 8-4</a></i></b>.&nbsp;&nbsp;WebSocketClient Send Method</p>
<pre><span class="FontName1">WebSocketConnection.prototype.send = function(data, cb) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (Buffer.isBuffer(data)) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.sendBytes(data, cb);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">else if (typeof(data['toString']) === 'function') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.sendUTF(data, cb);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">throw new Error("Data provided must either be a Node Buffer or implement toString()")</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">};</span></pre>
<p class="indent">You were also able to listen to the ‘message’ event. This event is emitted from the WebSocket server and in your example, you checked to see what type of message is received. Checking the type allows you to process the message appropriately, whether it is a utf8 string or another format. Using the <span class="FontName1">WebSocketClient</span> that comes with WebSocket-Node is a great way to build interprocess communications for your Node.js applications. However, you may want to use an HTML page to create your WebSocket clients.</p>
<p class="indent">By utilizing either the <span class="FontName1">WebSocketClient</span> or the native WebSockets available in the WebSocket object in a web browser, you can create a useful client connection to a WebSocket server.</p>
</div>
<p id="Sec9" class="Heading1">8-3. Building a WebSocket API</p>
<div>
<p id="Sec10" class="Heading2_2">Problem</p>
<p class="noindent">You want to build an application to utilize WebSockets, but you need to create an API that fits well into the WebSocket paradigm.</p>
</div>
<div>
<p id="Sec11" class="Heading2">Solution</p>
<p class="noindent">Creating an API with WebSockets can seem to be different than another API approach, such as representational state transfer (REST)<a id="cXXX.440"></a>.<a id="cXXX.441"></a> This is because, though you could conceivably be targeting multiple routes in your application, with WebSockets you lack access to the HTTP verbs that dictate actions in a RESTful design<a id="cXXX.442"></a>. There are several ways in which you can still build an organized API. In <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list5" id="_list5">Listing 8-5</a> you see that you build a WebSocket server, not unlike the server created in the first section of this chapter, which contains some extra handling with the data that are sent in the messages from the client.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list5" id="list5">Listing 8-5</a></i></b>.&nbsp;&nbsp;Route Handling<a id="cXXX.443"></a> with a WebSocket Server</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* using WebSocket-Node</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fs = require('fs'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">url = require('url'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">WebSocketServer = require('websocket').server;</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(req, res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var urlParsed = url.parse(req.url,true, true);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fs.readFile(urlParsed.path.split('/')[1], function(err, data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 404;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(http.STATUS_CODES[404]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 200;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">}).listen(8080);</span><br>&nbsp;<br><span class="FontName1">var serverConfig = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">httpServer: server,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">autoAcceptConnections: false</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var wsserver = new WebSocketServer();</span><br>&nbsp;<br><span class="FontName1">wsserver.mount(serverConfig);</span><br>&nbsp;<br><span class="FontName1">wsserver.on('connect', function(connection) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.send('yo');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">wsserver.on('request', function(req) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (req.requestedProtocols[0] == 'echo-protocol') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var connection = req.accept('echo-protocol', req.origin);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.on('message', function(message) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (message.type === 'utf8') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var rt = JSON.parse(message.utf8Data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">switch (rt.path) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 'route_a':</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('something cool on route a');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">case 'route_b':</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('something cool on route b', rt);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">default:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('something awesome always can happen');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">break;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">else if (message.type === 'binary') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(message.binaryData);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.on('close', function(reasonCode, description) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connection closed', reasonCode, description);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('protocol not acceptable');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">wsserver.on('close', function(conn, reason, description) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('closing', reason, description);</span><br><span class="FontName1">});</span></pre>
<p class="indent">Once you have this route handling created on your server, you can build a more logical model for sending messages across the WebSocket connection from the client, as shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list6" id="_list6">Listing 8-6</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list6" id="list6">Listing 8-6</a></i></b>.&nbsp;&nbsp;Manual Routes<a id="cXXX.444"></a></p>
<pre><span class="FontName1">&lt;!doctype html&gt;</span><br><span class="FontName1">&lt;html&gt;</span><br><span class="FontName1">&lt;head&gt;</span><br><span class="FontName1">&lt;/head&gt;</span><br><span class="FontName1">&lt;body&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;h3&gt;WebSockets!&lt;/h3&gt;</span><br>&nbsp;<br><span class="FontName1">&lt;script&gt;</span><br><span class="FontName1">window.onload = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var ws = new WebSocket('ws://localhost:8080', 'echo-protocol');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.onopen = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('opened');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.onmessage = function(event) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(event);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.send(JSON.stringify({ status: 'ok', path: 'route_a'}));</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.send(JSON.stringify({ status: 'ok', path: 'route_b', action: 'update'}));</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">};</span><br><span class="FontName1">&lt;/script&gt;</span><br><span class="FontName1">&lt;/body&gt;</span><br><span class="FontName1">&lt;/html&gt;</span></pre>
<p class="indent">While this is usually a successful strategy for implementing some sort of routing or API design with WebSockets, there are alternatives for this object-routing concept as well. One alternative is shown by utilizing the WebSocket-Node <span class="FontName1">WebSocketRouter</span> object. This object allows you to easily dictate separate routing for different paths or protocols in your WebSocket-based Node.js application. A server of this type is shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list7" id="_list7">Listing 8-7</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list7" id="list7">Listing 8-7</a></i></b>.&nbsp;&nbsp;A WebSocketRouter Server<a id="cXXX.445"></a></p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* WebSockets API</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fs = require('fs'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">url = require('url'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">WebSocketServer = require('websocket').server,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">WebSocketRouter = require('websocket').router;</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(req, res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var urlParsed = url.parse(req.url,true, true);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fs.readFile(urlParsed.path.split('/')[1], function(err, data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 404;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(http.STATUS_CODES[404]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 200;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">}).listen(8080);</span><br>&nbsp;<br><span class="FontName1">var serverConfig = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">httpServer: server,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">autoAcceptConnections: false</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var wsserver = new WebSocketServer();</span><br>&nbsp;<br><span class="FontName1">wsserver.mount(serverConfig);</span><br>&nbsp;<br><span class="FontName1">var router = new WebSocketRouter();</span><br><span class="FontName1">router.attachServer(wsserver);</span><br>&nbsp;<br><span class="FontName1">router.mount('*', 'echo-protocol', function(request) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('mounted to echo protocol');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var conn = request.accept(request.origin);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">conn.on('message', function(message) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('routed message');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">conn.send('hey');</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">router.mount('*', 'update-protocol', function(request) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('mounted to update protocol');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var conn = request.accept(request.origin);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">conn.on('message', function(message) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('update all the things');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">});</span></pre>
<p class="indent"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list8" id="_list8">Listing 8-8</a> shows how you can build an HTTP client<a id="cXXX.446"></a> within your HTML page that will showcase how you can specify routes from the <span class="FontName1">WebSocketRouter</span> server.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list8" id="list8">Listing 8-8</a></i></b>.&nbsp;&nbsp;WebSocketRouter HTTP Client<a id="cXXX.447"></a></p>
<pre><span class="FontName1">&lt;!doctype html&gt;</span><br><span class="FontName1">&lt;html&gt;</span><br><span class="FontName1">&lt;head&gt;</span><br><span class="FontName1">&lt;/head&gt;</span><br><span class="FontName1">&lt;body&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;h3&gt;WebSockets!&lt;/h3&gt;</span><br>&nbsp;<br><span class="FontName1">&lt;script&gt;</span><br><span class="FontName1">window.onload = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var ws = new WebSocket('ws://localhost:8080', 'echo-protocol');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.onopen = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('opened');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.onmessage = function(event) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(event);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.send(JSON.stringify({ status: 'ok', path: 'route_a'}));</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var wsupdate = new WebSocket('ws://localhost:8080', 'update-protocol');</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">wsupdate.onopen = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">wsupdate.send('update');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br><span class="FontName1">};</span><br><span class="FontName1">&lt;/script&gt;</span><br><span class="FontName1">&lt;/body&gt;</span><br><span class="FontName1">&lt;/html&gt;</span></pre>
</div>
<div>
<p id="Sec12" class="Heading2">How It Works</p>
<p class="noindent">After examining these two types of API implementations with WebSockets, you notice immediately that there is nothing overly complicated about these solutions. The basis for both is to specify an action to be resolved, given a specific message from the server.</p>
<p class="indent">In <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list4">Listing 8-4</a>, you created a server that handled a JavaScript Object Notation (JSON)<a id="cXXX.448"></a> object<a id="cXXX.449"></a> that is passed from the client to the server. This requires you to design the routes and actions that you wish to provide for in your API. If you choose, you could even mimic a REST API by providing routes and actions accordingly. For example, if you have a user profile you wish to access via an API, you could build a set of objects that could look like the following:</p>
<pre><span class="FontName1">{ route: '/user/profile', action: 'GET' }</span><br><span class="FontName1">{ route: '/user/profile', action: 'POST' }</span><br><span class="FontName1">{ route: '/user/profile', action: 'PUT' }</span><br><span class="FontName1">{ route: '/user/profile', action: 'DELETE'}</span></pre>
<p class="indent">This would be handled by your server by parsing the incoming message and then handling the routes as you do in the <span class="FontName1">switch(rt.path) {...}</span> in the solution. You can see that this solution for building a WebSocket API is very adequate for many needs, especially if you are only implementing a single protocol to handle the API directives. You could, of course, have segregated routing that is handled by different WebSocket protocols. For this, there is a feature in WebSocket-Node that makes accessing differing protocols with a single <span class="FontName1">WebSocketServer</span> instance even easier.</p>
<p class="indent">This was demonstrated in the solution found in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list6">Listing 8-6</a>. Here you create your server again, but you include the .router object from the WebSocket-Node module. To utilize this feature you first create your HTTP server. Then, just as before, you must tell your new WebSocket server that you wish to use this HTTP server for the connection. However, instead of the message and connection handling that you saw before, you now can pass the <span class="FontName1">WebSocketServer</span> to be bound to a <span class="FontName1">WebSocketRouter</span> instance. This <span class="FontName1">WebSocketRouter</span> instance will then allow you to split off the handling of the routes to specific paths and/or protocols from your client.</p>
<p class="indent">In your solution, you built a router that can handle any path that is supplied to it (‘*’), from the client but then can handle differing routes by handling different protocols<a id="cXXX.450"></a> in isolation. This means that if you have a logical separation in your application, say an API for user updates and an API for product updates, you can keep each of these easily separated with a separate protocol.&nbsp;&nbsp;You would simply create a new WebSocket on the client that points to your server and passes in the specific protocol for each item.</p>
<pre><span class="FontName1">var users = new WebSocket('ws://my.wsserver.co', 'users_protocol');</span><br><span class="FontName1">var products = new WebSocket('ws://my.wsserver.co', 'product_protocol');</span></pre>
<p class="indent">From here you no longer are concerned with all the details of routing in your data, though you will still need to be aware of actions and specific events you wish to drive through the WebSocket connection, but you know that if you are accessing a particular WebSocket protocol, you are isolated to that set of the application logic. In fact the entire route is isolated on the server as you saw in your example. Obviously segregating types of objects is one method, but you can imagine that the possibility to separate each type of update/fetch messaging is possible too. This may be too granular for most cases, but in an example of a chat room, you might have a ‘<span class="FontName1">sendmessage_protocol'</span> and a ‘<span class="FontName1">getmessage_protocol'</span> and handle the get and send operations completely separately.</p>
<p class="indent">There are essentially limitless ways in which you can build an API around your WebSocket connections in your Node.js application, allowing you the freedom to create your application as you see fit.</p>
<p class="indent">Most of this chapter to this point has been based around the WebSocket-Node module and its implementations. From here you will investigate Socket.IO, which is another and hugely popular framework for building a WebSocket-based Node.js application.</p>
</div>
<p id="Sec13" class="Heading1">8-4. Using Socket.IO for WebSocket Communications</p>
<div>
<p id="Sec14" class="Heading2_2">Problem</p>
<p class="noindent">You want to build your WebSocket-based Node.js application by utilizing the Socket.IO module.</p>
</div>
<div>
<p id="Sec15" class="Heading2">Solution</p>
<p class="noindent">Socket.IO is a fully operational and highly popular framework for utilizing WebSockets with Node.js.Implementations of Socket.IO can take many forms, but the most popular will be to communicate messages between a client and server in a manner similar to the Node.js event model. To get started, you first install Socket.IO via npm with the ‘$ npm install socket.io’ command. To build the Socket.IO server, you can follow the example shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list9" id="_list9">Listing 8-9</a>, which showcases various methods that are accessible to you as you implement a Node.js Socket.IO server.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list9" id="list9">Listing 8-9</a></i></b>.&nbsp;&nbsp;Implementing a Socket.IO Server<a id="cXXX.451"></a><a id="cXXX.452"></a></p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* Socket.io Server</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var app = require('http').createServer(connectHandler),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">io = require('socket.io').listen(app),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fs = require('fs');</span><br>&nbsp;<br><span class="FontName1">app.listen(8080);</span><br>&nbsp;<br><span class="FontName1">function connectHandler (req, res) {</span><br>&nbsp;&nbsp;<span class="FontName1">fs.readFile(__dirname + '/8-4-1.html',</span><br>&nbsp;&nbsp;<span class="FontName1">function (err, data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeHead(500);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return res.end('Error loading 8-4-1.html');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeHead(200);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(data);</span><br>&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">}</span><br><span class="FontName1">// General</span><br><span class="FontName1">io.sockets.on('connection', function (socket) {</span><br><span class="FontName1">socket.broadcast.emit('big_news'); // Emits to all others except this socket.</span><br><span class="FontName1">socket.emit('news', { hello: 'world' });</span><br><span class="FontName1">socket.on('my other event', function (data) {</span><br><span class="FontName1">console.log(data);</span><br><span class="FontName1">});</span><br><span class="FontName1">});</span><br><span class="FontName1">//namespaced</span><br><span class="FontName1">var users = io.of('/users').on('connection', function(socket) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">socket.emit('user message', {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">that: 'only',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">'/users': 'will get'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">users.emit('users message', {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">all: 'in',</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">'/users': 'will get'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">});</span></pre>
<p class="indent">One of the reasons that Socket.IO has become so popular is that it has a drop-in client module that you can utilize in an HTML page that is bound to your server. This allows for an effortless connection to the WebSocket server that was created using Socket.IO. Implementing this connection requires adding a single JavaScript file reference and then binding to the WebSocket server by using a Socket.IO specific binding as opposed to the <span class="FontName1">new WebSocket()</span> instantiation that is part of the web standard.</p>
<p class="noindent2"><b><i>Listing 8-10</i></b>.&nbsp;&nbsp;A Socket.IO<a id="cXXX.459a"></a> Client<a id="cXXX.453"></a><a id="cXXX.454"></a></p>
<pre><span class="FontName1">&lt;!doctype html&gt;</span><br><span class="FontName1">&lt;html&gt;</span><br><span class="FontName1">&lt;head&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;script&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var socket = io.connect('</span><span class="FontName1"><a href="http://localhost/">http://localhost</a></span><span class="FontName1">');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.on('news', function (data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.emit('my other event', { my: 'data' });</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.on('big_news', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('holy cow!');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var users = io.connect('</span><span class="FontName1"><a href="http://localhost/users">http://localhost/users</a></span><span class="FontName1">');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">users.on('connect', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">users.emit('users yo');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;/script&gt;</span><br><span class="FontName1">&lt;/head&gt;</span><br><span class="FontName1">&lt;body&gt;</span><br>&nbsp;<br><span class="FontName1">&lt;/body&gt;</span><br><span class="FontName1">&lt;/html&gt;</span></pre>
</div>
<div>
<p id="Sec16" class="Heading2">How It Works</p>
<p class="noindent">Socket.IO does many things for you when you are building a WebSocket server, but it also allows the flexibility that you need when building a Node.js application. Just as with WebSocket-Node, it abstracts away the handshake to create the upgraded WebSocket connection not only on the server but also on the client when you include the Socket.IO JavaScript file in your HTML.Socket.IO is also unique because it not only will leverage the power of the WebSocket protocol but also will fall back to other methods of two-way communication, such as Flash sockets, long-polling, and iframes. It will do this so that you can build your application, create a WebSocket communication structure<a id="cXXX.455"></a><a id="cXXX.456"></a>, and still be able to rely on the Socket.IO communication even on older browsers or on those that do not support the WebSocket protocol.</p>
<p class="indent">In <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list8">Listing 8-8</a> you created a WebSocket server by using Socket.IO. To do this, you first installed the Socket.IO package.&nbsp;&nbsp;You then created a simple HTTP server by using the native Node.js http module; this is to serve the HTML page from <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list9">Listing 8-9</a> that you plan to use to connect to the WebSocket server.</p>
<p class="indent">When you instantiate Socket.IO in your code, you do so by telling the new object to listen on the HTTP server, <span class="FontName1">io = require('socket.io').listen(server)</span>, but you could also just pass in a port on which to listen. Now you have access to the Socket.IO API. On the server there are several events that you utilized to communicate to the client.</p>
<p class="indent">First, you listened for the ‘connection’ event<a id="cXXX.457"></a><a id="cXXX.458"></a>, which is emitted when the server receives a connection from a client. From the callback on this event you gain access to the individual socket that is bound to that particular connection.This socket is where your WebSocket communication can take place.</p>
<p class="indent">The first communication that you perform is a broadcasted message<a id="cXXX.459"></a><a id="cXXX.460"></a>. This message is triggered by calling <span class="FontName1">socket.broadcast.emit('big_news');,</span> which will send the message ‘<span class="FontName1">big_news'</span> to all sockets that are connected to the Socket.IO server with the exception of the connection that is sending the broadcast. Next you emit an event ‘news’ by using the method <span class="FontName1">socket.emit('news', { hello: 'world' });</span>. This event is able to be listened for on the client where you can then process the data that were transmitted with the message. This is similar to the <span class="FontName1">WebSocket.send()</span> method that you will see in more detail in the following section.The last method that you utilize inside of the ‘connection’ event callback is the binding to an arbitrary event message emitted from the client. This is accomplished in the same manner as binding to any event.</p>
<p class="indent">You then made a WebSocket connection that was bound to a namespace. This would be useful for creating an API similar to the examples outlined in the previous section. You can bind to a namespace by calling <span class="FontName1">io.of('/path')</span>. This will then route any connections that are on that path to the specifiedhandlers. You can name these namespaces as you did in the solution <span class="FontName1">var users = io.on('/users');.</span> This is useful because you can then call events on only the user’s namespace, such as when you emitted the message to all users by calling <span class="FontName1">users.emit('users message'...).</span></p>
<p class="indent">To receive and transmit messages on the client, you simply start by adding a JavaScript reference to the socket.io.js file. This will give you access to an I/O object, which you can then use to connect to your Socket.IOserver. Once connected, you have an instance of a socket that can listen for and emit events to the server. Again, just as with the server namespacing you are able to connect to a specific route by utilizing a path: <span class="FontName1">var users = io.connect('</span><span class="FontName1"><a href="http://localhost/users">http://localhost/users</a></span><span class="FontName1">');</span>.</p>
<p class="indent">With this implementation, you are able to see how you can leverage Socket.IO to build a Node.js WebSocket server and client.Socket.IO utilizes its own API for sending and receiving messages. However, if you choose to use the WebSocket standard <span class="FontName1">.send()</span> instead of the <span class="FontName1">.emit()</span> method, Socket.IO will support that. In the next sections, you will get a closer look at how to utilize the WebSocket object to send and handle messages across connections.</p>
</div>
<p id="Sec17" class="Heading1">8-5. Handling WebSocket Events in a Browser</p>
<div>
<p id="Sec18" class="Heading2_2">Problem</p>
<p class="noindent">You would like to utilize WebSocket events in the browser.</p>
</div>
<div>
<p id="Sec19" class="Heading2">Solution</p>
<p class="noindent">Earlier in the chapter you saw how you are able to build a WebSocket client by using the WebSocket-Node module. You have also seen cases where these WebSocket connections can be made either in a web browser or by using Socket.IO in the browser. <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list11" id="_list11">Listing 8-11</a>shows how you can utilize the WebSocket API directly in the web browser<a id="cXXX.461"></a>. In this case you should have a WebSocket server running that is similar to the one shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list1">Listing 8-1</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list11" id="list11">Listing 8-11</a></i></b>.&nbsp;&nbsp;WebSocket API<a id="cXXX.446b"></a> in the Browser</p>
<pre><span class="FontName1">&lt;!doctype html&gt;</span><br><span class="FontName1">&lt;html&gt;</span><br><span class="FontName1">&lt;head&gt;</span><br><span class="FontName1">&lt;/head&gt;</span><br><span class="FontName1">&lt;body&gt;</span><br><span class="FontName1">&lt;h3&gt;WebSockets!&lt;/h3&gt;</span><br><span class="FontName1">&lt;script&gt;</span><br><span class="FontName1">window.onload = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var ws = new WebSocket('ws://localhost:8080', 'echo-protocol');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.onopen = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('opened');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.onmessage = function(event) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(event);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.send(JSON.stringify({ status: 'ok'}));</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(ws.binaryType);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(ws.bufferedAmount);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(ws.protocol);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(ws.url);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(ws.readyState);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.onerror = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('oh no! an error has occured');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ws.onclose = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connection closed');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">};</span><br><span class="FontName1">&lt;/script&gt;</span><br><span class="FontName1">&lt;/body&gt;</span><br><span class="FontName1">&lt;/html&gt;</span></pre>
</div>
<div>
<p id="Sec20" class="Heading2">How It Works</p>
<p class="noindent">You were able to create a WebSocket client in HTML by simply binding to the endpoint of your WebSocket server and requesting the correct protocol, which in your case was called ‘echo-protocol’<a id="cXXX.462"></a>.This is accomplished by creating a <span class="FontName1">new WebSocket(&lt;url&gt;, &lt;protocol&gt;);</span> object in your web page’s JavaScript. This new WebSocket object has access to several events and attributes. The WebSocket methods that are available are .<span class="FontName1">close()</span> and <span class="FontName1">.send()</span>, which close the connection or send a message, respectively. The events that you bound to in the solution are <span class="FontName1">.onmessage</span>, and <span class="FontName1">.onopen</span>. The .<span class="FontName1">onopen</span> event<a id="cXXX.463"></a> is emitted as soon as the connection is opened, meaning that the connection is ready to send and receive data. The .<span class="FontName1">onmessage</span> event<a id="cXXX.464"></a> is the receipt of a message from the WebSocket server. Other event listeners that are available are .<span class="FontName1">onerror</span>, which will receive any error that occurs, and the .<span class="FontName1">onclose</span> event<a id="cXXX.465"></a>, which is emitted when the state changes to closed.</p>
<p class="indent">The WebSocket object in the browser also has access to several attributes. These include the URL and protocol that is being utilized to transport the information, as well as the state and any extensions that are provided by the server. The WebSocket connection also has access to see the types of data that are being transmitted via the connection. This is accessed via the <span class="FontName1">.binaryType</span> property<a id="cXXX.466"></a>, which can report either “blob” or “arraybuffer” depending on the transported data. The final attribute of the WebSocket on the browser is the .<span class="FontName1">bufferedAmount</span> property<a id="cXXX.467"></a>. This tells you how many bytes of data have been buffered by using the .<span class="FontName1">send()</span> method.</p>
</div>
<p id="Sec21" class="Heading1">8-6. Communicating Server Events<a id="cXXX.433a"></a><a id="cXXX.468"></a> via WebSockets</p>
<div>
<p id="Sec22" class="Heading2_2">Problem</p>
<p class="noindent">You have seen how to implement WebSocket frameworks and modules. Now you would like tosend server information by using WebSockets.</p>
</div>
<div>
<p id="Sec23" class="Heading2">Solution</p>
<p class="noindent">When you build your WebSocket server, one of the highly enticing use cases of this two-way freeway of information is to be able to send updates on the status of your server, or events from the server in a low latency way. This is contrary to a standard web server where you would need to poll for information;instead you can simply just send the information on demand, and bind to the message as soon as it arrives.</p>
<p class="indent">You can imagine a situation similar to those you have seen in previous sections, but where you have created a WebSocket server that is transmitting data to the client, including connections and client-driven messaging. Here you will handle the WebSocket connections and periodically send updates to all connected clients.</p>
<p class="noindent2"><b><i>Listing 8-12</i></b>.&nbsp;&nbsp;Sending Server Events</p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* server events</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var http = require('http'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fs = require('fs'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">url = require('url'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">WebSocketServer = require('websocket').server;</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(req, res) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var urlParsed = url.parse(req.url,true, true);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fs.readFile(urlParsed.path.split('/')[1], function(err, data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 404;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(http.STATUS_CODES[404]);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.statusCode = 200;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(data);</span><br><span class="FontName1">});</span><br><span class="FontName1">}).listen(8080);</span><br>&nbsp;<br><span class="FontName1">var serverConfig = {</span><br>&nbsp;&nbsp;<span class="FontName1">httpServer: server,</span><br>&nbsp;&nbsp;<span class="FontName1">autoAcceptConnections: false</span><br><span class="FontName1">};</span><br>&nbsp;<br><span class="FontName1">var wsserver = new WebSocketServer();</span><br>&nbsp;<br><span class="FontName1">wsserver.mount(serverConfig);</span><br>&nbsp;<br><span class="FontName1">var conns = [];</span><br><span class="FontName1">wsserver.on('connect', function(connection) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connected');</span><br><b>conns.push(connection);</b><br>&nbsp;&nbsp;&nbsp;&nbsp;<b>setInterval(pingClients, 5e3);</b><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">wsserver.on('request', function(req) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('request');</span><br>&nbsp;&nbsp;<span class="FontName1">var connection = req.accept('echo-protocol', req.origin);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.on('message', function(message) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (message.type === 'utf8') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(message.utf8Data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">else if (message.type === 'binary') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(message.binaryData);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.on('close', function(reasonCode, description) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('connection closed', reasonCode, description);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">});</span><br><span class="FontName1">wsserver.on('close', function(conn, reason, description) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log('closing', reason, description);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<b>for (var i = 0; i &lt; conns.length; i++) {</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>if (conns[i] === conn) {</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>conns.splice(i, 1);</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>}</b><br>&nbsp;&nbsp;&nbsp;&nbsp;<b>}</b><br><span class="FontName1">});</span><br>&nbsp;<br><b>function pingClients() {</b><br>&nbsp;&nbsp;<b>for (var i =0; i &lt; conns.length; i++) {</b><br>&nbsp;&nbsp;&nbsp;&nbsp;<b>conns[i].send('ping');</b><br>&nbsp;&nbsp;<b>}</b><br><b>}</b></pre>
</div>
<div>
<p id="Sec24" class="Heading2">How It Works</p>
<p class="noindent">In this solution, the server itself is created in the same way as many others you have seen with WebSocket-Node. The difference is highlighted in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list11">Listing 8-11</a>, showing that as connections are made, they are added to an array of connections to the server. This way you do not have to remain inside of the connection or request callbacks in order to send messages to the connections. While in this solution, you trivially created a <span class="FontName1">pingClients()</span> method<a id="cXXX.469"></a> that will loop through all the connections in the array and send them a message on an interval; you can imagine a situation where you have a critical server event to communicate that you are able to distribute to the connected sockets in a similar manner.</p>
<p class="indent">The conns array contains the reference to the entire <span class="FontName1">WebSocketConnection</span> object. This means that you have the ability to pick out a single connection from the array and send a message. You see this in the <span class="FontName1">pingClients</span> function, where you iterate over the array and call the .<span class="FontName1">send()</span> method on each individual socket.To clean up after a connection is closed, you simply find the connection that is closed within the array, then remove it with the <span class="FontName1">splice()</span> method.</p>
</div>
<p id="Sec25" class="Heading1">8-7. Two-way Communications with WebSockets</p>
<div>
<p id="Sec26" class="Heading2_2">Problem</p>
<p class="noindent">You need to be able to utilize WebSockets for two-way communications.</p>
</div>
<div>
<p id="Sec27" class="Heading2">Solution</p>
<p class="noindent">This solution will allow you to create a simple chat room with WebSockets. You will create the server with Socket.IO and utilize that to transmit data between the client and the server and client. The server is shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list13" id="_list13">Listing 8-13</a> and the client web page follows in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list14" id="_list14">Listing 8-14</a>.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list13" id="list13">Listing 8-13</a></i></b>.&nbsp;&nbsp;Socket.IO Chat Server<a id="cXXX.470"></a></p>
<pre><span class="FontName1">/**</span><br><span class="FontName1">* two-way communications</span><br><span class="FontName1">*/</span><br>&nbsp;<br><span class="FontName1">var app = require('http').createServer(connectHandler),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">io = require('socket.io').listen(app),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">fs = require('fs');</span><br>&nbsp;<br><span class="FontName1">app.listen(8080);</span><br>&nbsp;<br><span class="FontName1">function connectHandler (req, res) {</span><br>&nbsp;&nbsp;<span class="FontName1">fs.readFile(__dirname + '/8-7-1.html',</span><br>&nbsp;&nbsp;<span class="FontName1">function (err, data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (err) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeHead(500);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return res.end('Error loading 8-7-1.html');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.writeHead(200);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">res.end(data);</span><br>&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">}</span><br>&nbsp;<br><span class="FontName1">var members = [];</span><br><span class="FontName1">io.sockets.on('connection', function (socket) {</span><br>&nbsp;&nbsp;<span class="FontName1">socket.on('joined', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var mbr = data;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">mbr.id = socket.id;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">members.push(mbr);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.broadcast.emit('joined', data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(data.name, 'joined the room');</span><br>&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">socket.on('message', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// store chat now</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.broadcast.emit('message', data);</span><br>&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;<span class="FontName1">socket.on('disconnect', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">for (var i = 0; i &lt; members.length; i++) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (members[i].id === socket.id) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.broadcast.emit('disconnected', { name: members[i].name });</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">});</span></pre>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list14" id="list14">Listing 8-14</a></i></b>.&nbsp;&nbsp;Chat Client<a id="cXXX.471"></a></p>
<pre><span class="FontName1">&lt;!doctype html&gt;</span><br><span class="FontName1">&lt;html&gt;</span><br><span class="FontName1">&lt;head&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;</span><br><span class="FontName1">&lt;/head&gt;</span><br><span class="FontName1">&lt;body&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;div id="messages"&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;/div&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;form id="newChat"&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;textarea id="text"&gt;&lt;/textarea&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;input type="submit" id="sendMessage" value="Send" /&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;/form&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;script&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var socket = io.connect('</span><span class="FontName1"><a href="http://localhost/">http://localhost</a></span><span class="FontName1">');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var who;</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.on('connect', function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">var chatter = prompt('Please enter your name');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">chatter = (chatter === "" || chatter === null) ? "anon" : chatter;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">addChatter("you", "Joined");</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">who = chatter;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">socket.emit('joined', { name: chatter});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">function addChatter(name, message) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">var chat = document.getElementById("messages");</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">chat.innerHTML += "&lt;div&gt;" + name + " - " + message + "&lt;/div&gt;";</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.on('joined', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">console.log(data);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">addChatter(data.name, ' joined');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.on('disconnected', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">addChatter(data.name, 'disconnected');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">socket.on('message', function(data) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">addChatter(data.name, data.message);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var chat = document.getElementById("newChat");</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">chat.onsubmit = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">var msg = document.getElementById("text").value;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">socket.emit("message", { name: who, message: msg });</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">document.getElementById("text").value = "";</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">addChatter(who, msg);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">return false;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">&lt;/script&gt;</span><br><span class="FontName1">&lt;/body&gt;</span><br><span class="FontName1">&lt;/html&gt;</span></pre>
</div>
<div>
<p id="Sec28" class="Heading2">How It Works</p>
<p class="noindent">This solution works by first creating a Socket.IO server. This server will act as a relay between your connected chat clients, and if you were to use this in a production environment you might wish to add some persistence layer to store chats in a database.</p>
<p class="indent">Your Socket.IO server performs a relay for three events: joining the chat room, sending a message, and disconnecting a socket.</p>
<p class="indent">Joining a chat room is controlled when you input your name on the client. The client will then send a message via <span class="FontName1">socket.emit('joined',&nbsp;&nbsp;{ name: &lt;username&gt; });</span>, which tells the server that there was a join event, as well as the name of the user. This is then received on the server, and immediately a broadcast event is emitted to the other clients. These clients then bind to the ‘joined’ message from the server, which contains the data that they need in order to know who has joined the room. This is then added to the HTML of the web page.</p>
<p class="indent">Once you have joined a room, you are able to send a message to the other users in the room. This begins on the client, where you are able to input your chat message into a text area, then you send the message. This occurs with <span class="FontName1">socket.emit('message', {name: &lt;user&gt;, message: &lt;text&gt;});</span> and again this is immediately broadcast to the other connections where the text is and the user is added to the HTML<a id="cXXX.472"></a>.</p>
<p class="indent">Finally, you want to know if those whom you are chatting with have left the room. To do this, you bind to the ‘<span class="FontName1">disconnect</span>’ event<a id="cXXX.473"></a> on the socket and find the username of the socket that is disconnecting; this is accomplished by storing user data in a <span class="FontName1">members[]</span> array on the server. You then broadcast that departure to the remaining clients that are connected to the server.</p>
<p class="indent">This is a basic chat server but it illustrates quite clearly how you are able to have low latency two-way communications between the client and server and client with WebSockets. In the next section you will see how you can build a multiuser whiteboard with similar methods, allowing drawn coordinates to be shared between many users in a collaborative way by using WebSockets.</p>
</div>
<p id="Sec29" class="Heading1">8-8. Building a Multiuser Whiteboard<a id="cXXX.476a"></a> with WebSockets</p>
<div>
<p id="Sec30" class="Heading2_2">Problem</p>
<p class="noindent">Now that you understand the two-way communications<a id="cXXX.471a"></a> of WebSockets, you want to build a multiuser whiteboard application in order to share a drawing in real-time.</p>
</div>
<div>
<p id="Sec31" class="Heading2">Solution</p>
<p class="noindent"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list15" id="_list15">Listing 8-15</a> shows how you can build a WebSocket server that will act as an intermediary between HTML canvas drawing clients. These clients (HTML; shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list16" id="_list16">Listing 8-16</a>) and&nbsp;&nbsp;(JavaScript; shown in <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#list17" id="_list17">Listing 8-17</a>) will send and accept WebSocket messages that will provide the ability to share collaborative drawing programs across client instances.</p>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list15" id="list15">Listing 8-15</a></i></b>.&nbsp;&nbsp;A Drawing WebSocket Server<a id="cXXX.474"></a> with WebSocket-Node</p>
<pre><span class="FontName1">var WebSocketServer = require('websocket').server,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">http = require('http'),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">sox = {},</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">idx = 0;</span><br>&nbsp;<br><span class="FontName1">var server = http.createServer(function(request, response) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">response.writeHead(404);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">response.end();</span><br><span class="FontName1">});</span><br><span class="FontName1">server.listen(8080, function() {</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">ws = new WebSocketServer({</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">httpServer: server,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">autoAcceptConnections: false</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">function originIsAllowed(origin) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">//Check here to make sure we're on the right origin</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return true;</span><br><span class="FontName1">}</span><br>&nbsp;<br><span class="FontName1">var getNextId =&nbsp;&nbsp;(function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var idx = 0;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return function() { return ++idx; };</span><br><span class="FontName1">})();</span><br><span class="FontName1">ws.on('request', function(request) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (!originIsAllowed(request.origin)) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">request.reject();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log((new Date()) + ' Connection from origin ' + request.origin + ' rejected.');</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">return;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var connection = request.accept('draw-protocol', request.origin);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.socketid = getNextId();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.sendUTF("socketid_" + connection.socketid);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">console.log(connection.socketid);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">sox[connection.socketid] = connection;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.on('message', function(message) {</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (message.type === 'utf8') {</span><br><span class="FontName1">sendToAll(JSON.parse(message.utf8Data), 'utf8');</span><br><span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">else if (message.type === 'binary') {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.sendBytes(message.binaryData);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">connection.on('close', function(reasonCode, description) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">delete sox[connection.socketid];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br><span class="FontName1">});</span><br>&nbsp;<br><span class="FontName1">function sendToAll(drawEvt, type) {</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">for (var socket in sox) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (type === 'utf8' &amp;&amp;drawEvt.socketid !== socket) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">sox[socket].sendUTF(JSON.stringify(drawEvt));</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">}</span></pre>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list16" id="list16">Listing 8-16</a></i></b>.&nbsp;&nbsp;Drawing Canvas and HTML Markup<a id="cXXX.475"></a></p>
<pre><span class="FontName1">&lt;!doctype html&gt;</span><br><span class="FontName1">&lt;html&gt;</span><br><span class="FontName1">&lt;head&gt;</span><br><span class="FontName1">&lt;title&gt;whiteboard&lt;/title&gt;</span><br><span class="FontName1">&lt;link rel="stylesheet" type="text/css" href="style.css" /&gt;</span><br><span class="FontName1">&lt;script src="jquery_1.10.2.js" type="text/javascript"&gt;&lt;/script&gt;</span><br><span class="FontName1">&lt;script src="drawings.js" type="text/javascript"&gt;&lt;/script&gt;</span><br><span class="FontName1">&lt;/head&gt;</span><br><span class="FontName1">&lt;body&gt;</span><br><span class="FontName1">&lt;div id="wrapper"&gt;</span><br><span class="FontName1">&lt;div class="menu"&gt;</span><br><span class="FontName1">&lt;ul&gt;</span><br><span class="FontName1">&lt;li&gt;</span><br><span class="FontName1">&lt;a&nbsp;&nbsp;id="clear"&gt;Clear&lt;/a&gt;</span><br>&nbsp;<br><span class="FontName1">&lt;/li&gt;</span><br><span class="FontName1">&lt;li&gt;</span><br><span class="FontName1">&lt;li&gt;</span><br><span class="FontName1">&lt;a&nbsp;&nbsp;id="draw"&gt;Draw&lt;/a&gt;</span><br><span class="FontName1">&lt;ul id="colors"&gt;</span><br><span class="FontName1">&lt;li style="background-color:white;"&gt;</span><br><span class="FontName1">&lt;a&gt;White&lt;/a&gt;</span><br><span class="FontName1">&lt;/li&gt;</span><br><span class="FontName1">&lt;li style="background-color:red;"&gt;</span><br><span class="FontName1">&lt;a&gt;Red&lt;/a&gt;</span><br><span class="FontName1">&lt;/li&gt;</span><br><span class="FontName1">&lt;li style="background-color:orange;"&gt;</span><br><span class="FontName1">&lt;a&gt;Orange&lt;/a&gt;</span><br><span class="FontName1">&lt;/li&gt;</span><br><span class="FontName1">&lt;li style="background-color:yellow;"&gt;</span><br><span class="FontName1">&lt;a&gt;Yellow&lt;/a&gt;</span><br><span class="FontName1">&lt;/li&gt;</span><br><span class="FontName1">&lt;li style="background-color:green;"&gt;</span><br><span class="FontName1">&lt;a&gt;Green&lt;/a&gt;</span><br><span class="FontName1">&lt;/li&gt;</span><br><span class="FontName1">&lt;li style="background-color:blue;"&gt;</span><br><span class="FontName1">&lt;a&gt;Blue&lt;/a&gt;</span><br><span class="FontName1">&lt;/li&gt;</span><br><span class="FontName1">&lt;li style="background-color:indigo;"&gt;</span><br><span class="FontName1">&lt;a&gt;Indigo&lt;/a&gt;</span><br><span class="FontName1">&lt;/li&gt;</span><br><span class="FontName1">&lt;li style="background-color:violet;"&gt;</span><br><span class="FontName1">&lt;a&gt;Violet&lt;/a&gt;</span><br><span class="FontName1">&lt;/li&gt;</span><br><span class="FontName1">&lt;li style="background-color:black;"&gt;</span><br><span class="FontName1">&lt;a&gt;Black&lt;/a&gt;</span><br><span class="FontName1">&lt;/li&gt;</span><br><span class="FontName1">&lt;/ul&gt;</span><br>&nbsp;<br><span class="FontName1">&lt;/li&gt;</span><br>&nbsp;<br><span class="FontName1">&lt;label for="sizer"&gt;Line Size:&lt;/label&gt;</span><br><span class="FontName1">&lt;input name="sizer" id="sizer" type="number" min="5" max="100" step="5" /&gt;</span><br>&nbsp;<br><span class="FontName1">&lt;/ul&gt;</span><br><span class="FontName1">&lt;/div&gt;</span><br><span class="FontName1">&lt;canvas id="canvas" &gt;&lt;/canvas&gt;</span><br><span class="FontName1">&lt;canvas id="remotecanvas"&gt;&lt;/canvas&gt;</span><br><span class="FontName1">&lt;/div&gt;</span><br><span class="FontName1">&lt;/body&gt;</span><br><span class="FontName1">&lt;/html&gt;</span></pre>
<p class="noindent2"><b><i><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#_list17" id="list17">Listing 8-17</a></i></b>.&nbsp;&nbsp;The Drawing Application: WebSockets and Canvas<a id="cXXX.476"></a></p>
<pre><span class="FontName1">$(document).ready(function() {</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var canvas = document.getElementById("canvas"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx = canvas.getContext("2d"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">remotecanvas = document.getElementById("remotecanvas"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">remotectx = remotecanvas.getContext("2d"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">$cvs = $("#canvas"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">top = $cvs.offset().top,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">left = $cvs.offset().left,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">wsc = new WebSocket("ws://localhost:8080", "draw-protocol"),</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">mySocketId = -1;</span><br>&nbsp;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var resizeCvs = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.canvas.width = remotectx.canvas.width = $(window).width();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.canvas.height = remotectx.canvas.height = $(window).height();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var initializeCvs = function () {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.lineCap = remotectx.lineCap = "round";</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">resizeCvs();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.save();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">remotectx.save();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">remotectx.clearRect(0,0, remotectx.canvas.width, remotectx.canvas.height);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.restore();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">remotectx.restore();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var draw = {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">isDrawing: false,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">mousedown: function(ctx, coordinates) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.beginPath();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.moveTo(coordinates.x, coordinates.y);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.isDrawing = true;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">},</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">mousemove: function(ctx, coordinates) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (this.isDrawing) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.lineTo(coordinates.x, coordinates.y);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.stroke();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">},</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">mouseup: function(ctx, coordinates) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.isDrawing = false;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.lineTo(coordinates.x, coordinates.y);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.stroke();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.closePath();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">},</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">touchstart: function(ctx, coordinates){</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.beginPath();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.moveTo(coordinates.x, coordinates.y);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.isDrawing = true;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">},</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">touchmove: function(ctx, coordinates){</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (this.isDrawing) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.lineTo(coordinates.x, coordinates.y);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.stroke();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">},</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">touchend: function(ctx, coordinates){</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (this.isDrawing) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.touchmove(coordinates);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">this.isDrawing = false;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">// create a function to pass touch events and coordinates to drawer</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">function setupDraw(event, isRemote){</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var coordinates = {};</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">var evt = {};</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">evt.type = event.type;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">evt.socketid = mySocketId;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">evt.lineWidth = ctx.lineWidth;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">evt.strokeStyle = ctx.strokeStyle;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (event.type.indexOf("touch") != -1 ){</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">evt.targetTouches = [{ pageX: 0, pageY: 0 }];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">evt.targetTouches[0].pageX = event.targetTouches[0].pageX || 0;</span><br><span class="FontName1">evt.targetTouches[0].pageY = event.targetTouches[0].pageY || 0;</span><br><span class="FontName1">coordinates.x = event.targetTouches[0].pageX - left;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">coordinates.y = event.targetTouches[0].pageY - top;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">evt.pageX = event.pageX;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">evt.pageY = event.pageY;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">coordinates.x = event.pageX - left;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">coordinates.y = event.pageY - top;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (event.strokeStyle) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">remotectx.strokeStyle = event.strokeStyle;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">remotectx.lineWidth = event.lineWidth;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (!isRemote) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">wsc.send(JSON.stringify(evt));</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">draw[event.type](ctx, coordinates);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">draw[event.type](remotectx, coordinates);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">window.addEventListener("mousedown", setupDraw, false);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">window.addEventListener("mousemove", setupDraw, false);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">window.addEventListener("mouseup", setupDraw, false);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">canvas.addEventListener('touchstart',setupDraw, false);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">canvas.addEventListener('touchmove',setupDraw, false);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">canvas.addEventListener('touchend',setupDraw, false);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">document.body.addEventListener('touchmove',function(event){</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">event.preventDefault();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">},false);</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">$('#clear').click(function (e) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">initializeCvs(true);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">$("#sizer").val("");</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">$("#draw").click(function (e) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">e.preventDefault();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">$("label[for='sizer']").text("Line Size:");</span><br><span class="FontName1">});</span><br>&nbsp;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">$("#colors li").click(function (e) {</span><br><span class="FontName1">e.preventDefault();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">$("label[for='sizer']").text("Line Size:");</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.strokeStyle = $(this).css("background-color");</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">$("#sizer").change(function (e) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">ctx.lineWidth = parseInt($(this).val(), 10);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">});</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">initializeCvs();</span><br>&nbsp;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">window.onresize = function() {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">resizeCvs();</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br>&nbsp;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">wsc.onmessage = function(event) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (event.data.indexOf("socketid_") !== -1) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">mySocketId = event.data.split("_")[1];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br><span class="FontName1">var dt = JSON.parse(event.data);</span><br><span class="FontName1">setupDraw(dt, true);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span><br><span class="FontName1">});</span></pre>
</div>
<div>
<p id="Sec32" class="Heading2">How It Works</p>
<p class="noindent">This solution begins again with a straightforward implementation of a WebSocket-Node WebSocket server. This server will only accept connections for the ‘draw-protocol<a id="cXXX.477"></a>’. Once these connections are established, you then must create a new socket identifier in order to deliver the messages to the socket later on. You then bind to the message events that will arrive from the connections. From here, you assume that you will get messages that contain coordinates that will reproduce the drawing from one client to another.You then send these messages to all connected clients by iterating through an object that contains all the sockets that are connected.</p>
<pre><span class="FontName1">function sendToAll(text, type) {</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">for (var socket in sox) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (type === 'utf8' &amp;&amp; text.socketid !== socket) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">sox[socket].sendUTF(JSON.stringify(text));</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br><span class="FontName1">}</span></pre>
<p class="indent">On the client, you create a canvas drawing app that has a few features, but you then extend that in a way that you are able to mimic the entire set of mouse or touch movements from one client to another.You, of course, start by binding to the URL of your WebSocket server and utilizing the ‘draw-protocol’ required by that server. Then you build out a <span class="FontName1">setupDraw</span> function<a id="cXXX.478"></a> within your JavaScript. This will parse the mouse or touch events that are occurring on your canvas and send them on to actually draw on the canvas. If the event that instantiates the drawing begins on the client, you will then send the coordinates, styles, and events to the WebSocket server for dispatch.</p>
<pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="FontName1">if (!isRemote) {</span><br><b>wsc.send(JSON.stringify(evt));</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">draw[event.type](ctx, coordinates);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">draw[event.type](remotectx, coordinates);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span></pre>
<p class="indent">The sent drawing event is then received on the client. This will then call the <span class="FontName1">setupDraw</span> function again; only this time you are telling the drawing tool that your data are from a remote origin, meaning that you do not need to send the stringified event back to the WebSocket server.</p>
<pre>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">wsc.onmessage = function(event) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">if (event.data.indexOf("socketid_") !== -1) {</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">mySocketId = event.data.split("_")[1];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">} else {</span><br><span class="FontName1">var dt = JSON.parse(event.data);</span><br><span class="FontName1">setupDraw(dt, true);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="FontName1">};</span></pre>
</div>
</div>
<div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders ">
		
		<li class="copy"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#">
			
				Add Note
			
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch07.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">CHAPTER 7: Discovering Other Node.js Modules</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch09.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">CHAPTER 9: Using Web Server Frameworks</div>
        </a>
    
  
  </div>


        
    </section>
    <div class="reading-controls-bottom">
      <ul class="interface-controls js-bitlist">
        <li class="queue-control">
            <button type="button" class="rec-fav ss-queue js-queue js-current-chapter-queue" data-queue-endpoint="/api/v1/book/9781430260585/chapter/9781430260585_Ch08.xhtml" data-for-analytics="9781430260585:9781430260585_Ch08.xhtml" aria-label="Add to Queue">
      <span>Add to Queue</span>
  </button>
        </li>
      </ul>
    </div>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  





    
    
      <div id="js-subscribe-nag" class="subscribe-nag clearfix trial-panel  collapsed slideUp">
        <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" class="js-toggle-nag ss-navigateup" title="Toggle open or close footer"></a>
        <div class="sample-message">
          <p class="usage-data t-collapsed-text">Enjoy Safari?
            <a class="ga-active-trial-subscribe-nag" href="https://www.safaribooksonline.com/subscribe/">
              Subscribe Today
              
            </a>
          </p>
          

        <div class="expanded">
          <h2>You have 10 days left in your trial, Raviguru0007. </h2>
          <p class="t-expanded-text">Safari is your trusted guide for building a remarkable career. We hope you've been enjoying your trial—ready to join?</p>
          <a href="https://www.safaribooksonline.com/subscribe/" class="button-primary">
            Subscribe Today
            
          </a>
          
          <footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
    <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" class="icon-up" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/contact/">Contact Us</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
    </ul>
    <span class="copyright">© 2017 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/membership-agreement/">Membership Agreement</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>

        </div>
      </div>
    </div>

    
    



        
      </div>
      




  <footer class="pagefoot t-pagefoot" style="padding-bottom: 69px;">
    <a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" class="icon-up" style="display: none;"><div class="visuallyhidden">Back to top</div></a>
    <ul class="js-footer-nav">
      
        <li><a class="t-recommendations-footer" href="https://www.safaribooksonline.com/r/">Recommended</a></li>
      
      <li><a class="t-queue-footer" href="https://www.safaribooksonline.com/s/">Queue</a></li>
      
        <li><a class="t-recent-footer" href="https://www.safaribooksonline.com/history/">History</a></li>
        <li><a class="t-topics-footer" href="https://www.safaribooksonline.com/topics?q=*&amp;limit=21">Topics</a></li>
      
      
        <li><a class="t-tutorials-footer" href="https://www.safaribooksonline.com/tutorials/">Tutorials</a></li>
      
      <li><a class="t-settings-footer js-settings" href="https://www.safaribooksonline.com/u/">Settings</a></li>
      <li><a href="https://www.safaribooksonline.com/blog/">Blog</a></li>
      <li class="full-support"><a href="https://www.safaribooksonline.com/public/support">Support</a></li>
      <li><a href="https://www.safaribooksonline.com/apps/">Get the App</a></li>
      <li><a href="https://www.safaribooksonline.com/accounts/logout/">Sign Out</a></li>
    </ul>
    <span class="copyright">© 2017 <a href="https://www.safaribooksonline.com/" target="_blank">Safari</a>.</span>
    <a href="https://www.safaribooksonline.com/terms/">Terms of Service</a> /
    <a href="https://www.safaribooksonline.com/privacy/">Privacy Policy</a>
  </footer>

<script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"agent":"","queueTime":0,"applicationTime":176,"beacon":"bam.nr-data.net","transactionName":"YgdaZ0NSW0cEB0RdWltNfkZfUEFdCgofXFBHDVYdR1pQQxZeRl1QQj1aWkU=","errorBeacon":"bam.nr-data.net","applicationID":"3275661","licenseKey":"510f1a6865"}</script>


    

    <script src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/saved_resource" charset="utf-8"></script>
    <script src="./CHAPTER 8_ Creating a WebSocket Server - Node.js Recipes_ A Problem-Solution Approach_files/saved_resource(1)" charset="utf-8"></script>
  

<div class="annotator-notice"></div><div class="font-flyout" style="top: 200.006px; left: 1217px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://www.safaribooksonline.com/library/view/nodejs-recipes-a/9781430260585/9781430260585_Ch08.xhtml#">Reset</a>
</div>
</div></body></html>